<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Fennix: Kernel/core/memory/heap_allocators/rpmalloc/rpmalloc.c Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="../../custom.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Fennix
   &#160;<span id="projectnumber">1.0.0</span>
   </div>
   <div id="projectbrief">Opeating System from scratch made in C and C++</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "../../search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('df/dc0/rpmalloc_8c_source.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">rpmalloc.c</div>  </div>
</div><!--header-->
<div class="contents">
<a href="../../df/dc0/rpmalloc_8c.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="comment">/* rpmalloc.c  -  Memory allocator  -  Public Domain  -  2016-2020 Mattias Jansson</span></div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment"> * This library provides a cross-platform lock free thread caching malloc implementation in C11.</span></div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment"> * The latest source code is always available at</span></div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="comment"> * https://github.com/mjansson/rpmalloc</span></div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="comment"> * This library is put in the public domain; you can redistribute it and/or modify it without any restrictions.</span></div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="comment"> */</span></div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160; </div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="../../d2/d43/rpmalloc_8h.html">rpmalloc.h</a>&quot;</span></div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160; </div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160; </div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="preprocessor">#if defined(__clang__)</span></div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="preprocessor">#pragma clang diagnostic ignored &quot;-Wunused-macros&quot;</span></div>
<div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;<span class="preprocessor">#pragma clang diagnostic ignored &quot;-Wunused-function&quot;</span></div>
<div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;<span class="preprocessor">#if __has_warning(&quot;-Wreserved-identifier&quot;</span>)</div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;<span class="preprocessor">#pragma clang diagnostic ignored &quot;-Wreserved-identifier&quot;</span></div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;<span class="preprocessor">#elif defined(__GNUC__)</span></div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;<span class="preprocessor">#pragma GCC diagnostic ignored &quot;-Wunused-macros&quot;</span></div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;<span class="preprocessor">#pragma GCC diagnostic ignored &quot;-Wunused-function&quot;</span></div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160; </div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;<span class="preprocessor">#ifndef HEAP_ARRAY_SIZE</span></div>
<div class="line"><a name="l00033"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#ac7e4a352a230ef04d4372db43a454b7f">   33</a></span>&#160;<span class="preprocessor">#define HEAP_ARRAY_SIZE 47</span></div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;<span class="preprocessor">#ifndef ENABLE_THREAD_CACHE</span></div>
<div class="line"><a name="l00037"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a69503d4619673c88e0882f291eb6d86f">   37</a></span>&#160;<span class="preprocessor">#define ENABLE_THREAD_CACHE 1</span></div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;<span class="preprocessor">#ifndef ENABLE_GLOBAL_CACHE</span></div>
<div class="line"><a name="l00041"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a39fd01af4bfcf583a5039c34d23e2bb9">   41</a></span>&#160;<span class="preprocessor">#define ENABLE_GLOBAL_CACHE 1</span></div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;<span class="preprocessor">#ifndef ENABLE_VALIDATE_ARGS</span></div>
<div class="line"><a name="l00045"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a53baabd23f5ba123eb9a9d6121faed9f">   45</a></span>&#160;<span class="preprocessor">#define ENABLE_VALIDATE_ARGS 1</span></div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;<span class="preprocessor">#ifndef ENABLE_STATISTICS</span></div>
<div class="line"><a name="l00049"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#aab186ebd3fdc6562bb8aadad4ccce3ed">   49</a></span>&#160;<span class="preprocessor">#define ENABLE_STATISTICS 0</span></div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;<span class="preprocessor">#ifndef ENABLE_ASSERTS</span></div>
<div class="line"><a name="l00053"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#ad616b76a55f585c9f7f75af50575911a">   53</a></span>&#160;<span class="preprocessor">#define ENABLE_ASSERTS 1</span></div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;<span class="preprocessor">#ifndef ENABLE_OVERRIDE</span></div>
<div class="line"><a name="l00057"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#ac2f574bcf90e64a0529171141caef930">   57</a></span>&#160;<span class="preprocessor">#define ENABLE_OVERRIDE 0</span></div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;<span class="preprocessor">#ifndef ENABLE_PRELOAD</span></div>
<div class="line"><a name="l00061"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#ae7896aa9035235aefac2ab04a90c9d10">   61</a></span>&#160;<span class="preprocessor">#define ENABLE_PRELOAD 0</span></div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;<span class="preprocessor">#ifndef DISABLE_UNMAP</span></div>
<div class="line"><a name="l00065"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#ae777722890578ce47ae32f908b4005b0">   65</a></span>&#160;<span class="preprocessor">#define DISABLE_UNMAP 0</span></div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;<span class="preprocessor">#ifndef ENABLE_UNLIMITED_CACHE</span></div>
<div class="line"><a name="l00069"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#afc6937f23f518f51f693f7d034100f9c">   69</a></span>&#160;<span class="preprocessor">#define ENABLE_UNLIMITED_CACHE 0</span></div>
<div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;<span class="preprocessor">#ifndef ENABLE_ADAPTIVE_THREAD_CACHE</span></div>
<div class="line"><a name="l00073"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a74abd212deb430c20e3bbf5cadbe075c">   73</a></span>&#160;<span class="preprocessor">#define ENABLE_ADAPTIVE_THREAD_CACHE 0</span></div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;<span class="preprocessor">#ifndef DEFAULT_SPAN_MAP_COUNT</span></div>
<div class="line"><a name="l00077"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#af8803f4eab133ac4c823104577553d78">   77</a></span>&#160;<span class="preprocessor">#define DEFAULT_SPAN_MAP_COUNT 64</span></div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;<span class="preprocessor">#ifndef GLOBAL_CACHE_MULTIPLIER</span></div>
<div class="line"><a name="l00081"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#aec9c1ea6434b5703d7b6e01cfffd1261">   81</a></span>&#160;<span class="preprocessor">#define GLOBAL_CACHE_MULTIPLIER 8</span></div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160; </div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;<span class="preprocessor">#if DISABLE_UNMAP &amp;&amp; !ENABLE_GLOBAL_CACHE</span></div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;<span class="preprocessor">#error Must use global cache if unmap is disabled</span></div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160; </div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;<span class="preprocessor">#if DISABLE_UNMAP</span></div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;<span class="preprocessor">#undef ENABLE_UNLIMITED_CACHE</span></div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;<span class="preprocessor">#define ENABLE_UNLIMITED_CACHE 1</span></div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160; </div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;<span class="preprocessor">#if !ENABLE_GLOBAL_CACHE</span></div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;<span class="preprocessor">#undef ENABLE_UNLIMITED_CACHE</span></div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;<span class="preprocessor">#define ENABLE_UNLIMITED_CACHE 0</span></div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160; </div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;<span class="preprocessor">#if !ENABLE_THREAD_CACHE</span></div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;<span class="preprocessor">#undef ENABLE_ADAPTIVE_THREAD_CACHE</span></div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;<span class="preprocessor">#define ENABLE_ADAPTIVE_THREAD_CACHE 0</span></div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160; </div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;<span class="preprocessor">#ifndef FORCEINLINE</span></div>
<div class="line"><a name="l00104"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a724fb9f82013c782db5c3c12ea36aac8">  104</a></span>&#160;<span class="preprocessor">#define FORCEINLINE inline __attribute__((__always_inline__))</span></div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160; </div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;<span class="preprocessor">#include &lt;unistd.h&gt;</span></div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;<span class="preprocessor">#include &lt;stdio.h&gt;</span></div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;<span class="preprocessor">#include &lt;stdlib.h&gt;</span></div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;<span class="preprocessor">#include &lt;time.h&gt;</span></div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;<span class="preprocessor">#include &lt;stdint.h&gt;</span></div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;<span class="preprocessor">#include &lt;string.h&gt;</span></div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;<span class="preprocessor">#include &lt;errno.h&gt;</span></div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160; </div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;<span class="preprocessor">#if defined(_WIN32) &amp;&amp; (!defined(BUILD_DYNAMIC_LINK) || !BUILD_DYNAMIC_LINK)</span></div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;<span class="preprocessor">#include &lt;fibersapi.h&gt;</span></div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;<span class="keyword">static</span> <a class="code" href="../../de/d63/msexec_8h.html#ad342ac907eb044443153a22f964bf0af">DWORD</a> fls_key;</div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160; </div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;<span class="preprocessor">#include &lt;sys/mman.h&gt;</span></div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;<span class="preprocessor">#include &lt;sched.h&gt;</span></div>
<div class="line"><a name="l00122"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a5e69d79e63de190044f85551915620bd">  122</a></span>&#160;<span class="preprocessor">#define PROT_MAX(f) 0</span></div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160; </div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;<span class="preprocessor">#ifndef MAP_UNINITIALIZED</span></div>
<div class="line"><a name="l00125"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a14828817b96941a8a2ad71e2bb95143b">  125</a></span>&#160;<span class="preprocessor">#define MAP_UNINITIALIZED 0</span></div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160; </div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;<span class="preprocessor">#include &lt;errno.h&gt;</span></div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160; </div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;<span class="keywordtype">long</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#a97f4a6378f5e22e4e38e32cf9f370430">__rpmalloc_sysconf</a>(<span class="keywordtype">int</span> name);</div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;<span class="keywordtype">void</span> *<a class="code" href="../../df/dc0/rpmalloc_8c.html#a38abd8cccc9bef76c59666dc716e3f30">__rpmalloc_mmap</a>(<span class="keywordtype">void</span> *<a class="code" href="../../d1/dc0/multiboot_8h.html#a8286ae6db03c34c4bb161accbfbfbbcd">addr</a>, <span class="keywordtype">size_t</span> length, <span class="keywordtype">int</span> prot, <span class="keywordtype">int</span> flags, <span class="keywordtype">int</span> <a class="code" href="../../d0/d64/syscall_8cpp.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <a class="code" href="../../d2/d5c/Userspace_2libc_2include_2sys_2stat_8h.html#ae498af04567b740d66e09d36613c2cd8">off_t</a> offset);</div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;<span class="keywordtype">int</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#a26f341387be75540b16ddf371b9ce3ed">__rpmalloc_munmap</a>(<span class="keywordtype">void</span> *<a class="code" href="../../d1/dc0/multiboot_8h.html#a8286ae6db03c34c4bb161accbfbfbbcd">addr</a>, <span class="keywordtype">size_t</span> length);</div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;<span class="keywordtype">int</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#a34a6e06414bb541b0d231513cb7b66e3">__rpmalloc_posix_madvise</a>(<span class="keywordtype">void</span> *<a class="code" href="../../d1/dc0/multiboot_8h.html#a8286ae6db03c34c4bb161accbfbfbbcd">addr</a>, <span class="keywordtype">size_t</span> length, <span class="keywordtype">int</span> advice);</div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160; </div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;<span class="preprocessor">#if ENABLE_ASSERTS</span></div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;<span class="preprocessor">#undef NDEBUG</span></div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;<span class="preprocessor">#if defined(_MSC_VER) &amp;&amp; !defined(_DEBUG)</span></div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;<span class="preprocessor">#define _DEBUG</span></div>
<div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;<span class="preprocessor">#include &lt;assert.h&gt;</span></div>
<div class="line"><a name="l00141"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a75f7f7a2b66bb3f915c9244acff27ae8">  141</a></span>&#160;<span class="preprocessor">#define RPMALLOC_TOSTRING_M(x) #x</span></div>
<div class="line"><a name="l00142"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#ad8d347756d4514d000e67815c1fc51e3">  142</a></span>&#160;<span class="preprocessor">#define RPMALLOC_TOSTRING(x) RPMALLOC_TOSTRING_M(x)</span></div>
<div class="line"><a name="l00143"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#ad008ddf766a4f56fbde2edf2c51d9a87">  143</a></span>&#160;<span class="preprocessor">#define rpmalloc_assert(truth, message)                                                                      \</span></div>
<div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;<span class="preprocessor">    do                                                                                                       \</span></div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;<span class="preprocessor">    {                                                                                                        \</span></div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;<span class="preprocessor">        if (!(truth))                                                                                        \</span></div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;<span class="preprocessor">        {                                                                                                    \</span></div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;<span class="preprocessor">            if (_memory_config.error_callback)                                                               \</span></div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;<span class="preprocessor">            {                                                                                                \</span></div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;<span class="preprocessor">                _memory_config.error_callback(                                                               \</span></div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;<span class="preprocessor">                    message &quot; (&quot;</span> RPMALLOC_TOSTRING(truth) &quot;) at &quot; __FILE__ &quot;:&quot; RPMALLOC_TOSTRING(__LINE__)); \</div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;            }                                                                                                \</div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;            else                                                                                             \</div>
<div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;            {                                                                                                \</div>
<div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;                assert((truth) &amp;&amp; message);                                                                  \</div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;            }                                                                                                \</div>
<div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;        }                                                                                                    \</div>
<div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;    } while (0)</div>
<div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;<span class="preprocessor">#define rpmalloc_assert(truth, message) \</span></div>
<div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;<span class="preprocessor">    do                                  \</span></div>
<div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;<span class="preprocessor">    {                                   \</span></div>
<div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;<span class="preprocessor">    } while (0)</span></div>
<div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;<span class="preprocessor">#if ENABLE_STATISTICS</span></div>
<div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;<span class="preprocessor">#include &lt;stdio.h&gt;</span></div>
<div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160; </div>
<div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="../../d6/d07/stdatomic_8h.html">stdatomic.h</a>&gt;</span></div>
<div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160; </div>
<div class="line"><a name="l00171"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a472f0bf448a2dc3f31c0b79acd70d829">  171</a></span>&#160;<span class="keyword">typedef</span> <span class="keyword">volatile</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#a472f0bf448a2dc3f31c0b79acd70d829">_Atomic</a>(<a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#a0c18914b3041c2f583aba76f418399c2">int32_t</a>) atomic32_t;</div>
<div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;<span class="keyword">typedef</span> <span class="keyword">volatile</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#a472f0bf448a2dc3f31c0b79acd70d829">_Atomic</a>(<a class="code" href="../../dd/ddd/arithmetic__operations_8c.html#a996e72f71b11a5bb8b3b7b6936b1516d">int64_t</a>) atomic64_t;</div>
<div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;<span class="keyword">typedef</span> <span class="keyword">volatile</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#a472f0bf448a2dc3f31c0b79acd70d829">_Atomic</a>(<span class="keywordtype">void</span> *) atomicptr_t;</div>
<div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160; </div>
<div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;<span class="comment">/* Intellisense errors */</span></div>
<div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;<span class="preprocessor">#ifndef __vscode__</span></div>
<div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160; </div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;<span class="keyword">static</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#a724fb9f82013c782db5c3c12ea36aac8">FORCEINLINE</a> <a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#a0c18914b3041c2f583aba76f418399c2">int32_t</a> atomic_load32(atomic32_t *src) { <span class="keywordflow">return</span> <a class="code" href="../../d6/d07/stdatomic_8h.html#a714cabdfee3dff182363e10401689371">atomic_load_explicit</a>(src, <a class="code" href="../../d6/d07/stdatomic_8h.html#a17c2de5ae768960284c047a320f17d1bac6489d0374e297a776f6a3db7ea5654a">memory_order_relaxed</a>); }</div>
<div class="line"><a name="l00179"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#aa1ee77cdccf0341222f64395d0be2626">  179</a></span>&#160;<span class="keyword">static</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#a724fb9f82013c782db5c3c12ea36aac8">FORCEINLINE</a> <span class="keywordtype">void</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#aa1ee77cdccf0341222f64395d0be2626">atomic_store32</a>(atomic32_t *dst, <a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#a0c18914b3041c2f583aba76f418399c2">int32_t</a> val) { <a class="code" href="../../d6/d07/stdatomic_8h.html#ad559c29e007899c11142f0d899625397">atomic_store_explicit</a>(dst, val, <a class="code" href="../../d6/d07/stdatomic_8h.html#a17c2de5ae768960284c047a320f17d1bac6489d0374e297a776f6a3db7ea5654a">memory_order_relaxed</a>); }</div>
<div class="line"><a name="l00180"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a1fe9c932f58e2baffed3ea33fd299691">  180</a></span>&#160;<span class="keyword">static</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#a724fb9f82013c782db5c3c12ea36aac8">FORCEINLINE</a> <a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#a0c18914b3041c2f583aba76f418399c2">int32_t</a> <a class="code" href="../../df/dc0/rpmalloc_8c.html#a1fe9c932f58e2baffed3ea33fd299691">atomic_incr32</a>(atomic32_t *val) { <span class="keywordflow">return</span> <a class="code" href="../../d6/d07/stdatomic_8h.html#a1d2b72b5d6ad1392c4f805054be0bdd1">atomic_fetch_add_explicit</a>(val, 1, <a class="code" href="../../d6/d07/stdatomic_8h.html#a17c2de5ae768960284c047a320f17d1bac6489d0374e297a776f6a3db7ea5654a">memory_order_relaxed</a>) + 1; }</div>
<div class="line"><a name="l00181"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a4f0dc3c548801773a4da1c96f39b04c9">  181</a></span>&#160;<span class="keyword">static</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#a724fb9f82013c782db5c3c12ea36aac8">FORCEINLINE</a> <a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#a0c18914b3041c2f583aba76f418399c2">int32_t</a> <a class="code" href="../../df/dc0/rpmalloc_8c.html#a4f0dc3c548801773a4da1c96f39b04c9">atomic_decr32</a>(atomic32_t *val) { <span class="keywordflow">return</span> <a class="code" href="../../d6/d07/stdatomic_8h.html#a1d2b72b5d6ad1392c4f805054be0bdd1">atomic_fetch_add_explicit</a>(val, -1, <a class="code" href="../../d6/d07/stdatomic_8h.html#a17c2de5ae768960284c047a320f17d1bac6489d0374e297a776f6a3db7ea5654a">memory_order_relaxed</a>) - 1; }</div>
<div class="line"><a name="l00182"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#af327588f7260778f453d9a212396e0e0">  182</a></span>&#160;<span class="keyword">static</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#a724fb9f82013c782db5c3c12ea36aac8">FORCEINLINE</a> <a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#a0c18914b3041c2f583aba76f418399c2">int32_t</a> <a class="code" href="../../df/dc0/rpmalloc_8c.html#af327588f7260778f453d9a212396e0e0">atomic_add32</a>(atomic32_t *val, <a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#a0c18914b3041c2f583aba76f418399c2">int32_t</a> add) { <span class="keywordflow">return</span> <a class="code" href="../../d6/d07/stdatomic_8h.html#a1d2b72b5d6ad1392c4f805054be0bdd1">atomic_fetch_add_explicit</a>(val, add, <a class="code" href="../../d6/d07/stdatomic_8h.html#a17c2de5ae768960284c047a320f17d1bac6489d0374e297a776f6a3db7ea5654a">memory_order_relaxed</a>) + add; }</div>
<div class="line"><a name="l00183"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a2071bf7ebae50eced1f16b359f9d5c7d">  183</a></span>&#160;<span class="keyword">static</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#a724fb9f82013c782db5c3c12ea36aac8">FORCEINLINE</a> <span class="keywordtype">int</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#a2071bf7ebae50eced1f16b359f9d5c7d">atomic_cas32_acquire</a>(atomic32_t *dst, <a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#a0c18914b3041c2f583aba76f418399c2">int32_t</a> val, <a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#a0c18914b3041c2f583aba76f418399c2">int32_t</a> ref) { <span class="keywordflow">return</span> <a class="code" href="../../d6/d07/stdatomic_8h.html#ae7f81d6541b8feec676e997952555882">atomic_compare_exchange_weak_explicit</a>(dst, &amp;ref, val, <a class="code" href="../../d6/d07/stdatomic_8h.html#a17c2de5ae768960284c047a320f17d1bafb313754331704b978e9a80a933b3da7">memory_order_acquire</a>, <a class="code" href="../../d6/d07/stdatomic_8h.html#a17c2de5ae768960284c047a320f17d1bac6489d0374e297a776f6a3db7ea5654a">memory_order_relaxed</a>); }</div>
<div class="line"><a name="l00184"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a2a87a6060d5387fe8491a00600073687">  184</a></span>&#160;<span class="keyword">static</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#a724fb9f82013c782db5c3c12ea36aac8">FORCEINLINE</a> <span class="keywordtype">void</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#a2a87a6060d5387fe8491a00600073687">atomic_store32_release</a>(atomic32_t *dst, <a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#a0c18914b3041c2f583aba76f418399c2">int32_t</a> val) { <a class="code" href="../../d6/d07/stdatomic_8h.html#ad559c29e007899c11142f0d899625397">atomic_store_explicit</a>(dst, val, <a class="code" href="../../d6/d07/stdatomic_8h.html#a17c2de5ae768960284c047a320f17d1ba685a90c8fc516895354973c3918a5f7b">memory_order_release</a>); }</div>
<div class="line"><a name="l00185"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a083ecd4af0f476009595e8ee78cf2ac0">  185</a></span>&#160;<span class="keyword">static</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#a724fb9f82013c782db5c3c12ea36aac8">FORCEINLINE</a> <a class="code" href="../../dd/ddd/arithmetic__operations_8c.html#a996e72f71b11a5bb8b3b7b6936b1516d">int64_t</a> <a class="code" href="../../df/dc0/rpmalloc_8c.html#a083ecd4af0f476009595e8ee78cf2ac0">atomic_load64</a>(atomic64_t *val) { <span class="keywordflow">return</span> <a class="code" href="../../d6/d07/stdatomic_8h.html#a714cabdfee3dff182363e10401689371">atomic_load_explicit</a>(val, <a class="code" href="../../d6/d07/stdatomic_8h.html#a17c2de5ae768960284c047a320f17d1bac6489d0374e297a776f6a3db7ea5654a">memory_order_relaxed</a>); }</div>
<div class="line"><a name="l00186"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a481f7733c3d6469b66e9a746e0afb0e9">  186</a></span>&#160;<span class="keyword">static</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#a724fb9f82013c782db5c3c12ea36aac8">FORCEINLINE</a> <a class="code" href="../../dd/ddd/arithmetic__operations_8c.html#a996e72f71b11a5bb8b3b7b6936b1516d">int64_t</a> <a class="code" href="../../df/dc0/rpmalloc_8c.html#a481f7733c3d6469b66e9a746e0afb0e9">atomic_add64</a>(atomic64_t *val, <a class="code" href="../../dd/ddd/arithmetic__operations_8c.html#a996e72f71b11a5bb8b3b7b6936b1516d">int64_t</a> add) { <span class="keywordflow">return</span> <a class="code" href="../../d6/d07/stdatomic_8h.html#a1d2b72b5d6ad1392c4f805054be0bdd1">atomic_fetch_add_explicit</a>(val, add, <a class="code" href="../../d6/d07/stdatomic_8h.html#a17c2de5ae768960284c047a320f17d1bac6489d0374e297a776f6a3db7ea5654a">memory_order_relaxed</a>) + add; }</div>
<div class="line"><a name="l00187"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a83ddc23debb02a3c47f0b00939fc8f35">  187</a></span>&#160;<span class="keyword">static</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#a724fb9f82013c782db5c3c12ea36aac8">FORCEINLINE</a> <span class="keywordtype">void</span> *<a class="code" href="../../df/dc0/rpmalloc_8c.html#a83ddc23debb02a3c47f0b00939fc8f35">atomic_load_ptr</a>(atomicptr_t *src) { <span class="keywordflow">return</span> <a class="code" href="../../d6/d07/stdatomic_8h.html#a714cabdfee3dff182363e10401689371">atomic_load_explicit</a>(src, <a class="code" href="../../d6/d07/stdatomic_8h.html#a17c2de5ae768960284c047a320f17d1bac6489d0374e297a776f6a3db7ea5654a">memory_order_relaxed</a>); }</div>
<div class="line"><a name="l00188"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#ae261e72f93968b03a76ada7a6b150965">  188</a></span>&#160;<span class="keyword">static</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#a724fb9f82013c782db5c3c12ea36aac8">FORCEINLINE</a> <span class="keywordtype">void</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#ae261e72f93968b03a76ada7a6b150965">atomic_store_ptr</a>(atomicptr_t *dst, <span class="keywordtype">void</span> *val) { <a class="code" href="../../d6/d07/stdatomic_8h.html#ad559c29e007899c11142f0d899625397">atomic_store_explicit</a>(dst, val, <a class="code" href="../../d6/d07/stdatomic_8h.html#a17c2de5ae768960284c047a320f17d1bac6489d0374e297a776f6a3db7ea5654a">memory_order_relaxed</a>); }</div>
<div class="line"><a name="l00189"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a94d4ba8d2181723f35b45da39c91d8ab">  189</a></span>&#160;<span class="keyword">static</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#a724fb9f82013c782db5c3c12ea36aac8">FORCEINLINE</a> <span class="keywordtype">void</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#a94d4ba8d2181723f35b45da39c91d8ab">atomic_store_ptr_release</a>(atomicptr_t *dst, <span class="keywordtype">void</span> *val) { <a class="code" href="../../d6/d07/stdatomic_8h.html#ad559c29e007899c11142f0d899625397">atomic_store_explicit</a>(dst, val, <a class="code" href="../../d6/d07/stdatomic_8h.html#a17c2de5ae768960284c047a320f17d1ba685a90c8fc516895354973c3918a5f7b">memory_order_release</a>); }</div>
<div class="line"><a name="l00190"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#af6f24a9d51e940bbad434106b1d56e20">  190</a></span>&#160;<span class="keyword">static</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#a724fb9f82013c782db5c3c12ea36aac8">FORCEINLINE</a> <span class="keywordtype">void</span> *<a class="code" href="../../df/dc0/rpmalloc_8c.html#af6f24a9d51e940bbad434106b1d56e20">atomic_exchange_ptr_acquire</a>(atomicptr_t *dst, <span class="keywordtype">void</span> *val) { <span class="keywordflow">return</span> <a class="code" href="../../d6/d07/stdatomic_8h.html#abc7db808dcdfb37a76f5dc646422fe29">atomic_exchange_explicit</a>(dst, val, <a class="code" href="../../d6/d07/stdatomic_8h.html#a17c2de5ae768960284c047a320f17d1bafb313754331704b978e9a80a933b3da7">memory_order_acquire</a>); }</div>
<div class="line"><a name="l00191"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a303f700546874a81e694eda44cc3174d">  191</a></span>&#160;<span class="keyword">static</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#a724fb9f82013c782db5c3c12ea36aac8">FORCEINLINE</a> <span class="keywordtype">int</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#a303f700546874a81e694eda44cc3174d">atomic_cas_ptr</a>(atomicptr_t *dst, <span class="keywordtype">void</span> *val, <span class="keywordtype">void</span> *ref) { <span class="keywordflow">return</span> <a class="code" href="../../d6/d07/stdatomic_8h.html#ae7f81d6541b8feec676e997952555882">atomic_compare_exchange_weak_explicit</a>(dst, &amp;ref, val, <a class="code" href="../../d6/d07/stdatomic_8h.html#a17c2de5ae768960284c047a320f17d1bac6489d0374e297a776f6a3db7ea5654a">memory_order_relaxed</a>, <a class="code" href="../../d6/d07/stdatomic_8h.html#a17c2de5ae768960284c047a320f17d1bac6489d0374e297a776f6a3db7ea5654a">memory_order_relaxed</a>); }</div>
<div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160; </div>
<div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160; </div>
<div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;<span class="keyword">static</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#a724fb9f82013c782db5c3c12ea36aac8">FORCEINLINE</a> <a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#a0c18914b3041c2f583aba76f418399c2">int32_t</a> atomic_load32(atomic32_t *src) { <span class="keywordflow">return</span> 0; }</div>
<div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;<span class="keyword">static</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#a724fb9f82013c782db5c3c12ea36aac8">FORCEINLINE</a> <span class="keywordtype">void</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#aa1ee77cdccf0341222f64395d0be2626">atomic_store32</a>(atomic32_t *dst, <a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#a0c18914b3041c2f583aba76f418399c2">int32_t</a> val) {}</div>
<div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;<span class="keyword">static</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#a724fb9f82013c782db5c3c12ea36aac8">FORCEINLINE</a> <a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#a0c18914b3041c2f583aba76f418399c2">int32_t</a> <a class="code" href="../../df/dc0/rpmalloc_8c.html#a1fe9c932f58e2baffed3ea33fd299691">atomic_incr32</a>(atomic32_t *val) { <span class="keywordflow">return</span> 0; }</div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;<span class="keyword">static</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#a724fb9f82013c782db5c3c12ea36aac8">FORCEINLINE</a> <a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#a0c18914b3041c2f583aba76f418399c2">int32_t</a> <a class="code" href="../../df/dc0/rpmalloc_8c.html#a4f0dc3c548801773a4da1c96f39b04c9">atomic_decr32</a>(atomic32_t *val) { <span class="keywordflow">return</span> 0; }</div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;<span class="keyword">static</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#a724fb9f82013c782db5c3c12ea36aac8">FORCEINLINE</a> <a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#a0c18914b3041c2f583aba76f418399c2">int32_t</a> <a class="code" href="../../df/dc0/rpmalloc_8c.html#af327588f7260778f453d9a212396e0e0">atomic_add32</a>(atomic32_t *val, <a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#a0c18914b3041c2f583aba76f418399c2">int32_t</a> add) { <span class="keywordflow">return</span> 0; }</div>
<div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;<span class="keyword">static</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#a724fb9f82013c782db5c3c12ea36aac8">FORCEINLINE</a> <span class="keywordtype">int</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#a2071bf7ebae50eced1f16b359f9d5c7d">atomic_cas32_acquire</a>(atomic32_t *dst, <a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#a0c18914b3041c2f583aba76f418399c2">int32_t</a> val, <a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#a0c18914b3041c2f583aba76f418399c2">int32_t</a> ref) { <span class="keywordflow">return</span> 0; }</div>
<div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;<span class="keyword">static</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#a724fb9f82013c782db5c3c12ea36aac8">FORCEINLINE</a> <span class="keywordtype">void</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#a2a87a6060d5387fe8491a00600073687">atomic_store32_release</a>(atomic32_t *dst, <a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#a0c18914b3041c2f583aba76f418399c2">int32_t</a> val) {}</div>
<div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;<span class="keyword">static</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#a724fb9f82013c782db5c3c12ea36aac8">FORCEINLINE</a> <a class="code" href="../../dd/ddd/arithmetic__operations_8c.html#a996e72f71b11a5bb8b3b7b6936b1516d">int64_t</a> <a class="code" href="../../df/dc0/rpmalloc_8c.html#a083ecd4af0f476009595e8ee78cf2ac0">atomic_load64</a>(atomic64_t *val) { <span class="keywordflow">return</span> 0; }</div>
<div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;<span class="keyword">static</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#a724fb9f82013c782db5c3c12ea36aac8">FORCEINLINE</a> <a class="code" href="../../dd/ddd/arithmetic__operations_8c.html#a996e72f71b11a5bb8b3b7b6936b1516d">int64_t</a> <a class="code" href="../../df/dc0/rpmalloc_8c.html#a481f7733c3d6469b66e9a746e0afb0e9">atomic_add64</a>(atomic64_t *val, <a class="code" href="../../dd/ddd/arithmetic__operations_8c.html#a996e72f71b11a5bb8b3b7b6936b1516d">int64_t</a> add) { <span class="keywordflow">return</span> 0; }</div>
<div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;<span class="keyword">static</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#a724fb9f82013c782db5c3c12ea36aac8">FORCEINLINE</a> <span class="keywordtype">void</span> *<a class="code" href="../../df/dc0/rpmalloc_8c.html#a83ddc23debb02a3c47f0b00939fc8f35">atomic_load_ptr</a>(atomicptr_t *src) { <span class="keywordflow">return</span> 0; }</div>
<div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;<span class="keyword">static</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#a724fb9f82013c782db5c3c12ea36aac8">FORCEINLINE</a> <span class="keywordtype">void</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#ae261e72f93968b03a76ada7a6b150965">atomic_store_ptr</a>(atomicptr_t *dst, <span class="keywordtype">void</span> *val) {}</div>
<div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;<span class="keyword">static</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#a724fb9f82013c782db5c3c12ea36aac8">FORCEINLINE</a> <span class="keywordtype">void</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#a94d4ba8d2181723f35b45da39c91d8ab">atomic_store_ptr_release</a>(atomicptr_t *dst, <span class="keywordtype">void</span> *val) {}</div>
<div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;<span class="keyword">static</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#a724fb9f82013c782db5c3c12ea36aac8">FORCEINLINE</a> <span class="keywordtype">void</span> *<a class="code" href="../../df/dc0/rpmalloc_8c.html#af6f24a9d51e940bbad434106b1d56e20">atomic_exchange_ptr_acquire</a>(atomicptr_t *dst, <span class="keywordtype">void</span> *val) { <span class="keywordflow">return</span> 0; }</div>
<div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;<span class="keyword">static</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#a724fb9f82013c782db5c3c12ea36aac8">FORCEINLINE</a> <span class="keywordtype">int</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#a303f700546874a81e694eda44cc3174d">atomic_cas_ptr</a>(atomicptr_t *dst, <span class="keywordtype">void</span> *val, <span class="keywordtype">void</span> *ref) { <span class="keywordflow">return</span> 0; }</div>
<div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160; </div>
<div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160; </div>
<div class="line"><a name="l00212"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a90593dceacf0c04f14d084bed7e7eabe">  212</a></span>&#160;<span class="preprocessor">#define EXPECTED(x) __builtin_expect((x), 1)</span></div>
<div class="line"><a name="l00213"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#af8f864d9fe0055b43dc8034fe9060630">  213</a></span>&#160;<span class="preprocessor">#define UNEXPECTED(x) __builtin_expect((x), 0)</span></div>
<div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160; </div>
<div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160; </div>
<div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;<span class="preprocessor">#if ENABLE_STATISTICS</span></div>
<div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;<span class="preprocessor">#define _rpmalloc_stat_inc(counter) atomic_incr32(counter)</span></div>
<div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;<span class="preprocessor">#define _rpmalloc_stat_dec(counter) atomic_decr32(counter)</span></div>
<div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;<span class="preprocessor">#define _rpmalloc_stat_add(counter, value) atomic_add32(counter, (int32_t)(value))</span></div>
<div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;<span class="preprocessor">#define _rpmalloc_stat_add64(counter, value) atomic_add64(counter, (int64_t)(value))</span></div>
<div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;<span class="preprocessor">#define _rpmalloc_stat_add_peak(counter, value, peak)                 \</span></div>
<div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;<span class="preprocessor">    do                                                                \</span></div>
<div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;<span class="preprocessor">    {                                                                 \</span></div>
<div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;<span class="preprocessor">        int32_t _cur_count = atomic_add32(counter, (int32_t)(value)); \</span></div>
<div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;<span class="preprocessor">        if (_cur_count &gt; (peak))                                      \</span></div>
<div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;<span class="preprocessor">            peak = _cur_count;                                        \</span></div>
<div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;<span class="preprocessor">    } while (0)</span></div>
<div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;<span class="preprocessor">#define _rpmalloc_stat_sub(counter, value) atomic_add32(counter, -(int32_t)(value))</span></div>
<div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;<span class="preprocessor">#define _rpmalloc_stat_inc_alloc(heap, class_idx)                                              \</span></div>
<div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;<span class="preprocessor">    do                                                                                         \</span></div>
<div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;<span class="preprocessor">    {                                                                                          \</span></div>
<div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;<span class="preprocessor">        int32_t alloc_current = atomic_incr32(&amp;heap-&gt;size_class_use[class_idx].alloc_current); \</span></div>
<div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;<span class="preprocessor">        if (alloc_current &gt; heap-&gt;size_class_use[class_idx].alloc_peak)                        \</span></div>
<div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;<span class="preprocessor">            heap-&gt;size_class_use[class_idx].alloc_peak = alloc_current;                        \</span></div>
<div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;<span class="preprocessor">        atomic_incr32(&amp;heap-&gt;size_class_use[class_idx].alloc_total);                           \</span></div>
<div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;<span class="preprocessor">    } while (0)</span></div>
<div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;<span class="preprocessor">#define _rpmalloc_stat_inc_free(heap, class_idx)                       \</span></div>
<div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;<span class="preprocessor">    do                                                                 \</span></div>
<div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;<span class="preprocessor">    {                                                                  \</span></div>
<div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;<span class="preprocessor">        atomic_decr32(&amp;heap-&gt;size_class_use[class_idx].alloc_current); \</span></div>
<div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;<span class="preprocessor">        atomic_incr32(&amp;heap-&gt;size_class_use[class_idx].free_total);    \</span></div>
<div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;<span class="preprocessor">    } while (0)</span></div>
<div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l00249"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#ab51bbcd0d9d41ba9c6f4ad547ba77405">  249</a></span>&#160;<span class="preprocessor">#define _rpmalloc_stat_inc(counter) \</span></div>
<div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;<span class="preprocessor">    do                              \</span></div>
<div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;<span class="preprocessor">    {                               \</span></div>
<div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;<span class="preprocessor">    } while (0)</span></div>
<div class="line"><a name="l00253"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#aab22b36fb2408434cc731fb9fe6a5cec">  253</a></span>&#160;<span class="preprocessor">#define _rpmalloc_stat_dec(counter) \</span></div>
<div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;<span class="preprocessor">    do                              \</span></div>
<div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;<span class="preprocessor">    {                               \</span></div>
<div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;<span class="preprocessor">    } while (0)</span></div>
<div class="line"><a name="l00257"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a4a53d0cfdcf755d4fbbae446a055440c">  257</a></span>&#160;<span class="preprocessor">#define _rpmalloc_stat_add(counter, value) \</span></div>
<div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;<span class="preprocessor">    do                                     \</span></div>
<div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;<span class="preprocessor">    {                                      \</span></div>
<div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;<span class="preprocessor">    } while (0)</span></div>
<div class="line"><a name="l00261"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a49e532a65b873a6c3315aa769299687c">  261</a></span>&#160;<span class="preprocessor">#define _rpmalloc_stat_add64(counter, value) \</span></div>
<div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;<span class="preprocessor">    do                                       \</span></div>
<div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;<span class="preprocessor">    {                                        \</span></div>
<div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;<span class="preprocessor">    } while (0)</span></div>
<div class="line"><a name="l00265"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a599c57201987cc23a9787a745296e575">  265</a></span>&#160;<span class="preprocessor">#define _rpmalloc_stat_add_peak(counter, value, peak) \</span></div>
<div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;<span class="preprocessor">    do                                                \</span></div>
<div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;<span class="preprocessor">    {                                                 \</span></div>
<div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;<span class="preprocessor">    } while (0)</span></div>
<div class="line"><a name="l00269"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a829d3a1ca51d0ba687990a8111940c42">  269</a></span>&#160;<span class="preprocessor">#define _rpmalloc_stat_sub(counter, value) \</span></div>
<div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;<span class="preprocessor">    do                                     \</span></div>
<div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;<span class="preprocessor">    {                                      \</span></div>
<div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;<span class="preprocessor">    } while (0)</span></div>
<div class="line"><a name="l00273"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#abd4c41e806e09b0468b6db0ae56ed461">  273</a></span>&#160;<span class="preprocessor">#define _rpmalloc_stat_inc_alloc(heap, class_idx) \</span></div>
<div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;<span class="preprocessor">    do                                            \</span></div>
<div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;<span class="preprocessor">    {                                             \</span></div>
<div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;<span class="preprocessor">    } while (0)</span></div>
<div class="line"><a name="l00277"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#ab3168e56cb172bc471c410e9daaf7ca1">  277</a></span>&#160;<span class="preprocessor">#define _rpmalloc_stat_inc_free(heap, class_idx) \</span></div>
<div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;<span class="preprocessor">    do                                           \</span></div>
<div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;<span class="preprocessor">    {                                            \</span></div>
<div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;<span class="preprocessor">    } while (0)</span></div>
<div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160; </div>
<div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160; </div>
<div class="line"><a name="l00288"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a000afcda168a6fd19a9435e049508463">  288</a></span>&#160;<span class="preprocessor">#define SMALL_GRANULARITY 16</span></div>
<div class="line"><a name="l00290"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a66893939b9053e9bf8a97a5f50bc773a">  290</a></span>&#160;<span class="preprocessor">#define SMALL_GRANULARITY_SHIFT 4</span></div>
<div class="line"><a name="l00292"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#afef7a20458b75404cdbba364a751694a">  292</a></span>&#160;<span class="preprocessor">#define SMALL_CLASS_COUNT 65</span></div>
<div class="line"><a name="l00294"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#aecf578949f89fb109c5f6f527a2dc49d">  294</a></span>&#160;<span class="preprocessor">#define SMALL_SIZE_LIMIT (SMALL_GRANULARITY * (SMALL_CLASS_COUNT - 1))</span></div>
<div class="line"><a name="l00296"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a0cbe158c682e307dc9372ee5a0b5167a">  296</a></span>&#160;<span class="preprocessor">#define MEDIUM_GRANULARITY 512</span></div>
<div class="line"><a name="l00298"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a95449a66565995789e144cfc3f538261">  298</a></span>&#160;<span class="preprocessor">#define MEDIUM_GRANULARITY_SHIFT 9</span></div>
<div class="line"><a name="l00300"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a554df4bc024ffaa8328e6ef37cec5c77">  300</a></span>&#160;<span class="preprocessor">#define MEDIUM_CLASS_COUNT 61</span></div>
<div class="line"><a name="l00302"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#aa74d427b2b9955ff2d9719693d9fc80e">  302</a></span>&#160;<span class="preprocessor">#define SIZE_CLASS_COUNT (SMALL_CLASS_COUNT + MEDIUM_CLASS_COUNT)</span></div>
<div class="line"><a name="l00304"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a04406da3f5ff4e24f155c97591678ed9">  304</a></span>&#160;<span class="preprocessor">#define LARGE_CLASS_COUNT 63</span></div>
<div class="line"><a name="l00306"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#aecb085054ab2d682b41748925519c084">  306</a></span>&#160;<span class="preprocessor">#define MEDIUM_SIZE_LIMIT (SMALL_SIZE_LIMIT + (MEDIUM_GRANULARITY * MEDIUM_CLASS_COUNT))</span></div>
<div class="line"><a name="l00308"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a6866e2b7c1e8f60d6c74ea8fba6be44d">  308</a></span>&#160;<span class="preprocessor">#define LARGE_SIZE_LIMIT ((LARGE_CLASS_COUNT * _memory_span_size) - SPAN_HEADER_SIZE)</span></div>
<div class="line"><a name="l00310"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a645356809d937167848705edabde7d44">  310</a></span>&#160;<span class="preprocessor">#define SPAN_HEADER_SIZE 128</span></div>
<div class="line"><a name="l00312"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#aebbd8639c3b627f526bd557e065f1c00">  312</a></span>&#160;<span class="preprocessor">#define MAX_THREAD_SPAN_CACHE 400</span></div>
<div class="line"><a name="l00314"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a24ad9380461f94f601227da3fe3676da">  314</a></span>&#160;<span class="preprocessor">#define THREAD_SPAN_CACHE_TRANSFER 64</span></div>
<div class="line"><a name="l00316"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a51b78975d481805f29847ad91c77d6ad">  316</a></span>&#160;<span class="preprocessor">#define MAX_THREAD_SPAN_LARGE_CACHE 100</span></div>
<div class="line"><a name="l00318"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a2e9cc04738eb37814086f557943373d8">  318</a></span>&#160;<span class="preprocessor">#define THREAD_SPAN_LARGE_CACHE_TRANSFER 6</span></div>
<div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160; </div>
<div class="line"><a name="l00320"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a0e1e1399df4fbb1246dc73f3c6d14427">  320</a></span>&#160;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a0e1e1399df4fbb1246dc73f3c6d14427">_Static_assert</a>((<a class="code" href="../../df/dc0/rpmalloc_8c.html#a000afcda168a6fd19a9435e049508463">SMALL_GRANULARITY</a> &amp; (<a class="code" href="../../df/dc0/rpmalloc_8c.html#a000afcda168a6fd19a9435e049508463">SMALL_GRANULARITY</a> - 1)) == 0, <span class="stringliteral">&quot;Small granularity must be power of two&quot;</span>);</div>
<div class="line"><a name="l00321"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#afff8f93bfc8fb8919ca19a3bed8c6831">  321</a></span>&#160;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a0e1e1399df4fbb1246dc73f3c6d14427">_Static_assert</a>((<a class="code" href="../../df/dc0/rpmalloc_8c.html#a645356809d937167848705edabde7d44">SPAN_HEADER_SIZE</a> &amp; (<a class="code" href="../../df/dc0/rpmalloc_8c.html#a645356809d937167848705edabde7d44">SPAN_HEADER_SIZE</a> - 1)) == 0, <span class="stringliteral">&quot;Span header size must be power of two&quot;</span>);</div>
<div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160; </div>
<div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;<span class="preprocessor">#if ENABLE_VALIDATE_ARGS</span></div>
<div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;<span class="preprocessor">#undef MAX_ALLOC_SIZE</span></div>
<div class="line"><a name="l00326"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a6ea14607e2b19ee5aa336addd0fdde01">  326</a></span>&#160;<span class="preprocessor">#define MAX_ALLOC_SIZE (((size_t)-1) - _memory_span_size)</span></div>
<div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160; </div>
<div class="line"><a name="l00329"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#ab4225911698b67188e1538c334cfe16c">  329</a></span>&#160;<span class="preprocessor">#define pointer_offset(ptr, ofs) (void *)((char *)(ptr) + (ptrdiff_t)(ofs))</span></div>
<div class="line"><a name="l00330"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#af51a6ed47e80b1b57187f1d5be6c8b4c">  330</a></span>&#160;<span class="preprocessor">#define pointer_diff(first, second) (ptrdiff_t)((const char *)(first) - (const char *)(second))</span></div>
<div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160; </div>
<div class="line"><a name="l00332"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a95d666267d99d22454086d5fa0390bff">  332</a></span>&#160;<span class="preprocessor">#define INVALID_POINTER ((void *)((uintptr_t)-1))</span></div>
<div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160; </div>
<div class="line"><a name="l00334"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a3f84dd23eb0ef3cf54aeb6afff0618ae">  334</a></span>&#160;<span class="preprocessor">#define SIZE_CLASS_LARGE SIZE_CLASS_COUNT</span></div>
<div class="line"><a name="l00335"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a284460248778c94b6ee9ea1529299439">  335</a></span>&#160;<span class="preprocessor">#define SIZE_CLASS_HUGE ((uint32_t)-1)</span></div>
<div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160; </div>
<div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160; </div>
<div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;<span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#d9/d8a/structheap__t">heap_t</a> <a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#d9/d8a/structheap__t">heap_t</a>;</div>
<div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;<span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> <a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a>;</div>
<div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;<span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../df/dc0/rpmalloc_8c.html#af2f2ee0936896aa297771a26dec63027">span_list_t</a> <a class="code" href="../../df/dc0/rpmalloc_8c.html#af2f2ee0936896aa297771a26dec63027">span_list_t</a>;</div>
<div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;<span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../df/dc0/rpmalloc_8c.html#af801d58362e979c2a31744800624dcf9">span_active_t</a> <a class="code" href="../../df/dc0/rpmalloc_8c.html#af801d58362e979c2a31744800624dcf9">span_active_t</a>;</div>
<div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;<span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../df/dc0/rpmalloc_8c.html#d2/daa/structsize__class__t">size_class_t</a> <a class="code" href="../../df/dc0/rpmalloc_8c.html#d2/daa/structsize__class__t">size_class_t</a>;</div>
<div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;<span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../df/dc0/rpmalloc_8c.html#db/d6b/structglobal__cache__t">global_cache_t</a> <a class="code" href="../../df/dc0/rpmalloc_8c.html#db/d6b/structglobal__cache__t">global_cache_t</a>;</div>
<div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160; </div>
<div class="line"><a name="l00357"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a98c82279e204e31a5dc89b64d2c6c27c">  357</a></span>&#160;<span class="preprocessor">#define SPAN_FLAG_MASTER 1U</span></div>
<div class="line"><a name="l00359"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a2fcaea32cf5846f1f5b40a882175dbb0">  359</a></span>&#160;<span class="preprocessor">#define SPAN_FLAG_SUBSPAN 2U</span></div>
<div class="line"><a name="l00361"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#ad1094486bd3e5ee282e7a4ce7de9c7db">  361</a></span>&#160;<span class="preprocessor">#define SPAN_FLAG_ALIGNED_BLOCKS 4U</span></div>
<div class="line"><a name="l00363"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a132ac3786920f0bf24b2d2f7c73cf863">  363</a></span>&#160;<span class="preprocessor">#define SPAN_FLAG_UNMAPPED_MASTER 8U</span></div>
<div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160; </div>
<div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;<span class="preprocessor">#if ENABLE_ADAPTIVE_THREAD_CACHE || ENABLE_STATISTICS</span></div>
<div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;<span class="keyword">struct </span>span_use_t</div>
<div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;{</div>
<div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;    atomic32_t current;</div>
<div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;    atomic32_t high;</div>
<div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;<span class="preprocessor">#if ENABLE_STATISTICS</span></div>
<div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;    atomic32_t spans_deferred;</div>
<div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;    atomic32_t spans_to_global;</div>
<div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;    atomic32_t spans_from_global;</div>
<div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;    atomic32_t spans_to_cache;</div>
<div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;    atomic32_t spans_from_cache;</div>
<div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;    atomic32_t spans_to_reserved;</div>
<div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;    atomic32_t spans_from_reserved;</div>
<div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;    atomic32_t spans_map_calls;</div>
<div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;};</div>
<div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;<span class="keyword">typedef</span> <span class="keyword">struct </span>span_use_t span_use_t;</div>
<div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160; </div>
<div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;<span class="preprocessor">#if ENABLE_STATISTICS</span></div>
<div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;<span class="keyword">struct </span>size_class_use_t</div>
<div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;{</div>
<div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;    atomic32_t alloc_current;</div>
<div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;    <a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#a0c18914b3041c2f583aba76f418399c2">int32_t</a> alloc_peak;</div>
<div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;    atomic32_t alloc_total;</div>
<div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;    atomic32_t free_total;</div>
<div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;    atomic32_t spans_current;</div>
<div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;    <a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#a0c18914b3041c2f583aba76f418399c2">int32_t</a> spans_peak;</div>
<div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;    atomic32_t spans_to_cache;</div>
<div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;    atomic32_t spans_from_cache;</div>
<div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;    atomic32_t spans_from_reserved;</div>
<div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;    atomic32_t spans_map_calls;</div>
<div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;    <a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#a0c18914b3041c2f583aba76f418399c2">int32_t</a> unused;</div>
<div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;};</div>
<div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;<span class="keyword">typedef</span> <span class="keyword">struct </span>size_class_use_t size_class_use_t;</div>
<div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160; </div>
<div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;<span class="comment">// A span can either represent a single span of memory pages with size declared by span_map_count configuration variable,</span></div>
<div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;<span class="comment">// or a set of spans in a continuous region, a super span. Any reference to the term &quot;span&quot; usually refers to both a single</span></div>
<div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;<span class="comment">// span or a super span. A super span can further be divided into multiple spans (or this, super spans), where the first</span></div>
<div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;<span class="comment">// (super)span is the master and subsequent (super)spans are subspans. The master span keeps track of how many subspans</span></div>
<div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;<span class="comment">// that are still alive and mapped in virtual memory, and once all subspans and master have been unmapped the entire</span></div>
<div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;<span class="comment">// superspan region is released and unmapped (on Windows for example, the entire superspan range has to be released</span></div>
<div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;<span class="comment">// in the same call to release the virtual memory range, but individual subranges can be decommitted individually</span></div>
<div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;<span class="comment">// to reduce physical memory use).</span></div>
<div class="line"><a name="l00430"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html">  430</a></span>&#160;<span class="keyword">struct </span><a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a></div>
<div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;{</div>
<div class="line"><a name="l00433"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a85527ad364915bcb39b7d421524d0bd6">  433</a></span>&#160;    <span class="keywordtype">void</span> *<a class="code" href="../../df/dc0/rpmalloc_8c.html#a85527ad364915bcb39b7d421524d0bd6">free_list</a>;</div>
<div class="line"><a name="l00435"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a7ee7892ce3c5d8342af193f1824a5098">  435</a></span>&#160;    <a class="code" href="../../dd/ddd/arithmetic__operations_8c.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a> <a class="code" href="../../df/dc0/rpmalloc_8c.html#a7ee7892ce3c5d8342af193f1824a5098">block_count</a>;</div>
<div class="line"><a name="l00437"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a5a977febdd2e9ae15bcf66f83d0cf817">  437</a></span>&#160;    <a class="code" href="../../dd/ddd/arithmetic__operations_8c.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a> <a class="code" href="../../df/dc0/rpmalloc_8c.html#a5a977febdd2e9ae15bcf66f83d0cf817">size_class</a>;</div>
<div class="line"><a name="l00439"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#af093d9cb1719d72c20f96a9b467590f5">  439</a></span>&#160;    <a class="code" href="../../dd/ddd/arithmetic__operations_8c.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a> <a class="code" href="../../df/dc0/rpmalloc_8c.html#af093d9cb1719d72c20f96a9b467590f5">free_list_limit</a>;</div>
<div class="line"><a name="l00441"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#abf4fa6f8f0e7baff0d6a7a96df58bcca">  441</a></span>&#160;    <a class="code" href="../../dd/ddd/arithmetic__operations_8c.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a> <a class="code" href="../../df/dc0/rpmalloc_8c.html#abf4fa6f8f0e7baff0d6a7a96df58bcca">used_count</a>;</div>
<div class="line"><a name="l00443"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a22b0340927d02f0c7c4486f01c31358e">  443</a></span>&#160;    atomicptr_t <a class="code" href="../../df/dc0/rpmalloc_8c.html#a22b0340927d02f0c7c4486f01c31358e">free_list_deferred</a>;</div>
<div class="line"><a name="l00445"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#ad842dbc76a30fb5beee77a2d773a3e91">  445</a></span>&#160;    <a class="code" href="../../dd/ddd/arithmetic__operations_8c.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a> <a class="code" href="../../df/dc0/rpmalloc_8c.html#ad842dbc76a30fb5beee77a2d773a3e91">list_size</a>;</div>
<div class="line"><a name="l00447"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a97df83853dc6ddf7e0114691b15edb49">  447</a></span>&#160;    <a class="code" href="../../dd/ddd/arithmetic__operations_8c.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a> <a class="code" href="../../df/dc0/rpmalloc_8c.html#a97df83853dc6ddf7e0114691b15edb49">block_size</a>;</div>
<div class="line"><a name="l00449"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a4de89d484559557bb639a2703c750b17">  449</a></span>&#160;    <a class="code" href="../../dd/ddd/arithmetic__operations_8c.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a> <a class="code" href="../../df/dc0/rpmalloc_8c.html#a4de89d484559557bb639a2703c750b17">flags</a>;</div>
<div class="line"><a name="l00451"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#ae77d9a2cdd2a2fd46e3b27739d6c88cc">  451</a></span>&#160;    <a class="code" href="../../dd/ddd/arithmetic__operations_8c.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a> <a class="code" href="../../df/dc0/rpmalloc_8c.html#ae77d9a2cdd2a2fd46e3b27739d6c88cc">span_count</a>;</div>
<div class="line"><a name="l00453"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#af32dc4254a995d8ba3ab99376c9ad4d0">  453</a></span>&#160;    <a class="code" href="../../dd/ddd/arithmetic__operations_8c.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a> <a class="code" href="../../df/dc0/rpmalloc_8c.html#af32dc4254a995d8ba3ab99376c9ad4d0">total_spans</a>;</div>
<div class="line"><a name="l00455"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a07d2ba73260e7e5dbe98c76436888c5f">  455</a></span>&#160;    <a class="code" href="../../dd/ddd/arithmetic__operations_8c.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a> <a class="code" href="../../df/dc0/rpmalloc_8c.html#a07d2ba73260e7e5dbe98c76436888c5f">offset_from_master</a>;</div>
<div class="line"><a name="l00457"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a4aecbd1cbb36425fddd53125ea1a84c7">  457</a></span>&#160;    atomic32_t <a class="code" href="../../df/dc0/rpmalloc_8c.html#a4aecbd1cbb36425fddd53125ea1a84c7">remaining_spans</a>;</div>
<div class="line"><a name="l00459"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a13753de75bc52a5b8a1a9532083c9ba4">  459</a></span>&#160;    <a class="code" href="../../dd/ddd/arithmetic__operations_8c.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a> <a class="code" href="../../df/dc0/rpmalloc_8c.html#a13753de75bc52a5b8a1a9532083c9ba4">align_offset</a>;</div>
<div class="line"><a name="l00461"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a345270ce5d1e5e112b45cfde43f37da0">  461</a></span>&#160;    <a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#d9/d8a/structheap__t">heap_t</a> *<a class="code" href="../../df/dc0/rpmalloc_8c.html#a345270ce5d1e5e112b45cfde43f37da0">heap</a>;</div>
<div class="line"><a name="l00463"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#ac62e0e77eb38ebff4443eb5db3ccd45c">  463</a></span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *<a class="code" href="../../df/dc0/rpmalloc_8c.html#ac62e0e77eb38ebff4443eb5db3ccd45c">next</a>;</div>
<div class="line"><a name="l00465"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a386f776cc556d33534161ece5083e4de">  465</a></span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *<a class="code" href="../../df/dc0/rpmalloc_8c.html#a386f776cc556d33534161ece5083e4de">prev</a>;</div>
<div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;};</div>
<div class="line"><a name="l00467"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#af5d3cdaa825dc71b9d3f7adf1b4062fa">  467</a></span>&#160;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a0e1e1399df4fbb1246dc73f3c6d14427">_Static_assert</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a>) &lt;= <a class="code" href="../../df/dc0/rpmalloc_8c.html#a645356809d937167848705edabde7d44">SPAN_HEADER_SIZE</a>, <span class="stringliteral">&quot;span size mismatch&quot;</span>);</div>
<div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160; </div>
<div class="line"><a name="l00469"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html">  469</a></span>&#160;<span class="keyword">struct </span><a class="code" href="../../df/dc0/rpmalloc_8c.html#da/d15/structspan__cache__t">span_cache_t</a></div>
<div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;{</div>
<div class="line"><a name="l00471"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a894a66f329862f01de7619aee1954d19">  471</a></span>&#160;    <span class="keywordtype">size_t</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#a894a66f329862f01de7619aee1954d19">count</a>;</div>
<div class="line"><a name="l00472"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a8cc6a9b0d6d8d6bf8367bca0101b1ae3">  472</a></span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *<a class="code" href="../../df/dc0/rpmalloc_8c.html#a8cc6a9b0d6d8d6bf8367bca0101b1ae3">span</a>[<a class="code" href="../../df/dc0/rpmalloc_8c.html#aebbd8639c3b627f526bd557e065f1c00">MAX_THREAD_SPAN_CACHE</a>];</div>
<div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;};</div>
<div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;<span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../df/dc0/rpmalloc_8c.html#da/d15/structspan__cache__t">span_cache_t</a> <a class="code" href="../../df/dc0/rpmalloc_8c.html#da/d15/structspan__cache__t">span_cache_t</a>;</div>
<div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160; </div>
<div class="line"><a name="l00476"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html">  476</a></span>&#160;<span class="keyword">struct </span><a class="code" href="../../df/dc0/rpmalloc_8c.html#d5/dec/structspan__large__cache__t">span_large_cache_t</a></div>
<div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;{</div>
<div class="line"><a name="l00478"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a07da73cfe1c11642973a6eb1386a3a1c">  478</a></span>&#160;    <span class="keywordtype">size_t</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#a07da73cfe1c11642973a6eb1386a3a1c">count</a>;</div>
<div class="line"><a name="l00479"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a77eff1faca249ec6ae27881769f7d979">  479</a></span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *<a class="code" href="../../df/dc0/rpmalloc_8c.html#a77eff1faca249ec6ae27881769f7d979">span</a>[<a class="code" href="../../df/dc0/rpmalloc_8c.html#a51b78975d481805f29847ad91c77d6ad">MAX_THREAD_SPAN_LARGE_CACHE</a>];</div>
<div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;};</div>
<div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;<span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../df/dc0/rpmalloc_8c.html#d5/dec/structspan__large__cache__t">span_large_cache_t</a> <a class="code" href="../../df/dc0/rpmalloc_8c.html#d5/dec/structspan__large__cache__t">span_large_cache_t</a>;</div>
<div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160; </div>
<div class="line"><a name="l00483"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html">  483</a></span>&#160;<span class="keyword">struct </span><a class="code" href="../../df/dc0/rpmalloc_8c.html#d3/dad/structheap__size__class__t">heap_size_class_t</a></div>
<div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;{</div>
<div class="line"><a name="l00486"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#ac411b0f198d4e31569fc30ca2c174f65">  486</a></span>&#160;    <span class="keywordtype">void</span> *<a class="code" href="../../df/dc0/rpmalloc_8c.html#ac411b0f198d4e31569fc30ca2c174f65">free_list</a>;</div>
<div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;    <span class="comment">//  Previous span pointer in head points to tail span of list.</span></div>
<div class="line"><a name="l00489"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#af829c49d9fc4d933c14113ba0d694e7c">  489</a></span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *<a class="code" href="../../df/dc0/rpmalloc_8c.html#af829c49d9fc4d933c14113ba0d694e7c">partial_span</a>;</div>
<div class="line"><a name="l00491"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a72cb3beffa763418cb7c8e89ff257b8e">  491</a></span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *<a class="code" href="../../df/dc0/rpmalloc_8c.html#a72cb3beffa763418cb7c8e89ff257b8e">cache</a>;</div>
<div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;};</div>
<div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;<span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../df/dc0/rpmalloc_8c.html#d3/dad/structheap__size__class__t">heap_size_class_t</a> <a class="code" href="../../df/dc0/rpmalloc_8c.html#d3/dad/structheap__size__class__t">heap_size_class_t</a>;</div>
<div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160; </div>
<div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;<span class="comment">// Control structure for a heap, either a thread heap or a first class heap if enabled</span></div>
<div class="line"><a name="l00496"></a><span class="lineno"><a class="line" href="../../d1/d7e/rpmalloc__compat_8cpp.html">  496</a></span>&#160;<span class="keyword">struct </span><a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#d9/d8a/structheap__t">heap_t</a></div>
<div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;{</div>
<div class="line"><a name="l00499"></a><span class="lineno"><a class="line" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a436e67271364d132c12f2f5f0d4c79ef">  499</a></span>&#160;    <a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#a4788399d1d0b37ccf098a7da82254808">uintptr_t</a> <a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a436e67271364d132c12f2f5f0d4c79ef">owner_thread</a>;</div>
<div class="line"><a name="l00501"></a><span class="lineno"><a class="line" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a70f9a96b9071ccb6642894f5a7f56432">  501</a></span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#d3/dad/structheap__size__class__t">heap_size_class_t</a> <a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a70f9a96b9071ccb6642894f5a7f56432">size_class</a>[<a class="code" href="../../df/dc0/rpmalloc_8c.html#aa74d427b2b9955ff2d9719693d9fc80e">SIZE_CLASS_COUNT</a>];</div>
<div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;<span class="preprocessor">#if ENABLE_THREAD_CACHE</span></div>
<div class="line"><a name="l00504"></a><span class="lineno"><a class="line" href="../../d1/d7e/rpmalloc__compat_8cpp.html#ae112aace519bbe14edb9127cefb59705">  504</a></span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#da/d15/structspan__cache__t">span_cache_t</a> <a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#ae112aace519bbe14edb9127cefb59705">span_cache</a>;</div>
<div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00507"></a><span class="lineno"><a class="line" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a354c0beb35fd982bc4dbd3783b2dd1ff">  507</a></span>&#160;    atomicptr_t <a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a354c0beb35fd982bc4dbd3783b2dd1ff">span_free_deferred</a>;</div>
<div class="line"><a name="l00509"></a><span class="lineno"><a class="line" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a6aa789c3cdf7e70df144c248d18c5f4c">  509</a></span>&#160;    <span class="keywordtype">size_t</span> <a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a6aa789c3cdf7e70df144c248d18c5f4c">full_span_count</a>;</div>
<div class="line"><a name="l00511"></a><span class="lineno"><a class="line" href="../../d1/d7e/rpmalloc__compat_8cpp.html#aa549da79e540bdd3e963e294a39f64cf">  511</a></span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#aa549da79e540bdd3e963e294a39f64cf">span_reserve</a>;</div>
<div class="line"><a name="l00513"></a><span class="lineno"><a class="line" href="../../d1/d7e/rpmalloc__compat_8cpp.html#aa6719c6b21d6c30ce96e404a63cc4bae">  513</a></span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#aa6719c6b21d6c30ce96e404a63cc4bae">span_reserve_master</a>;</div>
<div class="line"><a name="l00515"></a><span class="lineno"><a class="line" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a8d5b27011e1ab5140090f90a75584329">  515</a></span>&#160;    <a class="code" href="../../dd/ddd/arithmetic__operations_8c.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a> <a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a8d5b27011e1ab5140090f90a75584329">spans_reserved</a>;</div>
<div class="line"><a name="l00517"></a><span class="lineno"><a class="line" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a59fb66e831ef1e0d56d826b1851576eb">  517</a></span>&#160;    atomic32_t <a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a59fb66e831ef1e0d56d826b1851576eb">child_count</a>;</div>
<div class="line"><a name="l00519"></a><span class="lineno"><a class="line" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a74b47a0eacf313fe421d32379a2b942c">  519</a></span>&#160;    <a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#d9/d8a/structheap__t">heap_t</a> *<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a74b47a0eacf313fe421d32379a2b942c">next_heap</a>;</div>
<div class="line"><a name="l00521"></a><span class="lineno"><a class="line" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a87e83453c93d1e6de70f6a45044e510d">  521</a></span>&#160;    <a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#d9/d8a/structheap__t">heap_t</a> *<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a87e83453c93d1e6de70f6a45044e510d">next_orphan</a>;</div>
<div class="line"><a name="l00523"></a><span class="lineno"><a class="line" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a2342224142317f85fca91614fc973131">  523</a></span>&#160;    <a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#a0c18914b3041c2f583aba76f418399c2">int32_t</a> <a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a2342224142317f85fca91614fc973131">id</a>;</div>
<div class="line"><a name="l00525"></a><span class="lineno"><a class="line" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a13ccab5430ace95c471aacf1fab0fcd6">  525</a></span>&#160;    <span class="keywordtype">int</span> <a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a13ccab5430ace95c471aacf1fab0fcd6">finalize</a>;</div>
<div class="line"><a name="l00527"></a><span class="lineno"><a class="line" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a348c1835d21f0af4a3776f96bdba64fb">  527</a></span>&#160;    <a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#d9/d8a/structheap__t">heap_t</a> *<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a348c1835d21f0af4a3776f96bdba64fb">master_heap</a>;</div>
<div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;<span class="preprocessor">#if ENABLE_THREAD_CACHE</span></div>
<div class="line"><a name="l00530"></a><span class="lineno"><a class="line" href="../../d1/d7e/rpmalloc__compat_8cpp.html#aea02bb1ed60acc428d5a2d2db2cd9a7b">  530</a></span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#d5/dec/structspan__large__cache__t">span_large_cache_t</a> <a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#aea02bb1ed60acc428d5a2d2db2cd9a7b">span_large_cache</a>[<a class="code" href="../../df/dc0/rpmalloc_8c.html#a04406da3f5ff4e24f155c97591678ed9">LARGE_CLASS_COUNT</a> - 1];</div>
<div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;<span class="preprocessor">#if RPMALLOC_FIRST_CLASS_HEAPS</span></div>
<div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;    <span class="comment">//  Previous span pointer in head points to tail span of list.</span></div>
<div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *full_span[<a class="code" href="../../df/dc0/rpmalloc_8c.html#aa74d427b2b9955ff2d9719693d9fc80e">SIZE_CLASS_COUNT</a>];</div>
<div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *large_huge_span;</div>
<div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;<span class="preprocessor">#if ENABLE_ADAPTIVE_THREAD_CACHE || ENABLE_STATISTICS</span></div>
<div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;    span_use_t span_use[<a class="code" href="../../df/dc0/rpmalloc_8c.html#a04406da3f5ff4e24f155c97591678ed9">LARGE_CLASS_COUNT</a>];</div>
<div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;<span class="preprocessor">#if ENABLE_STATISTICS</span></div>
<div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;    size_class_use_t size_class_use[<a class="code" href="../../df/dc0/rpmalloc_8c.html#aa74d427b2b9955ff2d9719693d9fc80e">SIZE_CLASS_COUNT</a> + 1];</div>
<div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;    atomic64_t thread_to_global;</div>
<div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;    atomic64_t global_to_thread;</div>
<div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;};</div>
<div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160; </div>
<div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;<span class="comment">/* Keep in sync with heap_t inside rpmalloc_compat.cpp */</span></div>
<div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;<a class="code" href="../../da/d46/Kernel_2include_2interface_2fs_8h.html#a8a8f6bdc98a851b29a69b484cb1bad98">static_assert</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#d9/d8a/structheap__t">heap_t</a>) == 56408, <span class="stringliteral">&quot;heap_t size mismatch&quot;</span>);</div>
<div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160; </div>
<div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;<span class="comment">// Size class for defining a block size bucket</span></div>
<div class="line"><a name="l00557"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html">  557</a></span>&#160;<span class="keyword">struct </span><a class="code" href="../../df/dc0/rpmalloc_8c.html#d2/daa/structsize__class__t">size_class_t</a></div>
<div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;{</div>
<div class="line"><a name="l00560"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a007fc7dd52ba1f95d9a6ce88f47a614b">  560</a></span>&#160;    <a class="code" href="../../dd/ddd/arithmetic__operations_8c.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a> <a class="code" href="../../df/dc0/rpmalloc_8c.html#a007fc7dd52ba1f95d9a6ce88f47a614b">block_size</a>;</div>
<div class="line"><a name="l00562"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#aeded978bd21c13b71d9b0310b5bb09ec">  562</a></span>&#160;    <a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#a5debae8b2a1ec20a6694c0c443ee399e">uint16_t</a> <a class="code" href="../../df/dc0/rpmalloc_8c.html#aeded978bd21c13b71d9b0310b5bb09ec">block_count</a>;</div>
<div class="line"><a name="l00564"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a7524fc81b83a0b54ef5ec3fb4563b69d">  564</a></span>&#160;    <a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#a5debae8b2a1ec20a6694c0c443ee399e">uint16_t</a> <a class="code" href="../../df/dc0/rpmalloc_8c.html#a7524fc81b83a0b54ef5ec3fb4563b69d">class_idx</a>;</div>
<div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;};</div>
<div class="line"><a name="l00566"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a3e9ea498b766939621d2fb398ed0a620">  566</a></span>&#160;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a0e1e1399df4fbb1246dc73f3c6d14427">_Static_assert</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../df/dc0/rpmalloc_8c.html#d2/daa/structsize__class__t">size_class_t</a>) == 8, <span class="stringliteral">&quot;Size class size mismatch&quot;</span>);</div>
<div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160; </div>
<div class="line"><a name="l00568"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html">  568</a></span>&#160;<span class="keyword">struct </span><a class="code" href="../../df/dc0/rpmalloc_8c.html#db/d6b/structglobal__cache__t">global_cache_t</a></div>
<div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;{</div>
<div class="line"><a name="l00571"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a9c0563645d0d1fd53044a9c00dad6dc0">  571</a></span>&#160;    atomic32_t <a class="code" href="../../df/dc0/rpmalloc_8c.html#a9c0563645d0d1fd53044a9c00dad6dc0">lock</a>;</div>
<div class="line"><a name="l00573"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a440c6f31099f3836f7beb5e47d14fb2d">  573</a></span>&#160;    <a class="code" href="../../dd/ddd/arithmetic__operations_8c.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a> <a class="code" href="../../df/dc0/rpmalloc_8c.html#a440c6f31099f3836f7beb5e47d14fb2d">count</a>;</div>
<div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;<span class="preprocessor">#if ENABLE_STATISTICS</span></div>
<div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;    <span class="keywordtype">size_t</span> insert_count;</div>
<div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;    <span class="keywordtype">size_t</span> extract_count;</div>
<div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00581"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a9d6636075b348ce9cbd7e59e45d097c7">  581</a></span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *<a class="code" href="../../df/dc0/rpmalloc_8c.html#a9d6636075b348ce9cbd7e59e45d097c7">span</a>[<a class="code" href="../../df/dc0/rpmalloc_8c.html#aec9c1ea6434b5703d7b6e01cfffd1261">GLOBAL_CACHE_MULTIPLIER</a> * <a class="code" href="../../df/dc0/rpmalloc_8c.html#aebbd8639c3b627f526bd557e065f1c00">MAX_THREAD_SPAN_CACHE</a>];</div>
<div class="line"><a name="l00583"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a8bb140aee00ffae527f7c0706d98c3d1">  583</a></span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *<a class="code" href="../../df/dc0/rpmalloc_8c.html#a8bb140aee00ffae527f7c0706d98c3d1">overflow</a>;</div>
<div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160;};</div>
<div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160; </div>
<div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160; </div>
<div class="line"><a name="l00593"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a04a025a8c2529bc60cb95c78d3948c52">  593</a></span>&#160;<span class="preprocessor">#define _memory_default_span_size (64 * 1024)</span></div>
<div class="line"><a name="l00594"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a3dedf1d71cda4a8f3d1f372934ddad30">  594</a></span>&#160;<span class="preprocessor">#define _memory_default_span_size_shift 16</span></div>
<div class="line"><a name="l00595"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#ada0a343b3498bb882ebd7e0c3caa0935">  595</a></span>&#160;<span class="preprocessor">#define _memory_default_span_mask (~((uintptr_t)(_memory_span_size - 1)))</span></div>
<div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160; </div>
<div class="line"><a name="l00598"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a6414f61e9643ce358f1a33e6a2c6aeaa">  598</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#a6414f61e9643ce358f1a33e6a2c6aeaa">_rpmalloc_initialized</a>;</div>
<div class="line"><a name="l00600"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#aacc7bcb924cab5e38c3fe65c5d0b4ab0">  600</a></span>&#160;<span class="keyword">static</span> <a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#a4788399d1d0b37ccf098a7da82254808">uintptr_t</a> <a class="code" href="../../df/dc0/rpmalloc_8c.html#aacc7bcb924cab5e38c3fe65c5d0b4ab0">_rpmalloc_main_thread_id</a>;</div>
<div class="line"><a name="l00602"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#ae1f1297fe3d143e41deac95ee7a7f8d4">  602</a></span>&#160;<span class="keyword">static</span> <a class="code" href="../../df/d42/structrpmalloc__config__t.html">rpmalloc_config_t</a> <a class="code" href="../../df/dc0/rpmalloc_8c.html#ae1f1297fe3d143e41deac95ee7a7f8d4">_memory_config</a>;</div>
<div class="line"><a name="l00604"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">  604</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">size_t</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a>;</div>
<div class="line"><a name="l00606"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a9d7ec974d864302bb4f8516859c4b212">  606</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">size_t</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#a9d7ec974d864302bb4f8516859c4b212">_memory_page_size_shift</a>;</div>
<div class="line"><a name="l00608"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a1e29d8d18139babda354d5d92d46ca02">  608</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">size_t</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#a1e29d8d18139babda354d5d92d46ca02">_memory_map_granularity</a>;</div>
<div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;<span class="preprocessor">#if RPMALLOC_CONFIGURABLE</span></div>
<div class="line"><a name="l00611"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a9fefa5277fefa0c58f69d5b86d679ccb">  611</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">size_t</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#a9fefa5277fefa0c58f69d5b86d679ccb">_memory_span_size</a>;</div>
<div class="line"><a name="l00613"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#adb538a1ad8a86db6b92895d9ebf6d907">  613</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">size_t</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#adb538a1ad8a86db6b92895d9ebf6d907">_memory_span_size_shift</a>;</div>
<div class="line"><a name="l00615"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#ae7b97ba12e15609b6d63926ed2e30238">  615</a></span>&#160;<span class="keyword">static</span> <a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#a4788399d1d0b37ccf098a7da82254808">uintptr_t</a> <a class="code" href="../../df/dc0/rpmalloc_8c.html#ae7b97ba12e15609b6d63926ed2e30238">_memory_span_mask</a>;</div>
<div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160;<span class="preprocessor">#define _memory_span_size _memory_default_span_size</span></div>
<div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160;<span class="preprocessor">#define _memory_span_size_shift _memory_default_span_size_shift</span></div>
<div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;<span class="preprocessor">#define _memory_span_mask _memory_default_span_mask</span></div>
<div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00623"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a3d9a7f69f3e3cc2dc7ea18d8c58b274c">  623</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">size_t</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#a3d9a7f69f3e3cc2dc7ea18d8c58b274c">_memory_span_map_count</a>;</div>
<div class="line"><a name="l00625"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#ada12637cd22672d5ad52ceba482b7f5c">  625</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">size_t</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#ada12637cd22672d5ad52ceba482b7f5c">_memory_heap_reserve_count</a>;</div>
<div class="line"><a name="l00627"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a33cddb08b9ee0f969cc82dbf9cddb947">  627</a></span>&#160;<span class="keyword">static</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#d2/daa/structsize__class__t">size_class_t</a> <a class="code" href="../../df/dc0/rpmalloc_8c.html#a33cddb08b9ee0f969cc82dbf9cddb947">_memory_size_class</a>[<a class="code" href="../../df/dc0/rpmalloc_8c.html#aa74d427b2b9955ff2d9719693d9fc80e">SIZE_CLASS_COUNT</a>];</div>
<div class="line"><a name="l00629"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a9641beb0030ad56b2df025775823b2af">  629</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">size_t</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#a9641beb0030ad56b2df025775823b2af">_memory_medium_size_limit</a>;</div>
<div class="line"><a name="l00631"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#af42cdefbf9addf1c268ba19e63c60f29">  631</a></span>&#160;<span class="keyword">static</span> atomic32_t <a class="code" href="../../df/dc0/rpmalloc_8c.html#af42cdefbf9addf1c268ba19e63c60f29">_memory_heap_id</a>;</div>
<div class="line"><a name="l00633"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a4cdf64413eaa3e80f8a1dfe158bd2525">  633</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#a4cdf64413eaa3e80f8a1dfe158bd2525">_memory_huge_pages</a>;</div>
<div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;<span class="preprocessor">#if ENABLE_GLOBAL_CACHE</span></div>
<div class="line"><a name="l00636"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#ad7af40ab0c9174515ec06efb45ebdd73">  636</a></span>&#160;<span class="keyword">static</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#db/d6b/structglobal__cache__t">global_cache_t</a> <a class="code" href="../../df/dc0/rpmalloc_8c.html#ad7af40ab0c9174515ec06efb45ebdd73">_memory_span_cache</a>[<a class="code" href="../../df/dc0/rpmalloc_8c.html#a04406da3f5ff4e24f155c97591678ed9">LARGE_CLASS_COUNT</a>];</div>
<div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00639"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a411d5d6c063a099c1a08fa853851b764">  639</a></span>&#160;<span class="keyword">static</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *<a class="code" href="../../df/dc0/rpmalloc_8c.html#a411d5d6c063a099c1a08fa853851b764">_memory_global_reserve</a>;</div>
<div class="line"><a name="l00641"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a19d785146ca5053c2da69ad1ec4de94c">  641</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">size_t</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#a19d785146ca5053c2da69ad1ec4de94c">_memory_global_reserve_count</a>;</div>
<div class="line"><a name="l00643"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a1d5126b78d2bb31fe3476abcd07dd801">  643</a></span>&#160;<span class="keyword">static</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *<a class="code" href="../../df/dc0/rpmalloc_8c.html#a1d5126b78d2bb31fe3476abcd07dd801">_memory_global_reserve_master</a>;</div>
<div class="line"><a name="l00645"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a3e39052a111a2e243645494f1d6ca439">  645</a></span>&#160;<span class="keyword">static</span> <a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#d9/d8a/structheap__t">heap_t</a> *<a class="code" href="../../df/dc0/rpmalloc_8c.html#a3e39052a111a2e243645494f1d6ca439">_memory_heaps</a>[<a class="code" href="../../df/dc0/rpmalloc_8c.html#ac7e4a352a230ef04d4372db43a454b7f">HEAP_ARRAY_SIZE</a>];</div>
<div class="line"><a name="l00647"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a1cb428169705ddd63fb35383132dbc40">  647</a></span>&#160;<span class="keyword">static</span> atomic32_t <a class="code" href="../../df/dc0/rpmalloc_8c.html#a1cb428169705ddd63fb35383132dbc40">_memory_global_lock</a>;</div>
<div class="line"><a name="l00649"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#ae3a524405e2a853229e95546df284be2">  649</a></span>&#160;<span class="keyword">static</span> <a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#d9/d8a/structheap__t">heap_t</a> *<a class="code" href="../../df/dc0/rpmalloc_8c.html#ae3a524405e2a853229e95546df284be2">_memory_orphan_heaps</a>;</div>
<div class="line"><a name="l00650"></a><span class="lineno">  650</span>&#160;<span class="preprocessor">#if RPMALLOC_FIRST_CLASS_HEAPS</span></div>
<div class="line"><a name="l00652"></a><span class="lineno">  652</span>&#160;<span class="keyword">static</span> <a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#d9/d8a/structheap__t">heap_t</a> *_memory_first_class_orphan_heaps;</div>
<div class="line"><a name="l00653"></a><span class="lineno">  653</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00654"></a><span class="lineno">  654</span>&#160;<span class="preprocessor">#if ENABLE_STATISTICS</span></div>
<div class="line"><a name="l00656"></a><span class="lineno">  656</span>&#160;<span class="keyword">static</span> atomic64_t _allocation_counter;</div>
<div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160;<span class="keyword">static</span> atomic64_t _deallocation_counter;</div>
<div class="line"><a name="l00660"></a><span class="lineno">  660</span>&#160;<span class="keyword">static</span> atomic32_t _memory_active_heaps;</div>
<div class="line"><a name="l00662"></a><span class="lineno">  662</span>&#160;<span class="keyword">static</span> atomic32_t _mapped_pages;</div>
<div class="line"><a name="l00664"></a><span class="lineno">  664</span>&#160;<span class="keyword">static</span> <a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#a0c18914b3041c2f583aba76f418399c2">int32_t</a> _mapped_pages_peak;</div>
<div class="line"><a name="l00666"></a><span class="lineno">  666</span>&#160;<span class="keyword">static</span> atomic32_t _master_spans;</div>
<div class="line"><a name="l00668"></a><span class="lineno">  668</span>&#160;<span class="keyword">static</span> atomic32_t _unmapped_master_spans;</div>
<div class="line"><a name="l00670"></a><span class="lineno">  670</span>&#160;<span class="keyword">static</span> atomic32_t _mapped_total;</div>
<div class="line"><a name="l00672"></a><span class="lineno">  672</span>&#160;<span class="keyword">static</span> atomic32_t _unmapped_total;</div>
<div class="line"><a name="l00674"></a><span class="lineno">  674</span>&#160;<span class="keyword">static</span> atomic32_t _mapped_pages_os;</div>
<div class="line"><a name="l00676"></a><span class="lineno">  676</span>&#160;<span class="keyword">static</span> atomic32_t _huge_pages_current;</div>
<div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160;<span class="keyword">static</span> <a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#a0c18914b3041c2f583aba76f418399c2">int32_t</a> _huge_pages_peak;</div>
<div class="line"><a name="l00679"></a><span class="lineno">  679</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00680"></a><span class="lineno">  680</span>&#160; </div>
<div class="line"><a name="l00686"></a><span class="lineno">  686</span>&#160; </div>
<div class="line"><a name="l00688"></a><span class="lineno">  688</span>&#160;<span class="preprocessor">#if ((defined(__APPLE__) || defined(__HAIKU__)) &amp;&amp; ENABLE_PRELOAD) || defined(__TINYC__)</span></div>
<div class="line"><a name="l00689"></a><span class="lineno">  689</span>&#160;<span class="keyword">static</span> pthread_key_t <a class="code" href="../../df/dc0/rpmalloc_8c.html#a0c3d121b2c7e431b109863973cff023c">_memory_thread_heap</a>;</div>
<div class="line"><a name="l00690"></a><span class="lineno">  690</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l00691"></a><span class="lineno">  691</span>&#160;<span class="preprocessor">#ifdef _MSC_VER</span></div>
<div class="line"><a name="l00692"></a><span class="lineno">  692</span>&#160;<span class="preprocessor">#define _Thread_local __declspec(thread)</span></div>
<div class="line"><a name="l00693"></a><span class="lineno">  693</span>&#160;<span class="preprocessor">#define TLS_MODEL</span></div>
<div class="line"><a name="l00694"></a><span class="lineno">  694</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l00695"></a><span class="lineno">  695</span>&#160;<span class="preprocessor">#ifndef __HAIKU__</span></div>
<div class="line"><a name="l00696"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a3cf2ef5bd78a81c297328a5534f0ddf4">  696</a></span>&#160;<span class="preprocessor">#define TLS_MODEL __attribute__((tls_model(&quot;initial-exec&quot;</span>)))</div>
<div class="line"><a name="l00697"></a><span class="lineno">  697</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l00698"></a><span class="lineno">  698</span>&#160;<span class="preprocessor">#define TLS_MODEL</span></div>
<div class="line"><a name="l00699"></a><span class="lineno">  699</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00700"></a><span class="lineno">  700</span>&#160;<span class="preprocessor">#if !defined(__clang__) &amp;&amp; defined(__GNUC__)</span></div>
<div class="line"><a name="l00701"></a><span class="lineno">  701</span>&#160;<span class="preprocessor">#define _Thread_local __thread</span></div>
<div class="line"><a name="l00702"></a><span class="lineno">  702</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00703"></a><span class="lineno">  703</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00704"></a><span class="lineno">  704</span>&#160;<span class="comment">// static _Thread_local heap_t *_memory_thread_heap TLS_MODEL;</span></div>
<div class="line"><a name="l00705"></a><span class="lineno">  705</span>&#160;<span class="keyword">extern</span> <a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#d9/d8a/structheap__t">heap_t</a> **<a class="code" href="../../df/dc0/rpmalloc_8c.html#a1e97049d3ae6097ed1f1b258eaabf2ee">__memory_thread_heap</a>(<span class="keywordtype">void</span>);</div>
<div class="line"><a name="l00706"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a0c3d121b2c7e431b109863973cff023c">  706</a></span>&#160;<span class="preprocessor">#define _memory_thread_heap (*__memory_thread_heap())</span></div>
<div class="line"><a name="l00707"></a><span class="lineno">  707</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00708"></a><span class="lineno">  708</span>&#160; </div>
<div class="line"><a name="l00709"></a><span class="lineno">  709</span>&#160;<span class="keyword">static</span> <span class="keyword">inline</span> <a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#d9/d8a/structheap__t">heap_t</a> *</div>
<div class="line"><a name="l00710"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#af7213260e19fbad385988302247150d4">  710</a></span>&#160;<a class="code" href="../../df/dc0/rpmalloc_8c.html#af7213260e19fbad385988302247150d4">get_thread_heap_raw</a>(<span class="keywordtype">void</span>)</div>
<div class="line"><a name="l00711"></a><span class="lineno">  711</span>&#160;{</div>
<div class="line"><a name="l00712"></a><span class="lineno">  712</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#a0c3d121b2c7e431b109863973cff023c">_memory_thread_heap</a>;</div>
<div class="line"><a name="l00713"></a><span class="lineno">  713</span>&#160;}</div>
<div class="line"><a name="l00714"></a><span class="lineno">  714</span>&#160; </div>
<div class="line"><a name="l00716"></a><span class="lineno">  716</span>&#160;<span class="keyword">static</span> <span class="keyword">inline</span> <a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#d9/d8a/structheap__t">heap_t</a> *</div>
<div class="line"><a name="l00717"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#ae75d84f0a9ac27b96d18fcd652249cda">  717</a></span>&#160;<a class="code" href="../../df/dc0/rpmalloc_8c.html#ae75d84f0a9ac27b96d18fcd652249cda">get_thread_heap</a>(<span class="keywordtype">void</span>)</div>
<div class="line"><a name="l00718"></a><span class="lineno">  718</span>&#160;{</div>
<div class="line"><a name="l00719"></a><span class="lineno">  719</span>&#160;    <a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#d9/d8a/structheap__t">heap_t</a> *heap = <a class="code" href="../../df/dc0/rpmalloc_8c.html#af7213260e19fbad385988302247150d4">get_thread_heap_raw</a>();</div>
<div class="line"><a name="l00720"></a><span class="lineno">  720</span>&#160;<span class="preprocessor">#if ENABLE_PRELOAD</span></div>
<div class="line"><a name="l00721"></a><span class="lineno">  721</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="../../df/dc0/rpmalloc_8c.html#a90593dceacf0c04f14d084bed7e7eabe">EXPECTED</a>(heap != 0))</div>
<div class="line"><a name="l00722"></a><span class="lineno">  722</span>&#160;        <span class="keywordflow">return</span> heap;</div>
<div class="line"><a name="l00723"></a><span class="lineno">  723</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#a995ec0e5a8f40e3fb178abab89dc7fd5">rpmalloc_initialize</a>();</div>
<div class="line"><a name="l00724"></a><span class="lineno">  724</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#af7213260e19fbad385988302247150d4">get_thread_heap_raw</a>();</div>
<div class="line"><a name="l00725"></a><span class="lineno">  725</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l00726"></a><span class="lineno">  726</span>&#160;    <span class="keywordflow">return</span> heap;</div>
<div class="line"><a name="l00727"></a><span class="lineno">  727</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00728"></a><span class="lineno">  728</span>&#160;}</div>
<div class="line"><a name="l00729"></a><span class="lineno">  729</span>&#160; </div>
<div class="line"><a name="l00730"></a><span class="lineno">  730</span>&#160;<span class="keyword">extern</span> <a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#a4788399d1d0b37ccf098a7da82254808">uintptr_t</a> <a class="code" href="../../df/dc0/rpmalloc_8c.html#a1af1f32c9b66b7e16c30098e456efa0d">__get_tid</a>(<span class="keywordtype">void</span>);</div>
<div class="line"><a name="l00731"></a><span class="lineno">  731</span>&#160; </div>
<div class="line"><a name="l00733"></a><span class="lineno">  733</span>&#160;<span class="keyword">static</span> <span class="keyword">inline</span> <a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#a4788399d1d0b37ccf098a7da82254808">uintptr_t</a></div>
<div class="line"><a name="l00734"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a84e326ca88dee0bd7ca995727bb52381">  734</a></span>&#160;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a84e326ca88dee0bd7ca995727bb52381">get_thread_id</a>(<span class="keywordtype">void</span>) { <span class="keywordflow">return</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#a1af1f32c9b66b7e16c30098e456efa0d">__get_tid</a>(); }</div>
<div class="line"><a name="l00735"></a><span class="lineno">  735</span>&#160; </div>
<div class="line"><a name="l00737"></a><span class="lineno">  737</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="l00738"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a4a224c6ef987eb60f3e3be98239109ec">  738</a></span>&#160;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a4a224c6ef987eb60f3e3be98239109ec">set_thread_heap</a>(<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#d9/d8a/structheap__t">heap_t</a> *heap)</div>
<div class="line"><a name="l00739"></a><span class="lineno">  739</span>&#160;{</div>
<div class="line"><a name="l00740"></a><span class="lineno">  740</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#a0c3d121b2c7e431b109863973cff023c">_memory_thread_heap</a> = heap;</div>
<div class="line"><a name="l00741"></a><span class="lineno">  741</span>&#160;    <span class="keywordflow">if</span> (heap)</div>
<div class="line"><a name="l00742"></a><span class="lineno">  742</span>&#160;        heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a436e67271364d132c12f2f5f0d4c79ef">owner_thread</a> = <a class="code" href="../../df/dc0/rpmalloc_8c.html#a84e326ca88dee0bd7ca995727bb52381">get_thread_id</a>();</div>
<div class="line"><a name="l00743"></a><span class="lineno">  743</span>&#160;}</div>
<div class="line"><a name="l00744"></a><span class="lineno">  744</span>&#160; </div>
<div class="line"><a name="l00746"></a><span class="lineno">  746</span>&#160;<span class="keyword">extern</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="l00747"></a><span class="lineno">  747</span>&#160;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a53adc7f95e9b3fa3e62ba8f50add0ce9">rpmalloc_set_main_thread</a>(<span class="keywordtype">void</span>);</div>
<div class="line"><a name="l00748"></a><span class="lineno">  748</span>&#160; </div>
<div class="line"><a name="l00749"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a53adc7f95e9b3fa3e62ba8f50add0ce9">  749</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#a53adc7f95e9b3fa3e62ba8f50add0ce9">rpmalloc_set_main_thread</a>(<span class="keywordtype">void</span>)</div>
<div class="line"><a name="l00750"></a><span class="lineno">  750</span>&#160;{</div>
<div class="line"><a name="l00751"></a><span class="lineno">  751</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#aacc7bcb924cab5e38c3fe65c5d0b4ab0">_rpmalloc_main_thread_id</a> = <a class="code" href="../../df/dc0/rpmalloc_8c.html#a84e326ca88dee0bd7ca995727bb52381">get_thread_id</a>();</div>
<div class="line"><a name="l00752"></a><span class="lineno">  752</span>&#160;}</div>
<div class="line"><a name="l00753"></a><span class="lineno">  753</span>&#160; </div>
<div class="line"><a name="l00754"></a><span class="lineno">  754</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="l00755"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a335307d78e0ff77d4da9cf42156803ec">  755</a></span>&#160;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a335307d78e0ff77d4da9cf42156803ec">_rpmalloc_spin</a>(<span class="keywordtype">void</span>)</div>
<div class="line"><a name="l00756"></a><span class="lineno">  756</span>&#160;{</div>
<div class="line"><a name="l00757"></a><span class="lineno">  757</span>&#160;<span class="preprocessor">#if defined(_MSC_VER)</span></div>
<div class="line"><a name="l00758"></a><span class="lineno">  758</span>&#160;    _mm_pause();</div>
<div class="line"><a name="l00759"></a><span class="lineno">  759</span>&#160;<span class="preprocessor">#elif defined(__x86_64__) || defined(__i386__)</span></div>
<div class="line"><a name="l00760"></a><span class="lineno">  760</span>&#160;    <a class="code" href="../../d3/dfc/aarch64_2crt__arch_8h.html#a5ca5c7b25f3542384caad5c6fecf0ec1">__asm__</a> <span class="keyword">volatile</span>(<span class="stringliteral">&quot;pause&quot;</span> ::: <span class="stringliteral">&quot;memory&quot;</span>);</div>
<div class="line"><a name="l00761"></a><span class="lineno">  761</span>&#160;<span class="preprocessor">#elif defined(__aarch64__) || (defined(__arm__) &amp;&amp; __ARM_ARCH &gt;= 7)</span></div>
<div class="line"><a name="l00762"></a><span class="lineno">  762</span>&#160;    <a class="code" href="../../d3/dfc/aarch64_2crt__arch_8h.html#a5ca5c7b25f3542384caad5c6fecf0ec1">__asm__</a> <span class="keyword">volatile</span>(<span class="stringliteral">&quot;yield&quot;</span> ::: <span class="stringliteral">&quot;memory&quot;</span>);</div>
<div class="line"><a name="l00763"></a><span class="lineno">  763</span>&#160;<span class="preprocessor">#elif defined(__powerpc__) || defined(__powerpc64__)</span></div>
<div class="line"><a name="l00764"></a><span class="lineno">  764</span>&#160;    <span class="comment">// No idea if ever been compiled in such archs but ... as precaution</span></div>
<div class="line"><a name="l00765"></a><span class="lineno">  765</span>&#160;    <a class="code" href="../../d3/dfc/aarch64_2crt__arch_8h.html#a5ca5c7b25f3542384caad5c6fecf0ec1">__asm__</a> <span class="keyword">volatile</span>(<span class="stringliteral">&quot;or 27,27,27&quot;</span>);</div>
<div class="line"><a name="l00766"></a><span class="lineno">  766</span>&#160;<span class="preprocessor">#elif defined(__sparc__)</span></div>
<div class="line"><a name="l00767"></a><span class="lineno">  767</span>&#160;    <a class="code" href="../../d3/dfc/aarch64_2crt__arch_8h.html#a5ca5c7b25f3542384caad5c6fecf0ec1">__asm__</a> <span class="keyword">volatile</span>(<span class="stringliteral">&quot;rd %ccr, %g0 \n\trd %ccr, %g0 \n\trd %ccr, %g0&quot;</span>);</div>
<div class="line"><a name="l00768"></a><span class="lineno">  768</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l00769"></a><span class="lineno">  769</span>&#160;    <span class="keyword">struct </span><a class="code" href="../../de/d98/Kernel_2include__std_2time_8h.html#da/d1c/structtimespec">timespec</a> ts = {0};</div>
<div class="line"><a name="l00770"></a><span class="lineno">  770</span>&#160;    <a class="code" href="../../d7/d50/nanosleep_8c.html#a1b63fa141b202a0b01cfef8421aa48d6">nanosleep</a>(&amp;ts, 0);</div>
<div class="line"><a name="l00771"></a><span class="lineno">  771</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00772"></a><span class="lineno">  772</span>&#160;}</div>
<div class="line"><a name="l00773"></a><span class="lineno">  773</span>&#160; </div>
<div class="line"><a name="l00779"></a><span class="lineno">  779</span>&#160; </div>
<div class="line"><a name="l00780"></a><span class="lineno">  780</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="l00781"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a66c4be5ac967e1374b25eb8ac80f68d9">  781</a></span>&#160;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a66c4be5ac967e1374b25eb8ac80f68d9">_rpmalloc_set_name</a>(<span class="keywordtype">void</span> *<a class="code" href="../../dd/d45/lookup_8h.html#da/d97/structaddress">address</a>, <span class="keywordtype">size_t</span> <a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a>)</div>
<div class="line"><a name="l00782"></a><span class="lineno">  782</span>&#160;{</div>
<div class="line"><a name="l00783"></a><span class="lineno">  783</span>&#160;<span class="preprocessor">#if defined(__linux__) || defined(__ANDROID__)</span></div>
<div class="line"><a name="l00784"></a><span class="lineno">  784</span>&#160;    <span class="keyword">const</span> <span class="keywordtype">char</span> *name = <a class="code" href="../../df/dc0/rpmalloc_8c.html#a4cdf64413eaa3e80f8a1dfe158bd2525">_memory_huge_pages</a> ? <a class="code" href="../../df/dc0/rpmalloc_8c.html#ae1f1297fe3d143e41deac95ee7a7f8d4">_memory_config</a>.<a class="code" href="../../df/d42/structrpmalloc__config__t.html#aaaf26ab237ec708c05953e92ae93578f">huge_page_name</a> : <a class="code" href="../../df/dc0/rpmalloc_8c.html#ae1f1297fe3d143e41deac95ee7a7f8d4">_memory_config</a>.<a class="code" href="../../df/d42/structrpmalloc__config__t.html#a8b1c79b90f2b7f66d98690b1234ab8d8">page_name</a>;</div>
<div class="line"><a name="l00785"></a><span class="lineno">  785</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="../../dd/d45/lookup_8h.html#da/d97/structaddress">address</a> == <a class="code" href="../../d1/deb/Kernel_2include__std_2sys_2mman_8h.html#a8523dcf952f6ff059a3bed717e4f1296">MAP_FAILED</a> || !name)</div>
<div class="line"><a name="l00786"></a><span class="lineno">  786</span>&#160;        <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00787"></a><span class="lineno">  787</span>&#160;    <span class="comment">// If the kernel does not support CONFIG_ANON_VMA_NAME or if the call fails</span></div>
<div class="line"><a name="l00788"></a><span class="lineno">  788</span>&#160;    <span class="comment">// (e.g. invalid name) it is a no-op basically.</span></div>
<div class="line"><a name="l00789"></a><span class="lineno">  789</span>&#160;    (void)<a class="code" href="../../db/dba/prctl_8h.html#a124f93dce8f8b29b6a245b178261b10e">prctl</a>(PR_SET_VMA, PR_SET_VMA_ANON_NAME, (<a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#a4788399d1d0b37ccf098a7da82254808">uintptr_t</a>)<a class="code" href="../../dd/d45/lookup_8h.html#da/d97/structaddress">address</a>, <a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a>, (<a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#a4788399d1d0b37ccf098a7da82254808">uintptr_t</a>)name);</div>
<div class="line"><a name="l00790"></a><span class="lineno">  790</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l00791"></a><span class="lineno">  791</span>&#160;    (void)<span class="keyword">sizeof</span>(<a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a>);</div>
<div class="line"><a name="l00792"></a><span class="lineno">  792</span>&#160;    (void)<span class="keyword">sizeof</span>(<a class="code" href="../../dd/d45/lookup_8h.html#da/d97/structaddress">address</a>);</div>
<div class="line"><a name="l00793"></a><span class="lineno">  793</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00794"></a><span class="lineno">  794</span>&#160;}</div>
<div class="line"><a name="l00795"></a><span class="lineno">  795</span>&#160; </div>
<div class="line"><a name="l00797"></a><span class="lineno">  797</span>&#160;<span class="comment">//  size is number of bytes to map</span></div>
<div class="line"><a name="l00798"></a><span class="lineno">  798</span>&#160;<span class="comment">//  offset receives the offset in bytes from start of mapped region</span></div>
<div class="line"><a name="l00799"></a><span class="lineno">  799</span>&#160;<span class="comment">//  returns address to start of mapped region to use</span></div>
<div class="line"><a name="l00800"></a><span class="lineno">  800</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> *</div>
<div class="line"><a name="l00801"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a2d8a3eac487ff2943f8aae4dd20badd3">  801</a></span>&#160;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a2d8a3eac487ff2943f8aae4dd20badd3">_rpmalloc_mmap</a>(<span class="keywordtype">size_t</span> <a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a>, <span class="keywordtype">size_t</span> *offset)</div>
<div class="line"><a name="l00802"></a><span class="lineno">  802</span>&#160;{</div>
<div class="line"><a name="l00803"></a><span class="lineno">  803</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#ad008ddf766a4f56fbde2edf2c51d9a87">rpmalloc_assert</a>(!(<a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a> % <a class="code" href="../../df/dc0/rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a>), <span class="stringliteral">&quot;Invalid mmap size&quot;</span>);</div>
<div class="line"><a name="l00804"></a><span class="lineno">  804</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#ad008ddf766a4f56fbde2edf2c51d9a87">rpmalloc_assert</a>(<a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a> &gt;= <a class="code" href="../../df/dc0/rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a>, <span class="stringliteral">&quot;Invalid mmap size&quot;</span>);</div>
<div class="line"><a name="l00805"></a><span class="lineno">  805</span>&#160;    <span class="keywordtype">void</span> *<a class="code" href="../../dd/d45/lookup_8h.html#da/d97/structaddress">address</a> = <a class="code" href="../../df/dc0/rpmalloc_8c.html#ae1f1297fe3d143e41deac95ee7a7f8d4">_memory_config</a>.<a class="code" href="../../df/d42/structrpmalloc__config__t.html#ab1a81b9e7c3dee077fafc85b5327ea6b">memory_map</a>(<a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a>, offset);</div>
<div class="line"><a name="l00806"></a><span class="lineno">  806</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="../../df/dc0/rpmalloc_8c.html#a90593dceacf0c04f14d084bed7e7eabe">EXPECTED</a>(<a class="code" href="../../dd/d45/lookup_8h.html#da/d97/structaddress">address</a> != 0))</div>
<div class="line"><a name="l00807"></a><span class="lineno">  807</span>&#160;    {</div>
<div class="line"><a name="l00808"></a><span class="lineno">  808</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#a599c57201987cc23a9787a745296e575">_rpmalloc_stat_add_peak</a>(&amp;_mapped_pages, (<a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a> &gt;&gt; <a class="code" href="../../df/dc0/rpmalloc_8c.html#a9d7ec974d864302bb4f8516859c4b212">_memory_page_size_shift</a>), _mapped_pages_peak);</div>
<div class="line"><a name="l00809"></a><span class="lineno">  809</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#a4a53d0cfdcf755d4fbbae446a055440c">_rpmalloc_stat_add</a>(&amp;_mapped_total, (<a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a> &gt;&gt; <a class="code" href="../../df/dc0/rpmalloc_8c.html#a9d7ec974d864302bb4f8516859c4b212">_memory_page_size_shift</a>));</div>
<div class="line"><a name="l00810"></a><span class="lineno">  810</span>&#160;    }</div>
<div class="line"><a name="l00811"></a><span class="lineno">  811</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="../../dd/d45/lookup_8h.html#da/d97/structaddress">address</a>;</div>
<div class="line"><a name="l00812"></a><span class="lineno">  812</span>&#160;}</div>
<div class="line"><a name="l00813"></a><span class="lineno">  813</span>&#160; </div>
<div class="line"><a name="l00815"></a><span class="lineno">  815</span>&#160;<span class="comment">//  address is the memory address to unmap, as returned from _memory_map</span></div>
<div class="line"><a name="l00816"></a><span class="lineno">  816</span>&#160;<span class="comment">//  size is the number of bytes to unmap, which might be less than full region for a partial unmap</span></div>
<div class="line"><a name="l00817"></a><span class="lineno">  817</span>&#160;<span class="comment">//  offset is the offset in bytes to the actual mapped region, as set by _memory_map</span></div>
<div class="line"><a name="l00818"></a><span class="lineno">  818</span>&#160;<span class="comment">//  release is set to 0 for partial unmap, or size of entire range for a full unmap</span></div>
<div class="line"><a name="l00819"></a><span class="lineno">  819</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="l00820"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#abfbbb8e2f9b086d466fe2898a283c98d">  820</a></span>&#160;<a class="code" href="../../df/dc0/rpmalloc_8c.html#abfbbb8e2f9b086d466fe2898a283c98d">_rpmalloc_unmap</a>(<span class="keywordtype">void</span> *<a class="code" href="../../dd/d45/lookup_8h.html#da/d97/structaddress">address</a>, <span class="keywordtype">size_t</span> <a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a>, <span class="keywordtype">size_t</span> offset, <span class="keywordtype">size_t</span> release)</div>
<div class="line"><a name="l00821"></a><span class="lineno">  821</span>&#160;{</div>
<div class="line"><a name="l00822"></a><span class="lineno">  822</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#ad008ddf766a4f56fbde2edf2c51d9a87">rpmalloc_assert</a>(!release || (release &gt;= <a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a>), <span class="stringliteral">&quot;Invalid unmap size&quot;</span>);</div>
<div class="line"><a name="l00823"></a><span class="lineno">  823</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#ad008ddf766a4f56fbde2edf2c51d9a87">rpmalloc_assert</a>(!release || (release &gt;= <a class="code" href="../../df/dc0/rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a>), <span class="stringliteral">&quot;Invalid unmap size&quot;</span>);</div>
<div class="line"><a name="l00824"></a><span class="lineno">  824</span>&#160;    <span class="keywordflow">if</span> (release)</div>
<div class="line"><a name="l00825"></a><span class="lineno">  825</span>&#160;    {</div>
<div class="line"><a name="l00826"></a><span class="lineno">  826</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#ad008ddf766a4f56fbde2edf2c51d9a87">rpmalloc_assert</a>(!(release % <a class="code" href="../../df/dc0/rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a>), <span class="stringliteral">&quot;Invalid unmap size&quot;</span>);</div>
<div class="line"><a name="l00827"></a><span class="lineno">  827</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#a829d3a1ca51d0ba687990a8111940c42">_rpmalloc_stat_sub</a>(&amp;_mapped_pages, (release &gt;&gt; <a class="code" href="../../df/dc0/rpmalloc_8c.html#a9d7ec974d864302bb4f8516859c4b212">_memory_page_size_shift</a>));</div>
<div class="line"><a name="l00828"></a><span class="lineno">  828</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#a4a53d0cfdcf755d4fbbae446a055440c">_rpmalloc_stat_add</a>(&amp;_unmapped_total, (release &gt;&gt; <a class="code" href="../../df/dc0/rpmalloc_8c.html#a9d7ec974d864302bb4f8516859c4b212">_memory_page_size_shift</a>));</div>
<div class="line"><a name="l00829"></a><span class="lineno">  829</span>&#160;    }</div>
<div class="line"><a name="l00830"></a><span class="lineno">  830</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#ae1f1297fe3d143e41deac95ee7a7f8d4">_memory_config</a>.<a class="code" href="../../df/d42/structrpmalloc__config__t.html#a10fb22a2f8775aafd70b1c79f6b80630">memory_unmap</a>(<a class="code" href="../../dd/d45/lookup_8h.html#da/d97/structaddress">address</a>, <a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a>, offset, release);</div>
<div class="line"><a name="l00831"></a><span class="lineno">  831</span>&#160;}</div>
<div class="line"><a name="l00832"></a><span class="lineno">  832</span>&#160; </div>
<div class="line"><a name="l00834"></a><span class="lineno">  834</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> *</div>
<div class="line"><a name="l00835"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#aa3b1a6473db3c198691da8c7b8918f7a">  835</a></span>&#160;<a class="code" href="../../df/dc0/rpmalloc_8c.html#aa3b1a6473db3c198691da8c7b8918f7a">_rpmalloc_mmap_os</a>(<span class="keywordtype">size_t</span> <a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a>, <span class="keywordtype">size_t</span> *offset)</div>
<div class="line"><a name="l00836"></a><span class="lineno">  836</span>&#160;{</div>
<div class="line"><a name="l00837"></a><span class="lineno">  837</span>&#160;    <span class="comment">// Either size is a heap (a single page) or a (multiple) span - we only need to align spans, and only if larger than map granularity</span></div>
<div class="line"><a name="l00838"></a><span class="lineno">  838</span>&#160;    <span class="keywordtype">size_t</span> padding = ((<a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a> &gt;= <a class="code" href="../../df/dc0/rpmalloc_8c.html#a9fefa5277fefa0c58f69d5b86d679ccb">_memory_span_size</a>) &amp;&amp; (<a class="code" href="../../df/dc0/rpmalloc_8c.html#a9fefa5277fefa0c58f69d5b86d679ccb">_memory_span_size</a> &gt; <a class="code" href="../../df/dc0/rpmalloc_8c.html#a1e29d8d18139babda354d5d92d46ca02">_memory_map_granularity</a>)) ? <a class="code" href="../../df/dc0/rpmalloc_8c.html#a9fefa5277fefa0c58f69d5b86d679ccb">_memory_span_size</a> : 0;</div>
<div class="line"><a name="l00839"></a><span class="lineno">  839</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#ad008ddf766a4f56fbde2edf2c51d9a87">rpmalloc_assert</a>(<a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a> &gt;= <a class="code" href="../../df/dc0/rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a>, <span class="stringliteral">&quot;Invalid mmap size&quot;</span>);</div>
<div class="line"><a name="l00840"></a><span class="lineno">  840</span>&#160; </div>
<div class="line"><a name="l00841"></a><span class="lineno">  841</span>&#160;    <span class="keywordtype">int</span> flags = <a class="code" href="../../d1/deb/Kernel_2include__std_2sys_2mman_8h.html#a398ef47a991a44389aa9818c98a28d24">MAP_PRIVATE</a> | <a class="code" href="../../d1/deb/Kernel_2include__std_2sys_2mman_8h.html#ae4f86bff73414c5fc08c058f957212f0">MAP_ANONYMOUS</a> | <a class="code" href="../../df/dc0/rpmalloc_8c.html#a14828817b96941a8a2ad71e2bb95143b">MAP_UNINITIALIZED</a>;</div>
<div class="line"><a name="l00842"></a><span class="lineno">  842</span>&#160;    <span class="keywordtype">void</span> *ptr = <a class="code" href="../../df/dc0/rpmalloc_8c.html#a38abd8cccc9bef76c59666dc716e3f30">__rpmalloc_mmap</a>(0, <a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a> + padding, <a class="code" href="../../d1/deb/Kernel_2include__std_2sys_2mman_8h.html#a15bf68ce8b590838b3a5c0b639d8d519">PROT_READ</a> | <a class="code" href="../../d1/deb/Kernel_2include__std_2sys_2mman_8h.html#a2a79c8ceefb8fc25a940ae07a3d94429">PROT_WRITE</a>, flags, -1, 0);</div>
<div class="line"><a name="l00843"></a><span class="lineno">  843</span>&#160; </div>
<div class="line"><a name="l00844"></a><span class="lineno">  844</span>&#160;    <span class="keywordflow">if</span> ((ptr == <a class="code" href="../../d1/deb/Kernel_2include__std_2sys_2mman_8h.html#a8523dcf952f6ff059a3bed717e4f1296">MAP_FAILED</a>) || !ptr)</div>
<div class="line"><a name="l00845"></a><span class="lineno">  845</span>&#160;    {</div>
<div class="line"><a name="l00846"></a><span class="lineno">  846</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="../../df/dc0/rpmalloc_8c.html#ae1f1297fe3d143e41deac95ee7a7f8d4">_memory_config</a>.<a class="code" href="../../df/d42/structrpmalloc__config__t.html#a35106c441d799201ae0c57068d539ca4">map_fail_callback</a>)</div>
<div class="line"><a name="l00847"></a><span class="lineno">  847</span>&#160;        {</div>
<div class="line"><a name="l00848"></a><span class="lineno">  848</span>&#160;            <span class="keywordflow">if</span> (<a class="code" href="../../df/dc0/rpmalloc_8c.html#ae1f1297fe3d143e41deac95ee7a7f8d4">_memory_config</a>.<a class="code" href="../../df/d42/structrpmalloc__config__t.html#a35106c441d799201ae0c57068d539ca4">map_fail_callback</a>(<a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a> + padding))</div>
<div class="line"><a name="l00849"></a><span class="lineno">  849</span>&#160;                <span class="keywordflow">return</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#aa3b1a6473db3c198691da8c7b8918f7a">_rpmalloc_mmap_os</a>(<a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a>, offset);</div>
<div class="line"><a name="l00850"></a><span class="lineno">  850</span>&#160;        }</div>
<div class="line"><a name="l00851"></a><span class="lineno">  851</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../df/d9b/Kernel_2include_2interface_2errno_8h.html#ab03f640d90fbc5bcb75285d08a0f25ed">errno</a> != <a class="code" href="../../df/d53/Userspace_2libc_2include_2errno_8h.html#a6a05c923dad0c1208043e9c20a58c8e5">ENOMEM</a>)</div>
<div class="line"><a name="l00852"></a><span class="lineno">  852</span>&#160;        {</div>
<div class="line"><a name="l00853"></a><span class="lineno">  853</span>&#160;            <a class="code" href="../../df/dc0/rpmalloc_8c.html#ad008ddf766a4f56fbde2edf2c51d9a87">rpmalloc_assert</a>((ptr != <a class="code" href="../../d1/deb/Kernel_2include__std_2sys_2mman_8h.html#a8523dcf952f6ff059a3bed717e4f1296">MAP_FAILED</a>) &amp;&amp; ptr, <span class="stringliteral">&quot;Failed to map virtual memory block&quot;</span>);</div>
<div class="line"><a name="l00854"></a><span class="lineno">  854</span>&#160;        }</div>
<div class="line"><a name="l00855"></a><span class="lineno">  855</span>&#160;        <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00856"></a><span class="lineno">  856</span>&#160;    }</div>
<div class="line"><a name="l00857"></a><span class="lineno">  857</span>&#160; </div>
<div class="line"><a name="l00858"></a><span class="lineno">  858</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#a4a53d0cfdcf755d4fbbae446a055440c">_rpmalloc_stat_add</a>(&amp;_mapped_pages_os, (<a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#a0c18914b3041c2f583aba76f418399c2">int32_t</a>)((<a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a> + padding) &gt;&gt; <a class="code" href="../../df/dc0/rpmalloc_8c.html#a9d7ec974d864302bb4f8516859c4b212">_memory_page_size_shift</a>));</div>
<div class="line"><a name="l00859"></a><span class="lineno">  859</span>&#160;    <span class="keywordflow">if</span> (padding)</div>
<div class="line"><a name="l00860"></a><span class="lineno">  860</span>&#160;    {</div>
<div class="line"><a name="l00861"></a><span class="lineno">  861</span>&#160;        <span class="keywordtype">size_t</span> final_padding = padding - ((<a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#a4788399d1d0b37ccf098a7da82254808">uintptr_t</a>)ptr &amp; ~<a class="code" href="../../df/dc0/rpmalloc_8c.html#ae7b97ba12e15609b6d63926ed2e30238">_memory_span_mask</a>);</div>
<div class="line"><a name="l00862"></a><span class="lineno">  862</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#ad008ddf766a4f56fbde2edf2c51d9a87">rpmalloc_assert</a>(final_padding &lt;= <a class="code" href="../../df/dc0/rpmalloc_8c.html#a9fefa5277fefa0c58f69d5b86d679ccb">_memory_span_size</a>, <span class="stringliteral">&quot;Internal failure in padding&quot;</span>);</div>
<div class="line"><a name="l00863"></a><span class="lineno">  863</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#ad008ddf766a4f56fbde2edf2c51d9a87">rpmalloc_assert</a>(final_padding &lt;= padding, <span class="stringliteral">&quot;Internal failure in padding&quot;</span>);</div>
<div class="line"><a name="l00864"></a><span class="lineno">  864</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#ad008ddf766a4f56fbde2edf2c51d9a87">rpmalloc_assert</a>(!(final_padding % 8), <span class="stringliteral">&quot;Internal failure in padding&quot;</span>);</div>
<div class="line"><a name="l00865"></a><span class="lineno">  865</span>&#160;        ptr = <a class="code" href="../../df/dc0/rpmalloc_8c.html#ab4225911698b67188e1538c334cfe16c">pointer_offset</a>(ptr, final_padding);</div>
<div class="line"><a name="l00866"></a><span class="lineno">  866</span>&#160;        *offset = final_padding &gt;&gt; 3;</div>
<div class="line"><a name="l00867"></a><span class="lineno">  867</span>&#160;    }</div>
<div class="line"><a name="l00868"></a><span class="lineno">  868</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#ad008ddf766a4f56fbde2edf2c51d9a87">rpmalloc_assert</a>((<a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a> &lt; <a class="code" href="../../df/dc0/rpmalloc_8c.html#a9fefa5277fefa0c58f69d5b86d679ccb">_memory_span_size</a>) || !((<a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#a4788399d1d0b37ccf098a7da82254808">uintptr_t</a>)ptr &amp; ~<a class="code" href="../../df/dc0/rpmalloc_8c.html#ae7b97ba12e15609b6d63926ed2e30238">_memory_span_mask</a>), <span class="stringliteral">&quot;Internal failure in padding&quot;</span>);</div>
<div class="line"><a name="l00869"></a><span class="lineno">  869</span>&#160;    <span class="keywordflow">return</span> ptr;</div>
<div class="line"><a name="l00870"></a><span class="lineno">  870</span>&#160;}</div>
<div class="line"><a name="l00871"></a><span class="lineno">  871</span>&#160; </div>
<div class="line"><a name="l00873"></a><span class="lineno">  873</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="l00874"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a693c463bae081b54b0b799e97bf84fb5">  874</a></span>&#160;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a693c463bae081b54b0b799e97bf84fb5">_rpmalloc_unmap_os</a>(<span class="keywordtype">void</span> *<a class="code" href="../../dd/d45/lookup_8h.html#da/d97/structaddress">address</a>, <span class="keywordtype">size_t</span> <a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a>, <span class="keywordtype">size_t</span> offset, <span class="keywordtype">size_t</span> release)</div>
<div class="line"><a name="l00875"></a><span class="lineno">  875</span>&#160;{</div>
<div class="line"><a name="l00876"></a><span class="lineno">  876</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#ad008ddf766a4f56fbde2edf2c51d9a87">rpmalloc_assert</a>(release || (offset == 0), <span class="stringliteral">&quot;Invalid unmap size&quot;</span>);</div>
<div class="line"><a name="l00877"></a><span class="lineno">  877</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#ad008ddf766a4f56fbde2edf2c51d9a87">rpmalloc_assert</a>(!release || (release &gt;= <a class="code" href="../../df/dc0/rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a>), <span class="stringliteral">&quot;Invalid unmap size&quot;</span>);</div>
<div class="line"><a name="l00878"></a><span class="lineno">  878</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#ad008ddf766a4f56fbde2edf2c51d9a87">rpmalloc_assert</a>(<a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a> &gt;= <a class="code" href="../../df/dc0/rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a>, <span class="stringliteral">&quot;Invalid unmap size&quot;</span>);</div>
<div class="line"><a name="l00879"></a><span class="lineno">  879</span>&#160;    <span class="keywordflow">if</span> (release &amp;&amp; offset)</div>
<div class="line"><a name="l00880"></a><span class="lineno">  880</span>&#160;    {</div>
<div class="line"><a name="l00881"></a><span class="lineno">  881</span>&#160;        offset &lt;&lt;= 3;</div>
<div class="line"><a name="l00882"></a><span class="lineno">  882</span>&#160;        <a class="code" href="../../dd/d45/lookup_8h.html#da/d97/structaddress">address</a> = <a class="code" href="../../df/dc0/rpmalloc_8c.html#ab4225911698b67188e1538c334cfe16c">pointer_offset</a>(<a class="code" href="../../dd/d45/lookup_8h.html#da/d97/structaddress">address</a>, -(<a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#a0c18914b3041c2f583aba76f418399c2">int32_t</a>)offset);</div>
<div class="line"><a name="l00883"></a><span class="lineno">  883</span>&#160;        <span class="keywordflow">if</span> ((release &gt;= <a class="code" href="../../df/dc0/rpmalloc_8c.html#a9fefa5277fefa0c58f69d5b86d679ccb">_memory_span_size</a>) &amp;&amp; (<a class="code" href="../../df/dc0/rpmalloc_8c.html#a9fefa5277fefa0c58f69d5b86d679ccb">_memory_span_size</a> &gt; <a class="code" href="../../df/dc0/rpmalloc_8c.html#a1e29d8d18139babda354d5d92d46ca02">_memory_map_granularity</a>))</div>
<div class="line"><a name="l00884"></a><span class="lineno">  884</span>&#160;        {</div>
<div class="line"><a name="l00885"></a><span class="lineno">  885</span>&#160;            <span class="comment">// Padding is always one span size</span></div>
<div class="line"><a name="l00886"></a><span class="lineno">  886</span>&#160;            release += <a class="code" href="../../df/dc0/rpmalloc_8c.html#a9fefa5277fefa0c58f69d5b86d679ccb">_memory_span_size</a>;</div>
<div class="line"><a name="l00887"></a><span class="lineno">  887</span>&#160;        }</div>
<div class="line"><a name="l00888"></a><span class="lineno">  888</span>&#160;    }</div>
<div class="line"><a name="l00889"></a><span class="lineno">  889</span>&#160;<span class="preprocessor">#if !DISABLE_UNMAP</span></div>
<div class="line"><a name="l00890"></a><span class="lineno">  890</span>&#160;    <span class="keywordflow">if</span> (release)</div>
<div class="line"><a name="l00891"></a><span class="lineno">  891</span>&#160;    {</div>
<div class="line"><a name="l00892"></a><span class="lineno">  892</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="../../df/dc0/rpmalloc_8c.html#a26f341387be75540b16ddf371b9ce3ed">__rpmalloc_munmap</a>(<a class="code" href="../../dd/d45/lookup_8h.html#da/d97/structaddress">address</a>, release))</div>
<div class="line"><a name="l00893"></a><span class="lineno">  893</span>&#160;        {</div>
<div class="line"><a name="l00894"></a><span class="lineno">  894</span>&#160;            <a class="code" href="../../df/dc0/rpmalloc_8c.html#ad008ddf766a4f56fbde2edf2c51d9a87">rpmalloc_assert</a>(0, <span class="stringliteral">&quot;Failed to unmap virtual memory block&quot;</span>);</div>
<div class="line"><a name="l00895"></a><span class="lineno">  895</span>&#160;        }</div>
<div class="line"><a name="l00896"></a><span class="lineno">  896</span>&#160;    }</div>
<div class="line"><a name="l00897"></a><span class="lineno">  897</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l00898"></a><span class="lineno">  898</span>&#160;    {</div>
<div class="line"><a name="l00899"></a><span class="lineno">  899</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="../../df/dc0/rpmalloc_8c.html#a34a6e06414bb541b0d231513cb7b66e3">__rpmalloc_posix_madvise</a>(<a class="code" href="../../dd/d45/lookup_8h.html#da/d97/structaddress">address</a>, <a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a>, <a class="code" href="../../d1/deb/Kernel_2include__std_2sys_2mman_8h.html#a930a5f4c7440ba221317ea3bf8139b58">POSIX_MADV_DONTNEED</a>))</div>
<div class="line"><a name="l00900"></a><span class="lineno">  900</span>&#160;        {</div>
<div class="line"><a name="l00901"></a><span class="lineno">  901</span>&#160;            <a class="code" href="../../df/dc0/rpmalloc_8c.html#ad008ddf766a4f56fbde2edf2c51d9a87">rpmalloc_assert</a>(0, <span class="stringliteral">&quot;Failed to madvise virtual memory block as free&quot;</span>);</div>
<div class="line"><a name="l00902"></a><span class="lineno">  902</span>&#160;        }</div>
<div class="line"><a name="l00903"></a><span class="lineno">  903</span>&#160;    }</div>
<div class="line"><a name="l00904"></a><span class="lineno">  904</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00905"></a><span class="lineno">  905</span>&#160;    <span class="keywordflow">if</span> (release)</div>
<div class="line"><a name="l00906"></a><span class="lineno">  906</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#a829d3a1ca51d0ba687990a8111940c42">_rpmalloc_stat_sub</a>(&amp;_mapped_pages_os, release &gt;&gt; <a class="code" href="../../df/dc0/rpmalloc_8c.html#a9d7ec974d864302bb4f8516859c4b212">_memory_page_size_shift</a>);</div>
<div class="line"><a name="l00907"></a><span class="lineno">  907</span>&#160;}</div>
<div class="line"><a name="l00908"></a><span class="lineno">  908</span>&#160; </div>
<div class="line"><a name="l00909"></a><span class="lineno">  909</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="l00910"></a><span class="lineno">  910</span>&#160;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a91bf3ee061b188b8a650fbac9babef4a">_rpmalloc_span_mark_as_subspan_unless_master</a>(<a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *master, <a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *subspan, <span class="keywordtype">size_t</span> span_count);</div>
<div class="line"><a name="l00911"></a><span class="lineno">  911</span>&#160; </div>
<div class="line"><a name="l00913"></a><span class="lineno">  913</span>&#160;<span class="keyword">static</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *</div>
<div class="line"><a name="l00914"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#abc75935ba437c535deefc42928807231">  914</a></span>&#160;<a class="code" href="../../df/dc0/rpmalloc_8c.html#abc75935ba437c535deefc42928807231">_rpmalloc_global_get_reserved_spans</a>(<span class="keywordtype">size_t</span> span_count)</div>
<div class="line"><a name="l00915"></a><span class="lineno">  915</span>&#160;{</div>
<div class="line"><a name="l00916"></a><span class="lineno">  916</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *span = <a class="code" href="../../df/dc0/rpmalloc_8c.html#a411d5d6c063a099c1a08fa853851b764">_memory_global_reserve</a>;</div>
<div class="line"><a name="l00917"></a><span class="lineno">  917</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#a91bf3ee061b188b8a650fbac9babef4a">_rpmalloc_span_mark_as_subspan_unless_master</a>(<a class="code" href="../../df/dc0/rpmalloc_8c.html#a1d5126b78d2bb31fe3476abcd07dd801">_memory_global_reserve_master</a>, span, span_count);</div>
<div class="line"><a name="l00918"></a><span class="lineno">  918</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#a19d785146ca5053c2da69ad1ec4de94c">_memory_global_reserve_count</a> -= span_count;</div>
<div class="line"><a name="l00919"></a><span class="lineno">  919</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="../../df/dc0/rpmalloc_8c.html#a19d785146ca5053c2da69ad1ec4de94c">_memory_global_reserve_count</a>)</div>
<div class="line"><a name="l00920"></a><span class="lineno">  920</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#a411d5d6c063a099c1a08fa853851b764">_memory_global_reserve</a> = (<a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *)<a class="code" href="../../df/dc0/rpmalloc_8c.html#ab4225911698b67188e1538c334cfe16c">pointer_offset</a>(span, span_count &lt;&lt; <a class="code" href="../../df/dc0/rpmalloc_8c.html#adb538a1ad8a86db6b92895d9ebf6d907">_memory_span_size_shift</a>);</div>
<div class="line"><a name="l00921"></a><span class="lineno">  921</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l00922"></a><span class="lineno">  922</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#a411d5d6c063a099c1a08fa853851b764">_memory_global_reserve</a> = 0;</div>
<div class="line"><a name="l00923"></a><span class="lineno">  923</span>&#160;    <span class="keywordflow">return</span> span;</div>
<div class="line"><a name="l00924"></a><span class="lineno">  924</span>&#160;}</div>
<div class="line"><a name="l00925"></a><span class="lineno">  925</span>&#160; </div>
<div class="line"><a name="l00927"></a><span class="lineno">  927</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="l00928"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#aa6d37b325f0f3c68f89cdf681681a09f">  928</a></span>&#160;<a class="code" href="../../df/dc0/rpmalloc_8c.html#aa6d37b325f0f3c68f89cdf681681a09f">_rpmalloc_global_set_reserved_spans</a>(<a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *master, <a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *reserve, <span class="keywordtype">size_t</span> reserve_span_count)</div>
<div class="line"><a name="l00929"></a><span class="lineno">  929</span>&#160;{</div>
<div class="line"><a name="l00930"></a><span class="lineno">  930</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#a1d5126b78d2bb31fe3476abcd07dd801">_memory_global_reserve_master</a> = master;</div>
<div class="line"><a name="l00931"></a><span class="lineno">  931</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#a19d785146ca5053c2da69ad1ec4de94c">_memory_global_reserve_count</a> = reserve_span_count;</div>
<div class="line"><a name="l00932"></a><span class="lineno">  932</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#a411d5d6c063a099c1a08fa853851b764">_memory_global_reserve</a> = reserve;</div>
<div class="line"><a name="l00933"></a><span class="lineno">  933</span>&#160;}</div>
<div class="line"><a name="l00934"></a><span class="lineno">  934</span>&#160; </div>
<div class="line"><a name="l00940"></a><span class="lineno">  940</span>&#160; </div>
<div class="line"><a name="l00942"></a><span class="lineno">  942</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="l00943"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#ac32a750ddf4072d46c28f52b9f3ee018">  943</a></span>&#160;<a class="code" href="../../df/dc0/rpmalloc_8c.html#ac32a750ddf4072d46c28f52b9f3ee018">_rpmalloc_span_double_link_list_add</a>(<a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> **<a class="code" href="../../d3/dbb/hu__stuff_8c.html#a20358970b1abaf992eb85e071e454653">head</a>, <a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *span)</div>
<div class="line"><a name="l00944"></a><span class="lineno">  944</span>&#160;{</div>
<div class="line"><a name="l00945"></a><span class="lineno">  945</span>&#160;    <span class="keywordflow">if</span> (*<a class="code" href="../../d3/dbb/hu__stuff_8c.html#a20358970b1abaf992eb85e071e454653">head</a>)</div>
<div class="line"><a name="l00946"></a><span class="lineno">  946</span>&#160;        (*head)-&gt;prev = span;</div>
<div class="line"><a name="l00947"></a><span class="lineno">  947</span>&#160;    span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#ac62e0e77eb38ebff4443eb5db3ccd45c">next</a> = *<a class="code" href="../../d3/dbb/hu__stuff_8c.html#a20358970b1abaf992eb85e071e454653">head</a>;</div>
<div class="line"><a name="l00948"></a><span class="lineno">  948</span>&#160;    *<a class="code" href="../../d3/dbb/hu__stuff_8c.html#a20358970b1abaf992eb85e071e454653">head</a> = span;</div>
<div class="line"><a name="l00949"></a><span class="lineno">  949</span>&#160;}</div>
<div class="line"><a name="l00950"></a><span class="lineno">  950</span>&#160; </div>
<div class="line"><a name="l00952"></a><span class="lineno">  952</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="l00953"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a49d22808308e599742e41ef2d4671cfa">  953</a></span>&#160;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a49d22808308e599742e41ef2d4671cfa">_rpmalloc_span_double_link_list_pop_head</a>(<a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> **<a class="code" href="../../d3/dbb/hu__stuff_8c.html#a20358970b1abaf992eb85e071e454653">head</a>, <a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *span)</div>
<div class="line"><a name="l00954"></a><span class="lineno">  954</span>&#160;{</div>
<div class="line"><a name="l00955"></a><span class="lineno">  955</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#ad008ddf766a4f56fbde2edf2c51d9a87">rpmalloc_assert</a>(*<a class="code" href="../../d3/dbb/hu__stuff_8c.html#a20358970b1abaf992eb85e071e454653">head</a> == span, <span class="stringliteral">&quot;Linked list corrupted&quot;</span>);</div>
<div class="line"><a name="l00956"></a><span class="lineno">  956</span>&#160;    span = *<a class="code" href="../../d3/dbb/hu__stuff_8c.html#a20358970b1abaf992eb85e071e454653">head</a>;</div>
<div class="line"><a name="l00957"></a><span class="lineno">  957</span>&#160;    *<a class="code" href="../../d3/dbb/hu__stuff_8c.html#a20358970b1abaf992eb85e071e454653">head</a> = span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#ac62e0e77eb38ebff4443eb5db3ccd45c">next</a>;</div>
<div class="line"><a name="l00958"></a><span class="lineno">  958</span>&#160;}</div>
<div class="line"><a name="l00959"></a><span class="lineno">  959</span>&#160; </div>
<div class="line"><a name="l00961"></a><span class="lineno">  961</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="l00962"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#aec7913670102d551e3fd60509cd381a3">  962</a></span>&#160;<a class="code" href="../../df/dc0/rpmalloc_8c.html#aec7913670102d551e3fd60509cd381a3">_rpmalloc_span_double_link_list_remove</a>(<a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> **<a class="code" href="../../d3/dbb/hu__stuff_8c.html#a20358970b1abaf992eb85e071e454653">head</a>, <a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *span)</div>
<div class="line"><a name="l00963"></a><span class="lineno">  963</span>&#160;{</div>
<div class="line"><a name="l00964"></a><span class="lineno">  964</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#ad008ddf766a4f56fbde2edf2c51d9a87">rpmalloc_assert</a>(*<a class="code" href="../../d3/dbb/hu__stuff_8c.html#a20358970b1abaf992eb85e071e454653">head</a>, <span class="stringliteral">&quot;Linked list corrupted&quot;</span>);</div>
<div class="line"><a name="l00965"></a><span class="lineno">  965</span>&#160;    <span class="keywordflow">if</span> (*<a class="code" href="../../d3/dbb/hu__stuff_8c.html#a20358970b1abaf992eb85e071e454653">head</a> == span)</div>
<div class="line"><a name="l00966"></a><span class="lineno">  966</span>&#160;    {</div>
<div class="line"><a name="l00967"></a><span class="lineno">  967</span>&#160;        *<a class="code" href="../../d3/dbb/hu__stuff_8c.html#a20358970b1abaf992eb85e071e454653">head</a> = span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#ac62e0e77eb38ebff4443eb5db3ccd45c">next</a>;</div>
<div class="line"><a name="l00968"></a><span class="lineno">  968</span>&#160;    }</div>
<div class="line"><a name="l00969"></a><span class="lineno">  969</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l00970"></a><span class="lineno">  970</span>&#160;    {</div>
<div class="line"><a name="l00971"></a><span class="lineno">  971</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *next_span = span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#ac62e0e77eb38ebff4443eb5db3ccd45c">next</a>;</div>
<div class="line"><a name="l00972"></a><span class="lineno">  972</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *prev_span = span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a386f776cc556d33534161ece5083e4de">prev</a>;</div>
<div class="line"><a name="l00973"></a><span class="lineno">  973</span>&#160;        prev_span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#ac62e0e77eb38ebff4443eb5db3ccd45c">next</a> = next_span;</div>
<div class="line"><a name="l00974"></a><span class="lineno">  974</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="../../df/dc0/rpmalloc_8c.html#a90593dceacf0c04f14d084bed7e7eabe">EXPECTED</a>(next_span != 0))</div>
<div class="line"><a name="l00975"></a><span class="lineno">  975</span>&#160;            next_span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a386f776cc556d33534161ece5083e4de">prev</a> = prev_span;</div>
<div class="line"><a name="l00976"></a><span class="lineno">  976</span>&#160;    }</div>
<div class="line"><a name="l00977"></a><span class="lineno">  977</span>&#160;}</div>
<div class="line"><a name="l00978"></a><span class="lineno">  978</span>&#160; </div>
<div class="line"><a name="l00984"></a><span class="lineno">  984</span>&#160; </div>
<div class="line"><a name="l00985"></a><span class="lineno">  985</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="l00986"></a><span class="lineno">  986</span>&#160;<a class="code" href="../../df/dc0/rpmalloc_8c.html#abdbbc20ab63d76c1709722f3f2305610">_rpmalloc_heap_cache_insert</a>(<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#d9/d8a/structheap__t">heap_t</a> *heap, <a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *span);</div>
<div class="line"><a name="l00987"></a><span class="lineno">  987</span>&#160; </div>
<div class="line"><a name="l00988"></a><span class="lineno">  988</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="l00989"></a><span class="lineno">  989</span>&#160;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a2a1e3b11c0a8fc714d6def51250c6906">_rpmalloc_heap_finalize</a>(<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#d9/d8a/structheap__t">heap_t</a> *heap);</div>
<div class="line"><a name="l00990"></a><span class="lineno">  990</span>&#160; </div>
<div class="line"><a name="l00991"></a><span class="lineno">  991</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="l00992"></a><span class="lineno">  992</span>&#160;<a class="code" href="../../df/dc0/rpmalloc_8c.html#ae4a00ccf859d64a7519ae121563a56e7">_rpmalloc_heap_set_reserved_spans</a>(<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#d9/d8a/structheap__t">heap_t</a> *heap, <a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *master, <a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *reserve, <span class="keywordtype">size_t</span> reserve_span_count);</div>
<div class="line"><a name="l00993"></a><span class="lineno">  993</span>&#160; </div>
<div class="line"><a name="l00995"></a><span class="lineno">  995</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="l00996"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a91bf3ee061b188b8a650fbac9babef4a">  996</a></span>&#160;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a91bf3ee061b188b8a650fbac9babef4a">_rpmalloc_span_mark_as_subspan_unless_master</a>(<a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *master, <a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *subspan, <span class="keywordtype">size_t</span> span_count)</div>
<div class="line"><a name="l00997"></a><span class="lineno">  997</span>&#160;{</div>
<div class="line"><a name="l00998"></a><span class="lineno">  998</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#ad008ddf766a4f56fbde2edf2c51d9a87">rpmalloc_assert</a>((subspan != master) || (subspan-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a4de89d484559557bb639a2703c750b17">flags</a> &amp; <a class="code" href="../../df/dc0/rpmalloc_8c.html#a98c82279e204e31a5dc89b64d2c6c27c">SPAN_FLAG_MASTER</a>), <span class="stringliteral">&quot;Span master pointer and/or flag mismatch&quot;</span>);</div>
<div class="line"><a name="l00999"></a><span class="lineno">  999</span>&#160;    <span class="keywordflow">if</span> (subspan != master)</div>
<div class="line"><a name="l01000"></a><span class="lineno"> 1000</span>&#160;    {</div>
<div class="line"><a name="l01001"></a><span class="lineno"> 1001</span>&#160;        subspan-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a4de89d484559557bb639a2703c750b17">flags</a> = <a class="code" href="../../df/dc0/rpmalloc_8c.html#a2fcaea32cf5846f1f5b40a882175dbb0">SPAN_FLAG_SUBSPAN</a>;</div>
<div class="line"><a name="l01002"></a><span class="lineno"> 1002</span>&#160;        subspan-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a07d2ba73260e7e5dbe98c76436888c5f">offset_from_master</a> = (<a class="code" href="../../dd/ddd/arithmetic__operations_8c.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a>)((<a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#a4788399d1d0b37ccf098a7da82254808">uintptr_t</a>)<a class="code" href="../../df/dc0/rpmalloc_8c.html#af51a6ed47e80b1b57187f1d5be6c8b4c">pointer_diff</a>(subspan, master) &gt;&gt; <a class="code" href="../../df/dc0/rpmalloc_8c.html#adb538a1ad8a86db6b92895d9ebf6d907">_memory_span_size_shift</a>);</div>
<div class="line"><a name="l01003"></a><span class="lineno"> 1003</span>&#160;        subspan-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a13753de75bc52a5b8a1a9532083c9ba4">align_offset</a> = 0;</div>
<div class="line"><a name="l01004"></a><span class="lineno"> 1004</span>&#160;    }</div>
<div class="line"><a name="l01005"></a><span class="lineno"> 1005</span>&#160;    subspan-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#ae77d9a2cdd2a2fd46e3b27739d6c88cc">span_count</a> = (<a class="code" href="../../dd/ddd/arithmetic__operations_8c.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a>)span_count;</div>
<div class="line"><a name="l01006"></a><span class="lineno"> 1006</span>&#160;}</div>
<div class="line"><a name="l01007"></a><span class="lineno"> 1007</span>&#160; </div>
<div class="line"><a name="l01009"></a><span class="lineno"> 1009</span>&#160;<span class="keyword">static</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *</div>
<div class="line"><a name="l01010"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#ab1224666923d459edcb9bc5a7399a419"> 1010</a></span>&#160;<a class="code" href="../../df/dc0/rpmalloc_8c.html#ab1224666923d459edcb9bc5a7399a419">_rpmalloc_span_map_from_reserve</a>(<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#d9/d8a/structheap__t">heap_t</a> *heap, <span class="keywordtype">size_t</span> span_count)</div>
<div class="line"><a name="l01011"></a><span class="lineno"> 1011</span>&#160;{</div>
<div class="line"><a name="l01012"></a><span class="lineno"> 1012</span>&#160;    <span class="comment">// Update the heap span reserve</span></div>
<div class="line"><a name="l01013"></a><span class="lineno"> 1013</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *span = heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#aa549da79e540bdd3e963e294a39f64cf">span_reserve</a>;</div>
<div class="line"><a name="l01014"></a><span class="lineno"> 1014</span>&#160;    heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#aa549da79e540bdd3e963e294a39f64cf">span_reserve</a> = (<a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *)<a class="code" href="../../df/dc0/rpmalloc_8c.html#ab4225911698b67188e1538c334cfe16c">pointer_offset</a>(span, span_count * <a class="code" href="../../df/dc0/rpmalloc_8c.html#a9fefa5277fefa0c58f69d5b86d679ccb">_memory_span_size</a>);</div>
<div class="line"><a name="l01015"></a><span class="lineno"> 1015</span>&#160;    heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a8d5b27011e1ab5140090f90a75584329">spans_reserved</a> -= (<a class="code" href="../../dd/ddd/arithmetic__operations_8c.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a>)span_count;</div>
<div class="line"><a name="l01016"></a><span class="lineno"> 1016</span>&#160; </div>
<div class="line"><a name="l01017"></a><span class="lineno"> 1017</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#a91bf3ee061b188b8a650fbac9babef4a">_rpmalloc_span_mark_as_subspan_unless_master</a>(heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#aa6719c6b21d6c30ce96e404a63cc4bae">span_reserve_master</a>, span, span_count);</div>
<div class="line"><a name="l01018"></a><span class="lineno"> 1018</span>&#160;    <span class="keywordflow">if</span> (span_count &lt;= <a class="code" href="../../df/dc0/rpmalloc_8c.html#a04406da3f5ff4e24f155c97591678ed9">LARGE_CLASS_COUNT</a>)</div>
<div class="line"><a name="l01019"></a><span class="lineno"> 1019</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#ab51bbcd0d9d41ba9c6f4ad547ba77405">_rpmalloc_stat_inc</a>(&amp;heap-&gt;span_use[span_count - 1].spans_from_reserved);</div>
<div class="line"><a name="l01020"></a><span class="lineno"> 1020</span>&#160; </div>
<div class="line"><a name="l01021"></a><span class="lineno"> 1021</span>&#160;    <span class="keywordflow">return</span> span;</div>
<div class="line"><a name="l01022"></a><span class="lineno"> 1022</span>&#160;}</div>
<div class="line"><a name="l01023"></a><span class="lineno"> 1023</span>&#160; </div>
<div class="line"><a name="l01025"></a><span class="lineno"> 1025</span>&#160;<span class="keyword">static</span> <span class="keywordtype">size_t</span></div>
<div class="line"><a name="l01026"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a6780f79fe39d5c99886e27fccaf4133c"> 1026</a></span>&#160;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a6780f79fe39d5c99886e27fccaf4133c">_rpmalloc_span_align_count</a>(<span class="keywordtype">size_t</span> span_count)</div>
<div class="line"><a name="l01027"></a><span class="lineno"> 1027</span>&#160;{</div>
<div class="line"><a name="l01028"></a><span class="lineno"> 1028</span>&#160;    <span class="keywordtype">size_t</span> request_count = (span_count &gt; <a class="code" href="../../df/dc0/rpmalloc_8c.html#a3d9a7f69f3e3cc2dc7ea18d8c58b274c">_memory_span_map_count</a>) ? span_count : <a class="code" href="../../df/dc0/rpmalloc_8c.html#a3d9a7f69f3e3cc2dc7ea18d8c58b274c">_memory_span_map_count</a>;</div>
<div class="line"><a name="l01029"></a><span class="lineno"> 1029</span>&#160;    <span class="keywordflow">if</span> ((<a class="code" href="../../df/dc0/rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a> &gt; <a class="code" href="../../df/dc0/rpmalloc_8c.html#a9fefa5277fefa0c58f69d5b86d679ccb">_memory_span_size</a>) &amp;&amp; ((request_count * <a class="code" href="../../df/dc0/rpmalloc_8c.html#a9fefa5277fefa0c58f69d5b86d679ccb">_memory_span_size</a>) % <a class="code" href="../../df/dc0/rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a>))</div>
<div class="line"><a name="l01030"></a><span class="lineno"> 1030</span>&#160;        request_count += <a class="code" href="../../df/dc0/rpmalloc_8c.html#a3d9a7f69f3e3cc2dc7ea18d8c58b274c">_memory_span_map_count</a> - (request_count % <a class="code" href="../../df/dc0/rpmalloc_8c.html#a3d9a7f69f3e3cc2dc7ea18d8c58b274c">_memory_span_map_count</a>);</div>
<div class="line"><a name="l01031"></a><span class="lineno"> 1031</span>&#160;    <span class="keywordflow">return</span> request_count;</div>
<div class="line"><a name="l01032"></a><span class="lineno"> 1032</span>&#160;}</div>
<div class="line"><a name="l01033"></a><span class="lineno"> 1033</span>&#160; </div>
<div class="line"><a name="l01035"></a><span class="lineno"> 1035</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="l01036"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#ad5eb163989618d4ea0eff254cdbdd596"> 1036</a></span>&#160;<a class="code" href="../../df/dc0/rpmalloc_8c.html#ad5eb163989618d4ea0eff254cdbdd596">_rpmalloc_span_initialize</a>(<a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *span, <span class="keywordtype">size_t</span> total_span_count, <span class="keywordtype">size_t</span> span_count, <span class="keywordtype">size_t</span> align_offset)</div>
<div class="line"><a name="l01037"></a><span class="lineno"> 1037</span>&#160;{</div>
<div class="line"><a name="l01038"></a><span class="lineno"> 1038</span>&#160;    span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#af32dc4254a995d8ba3ab99376c9ad4d0">total_spans</a> = (<a class="code" href="../../dd/ddd/arithmetic__operations_8c.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a>)total_span_count;</div>
<div class="line"><a name="l01039"></a><span class="lineno"> 1039</span>&#160;    span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#ae77d9a2cdd2a2fd46e3b27739d6c88cc">span_count</a> = (<a class="code" href="../../dd/ddd/arithmetic__operations_8c.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a>)span_count;</div>
<div class="line"><a name="l01040"></a><span class="lineno"> 1040</span>&#160;    span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a13753de75bc52a5b8a1a9532083c9ba4">align_offset</a> = (<a class="code" href="../../dd/ddd/arithmetic__operations_8c.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a>)align_offset;</div>
<div class="line"><a name="l01041"></a><span class="lineno"> 1041</span>&#160;    span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a4de89d484559557bb639a2703c750b17">flags</a> = <a class="code" href="../../df/dc0/rpmalloc_8c.html#a98c82279e204e31a5dc89b64d2c6c27c">SPAN_FLAG_MASTER</a>;</div>
<div class="line"><a name="l01042"></a><span class="lineno"> 1042</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#aa1ee77cdccf0341222f64395d0be2626">atomic_store32</a>(&amp;span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a4aecbd1cbb36425fddd53125ea1a84c7">remaining_spans</a>, (<a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#a0c18914b3041c2f583aba76f418399c2">int32_t</a>)total_span_count);</div>
<div class="line"><a name="l01043"></a><span class="lineno"> 1043</span>&#160;}</div>
<div class="line"><a name="l01044"></a><span class="lineno"> 1044</span>&#160; </div>
<div class="line"><a name="l01045"></a><span class="lineno"> 1045</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="l01046"></a><span class="lineno"> 1046</span>&#160;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a1b31ff8fa0abcdb205dadd8afc026014">_rpmalloc_span_unmap</a>(<a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *span);</div>
<div class="line"><a name="l01047"></a><span class="lineno"> 1047</span>&#160; </div>
<div class="line"><a name="l01049"></a><span class="lineno"> 1049</span>&#160;<span class="keyword">static</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *</div>
<div class="line"><a name="l01050"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#ae82498bcdc6e7af0bc9adc0e75c60cee"> 1050</a></span>&#160;<a class="code" href="../../df/dc0/rpmalloc_8c.html#ae82498bcdc6e7af0bc9adc0e75c60cee">_rpmalloc_span_map_aligned_count</a>(<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#d9/d8a/structheap__t">heap_t</a> *heap, <span class="keywordtype">size_t</span> span_count)</div>
<div class="line"><a name="l01051"></a><span class="lineno"> 1051</span>&#160;{</div>
<div class="line"><a name="l01052"></a><span class="lineno"> 1052</span>&#160;    <span class="comment">// If we already have some, but not enough, reserved spans, release those to heap cache and map a new</span></div>
<div class="line"><a name="l01053"></a><span class="lineno"> 1053</span>&#160;    <span class="comment">// full set of spans. Otherwise we would waste memory if page size &gt; span size (huge pages)</span></div>
<div class="line"><a name="l01054"></a><span class="lineno"> 1054</span>&#160;    <span class="keywordtype">size_t</span> aligned_span_count = <a class="code" href="../../df/dc0/rpmalloc_8c.html#a6780f79fe39d5c99886e27fccaf4133c">_rpmalloc_span_align_count</a>(span_count);</div>
<div class="line"><a name="l01055"></a><span class="lineno"> 1055</span>&#160;    <span class="keywordtype">size_t</span> align_offset = 0;</div>
<div class="line"><a name="l01056"></a><span class="lineno"> 1056</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *span = (<a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *)<a class="code" href="../../df/dc0/rpmalloc_8c.html#a2d8a3eac487ff2943f8aae4dd20badd3">_rpmalloc_mmap</a>(aligned_span_count * <a class="code" href="../../df/dc0/rpmalloc_8c.html#a9fefa5277fefa0c58f69d5b86d679ccb">_memory_span_size</a>, &amp;align_offset);</div>
<div class="line"><a name="l01057"></a><span class="lineno"> 1057</span>&#160;    <span class="keywordflow">if</span> (!span)</div>
<div class="line"><a name="l01058"></a><span class="lineno"> 1058</span>&#160;        <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l01059"></a><span class="lineno"> 1059</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#ad5eb163989618d4ea0eff254cdbdd596">_rpmalloc_span_initialize</a>(span, aligned_span_count, span_count, align_offset);</div>
<div class="line"><a name="l01060"></a><span class="lineno"> 1060</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#ab51bbcd0d9d41ba9c6f4ad547ba77405">_rpmalloc_stat_inc</a>(&amp;_master_spans);</div>
<div class="line"><a name="l01061"></a><span class="lineno"> 1061</span>&#160;    <span class="keywordflow">if</span> (span_count &lt;= <a class="code" href="../../df/dc0/rpmalloc_8c.html#a04406da3f5ff4e24f155c97591678ed9">LARGE_CLASS_COUNT</a>)</div>
<div class="line"><a name="l01062"></a><span class="lineno"> 1062</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#ab51bbcd0d9d41ba9c6f4ad547ba77405">_rpmalloc_stat_inc</a>(&amp;heap-&gt;span_use[span_count - 1].spans_map_calls);</div>
<div class="line"><a name="l01063"></a><span class="lineno"> 1063</span>&#160;    <span class="keywordflow">if</span> (aligned_span_count &gt; span_count)</div>
<div class="line"><a name="l01064"></a><span class="lineno"> 1064</span>&#160;    {</div>
<div class="line"><a name="l01065"></a><span class="lineno"> 1065</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *reserved_spans = (<a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *)<a class="code" href="../../df/dc0/rpmalloc_8c.html#ab4225911698b67188e1538c334cfe16c">pointer_offset</a>(span, span_count * <a class="code" href="../../df/dc0/rpmalloc_8c.html#a9fefa5277fefa0c58f69d5b86d679ccb">_memory_span_size</a>);</div>
<div class="line"><a name="l01066"></a><span class="lineno"> 1066</span>&#160;        <span class="keywordtype">size_t</span> reserved_count = aligned_span_count - span_count;</div>
<div class="line"><a name="l01067"></a><span class="lineno"> 1067</span>&#160;        <span class="keywordflow">if</span> (heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a8d5b27011e1ab5140090f90a75584329">spans_reserved</a>)</div>
<div class="line"><a name="l01068"></a><span class="lineno"> 1068</span>&#160;        {</div>
<div class="line"><a name="l01069"></a><span class="lineno"> 1069</span>&#160;            <a class="code" href="../../df/dc0/rpmalloc_8c.html#a91bf3ee061b188b8a650fbac9babef4a">_rpmalloc_span_mark_as_subspan_unless_master</a>(heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#aa6719c6b21d6c30ce96e404a63cc4bae">span_reserve_master</a>, heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#aa549da79e540bdd3e963e294a39f64cf">span_reserve</a>, heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a8d5b27011e1ab5140090f90a75584329">spans_reserved</a>);</div>
<div class="line"><a name="l01070"></a><span class="lineno"> 1070</span>&#160;            <a class="code" href="../../df/dc0/rpmalloc_8c.html#abdbbc20ab63d76c1709722f3f2305610">_rpmalloc_heap_cache_insert</a>(heap, heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#aa549da79e540bdd3e963e294a39f64cf">span_reserve</a>);</div>
<div class="line"><a name="l01071"></a><span class="lineno"> 1071</span>&#160;        }</div>
<div class="line"><a name="l01072"></a><span class="lineno"> 1072</span>&#160;        <span class="keywordflow">if</span> (reserved_count &gt; <a class="code" href="../../df/dc0/rpmalloc_8c.html#ada12637cd22672d5ad52ceba482b7f5c">_memory_heap_reserve_count</a>)</div>
<div class="line"><a name="l01073"></a><span class="lineno"> 1073</span>&#160;        {</div>
<div class="line"><a name="l01074"></a><span class="lineno"> 1074</span>&#160;            <span class="comment">// If huge pages or eager spam map count, the global reserve spin lock is held by caller, _rpmalloc_span_map</span></div>
<div class="line"><a name="l01075"></a><span class="lineno"> 1075</span>&#160;            <a class="code" href="../../df/dc0/rpmalloc_8c.html#ad008ddf766a4f56fbde2edf2c51d9a87">rpmalloc_assert</a>(atomic_load32(&amp;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a1cb428169705ddd63fb35383132dbc40">_memory_global_lock</a>) == 1, <span class="stringliteral">&quot;Global spin lock not held as expected&quot;</span>);</div>
<div class="line"><a name="l01076"></a><span class="lineno"> 1076</span>&#160;            <span class="keywordtype">size_t</span> remain_count = reserved_count - <a class="code" href="../../df/dc0/rpmalloc_8c.html#ada12637cd22672d5ad52ceba482b7f5c">_memory_heap_reserve_count</a>;</div>
<div class="line"><a name="l01077"></a><span class="lineno"> 1077</span>&#160;            reserved_count = <a class="code" href="../../df/dc0/rpmalloc_8c.html#ada12637cd22672d5ad52ceba482b7f5c">_memory_heap_reserve_count</a>;</div>
<div class="line"><a name="l01078"></a><span class="lineno"> 1078</span>&#160;            <a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *remain_span = (<a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *)<a class="code" href="../../df/dc0/rpmalloc_8c.html#ab4225911698b67188e1538c334cfe16c">pointer_offset</a>(reserved_spans, reserved_count * <a class="code" href="../../df/dc0/rpmalloc_8c.html#a9fefa5277fefa0c58f69d5b86d679ccb">_memory_span_size</a>);</div>
<div class="line"><a name="l01079"></a><span class="lineno"> 1079</span>&#160;            <span class="keywordflow">if</span> (<a class="code" href="../../df/dc0/rpmalloc_8c.html#a411d5d6c063a099c1a08fa853851b764">_memory_global_reserve</a>)</div>
<div class="line"><a name="l01080"></a><span class="lineno"> 1080</span>&#160;            {</div>
<div class="line"><a name="l01081"></a><span class="lineno"> 1081</span>&#160;                <a class="code" href="../../df/dc0/rpmalloc_8c.html#a91bf3ee061b188b8a650fbac9babef4a">_rpmalloc_span_mark_as_subspan_unless_master</a>(<a class="code" href="../../df/dc0/rpmalloc_8c.html#a1d5126b78d2bb31fe3476abcd07dd801">_memory_global_reserve_master</a>, <a class="code" href="../../df/dc0/rpmalloc_8c.html#a411d5d6c063a099c1a08fa853851b764">_memory_global_reserve</a>, <a class="code" href="../../df/dc0/rpmalloc_8c.html#a19d785146ca5053c2da69ad1ec4de94c">_memory_global_reserve_count</a>);</div>
<div class="line"><a name="l01082"></a><span class="lineno"> 1082</span>&#160;                <a class="code" href="../../df/dc0/rpmalloc_8c.html#a1b31ff8fa0abcdb205dadd8afc026014">_rpmalloc_span_unmap</a>(<a class="code" href="../../df/dc0/rpmalloc_8c.html#a411d5d6c063a099c1a08fa853851b764">_memory_global_reserve</a>);</div>
<div class="line"><a name="l01083"></a><span class="lineno"> 1083</span>&#160;            }</div>
<div class="line"><a name="l01084"></a><span class="lineno"> 1084</span>&#160;            <a class="code" href="../../df/dc0/rpmalloc_8c.html#aa6d37b325f0f3c68f89cdf681681a09f">_rpmalloc_global_set_reserved_spans</a>(span, remain_span, remain_count);</div>
<div class="line"><a name="l01085"></a><span class="lineno"> 1085</span>&#160;        }</div>
<div class="line"><a name="l01086"></a><span class="lineno"> 1086</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#ae4a00ccf859d64a7519ae121563a56e7">_rpmalloc_heap_set_reserved_spans</a>(heap, span, reserved_spans, reserved_count);</div>
<div class="line"><a name="l01087"></a><span class="lineno"> 1087</span>&#160;    }</div>
<div class="line"><a name="l01088"></a><span class="lineno"> 1088</span>&#160;    <span class="keywordflow">return</span> span;</div>
<div class="line"><a name="l01089"></a><span class="lineno"> 1089</span>&#160;}</div>
<div class="line"><a name="l01090"></a><span class="lineno"> 1090</span>&#160; </div>
<div class="line"><a name="l01092"></a><span class="lineno"> 1092</span>&#160;<span class="keyword">static</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *</div>
<div class="line"><a name="l01093"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a80aeb0b9294d1463006c963e7073244e"> 1093</a></span>&#160;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a80aeb0b9294d1463006c963e7073244e">_rpmalloc_span_map</a>(<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#d9/d8a/structheap__t">heap_t</a> *heap, <span class="keywordtype">size_t</span> span_count)</div>
<div class="line"><a name="l01094"></a><span class="lineno"> 1094</span>&#160;{</div>
<div class="line"><a name="l01095"></a><span class="lineno"> 1095</span>&#160;    <span class="keywordflow">if</span> (span_count &lt;= heap-&gt;spans_reserved)</div>
<div class="line"><a name="l01096"></a><span class="lineno"> 1096</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#ab1224666923d459edcb9bc5a7399a419">_rpmalloc_span_map_from_reserve</a>(heap, span_count);</div>
<div class="line"><a name="l01097"></a><span class="lineno"> 1097</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *span = 0;</div>
<div class="line"><a name="l01098"></a><span class="lineno"> 1098</span>&#160;    <span class="keywordtype">int</span> use_global_reserve = (<a class="code" href="../../df/dc0/rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a> &gt; <a class="code" href="../../df/dc0/rpmalloc_8c.html#a9fefa5277fefa0c58f69d5b86d679ccb">_memory_span_size</a>) || (<a class="code" href="../../df/dc0/rpmalloc_8c.html#a3d9a7f69f3e3cc2dc7ea18d8c58b274c">_memory_span_map_count</a> &gt; <a class="code" href="../../df/dc0/rpmalloc_8c.html#ada12637cd22672d5ad52ceba482b7f5c">_memory_heap_reserve_count</a>);</div>
<div class="line"><a name="l01099"></a><span class="lineno"> 1099</span>&#160;    <span class="keywordflow">if</span> (use_global_reserve)</div>
<div class="line"><a name="l01100"></a><span class="lineno"> 1100</span>&#160;    {</div>
<div class="line"><a name="l01101"></a><span class="lineno"> 1101</span>&#160;        <span class="comment">// If huge pages, make sure only one thread maps more memory to avoid bloat</span></div>
<div class="line"><a name="l01102"></a><span class="lineno"> 1102</span>&#160;        <span class="keywordflow">while</span> (!<a class="code" href="../../df/dc0/rpmalloc_8c.html#a2071bf7ebae50eced1f16b359f9d5c7d">atomic_cas32_acquire</a>(&amp;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a1cb428169705ddd63fb35383132dbc40">_memory_global_lock</a>, 1, 0))</div>
<div class="line"><a name="l01103"></a><span class="lineno"> 1103</span>&#160;            <a class="code" href="../../df/dc0/rpmalloc_8c.html#a335307d78e0ff77d4da9cf42156803ec">_rpmalloc_spin</a>();</div>
<div class="line"><a name="l01104"></a><span class="lineno"> 1104</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="../../df/dc0/rpmalloc_8c.html#a19d785146ca5053c2da69ad1ec4de94c">_memory_global_reserve_count</a> &gt;= span_count)</div>
<div class="line"><a name="l01105"></a><span class="lineno"> 1105</span>&#160;        {</div>
<div class="line"><a name="l01106"></a><span class="lineno"> 1106</span>&#160;            <span class="keywordtype">size_t</span> reserve_count = (!heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a8d5b27011e1ab5140090f90a75584329">spans_reserved</a> ? <a class="code" href="../../df/dc0/rpmalloc_8c.html#ada12637cd22672d5ad52ceba482b7f5c">_memory_heap_reserve_count</a> : span_count);</div>
<div class="line"><a name="l01107"></a><span class="lineno"> 1107</span>&#160;            <span class="keywordflow">if</span> (<a class="code" href="../../df/dc0/rpmalloc_8c.html#a19d785146ca5053c2da69ad1ec4de94c">_memory_global_reserve_count</a> &lt; reserve_count)</div>
<div class="line"><a name="l01108"></a><span class="lineno"> 1108</span>&#160;                reserve_count = <a class="code" href="../../df/dc0/rpmalloc_8c.html#a19d785146ca5053c2da69ad1ec4de94c">_memory_global_reserve_count</a>;</div>
<div class="line"><a name="l01109"></a><span class="lineno"> 1109</span>&#160;            span = <a class="code" href="../../df/dc0/rpmalloc_8c.html#abc75935ba437c535deefc42928807231">_rpmalloc_global_get_reserved_spans</a>(reserve_count);</div>
<div class="line"><a name="l01110"></a><span class="lineno"> 1110</span>&#160;            <span class="keywordflow">if</span> (span)</div>
<div class="line"><a name="l01111"></a><span class="lineno"> 1111</span>&#160;            {</div>
<div class="line"><a name="l01112"></a><span class="lineno"> 1112</span>&#160;                <span class="keywordflow">if</span> (reserve_count &gt; span_count)</div>
<div class="line"><a name="l01113"></a><span class="lineno"> 1113</span>&#160;                {</div>
<div class="line"><a name="l01114"></a><span class="lineno"> 1114</span>&#160;                    <a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *reserved_span = (<a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *)<a class="code" href="../../df/dc0/rpmalloc_8c.html#ab4225911698b67188e1538c334cfe16c">pointer_offset</a>(span, span_count &lt;&lt; <a class="code" href="../../df/dc0/rpmalloc_8c.html#adb538a1ad8a86db6b92895d9ebf6d907">_memory_span_size_shift</a>);</div>
<div class="line"><a name="l01115"></a><span class="lineno"> 1115</span>&#160;                    <a class="code" href="../../df/dc0/rpmalloc_8c.html#ae4a00ccf859d64a7519ae121563a56e7">_rpmalloc_heap_set_reserved_spans</a>(heap, <a class="code" href="../../df/dc0/rpmalloc_8c.html#a1d5126b78d2bb31fe3476abcd07dd801">_memory_global_reserve_master</a>, reserved_span, reserve_count - span_count);</div>
<div class="line"><a name="l01116"></a><span class="lineno"> 1116</span>&#160;                }</div>
<div class="line"><a name="l01117"></a><span class="lineno"> 1117</span>&#160;                <span class="comment">// Already marked as subspan in _rpmalloc_global_get_reserved_spans</span></div>
<div class="line"><a name="l01118"></a><span class="lineno"> 1118</span>&#160;                span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#ae77d9a2cdd2a2fd46e3b27739d6c88cc">span_count</a> = (<a class="code" href="../../dd/ddd/arithmetic__operations_8c.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a>)span_count;</div>
<div class="line"><a name="l01119"></a><span class="lineno"> 1119</span>&#160;            }</div>
<div class="line"><a name="l01120"></a><span class="lineno"> 1120</span>&#160;        }</div>
<div class="line"><a name="l01121"></a><span class="lineno"> 1121</span>&#160;    }</div>
<div class="line"><a name="l01122"></a><span class="lineno"> 1122</span>&#160;    <span class="keywordflow">if</span> (!span)</div>
<div class="line"><a name="l01123"></a><span class="lineno"> 1123</span>&#160;        span = <a class="code" href="../../df/dc0/rpmalloc_8c.html#ae82498bcdc6e7af0bc9adc0e75c60cee">_rpmalloc_span_map_aligned_count</a>(heap, span_count);</div>
<div class="line"><a name="l01124"></a><span class="lineno"> 1124</span>&#160;    <span class="keywordflow">if</span> (use_global_reserve)</div>
<div class="line"><a name="l01125"></a><span class="lineno"> 1125</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#a2a87a6060d5387fe8491a00600073687">atomic_store32_release</a>(&amp;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a1cb428169705ddd63fb35383132dbc40">_memory_global_lock</a>, 0);</div>
<div class="line"><a name="l01126"></a><span class="lineno"> 1126</span>&#160;    <span class="keywordflow">return</span> span;</div>
<div class="line"><a name="l01127"></a><span class="lineno"> 1127</span>&#160;}</div>
<div class="line"><a name="l01128"></a><span class="lineno"> 1128</span>&#160; </div>
<div class="line"><a name="l01130"></a><span class="lineno"> 1130</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="l01131"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a1b31ff8fa0abcdb205dadd8afc026014"> 1131</a></span>&#160;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a1b31ff8fa0abcdb205dadd8afc026014">_rpmalloc_span_unmap</a>(<a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *span)</div>
<div class="line"><a name="l01132"></a><span class="lineno"> 1132</span>&#160;{</div>
<div class="line"><a name="l01133"></a><span class="lineno"> 1133</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#ad008ddf766a4f56fbde2edf2c51d9a87">rpmalloc_assert</a>((span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a4de89d484559557bb639a2703c750b17">flags</a> &amp; <a class="code" href="../../df/dc0/rpmalloc_8c.html#a98c82279e204e31a5dc89b64d2c6c27c">SPAN_FLAG_MASTER</a>) || (span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a4de89d484559557bb639a2703c750b17">flags</a> &amp; <a class="code" href="../../df/dc0/rpmalloc_8c.html#a2fcaea32cf5846f1f5b40a882175dbb0">SPAN_FLAG_SUBSPAN</a>), <span class="stringliteral">&quot;Span flag corrupted&quot;</span>);</div>
<div class="line"><a name="l01134"></a><span class="lineno"> 1134</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#ad008ddf766a4f56fbde2edf2c51d9a87">rpmalloc_assert</a>(!(span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a4de89d484559557bb639a2703c750b17">flags</a> &amp; <a class="code" href="../../df/dc0/rpmalloc_8c.html#a98c82279e204e31a5dc89b64d2c6c27c">SPAN_FLAG_MASTER</a>) || !(span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a4de89d484559557bb639a2703c750b17">flags</a> &amp; <a class="code" href="../../df/dc0/rpmalloc_8c.html#a2fcaea32cf5846f1f5b40a882175dbb0">SPAN_FLAG_SUBSPAN</a>), <span class="stringliteral">&quot;Span flag corrupted&quot;</span>);</div>
<div class="line"><a name="l01135"></a><span class="lineno"> 1135</span>&#160; </div>
<div class="line"><a name="l01136"></a><span class="lineno"> 1136</span>&#160;    <span class="keywordtype">int</span> is_master = !!(span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a4de89d484559557bb639a2703c750b17">flags</a> &amp; <a class="code" href="../../df/dc0/rpmalloc_8c.html#a98c82279e204e31a5dc89b64d2c6c27c">SPAN_FLAG_MASTER</a>);</div>
<div class="line"><a name="l01137"></a><span class="lineno"> 1137</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *master = is_master ? span : ((<a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *)<a class="code" href="../../df/dc0/rpmalloc_8c.html#ab4225911698b67188e1538c334cfe16c">pointer_offset</a>(span, -(<a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#a0bd5dec00e345e69027427f8621d6a6c">intptr_t</a>)((<a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#a4788399d1d0b37ccf098a7da82254808">uintptr_t</a>)span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a07d2ba73260e7e5dbe98c76436888c5f">offset_from_master</a> * <a class="code" href="../../df/dc0/rpmalloc_8c.html#a9fefa5277fefa0c58f69d5b86d679ccb">_memory_span_size</a>)));</div>
<div class="line"><a name="l01138"></a><span class="lineno"> 1138</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#ad008ddf766a4f56fbde2edf2c51d9a87">rpmalloc_assert</a>(is_master || (span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a4de89d484559557bb639a2703c750b17">flags</a> &amp; <a class="code" href="../../df/dc0/rpmalloc_8c.html#a2fcaea32cf5846f1f5b40a882175dbb0">SPAN_FLAG_SUBSPAN</a>), <span class="stringliteral">&quot;Span flag corrupted&quot;</span>);</div>
<div class="line"><a name="l01139"></a><span class="lineno"> 1139</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#ad008ddf766a4f56fbde2edf2c51d9a87">rpmalloc_assert</a>(master-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a4de89d484559557bb639a2703c750b17">flags</a> &amp; <a class="code" href="../../df/dc0/rpmalloc_8c.html#a98c82279e204e31a5dc89b64d2c6c27c">SPAN_FLAG_MASTER</a>, <span class="stringliteral">&quot;Span flag corrupted&quot;</span>);</div>
<div class="line"><a name="l01140"></a><span class="lineno"> 1140</span>&#160; </div>
<div class="line"><a name="l01141"></a><span class="lineno"> 1141</span>&#160;    <span class="keywordtype">size_t</span> span_count = span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#ae77d9a2cdd2a2fd46e3b27739d6c88cc">span_count</a>;</div>
<div class="line"><a name="l01142"></a><span class="lineno"> 1142</span>&#160;    <span class="keywordflow">if</span> (!is_master)</div>
<div class="line"><a name="l01143"></a><span class="lineno"> 1143</span>&#160;    {</div>
<div class="line"><a name="l01144"></a><span class="lineno"> 1144</span>&#160;        <span class="comment">// Directly unmap subspans (unless huge pages, in which case we defer and unmap entire page range with master)</span></div>
<div class="line"><a name="l01145"></a><span class="lineno"> 1145</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#ad008ddf766a4f56fbde2edf2c51d9a87">rpmalloc_assert</a>(span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a13753de75bc52a5b8a1a9532083c9ba4">align_offset</a> == 0, <span class="stringliteral">&quot;Span align offset corrupted&quot;</span>);</div>
<div class="line"><a name="l01146"></a><span class="lineno"> 1146</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="../../df/dc0/rpmalloc_8c.html#a9fefa5277fefa0c58f69d5b86d679ccb">_memory_span_size</a> &gt;= <a class="code" href="../../df/dc0/rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a>)</div>
<div class="line"><a name="l01147"></a><span class="lineno"> 1147</span>&#160;            <a class="code" href="../../df/dc0/rpmalloc_8c.html#abfbbb8e2f9b086d466fe2898a283c98d">_rpmalloc_unmap</a>(span, span_count * <a class="code" href="../../df/dc0/rpmalloc_8c.html#a9fefa5277fefa0c58f69d5b86d679ccb">_memory_span_size</a>, 0, 0);</div>
<div class="line"><a name="l01148"></a><span class="lineno"> 1148</span>&#160;    }</div>
<div class="line"><a name="l01149"></a><span class="lineno"> 1149</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l01150"></a><span class="lineno"> 1150</span>&#160;    {</div>
<div class="line"><a name="l01151"></a><span class="lineno"> 1151</span>&#160;        <span class="comment">// Special double flag to denote an unmapped master</span></div>
<div class="line"><a name="l01152"></a><span class="lineno"> 1152</span>&#160;        <span class="comment">// It must be kept in memory since span header must be used</span></div>
<div class="line"><a name="l01153"></a><span class="lineno"> 1153</span>&#160;        span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a4de89d484559557bb639a2703c750b17">flags</a> |= <a class="code" href="../../df/dc0/rpmalloc_8c.html#a98c82279e204e31a5dc89b64d2c6c27c">SPAN_FLAG_MASTER</a> | <a class="code" href="../../df/dc0/rpmalloc_8c.html#a2fcaea32cf5846f1f5b40a882175dbb0">SPAN_FLAG_SUBSPAN</a> | <a class="code" href="../../df/dc0/rpmalloc_8c.html#a132ac3786920f0bf24b2d2f7c73cf863">SPAN_FLAG_UNMAPPED_MASTER</a>;</div>
<div class="line"><a name="l01154"></a><span class="lineno"> 1154</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#a4a53d0cfdcf755d4fbbae446a055440c">_rpmalloc_stat_add</a>(&amp;_unmapped_master_spans, 1);</div>
<div class="line"><a name="l01155"></a><span class="lineno"> 1155</span>&#160;    }</div>
<div class="line"><a name="l01156"></a><span class="lineno"> 1156</span>&#160; </div>
<div class="line"><a name="l01157"></a><span class="lineno"> 1157</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="../../df/dc0/rpmalloc_8c.html#af327588f7260778f453d9a212396e0e0">atomic_add32</a>(&amp;master-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a4aecbd1cbb36425fddd53125ea1a84c7">remaining_spans</a>, -(<a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#a0c18914b3041c2f583aba76f418399c2">int32_t</a>)span_count) &lt;= 0)</div>
<div class="line"><a name="l01158"></a><span class="lineno"> 1158</span>&#160;    {</div>
<div class="line"><a name="l01159"></a><span class="lineno"> 1159</span>&#160;        <span class="comment">// Everything unmapped, unmap the master span with release flag to unmap the entire range of the super span</span></div>
<div class="line"><a name="l01160"></a><span class="lineno"> 1160</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#ad008ddf766a4f56fbde2edf2c51d9a87">rpmalloc_assert</a>(!!(master-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a4de89d484559557bb639a2703c750b17">flags</a> &amp; <a class="code" href="../../df/dc0/rpmalloc_8c.html#a98c82279e204e31a5dc89b64d2c6c27c">SPAN_FLAG_MASTER</a>) &amp;&amp; !!(master-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a4de89d484559557bb639a2703c750b17">flags</a> &amp; <a class="code" href="../../df/dc0/rpmalloc_8c.html#a2fcaea32cf5846f1f5b40a882175dbb0">SPAN_FLAG_SUBSPAN</a>), <span class="stringliteral">&quot;Span flag corrupted&quot;</span>);</div>
<div class="line"><a name="l01161"></a><span class="lineno"> 1161</span>&#160;        <span class="keywordtype">size_t</span> unmap_count = master-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#ae77d9a2cdd2a2fd46e3b27739d6c88cc">span_count</a>;</div>
<div class="line"><a name="l01162"></a><span class="lineno"> 1162</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="../../df/dc0/rpmalloc_8c.html#a9fefa5277fefa0c58f69d5b86d679ccb">_memory_span_size</a> &lt; <a class="code" href="../../df/dc0/rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a>)</div>
<div class="line"><a name="l01163"></a><span class="lineno"> 1163</span>&#160;            unmap_count = master-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#af32dc4254a995d8ba3ab99376c9ad4d0">total_spans</a>;</div>
<div class="line"><a name="l01164"></a><span class="lineno"> 1164</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#a829d3a1ca51d0ba687990a8111940c42">_rpmalloc_stat_sub</a>(&amp;_master_spans, 1);</div>
<div class="line"><a name="l01165"></a><span class="lineno"> 1165</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#a829d3a1ca51d0ba687990a8111940c42">_rpmalloc_stat_sub</a>(&amp;_unmapped_master_spans, 1);</div>
<div class="line"><a name="l01166"></a><span class="lineno"> 1166</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#abfbbb8e2f9b086d466fe2898a283c98d">_rpmalloc_unmap</a>(master, unmap_count * <a class="code" href="../../df/dc0/rpmalloc_8c.html#a9fefa5277fefa0c58f69d5b86d679ccb">_memory_span_size</a>, master-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a13753de75bc52a5b8a1a9532083c9ba4">align_offset</a>, (<span class="keywordtype">size_t</span>)master-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#af32dc4254a995d8ba3ab99376c9ad4d0">total_spans</a> * <a class="code" href="../../df/dc0/rpmalloc_8c.html#a9fefa5277fefa0c58f69d5b86d679ccb">_memory_span_size</a>);</div>
<div class="line"><a name="l01167"></a><span class="lineno"> 1167</span>&#160;    }</div>
<div class="line"><a name="l01168"></a><span class="lineno"> 1168</span>&#160;}</div>
<div class="line"><a name="l01169"></a><span class="lineno"> 1169</span>&#160; </div>
<div class="line"><a name="l01171"></a><span class="lineno"> 1171</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="l01172"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a62b31eca2760e37676716c54c5b64947"> 1172</a></span>&#160;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a62b31eca2760e37676716c54c5b64947">_rpmalloc_span_release_to_cache</a>(<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#d9/d8a/structheap__t">heap_t</a> *heap, <a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *span)</div>
<div class="line"><a name="l01173"></a><span class="lineno"> 1173</span>&#160;{</div>
<div class="line"><a name="l01174"></a><span class="lineno"> 1174</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#ad008ddf766a4f56fbde2edf2c51d9a87">rpmalloc_assert</a>(heap == span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a345270ce5d1e5e112b45cfde43f37da0">heap</a>, <span class="stringliteral">&quot;Span heap pointer corrupted&quot;</span>);</div>
<div class="line"><a name="l01175"></a><span class="lineno"> 1175</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#ad008ddf766a4f56fbde2edf2c51d9a87">rpmalloc_assert</a>(span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a5a977febdd2e9ae15bcf66f83d0cf817">size_class</a> &lt; <a class="code" href="../../df/dc0/rpmalloc_8c.html#aa74d427b2b9955ff2d9719693d9fc80e">SIZE_CLASS_COUNT</a>, <span class="stringliteral">&quot;Invalid span size class&quot;</span>);</div>
<div class="line"><a name="l01176"></a><span class="lineno"> 1176</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#ad008ddf766a4f56fbde2edf2c51d9a87">rpmalloc_assert</a>(span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#ae77d9a2cdd2a2fd46e3b27739d6c88cc">span_count</a> == 1, <span class="stringliteral">&quot;Invalid span count&quot;</span>);</div>
<div class="line"><a name="l01177"></a><span class="lineno"> 1177</span>&#160;<span class="preprocessor">#if ENABLE_ADAPTIVE_THREAD_CACHE || ENABLE_STATISTICS</span></div>
<div class="line"><a name="l01178"></a><span class="lineno"> 1178</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#a4f0dc3c548801773a4da1c96f39b04c9">atomic_decr32</a>(&amp;heap-&gt;span_use[0].current);</div>
<div class="line"><a name="l01179"></a><span class="lineno"> 1179</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01180"></a><span class="lineno"> 1180</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#aab22b36fb2408434cc731fb9fe6a5cec">_rpmalloc_stat_dec</a>(&amp;heap-&gt;size_class_use[span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a5a977febdd2e9ae15bcf66f83d0cf817">size_class</a>].spans_current);</div>
<div class="line"><a name="l01181"></a><span class="lineno"> 1181</span>&#160;    <span class="keywordflow">if</span> (!heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a13ccab5430ace95c471aacf1fab0fcd6">finalize</a>)</div>
<div class="line"><a name="l01182"></a><span class="lineno"> 1182</span>&#160;    {</div>
<div class="line"><a name="l01183"></a><span class="lineno"> 1183</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#ab51bbcd0d9d41ba9c6f4ad547ba77405">_rpmalloc_stat_inc</a>(&amp;heap-&gt;span_use[0].spans_to_cache);</div>
<div class="line"><a name="l01184"></a><span class="lineno"> 1184</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#ab51bbcd0d9d41ba9c6f4ad547ba77405">_rpmalloc_stat_inc</a>(&amp;heap-&gt;size_class_use[span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a5a977febdd2e9ae15bcf66f83d0cf817">size_class</a>].spans_to_cache);</div>
<div class="line"><a name="l01185"></a><span class="lineno"> 1185</span>&#160;        <span class="keywordflow">if</span> (heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a70f9a96b9071ccb6642894f5a7f56432">size_class</a>[span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a5a977febdd2e9ae15bcf66f83d0cf817">size_class</a>].<a class="code" href="../../df/dc0/rpmalloc_8c.html#a72cb3beffa763418cb7c8e89ff257b8e">cache</a>)</div>
<div class="line"><a name="l01186"></a><span class="lineno"> 1186</span>&#160;            <a class="code" href="../../df/dc0/rpmalloc_8c.html#abdbbc20ab63d76c1709722f3f2305610">_rpmalloc_heap_cache_insert</a>(heap, heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a70f9a96b9071ccb6642894f5a7f56432">size_class</a>[span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a5a977febdd2e9ae15bcf66f83d0cf817">size_class</a>].<a class="code" href="../../df/dc0/rpmalloc_8c.html#a72cb3beffa763418cb7c8e89ff257b8e">cache</a>);</div>
<div class="line"><a name="l01187"></a><span class="lineno"> 1187</span>&#160;        heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a70f9a96b9071ccb6642894f5a7f56432">size_class</a>[span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a5a977febdd2e9ae15bcf66f83d0cf817">size_class</a>].<a class="code" href="../../df/dc0/rpmalloc_8c.html#a72cb3beffa763418cb7c8e89ff257b8e">cache</a> = span;</div>
<div class="line"><a name="l01188"></a><span class="lineno"> 1188</span>&#160;    }</div>
<div class="line"><a name="l01189"></a><span class="lineno"> 1189</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l01190"></a><span class="lineno"> 1190</span>&#160;    {</div>
<div class="line"><a name="l01191"></a><span class="lineno"> 1191</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#a1b31ff8fa0abcdb205dadd8afc026014">_rpmalloc_span_unmap</a>(span);</div>
<div class="line"><a name="l01192"></a><span class="lineno"> 1192</span>&#160;    }</div>
<div class="line"><a name="l01193"></a><span class="lineno"> 1193</span>&#160;}</div>
<div class="line"><a name="l01194"></a><span class="lineno"> 1194</span>&#160; </div>
<div class="line"><a name="l01197"></a><span class="lineno"> 1197</span>&#160;<span class="keyword">static</span> <a class="code" href="../../dd/ddd/arithmetic__operations_8c.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a></div>
<div class="line"><a name="l01198"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#addf543f30c5eefc1dded60025c78a816"> 1198</a></span>&#160;<a class="code" href="../../df/dc0/rpmalloc_8c.html#addf543f30c5eefc1dded60025c78a816">free_list_partial_init</a>(<span class="keywordtype">void</span> **list, <span class="keywordtype">void</span> **first_block, <span class="keywordtype">void</span> *page_start, <span class="keywordtype">void</span> *block_start, <a class="code" href="../../dd/ddd/arithmetic__operations_8c.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a> block_count, <a class="code" href="../../dd/ddd/arithmetic__operations_8c.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a> block_size)</div>
<div class="line"><a name="l01199"></a><span class="lineno"> 1199</span>&#160;{</div>
<div class="line"><a name="l01200"></a><span class="lineno"> 1200</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#ad008ddf766a4f56fbde2edf2c51d9a87">rpmalloc_assert</a>(block_count, <span class="stringliteral">&quot;Internal failure&quot;</span>);</div>
<div class="line"><a name="l01201"></a><span class="lineno"> 1201</span>&#160;    *first_block = block_start;</div>
<div class="line"><a name="l01202"></a><span class="lineno"> 1202</span>&#160;    <span class="keywordflow">if</span> (block_count &gt; 1)</div>
<div class="line"><a name="l01203"></a><span class="lineno"> 1203</span>&#160;    {</div>
<div class="line"><a name="l01204"></a><span class="lineno"> 1204</span>&#160;        <span class="keywordtype">void</span> *free_block = <a class="code" href="../../df/dc0/rpmalloc_8c.html#ab4225911698b67188e1538c334cfe16c">pointer_offset</a>(block_start, block_size);</div>
<div class="line"><a name="l01205"></a><span class="lineno"> 1205</span>&#160;        <span class="keywordtype">void</span> *block_end = <a class="code" href="../../df/dc0/rpmalloc_8c.html#ab4225911698b67188e1538c334cfe16c">pointer_offset</a>(block_start, (<span class="keywordtype">size_t</span>)block_size * block_count);</div>
<div class="line"><a name="l01206"></a><span class="lineno"> 1206</span>&#160;        <span class="comment">// If block size is less than half a memory page, bound init to next memory page boundary</span></div>
<div class="line"><a name="l01207"></a><span class="lineno"> 1207</span>&#160;        <span class="keywordflow">if</span> (block_size &lt; (<a class="code" href="../../df/dc0/rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a> &gt;&gt; 1))</div>
<div class="line"><a name="l01208"></a><span class="lineno"> 1208</span>&#160;        {</div>
<div class="line"><a name="l01209"></a><span class="lineno"> 1209</span>&#160;            <span class="keywordtype">void</span> *page_end = <a class="code" href="../../df/dc0/rpmalloc_8c.html#ab4225911698b67188e1538c334cfe16c">pointer_offset</a>(page_start, <a class="code" href="../../df/dc0/rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a>);</div>
<div class="line"><a name="l01210"></a><span class="lineno"> 1210</span>&#160;            <span class="keywordflow">if</span> (page_end &lt; block_end)</div>
<div class="line"><a name="l01211"></a><span class="lineno"> 1211</span>&#160;                block_end = page_end;</div>
<div class="line"><a name="l01212"></a><span class="lineno"> 1212</span>&#160;        }</div>
<div class="line"><a name="l01213"></a><span class="lineno"> 1213</span>&#160;        *list = free_block;</div>
<div class="line"><a name="l01214"></a><span class="lineno"> 1214</span>&#160;        block_count = 2;</div>
<div class="line"><a name="l01215"></a><span class="lineno"> 1215</span>&#160;        <span class="keywordtype">void</span> *next_block = <a class="code" href="../../df/dc0/rpmalloc_8c.html#ab4225911698b67188e1538c334cfe16c">pointer_offset</a>(free_block, block_size);</div>
<div class="line"><a name="l01216"></a><span class="lineno"> 1216</span>&#160;        <span class="keywordflow">while</span> (next_block &lt; block_end)</div>
<div class="line"><a name="l01217"></a><span class="lineno"> 1217</span>&#160;        {</div>
<div class="line"><a name="l01218"></a><span class="lineno"> 1218</span>&#160;            *((<span class="keywordtype">void</span> **)free_block) = next_block;</div>
<div class="line"><a name="l01219"></a><span class="lineno"> 1219</span>&#160;            free_block = next_block;</div>
<div class="line"><a name="l01220"></a><span class="lineno"> 1220</span>&#160;            ++block_count;</div>
<div class="line"><a name="l01221"></a><span class="lineno"> 1221</span>&#160;            next_block = <a class="code" href="../../df/dc0/rpmalloc_8c.html#ab4225911698b67188e1538c334cfe16c">pointer_offset</a>(next_block, block_size);</div>
<div class="line"><a name="l01222"></a><span class="lineno"> 1222</span>&#160;        }</div>
<div class="line"><a name="l01223"></a><span class="lineno"> 1223</span>&#160;        *((<span class="keywordtype">void</span> **)free_block) = 0;</div>
<div class="line"><a name="l01224"></a><span class="lineno"> 1224</span>&#160;    }</div>
<div class="line"><a name="l01225"></a><span class="lineno"> 1225</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l01226"></a><span class="lineno"> 1226</span>&#160;    {</div>
<div class="line"><a name="l01227"></a><span class="lineno"> 1227</span>&#160;        *list = 0;</div>
<div class="line"><a name="l01228"></a><span class="lineno"> 1228</span>&#160;    }</div>
<div class="line"><a name="l01229"></a><span class="lineno"> 1229</span>&#160;    <span class="keywordflow">return</span> block_count;</div>
<div class="line"><a name="l01230"></a><span class="lineno"> 1230</span>&#160;}</div>
<div class="line"><a name="l01231"></a><span class="lineno"> 1231</span>&#160; </div>
<div class="line"><a name="l01233"></a><span class="lineno"> 1233</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> *</div>
<div class="line"><a name="l01234"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#addaef25db6ed1f3f0308ad7464745828"> 1234</a></span>&#160;<a class="code" href="../../df/dc0/rpmalloc_8c.html#addaef25db6ed1f3f0308ad7464745828">_rpmalloc_span_initialize_new</a>(<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#d9/d8a/structheap__t">heap_t</a> *heap, <a class="code" href="../../df/dc0/rpmalloc_8c.html#d3/dad/structheap__size__class__t">heap_size_class_t</a> *heap_size_class, <a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *span, <a class="code" href="../../dd/ddd/arithmetic__operations_8c.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a> class_idx)</div>
<div class="line"><a name="l01235"></a><span class="lineno"> 1235</span>&#160;{</div>
<div class="line"><a name="l01236"></a><span class="lineno"> 1236</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#ad008ddf766a4f56fbde2edf2c51d9a87">rpmalloc_assert</a>(span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#ae77d9a2cdd2a2fd46e3b27739d6c88cc">span_count</a> == 1, <span class="stringliteral">&quot;Internal failure&quot;</span>);</div>
<div class="line"><a name="l01237"></a><span class="lineno"> 1237</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#d2/daa/structsize__class__t">size_class_t</a> *size_class = <a class="code" href="../../df/dc0/rpmalloc_8c.html#a33cddb08b9ee0f969cc82dbf9cddb947">_memory_size_class</a> + class_idx;</div>
<div class="line"><a name="l01238"></a><span class="lineno"> 1238</span>&#160;    span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a5a977febdd2e9ae15bcf66f83d0cf817">size_class</a> = class_idx;</div>
<div class="line"><a name="l01239"></a><span class="lineno"> 1239</span>&#160;    span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a345270ce5d1e5e112b45cfde43f37da0">heap</a> = heap;</div>
<div class="line"><a name="l01240"></a><span class="lineno"> 1240</span>&#160;    span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a4de89d484559557bb639a2703c750b17">flags</a> &amp;= ~<a class="code" href="../../df/dc0/rpmalloc_8c.html#ad1094486bd3e5ee282e7a4ce7de9c7db">SPAN_FLAG_ALIGNED_BLOCKS</a>;</div>
<div class="line"><a name="l01241"></a><span class="lineno"> 1241</span>&#160;    span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a97df83853dc6ddf7e0114691b15edb49">block_size</a> = size_class-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a007fc7dd52ba1f95d9a6ce88f47a614b">block_size</a>;</div>
<div class="line"><a name="l01242"></a><span class="lineno"> 1242</span>&#160;    span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a7ee7892ce3c5d8342af193f1824a5098">block_count</a> = size_class-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#aeded978bd21c13b71d9b0310b5bb09ec">block_count</a>;</div>
<div class="line"><a name="l01243"></a><span class="lineno"> 1243</span>&#160;    span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a85527ad364915bcb39b7d421524d0bd6">free_list</a> = 0;</div>
<div class="line"><a name="l01244"></a><span class="lineno"> 1244</span>&#160;    span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#ad842dbc76a30fb5beee77a2d773a3e91">list_size</a> = 0;</div>
<div class="line"><a name="l01245"></a><span class="lineno"> 1245</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#a94d4ba8d2181723f35b45da39c91d8ab">atomic_store_ptr_release</a>(&amp;span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a22b0340927d02f0c7c4486f01c31358e">free_list_deferred</a>, 0);</div>
<div class="line"><a name="l01246"></a><span class="lineno"> 1246</span>&#160; </div>
<div class="line"><a name="l01247"></a><span class="lineno"> 1247</span>&#160;    <span class="comment">// Setup free list. Only initialize one system page worth of free blocks in list</span></div>
<div class="line"><a name="l01248"></a><span class="lineno"> 1248</span>&#160;    <span class="keywordtype">void</span> *block;</div>
<div class="line"><a name="l01249"></a><span class="lineno"> 1249</span>&#160;    span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#af093d9cb1719d72c20f96a9b467590f5">free_list_limit</a> = <a class="code" href="../../df/dc0/rpmalloc_8c.html#addf543f30c5eefc1dded60025c78a816">free_list_partial_init</a>(&amp;heap_size_class-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#ac411b0f198d4e31569fc30ca2c174f65">free_list</a>, &amp;block,</div>
<div class="line"><a name="l01250"></a><span class="lineno"> 1250</span>&#160;                                                   span, <a class="code" href="../../df/dc0/rpmalloc_8c.html#ab4225911698b67188e1538c334cfe16c">pointer_offset</a>(span, <a class="code" href="../../df/dc0/rpmalloc_8c.html#a645356809d937167848705edabde7d44">SPAN_HEADER_SIZE</a>), size_class-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#aeded978bd21c13b71d9b0310b5bb09ec">block_count</a>, size_class-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a007fc7dd52ba1f95d9a6ce88f47a614b">block_size</a>);</div>
<div class="line"><a name="l01251"></a><span class="lineno"> 1251</span>&#160;    <span class="comment">// Link span as partial if there remains blocks to be initialized as free list, or full if fully initialized</span></div>
<div class="line"><a name="l01252"></a><span class="lineno"> 1252</span>&#160;    <span class="keywordflow">if</span> (span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#af093d9cb1719d72c20f96a9b467590f5">free_list_limit</a> &lt; span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a7ee7892ce3c5d8342af193f1824a5098">block_count</a>)</div>
<div class="line"><a name="l01253"></a><span class="lineno"> 1253</span>&#160;    {</div>
<div class="line"><a name="l01254"></a><span class="lineno"> 1254</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#ac32a750ddf4072d46c28f52b9f3ee018">_rpmalloc_span_double_link_list_add</a>(&amp;heap_size_class-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#af829c49d9fc4d933c14113ba0d694e7c">partial_span</a>, span);</div>
<div class="line"><a name="l01255"></a><span class="lineno"> 1255</span>&#160;        span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#abf4fa6f8f0e7baff0d6a7a96df58bcca">used_count</a> = span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#af093d9cb1719d72c20f96a9b467590f5">free_list_limit</a>;</div>
<div class="line"><a name="l01256"></a><span class="lineno"> 1256</span>&#160;    }</div>
<div class="line"><a name="l01257"></a><span class="lineno"> 1257</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l01258"></a><span class="lineno"> 1258</span>&#160;    {</div>
<div class="line"><a name="l01259"></a><span class="lineno"> 1259</span>&#160;<span class="preprocessor">#if RPMALLOC_FIRST_CLASS_HEAPS</span></div>
<div class="line"><a name="l01260"></a><span class="lineno"> 1260</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#ac32a750ddf4072d46c28f52b9f3ee018">_rpmalloc_span_double_link_list_add</a>(&amp;heap-&gt;full_span[class_idx], span);</div>
<div class="line"><a name="l01261"></a><span class="lineno"> 1261</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01262"></a><span class="lineno"> 1262</span>&#160;        ++heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a6aa789c3cdf7e70df144c248d18c5f4c">full_span_count</a>;</div>
<div class="line"><a name="l01263"></a><span class="lineno"> 1263</span>&#160;        span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#abf4fa6f8f0e7baff0d6a7a96df58bcca">used_count</a> = span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a7ee7892ce3c5d8342af193f1824a5098">block_count</a>;</div>
<div class="line"><a name="l01264"></a><span class="lineno"> 1264</span>&#160;    }</div>
<div class="line"><a name="l01265"></a><span class="lineno"> 1265</span>&#160;    <span class="keywordflow">return</span> block;</div>
<div class="line"><a name="l01266"></a><span class="lineno"> 1266</span>&#160;}</div>
<div class="line"><a name="l01267"></a><span class="lineno"> 1267</span>&#160; </div>
<div class="line"><a name="l01268"></a><span class="lineno"> 1268</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="l01269"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#af2ca2fcf7e544c9458ef49057a40b78e"> 1269</a></span>&#160;<a class="code" href="../../df/dc0/rpmalloc_8c.html#af2ca2fcf7e544c9458ef49057a40b78e">_rpmalloc_span_extract_free_list_deferred</a>(<a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *span)</div>
<div class="line"><a name="l01270"></a><span class="lineno"> 1270</span>&#160;{</div>
<div class="line"><a name="l01271"></a><span class="lineno"> 1271</span>&#160;    <span class="comment">// We need acquire semantics on the CAS operation since we are interested in the list size</span></div>
<div class="line"><a name="l01272"></a><span class="lineno"> 1272</span>&#160;    <span class="comment">// Refer to _rpmalloc_deallocate_defer_small_or_medium for further comments on this dependency</span></div>
<div class="line"><a name="l01273"></a><span class="lineno"> 1273</span>&#160;    <span class="keywordflow">do</span></div>
<div class="line"><a name="l01274"></a><span class="lineno"> 1274</span>&#160;    {</div>
<div class="line"><a name="l01275"></a><span class="lineno"> 1275</span>&#160;        span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a85527ad364915bcb39b7d421524d0bd6">free_list</a> = <a class="code" href="../../df/dc0/rpmalloc_8c.html#af6f24a9d51e940bbad434106b1d56e20">atomic_exchange_ptr_acquire</a>(&amp;span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a22b0340927d02f0c7c4486f01c31358e">free_list_deferred</a>, <a class="code" href="../../df/dc0/rpmalloc_8c.html#a95d666267d99d22454086d5fa0390bff">INVALID_POINTER</a>);</div>
<div class="line"><a name="l01276"></a><span class="lineno"> 1276</span>&#160;    } <span class="keywordflow">while</span> (span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a85527ad364915bcb39b7d421524d0bd6">free_list</a> == <a class="code" href="../../df/dc0/rpmalloc_8c.html#a95d666267d99d22454086d5fa0390bff">INVALID_POINTER</a>);</div>
<div class="line"><a name="l01277"></a><span class="lineno"> 1277</span>&#160;    span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#abf4fa6f8f0e7baff0d6a7a96df58bcca">used_count</a> -= span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#ad842dbc76a30fb5beee77a2d773a3e91">list_size</a>;</div>
<div class="line"><a name="l01278"></a><span class="lineno"> 1278</span>&#160;    span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#ad842dbc76a30fb5beee77a2d773a3e91">list_size</a> = 0;</div>
<div class="line"><a name="l01279"></a><span class="lineno"> 1279</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#a94d4ba8d2181723f35b45da39c91d8ab">atomic_store_ptr_release</a>(&amp;span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a22b0340927d02f0c7c4486f01c31358e">free_list_deferred</a>, 0);</div>
<div class="line"><a name="l01280"></a><span class="lineno"> 1280</span>&#160;}</div>
<div class="line"><a name="l01281"></a><span class="lineno"> 1281</span>&#160; </div>
<div class="line"><a name="l01282"></a><span class="lineno"> 1282</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line"><a name="l01283"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#ade7fb930b30a5a8bd04ecc97cad60e6b"> 1283</a></span>&#160;<a class="code" href="../../df/dc0/rpmalloc_8c.html#ade7fb930b30a5a8bd04ecc97cad60e6b">_rpmalloc_span_is_fully_utilized</a>(<a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *span)</div>
<div class="line"><a name="l01284"></a><span class="lineno"> 1284</span>&#160;{</div>
<div class="line"><a name="l01285"></a><span class="lineno"> 1285</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#ad008ddf766a4f56fbde2edf2c51d9a87">rpmalloc_assert</a>(span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#af093d9cb1719d72c20f96a9b467590f5">free_list_limit</a> &lt;= span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a7ee7892ce3c5d8342af193f1824a5098">block_count</a>, <span class="stringliteral">&quot;Span free list corrupted&quot;</span>);</div>
<div class="line"><a name="l01286"></a><span class="lineno"> 1286</span>&#160;    <span class="keywordflow">return</span> !span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a85527ad364915bcb39b7d421524d0bd6">free_list</a> &amp;&amp; (span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#af093d9cb1719d72c20f96a9b467590f5">free_list_limit</a> &gt;= span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a7ee7892ce3c5d8342af193f1824a5098">block_count</a>);</div>
<div class="line"><a name="l01287"></a><span class="lineno"> 1287</span>&#160;}</div>
<div class="line"><a name="l01288"></a><span class="lineno"> 1288</span>&#160; </div>
<div class="line"><a name="l01289"></a><span class="lineno"> 1289</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line"><a name="l01290"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#aa776faada2c6d5b7edda58a3a1d701c4"> 1290</a></span>&#160;<a class="code" href="../../df/dc0/rpmalloc_8c.html#aa776faada2c6d5b7edda58a3a1d701c4">_rpmalloc_span_finalize</a>(<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#d9/d8a/structheap__t">heap_t</a> *heap, <span class="keywordtype">size_t</span> iclass, <a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *span, <a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> **list_head)</div>
<div class="line"><a name="l01291"></a><span class="lineno"> 1291</span>&#160;{</div>
<div class="line"><a name="l01292"></a><span class="lineno"> 1292</span>&#160;    <span class="keywordtype">void</span> *free_list = heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a70f9a96b9071ccb6642894f5a7f56432">size_class</a>[iclass].<a class="code" href="../../df/dc0/rpmalloc_8c.html#ac411b0f198d4e31569fc30ca2c174f65">free_list</a>;</div>
<div class="line"><a name="l01293"></a><span class="lineno"> 1293</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *class_span = (<a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *)((<a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#a4788399d1d0b37ccf098a7da82254808">uintptr_t</a>)free_list &amp; <a class="code" href="../../df/dc0/rpmalloc_8c.html#ae7b97ba12e15609b6d63926ed2e30238">_memory_span_mask</a>);</div>
<div class="line"><a name="l01294"></a><span class="lineno"> 1294</span>&#160;    <span class="keywordflow">if</span> (span == class_span)</div>
<div class="line"><a name="l01295"></a><span class="lineno"> 1295</span>&#160;    {</div>
<div class="line"><a name="l01296"></a><span class="lineno"> 1296</span>&#160;        <span class="comment">// Adopt the heap class free list back into the span free list</span></div>
<div class="line"><a name="l01297"></a><span class="lineno"> 1297</span>&#160;        <span class="keywordtype">void</span> *block = span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a85527ad364915bcb39b7d421524d0bd6">free_list</a>;</div>
<div class="line"><a name="l01298"></a><span class="lineno"> 1298</span>&#160;        <span class="keywordtype">void</span> *last_block = 0;</div>
<div class="line"><a name="l01299"></a><span class="lineno"> 1299</span>&#160;        <span class="keywordflow">while</span> (block)</div>
<div class="line"><a name="l01300"></a><span class="lineno"> 1300</span>&#160;        {</div>
<div class="line"><a name="l01301"></a><span class="lineno"> 1301</span>&#160;            last_block = block;</div>
<div class="line"><a name="l01302"></a><span class="lineno"> 1302</span>&#160;            block = *((<span class="keywordtype">void</span> **)block);</div>
<div class="line"><a name="l01303"></a><span class="lineno"> 1303</span>&#160;        }</div>
<div class="line"><a name="l01304"></a><span class="lineno"> 1304</span>&#160;        <a class="code" href="../../dd/ddd/arithmetic__operations_8c.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a> free_count = 0;</div>
<div class="line"><a name="l01305"></a><span class="lineno"> 1305</span>&#160;        block = free_list;</div>
<div class="line"><a name="l01306"></a><span class="lineno"> 1306</span>&#160;        <span class="keywordflow">while</span> (block)</div>
<div class="line"><a name="l01307"></a><span class="lineno"> 1307</span>&#160;        {</div>
<div class="line"><a name="l01308"></a><span class="lineno"> 1308</span>&#160;            ++free_count;</div>
<div class="line"><a name="l01309"></a><span class="lineno"> 1309</span>&#160;            block = *((<span class="keywordtype">void</span> **)block);</div>
<div class="line"><a name="l01310"></a><span class="lineno"> 1310</span>&#160;        }</div>
<div class="line"><a name="l01311"></a><span class="lineno"> 1311</span>&#160;        <span class="keywordflow">if</span> (last_block)</div>
<div class="line"><a name="l01312"></a><span class="lineno"> 1312</span>&#160;        {</div>
<div class="line"><a name="l01313"></a><span class="lineno"> 1313</span>&#160;            *((<span class="keywordtype">void</span> **)last_block) = free_list;</div>
<div class="line"><a name="l01314"></a><span class="lineno"> 1314</span>&#160;        }</div>
<div class="line"><a name="l01315"></a><span class="lineno"> 1315</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l01316"></a><span class="lineno"> 1316</span>&#160;        {</div>
<div class="line"><a name="l01317"></a><span class="lineno"> 1317</span>&#160;            span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a85527ad364915bcb39b7d421524d0bd6">free_list</a> = free_list;</div>
<div class="line"><a name="l01318"></a><span class="lineno"> 1318</span>&#160;        }</div>
<div class="line"><a name="l01319"></a><span class="lineno"> 1319</span>&#160;        heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a70f9a96b9071ccb6642894f5a7f56432">size_class</a>[iclass].<a class="code" href="../../df/dc0/rpmalloc_8c.html#ac411b0f198d4e31569fc30ca2c174f65">free_list</a> = 0;</div>
<div class="line"><a name="l01320"></a><span class="lineno"> 1320</span>&#160;        span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#abf4fa6f8f0e7baff0d6a7a96df58bcca">used_count</a> -= free_count;</div>
<div class="line"><a name="l01321"></a><span class="lineno"> 1321</span>&#160;    }</div>
<div class="line"><a name="l01322"></a><span class="lineno"> 1322</span>&#160;    <span class="comment">// If this assert triggers you have memory leaks</span></div>
<div class="line"><a name="l01323"></a><span class="lineno"> 1323</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#ad008ddf766a4f56fbde2edf2c51d9a87">rpmalloc_assert</a>(span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#ad842dbc76a30fb5beee77a2d773a3e91">list_size</a> == span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#abf4fa6f8f0e7baff0d6a7a96df58bcca">used_count</a>, <span class="stringliteral">&quot;Memory leak detected&quot;</span>);</div>
<div class="line"><a name="l01324"></a><span class="lineno"> 1324</span>&#160;    <span class="keywordflow">if</span> (span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#ad842dbc76a30fb5beee77a2d773a3e91">list_size</a> == span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#abf4fa6f8f0e7baff0d6a7a96df58bcca">used_count</a>)</div>
<div class="line"><a name="l01325"></a><span class="lineno"> 1325</span>&#160;    {</div>
<div class="line"><a name="l01326"></a><span class="lineno"> 1326</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#aab22b36fb2408434cc731fb9fe6a5cec">_rpmalloc_stat_dec</a>(&amp;heap-&gt;span_use[0].current);</div>
<div class="line"><a name="l01327"></a><span class="lineno"> 1327</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#aab22b36fb2408434cc731fb9fe6a5cec">_rpmalloc_stat_dec</a>(&amp;heap-&gt;size_class_use[iclass].spans_current);</div>
<div class="line"><a name="l01328"></a><span class="lineno"> 1328</span>&#160;        <span class="comment">// This function only used for spans in double linked lists</span></div>
<div class="line"><a name="l01329"></a><span class="lineno"> 1329</span>&#160;        <span class="keywordflow">if</span> (list_head)</div>
<div class="line"><a name="l01330"></a><span class="lineno"> 1330</span>&#160;            <a class="code" href="../../df/dc0/rpmalloc_8c.html#aec7913670102d551e3fd60509cd381a3">_rpmalloc_span_double_link_list_remove</a>(list_head, span);</div>
<div class="line"><a name="l01331"></a><span class="lineno"> 1331</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#a1b31ff8fa0abcdb205dadd8afc026014">_rpmalloc_span_unmap</a>(span);</div>
<div class="line"><a name="l01332"></a><span class="lineno"> 1332</span>&#160;        <span class="keywordflow">return</span> 1;</div>
<div class="line"><a name="l01333"></a><span class="lineno"> 1333</span>&#160;    }</div>
<div class="line"><a name="l01334"></a><span class="lineno"> 1334</span>&#160;    <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l01335"></a><span class="lineno"> 1335</span>&#160;}</div>
<div class="line"><a name="l01336"></a><span class="lineno"> 1336</span>&#160; </div>
<div class="line"><a name="l01342"></a><span class="lineno"> 1342</span>&#160; </div>
<div class="line"><a name="l01343"></a><span class="lineno"> 1343</span>&#160;<span class="preprocessor">#if ENABLE_GLOBAL_CACHE</span></div>
<div class="line"><a name="l01344"></a><span class="lineno"> 1344</span>&#160; </div>
<div class="line"><a name="l01346"></a><span class="lineno"> 1346</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="l01347"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#ad3b62974f1bafcc293cde80eb05a7abe"> 1347</a></span>&#160;<a class="code" href="../../df/dc0/rpmalloc_8c.html#ad3b62974f1bafcc293cde80eb05a7abe">_rpmalloc_global_cache_finalize</a>(<a class="code" href="../../df/dc0/rpmalloc_8c.html#db/d6b/structglobal__cache__t">global_cache_t</a> *cache)</div>
<div class="line"><a name="l01348"></a><span class="lineno"> 1348</span>&#160;{</div>
<div class="line"><a name="l01349"></a><span class="lineno"> 1349</span>&#160;    <span class="keywordflow">while</span> (!<a class="code" href="../../df/dc0/rpmalloc_8c.html#a2071bf7ebae50eced1f16b359f9d5c7d">atomic_cas32_acquire</a>(&amp;cache-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a9c0563645d0d1fd53044a9c00dad6dc0">lock</a>, 1, 0))</div>
<div class="line"><a name="l01350"></a><span class="lineno"> 1350</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#a335307d78e0ff77d4da9cf42156803ec">_rpmalloc_spin</a>();</div>
<div class="line"><a name="l01351"></a><span class="lineno"> 1351</span>&#160; </div>
<div class="line"><a name="l01352"></a><span class="lineno"> 1352</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> ispan = 0; ispan &lt; cache-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a440c6f31099f3836f7beb5e47d14fb2d">count</a>; ++ispan)</div>
<div class="line"><a name="l01353"></a><span class="lineno"> 1353</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#a1b31ff8fa0abcdb205dadd8afc026014">_rpmalloc_span_unmap</a>(cache-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a9d6636075b348ce9cbd7e59e45d097c7">span</a>[ispan]);</div>
<div class="line"><a name="l01354"></a><span class="lineno"> 1354</span>&#160;    cache-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a440c6f31099f3836f7beb5e47d14fb2d">count</a> = 0;</div>
<div class="line"><a name="l01355"></a><span class="lineno"> 1355</span>&#160; </div>
<div class="line"><a name="l01356"></a><span class="lineno"> 1356</span>&#160;    <span class="keywordflow">while</span> (cache-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a8bb140aee00ffae527f7c0706d98c3d1">overflow</a>)</div>
<div class="line"><a name="l01357"></a><span class="lineno"> 1357</span>&#160;    {</div>
<div class="line"><a name="l01358"></a><span class="lineno"> 1358</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *span = cache-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a8bb140aee00ffae527f7c0706d98c3d1">overflow</a>;</div>
<div class="line"><a name="l01359"></a><span class="lineno"> 1359</span>&#160;        cache-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a8bb140aee00ffae527f7c0706d98c3d1">overflow</a> = span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#ac62e0e77eb38ebff4443eb5db3ccd45c">next</a>;</div>
<div class="line"><a name="l01360"></a><span class="lineno"> 1360</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#a1b31ff8fa0abcdb205dadd8afc026014">_rpmalloc_span_unmap</a>(span);</div>
<div class="line"><a name="l01361"></a><span class="lineno"> 1361</span>&#160;    }</div>
<div class="line"><a name="l01362"></a><span class="lineno"> 1362</span>&#160; </div>
<div class="line"><a name="l01363"></a><span class="lineno"> 1363</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#a2a87a6060d5387fe8491a00600073687">atomic_store32_release</a>(&amp;cache-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a9c0563645d0d1fd53044a9c00dad6dc0">lock</a>, 0);</div>
<div class="line"><a name="l01364"></a><span class="lineno"> 1364</span>&#160;}</div>
<div class="line"><a name="l01365"></a><span class="lineno"> 1365</span>&#160; </div>
<div class="line"><a name="l01366"></a><span class="lineno"> 1366</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="l01367"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a06d0861a56c7d5aac6e215ab0dceb9ca"> 1367</a></span>&#160;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a06d0861a56c7d5aac6e215ab0dceb9ca">_rpmalloc_global_cache_insert_spans</a>(<a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> **span, <span class="keywordtype">size_t</span> span_count, <span class="keywordtype">size_t</span> <a class="code" href="../../d0/d64/syscall_8cpp.html#a7801f18982e0e5d2853680593ff81c04">count</a>)</div>
<div class="line"><a name="l01368"></a><span class="lineno"> 1368</span>&#160;{</div>
<div class="line"><a name="l01369"></a><span class="lineno"> 1369</span>&#160;    <span class="keyword">const</span> <span class="keywordtype">size_t</span> cache_limit = (span_count == 1) ? <a class="code" href="../../df/dc0/rpmalloc_8c.html#aec9c1ea6434b5703d7b6e01cfffd1261">GLOBAL_CACHE_MULTIPLIER</a> * <a class="code" href="../../df/dc0/rpmalloc_8c.html#aebbd8639c3b627f526bd557e065f1c00">MAX_THREAD_SPAN_CACHE</a> : <a class="code" href="../../df/dc0/rpmalloc_8c.html#aec9c1ea6434b5703d7b6e01cfffd1261">GLOBAL_CACHE_MULTIPLIER</a> * (<a class="code" href="../../df/dc0/rpmalloc_8c.html#a51b78975d481805f29847ad91c77d6ad">MAX_THREAD_SPAN_LARGE_CACHE</a> - (span_count &gt;&gt; 1));</div>
<div class="line"><a name="l01370"></a><span class="lineno"> 1370</span>&#160; </div>
<div class="line"><a name="l01371"></a><span class="lineno"> 1371</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#db/d6b/structglobal__cache__t">global_cache_t</a> *cache = &amp;<a class="code" href="../../df/dc0/rpmalloc_8c.html#ad7af40ab0c9174515ec06efb45ebdd73">_memory_span_cache</a>[span_count - 1];</div>
<div class="line"><a name="l01372"></a><span class="lineno"> 1372</span>&#160; </div>
<div class="line"><a name="l01373"></a><span class="lineno"> 1373</span>&#160;    <span class="keywordtype">size_t</span> insert_count = <a class="code" href="../../d0/d64/syscall_8cpp.html#a7801f18982e0e5d2853680593ff81c04">count</a>;</div>
<div class="line"><a name="l01374"></a><span class="lineno"> 1374</span>&#160;    <span class="keywordflow">while</span> (!<a class="code" href="../../df/dc0/rpmalloc_8c.html#a2071bf7ebae50eced1f16b359f9d5c7d">atomic_cas32_acquire</a>(&amp;cache-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a9c0563645d0d1fd53044a9c00dad6dc0">lock</a>, 1, 0))</div>
<div class="line"><a name="l01375"></a><span class="lineno"> 1375</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#a335307d78e0ff77d4da9cf42156803ec">_rpmalloc_spin</a>();</div>
<div class="line"><a name="l01376"></a><span class="lineno"> 1376</span>&#160; </div>
<div class="line"><a name="l01377"></a><span class="lineno"> 1377</span>&#160;<span class="preprocessor">#if ENABLE_STATISTICS</span></div>
<div class="line"><a name="l01378"></a><span class="lineno"> 1378</span>&#160;    cache-&gt;insert_count += <a class="code" href="../../d0/d64/syscall_8cpp.html#a7801f18982e0e5d2853680593ff81c04">count</a>;</div>
<div class="line"><a name="l01379"></a><span class="lineno"> 1379</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01380"></a><span class="lineno"> 1380</span>&#160;    <span class="keywordflow">if</span> ((cache-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a440c6f31099f3836f7beb5e47d14fb2d">count</a> + insert_count) &gt; cache_limit)</div>
<div class="line"><a name="l01381"></a><span class="lineno"> 1381</span>&#160;        insert_count = cache_limit - cache-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a440c6f31099f3836f7beb5e47d14fb2d">count</a>;</div>
<div class="line"><a name="l01382"></a><span class="lineno"> 1382</span>&#160; </div>
<div class="line"><a name="l01383"></a><span class="lineno"> 1383</span>&#160;    <a class="code" href="../../d3/d82/convert_8h.html#a7a71051d6440816fca3ad080ae2539f4">memcpy_unsafe</a>(cache-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a9d6636075b348ce9cbd7e59e45d097c7">span</a> + cache-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a440c6f31099f3836f7beb5e47d14fb2d">count</a>, span, <span class="keyword">sizeof</span>(<a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *) * insert_count);</div>
<div class="line"><a name="l01384"></a><span class="lineno"> 1384</span>&#160;    cache-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a440c6f31099f3836f7beb5e47d14fb2d">count</a> += (<a class="code" href="../../dd/ddd/arithmetic__operations_8c.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a>)insert_count;</div>
<div class="line"><a name="l01385"></a><span class="lineno"> 1385</span>&#160; </div>
<div class="line"><a name="l01386"></a><span class="lineno"> 1386</span>&#160;<span class="preprocessor">#if ENABLE_UNLIMITED_CACHE</span></div>
<div class="line"><a name="l01387"></a><span class="lineno"> 1387</span>&#160;    <span class="keywordflow">while</span> (insert_count &lt; <a class="code" href="../../d0/d64/syscall_8cpp.html#a7801f18982e0e5d2853680593ff81c04">count</a>)</div>
<div class="line"><a name="l01388"></a><span class="lineno"> 1388</span>&#160;    {</div>
<div class="line"><a name="l01389"></a><span class="lineno"> 1389</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l01390"></a><span class="lineno"> 1390</span>&#160;    <span class="comment">// Enable unlimited cache if huge pages, or we will leak since it is unlikely that an entire huge page</span></div>
<div class="line"><a name="l01391"></a><span class="lineno"> 1391</span>&#160;    <span class="comment">// will be unmapped, and we&#39;re unable to partially decommit a huge page</span></div>
<div class="line"><a name="l01392"></a><span class="lineno"> 1392</span>&#160;    <span class="keywordflow">while</span> ((<a class="code" href="../../df/dc0/rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a> &gt; <a class="code" href="../../df/dc0/rpmalloc_8c.html#a9fefa5277fefa0c58f69d5b86d679ccb">_memory_span_size</a>) &amp;&amp; (insert_count &lt; <a class="code" href="../../d0/d64/syscall_8cpp.html#a7801f18982e0e5d2853680593ff81c04">count</a>))</div>
<div class="line"><a name="l01393"></a><span class="lineno"> 1393</span>&#160;    {</div>
<div class="line"><a name="l01394"></a><span class="lineno"> 1394</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01395"></a><span class="lineno"> 1395</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *current_span = span[insert_count++];</div>
<div class="line"><a name="l01396"></a><span class="lineno"> 1396</span>&#160;        current_span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#ac62e0e77eb38ebff4443eb5db3ccd45c">next</a> = cache-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a8bb140aee00ffae527f7c0706d98c3d1">overflow</a>;</div>
<div class="line"><a name="l01397"></a><span class="lineno"> 1397</span>&#160;        cache-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a8bb140aee00ffae527f7c0706d98c3d1">overflow</a> = current_span;</div>
<div class="line"><a name="l01398"></a><span class="lineno"> 1398</span>&#160;    }</div>
<div class="line"><a name="l01399"></a><span class="lineno"> 1399</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#a2a87a6060d5387fe8491a00600073687">atomic_store32_release</a>(&amp;cache-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a9c0563645d0d1fd53044a9c00dad6dc0">lock</a>, 0);</div>
<div class="line"><a name="l01400"></a><span class="lineno"> 1400</span>&#160; </div>
<div class="line"><a name="l01401"></a><span class="lineno"> 1401</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *keep = 0;</div>
<div class="line"><a name="l01402"></a><span class="lineno"> 1402</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> ispan = insert_count; ispan &lt; <a class="code" href="../../d0/d64/syscall_8cpp.html#a7801f18982e0e5d2853680593ff81c04">count</a>; ++ispan)</div>
<div class="line"><a name="l01403"></a><span class="lineno"> 1403</span>&#160;    {</div>
<div class="line"><a name="l01404"></a><span class="lineno"> 1404</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *current_span = span[ispan];</div>
<div class="line"><a name="l01405"></a><span class="lineno"> 1405</span>&#160;        <span class="comment">// Keep master spans that has remaining subspans to avoid dangling them</span></div>
<div class="line"><a name="l01406"></a><span class="lineno"> 1406</span>&#160;        <span class="keywordflow">if</span> ((current_span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a4de89d484559557bb639a2703c750b17">flags</a> &amp; <a class="code" href="../../df/dc0/rpmalloc_8c.html#a98c82279e204e31a5dc89b64d2c6c27c">SPAN_FLAG_MASTER</a>) &amp;&amp;</div>
<div class="line"><a name="l01407"></a><span class="lineno"> 1407</span>&#160;            (atomic_load32(&amp;current_span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a4aecbd1cbb36425fddd53125ea1a84c7">remaining_spans</a>) &gt; (<a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#a0c18914b3041c2f583aba76f418399c2">int32_t</a>)current_span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#ae77d9a2cdd2a2fd46e3b27739d6c88cc">span_count</a>))</div>
<div class="line"><a name="l01408"></a><span class="lineno"> 1408</span>&#160;        {</div>
<div class="line"><a name="l01409"></a><span class="lineno"> 1409</span>&#160;            current_span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#ac62e0e77eb38ebff4443eb5db3ccd45c">next</a> = keep;</div>
<div class="line"><a name="l01410"></a><span class="lineno"> 1410</span>&#160;            keep = current_span;</div>
<div class="line"><a name="l01411"></a><span class="lineno"> 1411</span>&#160;        }</div>
<div class="line"><a name="l01412"></a><span class="lineno"> 1412</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l01413"></a><span class="lineno"> 1413</span>&#160;        {</div>
<div class="line"><a name="l01414"></a><span class="lineno"> 1414</span>&#160;            <a class="code" href="../../df/dc0/rpmalloc_8c.html#a1b31ff8fa0abcdb205dadd8afc026014">_rpmalloc_span_unmap</a>(current_span);</div>
<div class="line"><a name="l01415"></a><span class="lineno"> 1415</span>&#160;        }</div>
<div class="line"><a name="l01416"></a><span class="lineno"> 1416</span>&#160;    }</div>
<div class="line"><a name="l01417"></a><span class="lineno"> 1417</span>&#160; </div>
<div class="line"><a name="l01418"></a><span class="lineno"> 1418</span>&#160;    <span class="keywordflow">if</span> (keep)</div>
<div class="line"><a name="l01419"></a><span class="lineno"> 1419</span>&#160;    {</div>
<div class="line"><a name="l01420"></a><span class="lineno"> 1420</span>&#160;        <span class="keywordflow">while</span> (!<a class="code" href="../../df/dc0/rpmalloc_8c.html#a2071bf7ebae50eced1f16b359f9d5c7d">atomic_cas32_acquire</a>(&amp;cache-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a9c0563645d0d1fd53044a9c00dad6dc0">lock</a>, 1, 0))</div>
<div class="line"><a name="l01421"></a><span class="lineno"> 1421</span>&#160;            <a class="code" href="../../df/dc0/rpmalloc_8c.html#a335307d78e0ff77d4da9cf42156803ec">_rpmalloc_spin</a>();</div>
<div class="line"><a name="l01422"></a><span class="lineno"> 1422</span>&#160; </div>
<div class="line"><a name="l01423"></a><span class="lineno"> 1423</span>&#160;        <span class="keywordtype">size_t</span> islot = 0;</div>
<div class="line"><a name="l01424"></a><span class="lineno"> 1424</span>&#160;        <span class="keywordflow">while</span> (keep)</div>
<div class="line"><a name="l01425"></a><span class="lineno"> 1425</span>&#160;        {</div>
<div class="line"><a name="l01426"></a><span class="lineno"> 1426</span>&#160;            <span class="keywordflow">for</span> (; islot &lt; cache-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a440c6f31099f3836f7beb5e47d14fb2d">count</a>; ++islot)</div>
<div class="line"><a name="l01427"></a><span class="lineno"> 1427</span>&#160;            {</div>
<div class="line"><a name="l01428"></a><span class="lineno"> 1428</span>&#160;                <a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *current_span = cache-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a9d6636075b348ce9cbd7e59e45d097c7">span</a>[islot];</div>
<div class="line"><a name="l01429"></a><span class="lineno"> 1429</span>&#160;                <span class="keywordflow">if</span> (!(current_span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a4de89d484559557bb639a2703c750b17">flags</a> &amp; <a class="code" href="../../df/dc0/rpmalloc_8c.html#a98c82279e204e31a5dc89b64d2c6c27c">SPAN_FLAG_MASTER</a>) || ((current_span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a4de89d484559557bb639a2703c750b17">flags</a> &amp; <a class="code" href="../../df/dc0/rpmalloc_8c.html#a98c82279e204e31a5dc89b64d2c6c27c">SPAN_FLAG_MASTER</a>) &amp;&amp;</div>
<div class="line"><a name="l01430"></a><span class="lineno"> 1430</span>&#160;                                                                  (atomic_load32(&amp;current_span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a4aecbd1cbb36425fddd53125ea1a84c7">remaining_spans</a>) &lt;= (<a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#a0c18914b3041c2f583aba76f418399c2">int32_t</a>)current_span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#ae77d9a2cdd2a2fd46e3b27739d6c88cc">span_count</a>)))</div>
<div class="line"><a name="l01431"></a><span class="lineno"> 1431</span>&#160;                {</div>
<div class="line"><a name="l01432"></a><span class="lineno"> 1432</span>&#160;                    <a class="code" href="../../df/dc0/rpmalloc_8c.html#a1b31ff8fa0abcdb205dadd8afc026014">_rpmalloc_span_unmap</a>(current_span);</div>
<div class="line"><a name="l01433"></a><span class="lineno"> 1433</span>&#160;                    cache-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a9d6636075b348ce9cbd7e59e45d097c7">span</a>[islot] = keep;</div>
<div class="line"><a name="l01434"></a><span class="lineno"> 1434</span>&#160;                    <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l01435"></a><span class="lineno"> 1435</span>&#160;                }</div>
<div class="line"><a name="l01436"></a><span class="lineno"> 1436</span>&#160;            }</div>
<div class="line"><a name="l01437"></a><span class="lineno"> 1437</span>&#160;            <span class="keywordflow">if</span> (islot == cache-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a440c6f31099f3836f7beb5e47d14fb2d">count</a>)</div>
<div class="line"><a name="l01438"></a><span class="lineno"> 1438</span>&#160;                <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l01439"></a><span class="lineno"> 1439</span>&#160;            keep = keep-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#ac62e0e77eb38ebff4443eb5db3ccd45c">next</a>;</div>
<div class="line"><a name="l01440"></a><span class="lineno"> 1440</span>&#160;        }</div>
<div class="line"><a name="l01441"></a><span class="lineno"> 1441</span>&#160; </div>
<div class="line"><a name="l01442"></a><span class="lineno"> 1442</span>&#160;        <span class="keywordflow">if</span> (keep)</div>
<div class="line"><a name="l01443"></a><span class="lineno"> 1443</span>&#160;        {</div>
<div class="line"><a name="l01444"></a><span class="lineno"> 1444</span>&#160;            <a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *<a class="code" href="../../d3/dbb/hu__stuff_8c.html#aff39d864a6594bc5f4a5e365282e00fe">tail</a> = keep;</div>
<div class="line"><a name="l01445"></a><span class="lineno"> 1445</span>&#160;            <span class="keywordflow">while</span> (<a class="code" href="../../d3/dbb/hu__stuff_8c.html#aff39d864a6594bc5f4a5e365282e00fe">tail</a>-&gt;next)</div>
<div class="line"><a name="l01446"></a><span class="lineno"> 1446</span>&#160;                <a class="code" href="../../d3/dbb/hu__stuff_8c.html#aff39d864a6594bc5f4a5e365282e00fe">tail</a> = <a class="code" href="../../d3/dbb/hu__stuff_8c.html#aff39d864a6594bc5f4a5e365282e00fe">tail</a>-&gt;next;</div>
<div class="line"><a name="l01447"></a><span class="lineno"> 1447</span>&#160;            <a class="code" href="../../d3/dbb/hu__stuff_8c.html#aff39d864a6594bc5f4a5e365282e00fe">tail</a>-&gt;next = cache-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a8bb140aee00ffae527f7c0706d98c3d1">overflow</a>;</div>
<div class="line"><a name="l01448"></a><span class="lineno"> 1448</span>&#160;            cache-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a8bb140aee00ffae527f7c0706d98c3d1">overflow</a> = keep;</div>
<div class="line"><a name="l01449"></a><span class="lineno"> 1449</span>&#160;        }</div>
<div class="line"><a name="l01450"></a><span class="lineno"> 1450</span>&#160; </div>
<div class="line"><a name="l01451"></a><span class="lineno"> 1451</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#a2a87a6060d5387fe8491a00600073687">atomic_store32_release</a>(&amp;cache-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a9c0563645d0d1fd53044a9c00dad6dc0">lock</a>, 0);</div>
<div class="line"><a name="l01452"></a><span class="lineno"> 1452</span>&#160;    }</div>
<div class="line"><a name="l01453"></a><span class="lineno"> 1453</span>&#160;}</div>
<div class="line"><a name="l01454"></a><span class="lineno"> 1454</span>&#160; </div>
<div class="line"><a name="l01455"></a><span class="lineno"> 1455</span>&#160;<span class="keyword">static</span> <span class="keywordtype">size_t</span></div>
<div class="line"><a name="l01456"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#ac0d9f7ba6a7fbb2c64e323a0f55c66d7"> 1456</a></span>&#160;<a class="code" href="../../df/dc0/rpmalloc_8c.html#ac0d9f7ba6a7fbb2c64e323a0f55c66d7">_rpmalloc_global_cache_extract_spans</a>(<a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> **span, <span class="keywordtype">size_t</span> span_count, <span class="keywordtype">size_t</span> <a class="code" href="../../d0/d64/syscall_8cpp.html#a7801f18982e0e5d2853680593ff81c04">count</a>)</div>
<div class="line"><a name="l01457"></a><span class="lineno"> 1457</span>&#160;{</div>
<div class="line"><a name="l01458"></a><span class="lineno"> 1458</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#db/d6b/structglobal__cache__t">global_cache_t</a> *cache = &amp;<a class="code" href="../../df/dc0/rpmalloc_8c.html#ad7af40ab0c9174515ec06efb45ebdd73">_memory_span_cache</a>[span_count - 1];</div>
<div class="line"><a name="l01459"></a><span class="lineno"> 1459</span>&#160; </div>
<div class="line"><a name="l01460"></a><span class="lineno"> 1460</span>&#160;    <span class="keywordtype">size_t</span> extract_count = 0;</div>
<div class="line"><a name="l01461"></a><span class="lineno"> 1461</span>&#160;    <span class="keywordflow">while</span> (!<a class="code" href="../../df/dc0/rpmalloc_8c.html#a2071bf7ebae50eced1f16b359f9d5c7d">atomic_cas32_acquire</a>(&amp;cache-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a9c0563645d0d1fd53044a9c00dad6dc0">lock</a>, 1, 0))</div>
<div class="line"><a name="l01462"></a><span class="lineno"> 1462</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#a335307d78e0ff77d4da9cf42156803ec">_rpmalloc_spin</a>();</div>
<div class="line"><a name="l01463"></a><span class="lineno"> 1463</span>&#160; </div>
<div class="line"><a name="l01464"></a><span class="lineno"> 1464</span>&#160;<span class="preprocessor">#if ENABLE_STATISTICS</span></div>
<div class="line"><a name="l01465"></a><span class="lineno"> 1465</span>&#160;    cache-&gt;extract_count += <a class="code" href="../../d0/d64/syscall_8cpp.html#a7801f18982e0e5d2853680593ff81c04">count</a>;</div>
<div class="line"><a name="l01466"></a><span class="lineno"> 1466</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01467"></a><span class="lineno"> 1467</span>&#160;    <span class="keywordtype">size_t</span> want = <a class="code" href="../../d0/d64/syscall_8cpp.html#a7801f18982e0e5d2853680593ff81c04">count</a> - extract_count;</div>
<div class="line"><a name="l01468"></a><span class="lineno"> 1468</span>&#160;    <span class="keywordflow">if</span> (want &gt; cache-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a440c6f31099f3836f7beb5e47d14fb2d">count</a>)</div>
<div class="line"><a name="l01469"></a><span class="lineno"> 1469</span>&#160;        want = cache-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a440c6f31099f3836f7beb5e47d14fb2d">count</a>;</div>
<div class="line"><a name="l01470"></a><span class="lineno"> 1470</span>&#160; </div>
<div class="line"><a name="l01471"></a><span class="lineno"> 1471</span>&#160;    <a class="code" href="../../d3/d82/convert_8h.html#a7a71051d6440816fca3ad080ae2539f4">memcpy_unsafe</a>(span + extract_count, cache-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a9d6636075b348ce9cbd7e59e45d097c7">span</a> + (cache-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a440c6f31099f3836f7beb5e47d14fb2d">count</a> - want), <span class="keyword">sizeof</span>(<a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *) * want);</div>
<div class="line"><a name="l01472"></a><span class="lineno"> 1472</span>&#160;    cache-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a440c6f31099f3836f7beb5e47d14fb2d">count</a> -= (<a class="code" href="../../dd/ddd/arithmetic__operations_8c.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a>)want;</div>
<div class="line"><a name="l01473"></a><span class="lineno"> 1473</span>&#160;    extract_count += want;</div>
<div class="line"><a name="l01474"></a><span class="lineno"> 1474</span>&#160; </div>
<div class="line"><a name="l01475"></a><span class="lineno"> 1475</span>&#160;    <span class="keywordflow">while</span> ((extract_count &lt; <a class="code" href="../../d0/d64/syscall_8cpp.html#a7801f18982e0e5d2853680593ff81c04">count</a>) &amp;&amp; cache-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a8bb140aee00ffae527f7c0706d98c3d1">overflow</a>)</div>
<div class="line"><a name="l01476"></a><span class="lineno"> 1476</span>&#160;    {</div>
<div class="line"><a name="l01477"></a><span class="lineno"> 1477</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *current_span = cache-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a8bb140aee00ffae527f7c0706d98c3d1">overflow</a>;</div>
<div class="line"><a name="l01478"></a><span class="lineno"> 1478</span>&#160;        span[extract_count++] = current_span;</div>
<div class="line"><a name="l01479"></a><span class="lineno"> 1479</span>&#160;        cache-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a8bb140aee00ffae527f7c0706d98c3d1">overflow</a> = current_span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#ac62e0e77eb38ebff4443eb5db3ccd45c">next</a>;</div>
<div class="line"><a name="l01480"></a><span class="lineno"> 1480</span>&#160;    }</div>
<div class="line"><a name="l01481"></a><span class="lineno"> 1481</span>&#160; </div>
<div class="line"><a name="l01482"></a><span class="lineno"> 1482</span>&#160;<span class="preprocessor">#if ENABLE_ASSERTS</span></div>
<div class="line"><a name="l01483"></a><span class="lineno"> 1483</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> ispan = 0; ispan &lt; extract_count; ++ispan)</div>
<div class="line"><a name="l01484"></a><span class="lineno"> 1484</span>&#160;    {</div>
<div class="line"><a name="l01485"></a><span class="lineno"> 1485</span>&#160;        <a class="code" href="../../dc/d6b/Kernel_2include__std_2assert_8h.html#af576bf8ffa22a44e53018c67095ffbf0">assert</a>(span[ispan]-&gt;span_count == span_count);</div>
<div class="line"><a name="l01486"></a><span class="lineno"> 1486</span>&#160;    }</div>
<div class="line"><a name="l01487"></a><span class="lineno"> 1487</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01488"></a><span class="lineno"> 1488</span>&#160; </div>
<div class="line"><a name="l01489"></a><span class="lineno"> 1489</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#a2a87a6060d5387fe8491a00600073687">atomic_store32_release</a>(&amp;cache-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a9c0563645d0d1fd53044a9c00dad6dc0">lock</a>, 0);</div>
<div class="line"><a name="l01490"></a><span class="lineno"> 1490</span>&#160; </div>
<div class="line"><a name="l01491"></a><span class="lineno"> 1491</span>&#160;    <span class="keywordflow">return</span> extract_count;</div>
<div class="line"><a name="l01492"></a><span class="lineno"> 1492</span>&#160;}</div>
<div class="line"><a name="l01493"></a><span class="lineno"> 1493</span>&#160; </div>
<div class="line"><a name="l01494"></a><span class="lineno"> 1494</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01495"></a><span class="lineno"> 1495</span>&#160; </div>
<div class="line"><a name="l01501"></a><span class="lineno"> 1501</span>&#160; </div>
<div class="line"><a name="l01502"></a><span class="lineno"> 1502</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#a428539d1600391a04bfc27f74980df5e">_rpmalloc_deallocate_huge</a>(<a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *);</div>
<div class="line"><a name="l01503"></a><span class="lineno"> 1503</span>&#160; </div>
<div class="line"><a name="l01505"></a><span class="lineno"> 1505</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="l01506"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#ae4a00ccf859d64a7519ae121563a56e7"> 1506</a></span>&#160;<a class="code" href="../../df/dc0/rpmalloc_8c.html#ae4a00ccf859d64a7519ae121563a56e7">_rpmalloc_heap_set_reserved_spans</a>(<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#d9/d8a/structheap__t">heap_t</a> *heap, <a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *master, <a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *reserve, <span class="keywordtype">size_t</span> reserve_span_count)</div>
<div class="line"><a name="l01507"></a><span class="lineno"> 1507</span>&#160;{</div>
<div class="line"><a name="l01508"></a><span class="lineno"> 1508</span>&#160;    heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#aa6719c6b21d6c30ce96e404a63cc4bae">span_reserve_master</a> = master;</div>
<div class="line"><a name="l01509"></a><span class="lineno"> 1509</span>&#160;    heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#aa549da79e540bdd3e963e294a39f64cf">span_reserve</a> = reserve;</div>
<div class="line"><a name="l01510"></a><span class="lineno"> 1510</span>&#160;    heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a8d5b27011e1ab5140090f90a75584329">spans_reserved</a> = (<a class="code" href="../../dd/ddd/arithmetic__operations_8c.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a>)reserve_span_count;</div>
<div class="line"><a name="l01511"></a><span class="lineno"> 1511</span>&#160;}</div>
<div class="line"><a name="l01512"></a><span class="lineno"> 1512</span>&#160; </div>
<div class="line"><a name="l01514"></a><span class="lineno"> 1514</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="l01515"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#af44e92f7ed42c434bd33a0ae98210a3f"> 1515</a></span>&#160;<a class="code" href="../../df/dc0/rpmalloc_8c.html#af44e92f7ed42c434bd33a0ae98210a3f">_rpmalloc_heap_cache_adopt_deferred</a>(<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#d9/d8a/structheap__t">heap_t</a> *heap, <a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> **single_span)</div>
<div class="line"><a name="l01516"></a><span class="lineno"> 1516</span>&#160;{</div>
<div class="line"><a name="l01517"></a><span class="lineno"> 1517</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *span = (<a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *)((<span class="keywordtype">void</span> *)<a class="code" href="../../df/dc0/rpmalloc_8c.html#af6f24a9d51e940bbad434106b1d56e20">atomic_exchange_ptr_acquire</a>(&amp;heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a354c0beb35fd982bc4dbd3783b2dd1ff">span_free_deferred</a>, 0));</div>
<div class="line"><a name="l01518"></a><span class="lineno"> 1518</span>&#160;    <span class="keywordflow">while</span> (span)</div>
<div class="line"><a name="l01519"></a><span class="lineno"> 1519</span>&#160;    {</div>
<div class="line"><a name="l01520"></a><span class="lineno"> 1520</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *next_span = (<a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *)span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a85527ad364915bcb39b7d421524d0bd6">free_list</a>;</div>
<div class="line"><a name="l01521"></a><span class="lineno"> 1521</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#ad008ddf766a4f56fbde2edf2c51d9a87">rpmalloc_assert</a>(span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a345270ce5d1e5e112b45cfde43f37da0">heap</a> == heap, <span class="stringliteral">&quot;Span heap pointer corrupted&quot;</span>);</div>
<div class="line"><a name="l01522"></a><span class="lineno"> 1522</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="../../df/dc0/rpmalloc_8c.html#a90593dceacf0c04f14d084bed7e7eabe">EXPECTED</a>(span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a5a977febdd2e9ae15bcf66f83d0cf817">size_class</a> &lt; <a class="code" href="../../df/dc0/rpmalloc_8c.html#aa74d427b2b9955ff2d9719693d9fc80e">SIZE_CLASS_COUNT</a>))</div>
<div class="line"><a name="l01523"></a><span class="lineno"> 1523</span>&#160;        {</div>
<div class="line"><a name="l01524"></a><span class="lineno"> 1524</span>&#160;            <a class="code" href="../../df/dc0/rpmalloc_8c.html#ad008ddf766a4f56fbde2edf2c51d9a87">rpmalloc_assert</a>(heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a6aa789c3cdf7e70df144c248d18c5f4c">full_span_count</a>, <span class="stringliteral">&quot;Heap span counter corrupted&quot;</span>);</div>
<div class="line"><a name="l01525"></a><span class="lineno"> 1525</span>&#160;            --heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a6aa789c3cdf7e70df144c248d18c5f4c">full_span_count</a>;</div>
<div class="line"><a name="l01526"></a><span class="lineno"> 1526</span>&#160;            <a class="code" href="../../df/dc0/rpmalloc_8c.html#aab22b36fb2408434cc731fb9fe6a5cec">_rpmalloc_stat_dec</a>(&amp;heap-&gt;span_use[0].spans_deferred);</div>
<div class="line"><a name="l01527"></a><span class="lineno"> 1527</span>&#160;<span class="preprocessor">#if RPMALLOC_FIRST_CLASS_HEAPS</span></div>
<div class="line"><a name="l01528"></a><span class="lineno"> 1528</span>&#160;            <a class="code" href="../../df/dc0/rpmalloc_8c.html#aec7913670102d551e3fd60509cd381a3">_rpmalloc_span_double_link_list_remove</a>(&amp;heap-&gt;full_span[span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a5a977febdd2e9ae15bcf66f83d0cf817">size_class</a>], span);</div>
<div class="line"><a name="l01529"></a><span class="lineno"> 1529</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01530"></a><span class="lineno"> 1530</span>&#160;            <a class="code" href="../../df/dc0/rpmalloc_8c.html#aab22b36fb2408434cc731fb9fe6a5cec">_rpmalloc_stat_dec</a>(&amp;heap-&gt;span_use[0].current);</div>
<div class="line"><a name="l01531"></a><span class="lineno"> 1531</span>&#160;            <a class="code" href="../../df/dc0/rpmalloc_8c.html#aab22b36fb2408434cc731fb9fe6a5cec">_rpmalloc_stat_dec</a>(&amp;heap-&gt;size_class_use[span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a5a977febdd2e9ae15bcf66f83d0cf817">size_class</a>].spans_current);</div>
<div class="line"><a name="l01532"></a><span class="lineno"> 1532</span>&#160;            <span class="keywordflow">if</span> (single_span &amp;&amp; !*single_span)</div>
<div class="line"><a name="l01533"></a><span class="lineno"> 1533</span>&#160;                *single_span = span;</div>
<div class="line"><a name="l01534"></a><span class="lineno"> 1534</span>&#160;            <span class="keywordflow">else</span></div>
<div class="line"><a name="l01535"></a><span class="lineno"> 1535</span>&#160;                <a class="code" href="../../df/dc0/rpmalloc_8c.html#abdbbc20ab63d76c1709722f3f2305610">_rpmalloc_heap_cache_insert</a>(heap, span);</div>
<div class="line"><a name="l01536"></a><span class="lineno"> 1536</span>&#160;        }</div>
<div class="line"><a name="l01537"></a><span class="lineno"> 1537</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l01538"></a><span class="lineno"> 1538</span>&#160;        {</div>
<div class="line"><a name="l01539"></a><span class="lineno"> 1539</span>&#160;            <span class="keywordflow">if</span> (span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a5a977febdd2e9ae15bcf66f83d0cf817">size_class</a> == <a class="code" href="../../df/dc0/rpmalloc_8c.html#a284460248778c94b6ee9ea1529299439">SIZE_CLASS_HUGE</a>)</div>
<div class="line"><a name="l01540"></a><span class="lineno"> 1540</span>&#160;            {</div>
<div class="line"><a name="l01541"></a><span class="lineno"> 1541</span>&#160;                <a class="code" href="../../df/dc0/rpmalloc_8c.html#a428539d1600391a04bfc27f74980df5e">_rpmalloc_deallocate_huge</a>(span);</div>
<div class="line"><a name="l01542"></a><span class="lineno"> 1542</span>&#160;            }</div>
<div class="line"><a name="l01543"></a><span class="lineno"> 1543</span>&#160;            <span class="keywordflow">else</span></div>
<div class="line"><a name="l01544"></a><span class="lineno"> 1544</span>&#160;            {</div>
<div class="line"><a name="l01545"></a><span class="lineno"> 1545</span>&#160;                <a class="code" href="../../df/dc0/rpmalloc_8c.html#ad008ddf766a4f56fbde2edf2c51d9a87">rpmalloc_assert</a>(span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a5a977febdd2e9ae15bcf66f83d0cf817">size_class</a> == <a class="code" href="../../df/dc0/rpmalloc_8c.html#a3f84dd23eb0ef3cf54aeb6afff0618ae">SIZE_CLASS_LARGE</a>, <span class="stringliteral">&quot;Span size class invalid&quot;</span>);</div>
<div class="line"><a name="l01546"></a><span class="lineno"> 1546</span>&#160;                <a class="code" href="../../df/dc0/rpmalloc_8c.html#ad008ddf766a4f56fbde2edf2c51d9a87">rpmalloc_assert</a>(heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a6aa789c3cdf7e70df144c248d18c5f4c">full_span_count</a>, <span class="stringliteral">&quot;Heap span counter corrupted&quot;</span>);</div>
<div class="line"><a name="l01547"></a><span class="lineno"> 1547</span>&#160;                --heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a6aa789c3cdf7e70df144c248d18c5f4c">full_span_count</a>;</div>
<div class="line"><a name="l01548"></a><span class="lineno"> 1548</span>&#160;<span class="preprocessor">#if RPMALLOC_FIRST_CLASS_HEAPS</span></div>
<div class="line"><a name="l01549"></a><span class="lineno"> 1549</span>&#160;                <a class="code" href="../../df/dc0/rpmalloc_8c.html#aec7913670102d551e3fd60509cd381a3">_rpmalloc_span_double_link_list_remove</a>(&amp;heap-&gt;large_huge_span, span);</div>
<div class="line"><a name="l01550"></a><span class="lineno"> 1550</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01551"></a><span class="lineno"> 1551</span>&#160;                <a class="code" href="../../dd/ddd/arithmetic__operations_8c.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a> <a class="code" href="../../dc/d3d/proto_8c.html#ae40354a1051342eb5a9db005715dcfa9">idx</a> = span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#ae77d9a2cdd2a2fd46e3b27739d6c88cc">span_count</a> - 1;</div>
<div class="line"><a name="l01552"></a><span class="lineno"> 1552</span>&#160;                <a class="code" href="../../df/dc0/rpmalloc_8c.html#aab22b36fb2408434cc731fb9fe6a5cec">_rpmalloc_stat_dec</a>(&amp;heap-&gt;span_use[<a class="code" href="../../dc/d3d/proto_8c.html#ae40354a1051342eb5a9db005715dcfa9">idx</a>].spans_deferred);</div>
<div class="line"><a name="l01553"></a><span class="lineno"> 1553</span>&#160;                <a class="code" href="../../df/dc0/rpmalloc_8c.html#aab22b36fb2408434cc731fb9fe6a5cec">_rpmalloc_stat_dec</a>(&amp;heap-&gt;span_use[<a class="code" href="../../dc/d3d/proto_8c.html#ae40354a1051342eb5a9db005715dcfa9">idx</a>].current);</div>
<div class="line"><a name="l01554"></a><span class="lineno"> 1554</span>&#160;                <span class="keywordflow">if</span> (!<a class="code" href="../../dc/d3d/proto_8c.html#ae40354a1051342eb5a9db005715dcfa9">idx</a> &amp;&amp; single_span &amp;&amp; !*single_span)</div>
<div class="line"><a name="l01555"></a><span class="lineno"> 1555</span>&#160;                    *single_span = span;</div>
<div class="line"><a name="l01556"></a><span class="lineno"> 1556</span>&#160;                <span class="keywordflow">else</span></div>
<div class="line"><a name="l01557"></a><span class="lineno"> 1557</span>&#160;                    <a class="code" href="../../df/dc0/rpmalloc_8c.html#abdbbc20ab63d76c1709722f3f2305610">_rpmalloc_heap_cache_insert</a>(heap, span);</div>
<div class="line"><a name="l01558"></a><span class="lineno"> 1558</span>&#160;            }</div>
<div class="line"><a name="l01559"></a><span class="lineno"> 1559</span>&#160;        }</div>
<div class="line"><a name="l01560"></a><span class="lineno"> 1560</span>&#160;        span = next_span;</div>
<div class="line"><a name="l01561"></a><span class="lineno"> 1561</span>&#160;    }</div>
<div class="line"><a name="l01562"></a><span class="lineno"> 1562</span>&#160;}</div>
<div class="line"><a name="l01563"></a><span class="lineno"> 1563</span>&#160; </div>
<div class="line"><a name="l01564"></a><span class="lineno"> 1564</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="l01565"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a0d896198d6c5673397704f9f6bdadbdf"> 1565</a></span>&#160;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a0d896198d6c5673397704f9f6bdadbdf">_rpmalloc_heap_unmap</a>(<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#d9/d8a/structheap__t">heap_t</a> *heap)</div>
<div class="line"><a name="l01566"></a><span class="lineno"> 1566</span>&#160;{</div>
<div class="line"><a name="l01567"></a><span class="lineno"> 1567</span>&#160;    <span class="keywordflow">if</span> (!heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a348c1835d21f0af4a3776f96bdba64fb">master_heap</a>)</div>
<div class="line"><a name="l01568"></a><span class="lineno"> 1568</span>&#160;    {</div>
<div class="line"><a name="l01569"></a><span class="lineno"> 1569</span>&#160;        <span class="keywordflow">if</span> ((heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a13ccab5430ace95c471aacf1fab0fcd6">finalize</a> &gt; 1) &amp;&amp; !atomic_load32(&amp;heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a59fb66e831ef1e0d56d826b1851576eb">child_count</a>))</div>
<div class="line"><a name="l01570"></a><span class="lineno"> 1570</span>&#160;        {</div>
<div class="line"><a name="l01571"></a><span class="lineno"> 1571</span>&#160;            <a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *span = (<a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *)((<a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#a4788399d1d0b37ccf098a7da82254808">uintptr_t</a>)heap &amp; <a class="code" href="../../df/dc0/rpmalloc_8c.html#ae7b97ba12e15609b6d63926ed2e30238">_memory_span_mask</a>);</div>
<div class="line"><a name="l01572"></a><span class="lineno"> 1572</span>&#160;            <a class="code" href="../../df/dc0/rpmalloc_8c.html#a1b31ff8fa0abcdb205dadd8afc026014">_rpmalloc_span_unmap</a>(span);</div>
<div class="line"><a name="l01573"></a><span class="lineno"> 1573</span>&#160;        }</div>
<div class="line"><a name="l01574"></a><span class="lineno"> 1574</span>&#160;    }</div>
<div class="line"><a name="l01575"></a><span class="lineno"> 1575</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l01576"></a><span class="lineno"> 1576</span>&#160;    {</div>
<div class="line"><a name="l01577"></a><span class="lineno"> 1577</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="../../df/dc0/rpmalloc_8c.html#a4f0dc3c548801773a4da1c96f39b04c9">atomic_decr32</a>(&amp;heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a348c1835d21f0af4a3776f96bdba64fb">master_heap</a>-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a59fb66e831ef1e0d56d826b1851576eb">child_count</a>) == 0)</div>
<div class="line"><a name="l01578"></a><span class="lineno"> 1578</span>&#160;        {</div>
<div class="line"><a name="l01579"></a><span class="lineno"> 1579</span>&#160;            <a class="code" href="../../df/dc0/rpmalloc_8c.html#a0d896198d6c5673397704f9f6bdadbdf">_rpmalloc_heap_unmap</a>(heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a348c1835d21f0af4a3776f96bdba64fb">master_heap</a>);</div>
<div class="line"><a name="l01580"></a><span class="lineno"> 1580</span>&#160;        }</div>
<div class="line"><a name="l01581"></a><span class="lineno"> 1581</span>&#160;    }</div>
<div class="line"><a name="l01582"></a><span class="lineno"> 1582</span>&#160;}</div>
<div class="line"><a name="l01583"></a><span class="lineno"> 1583</span>&#160; </div>
<div class="line"><a name="l01584"></a><span class="lineno"> 1584</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="l01585"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a2f7a67a3403fd19a70e7a0418714af57"> 1585</a></span>&#160;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a2f7a67a3403fd19a70e7a0418714af57">_rpmalloc_heap_global_finalize</a>(<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#d9/d8a/structheap__t">heap_t</a> *heap)</div>
<div class="line"><a name="l01586"></a><span class="lineno"> 1586</span>&#160;{</div>
<div class="line"><a name="l01587"></a><span class="lineno"> 1587</span>&#160;    <span class="keywordflow">if</span> (heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a13ccab5430ace95c471aacf1fab0fcd6">finalize</a>++ &gt; 1)</div>
<div class="line"><a name="l01588"></a><span class="lineno"> 1588</span>&#160;    {</div>
<div class="line"><a name="l01589"></a><span class="lineno"> 1589</span>&#160;        --heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a13ccab5430ace95c471aacf1fab0fcd6">finalize</a>;</div>
<div class="line"><a name="l01590"></a><span class="lineno"> 1590</span>&#160;        <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l01591"></a><span class="lineno"> 1591</span>&#160;    }</div>
<div class="line"><a name="l01592"></a><span class="lineno"> 1592</span>&#160; </div>
<div class="line"><a name="l01593"></a><span class="lineno"> 1593</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#a2a1e3b11c0a8fc714d6def51250c6906">_rpmalloc_heap_finalize</a>(heap);</div>
<div class="line"><a name="l01594"></a><span class="lineno"> 1594</span>&#160; </div>
<div class="line"><a name="l01595"></a><span class="lineno"> 1595</span>&#160;<span class="preprocessor">#if ENABLE_THREAD_CACHE</span></div>
<div class="line"><a name="l01596"></a><span class="lineno"> 1596</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> iclass = 0; iclass &lt; <a class="code" href="../../df/dc0/rpmalloc_8c.html#a04406da3f5ff4e24f155c97591678ed9">LARGE_CLASS_COUNT</a>; ++iclass)</div>
<div class="line"><a name="l01597"></a><span class="lineno"> 1597</span>&#160;    {</div>
<div class="line"><a name="l01598"></a><span class="lineno"> 1598</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#da/d15/structspan__cache__t">span_cache_t</a> *span_cache;</div>
<div class="line"><a name="l01599"></a><span class="lineno"> 1599</span>&#160;        <span class="keywordflow">if</span> (!iclass)</div>
<div class="line"><a name="l01600"></a><span class="lineno"> 1600</span>&#160;            span_cache = &amp;heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#ae112aace519bbe14edb9127cefb59705">span_cache</a>;</div>
<div class="line"><a name="l01601"></a><span class="lineno"> 1601</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l01602"></a><span class="lineno"> 1602</span>&#160;            span_cache = (<a class="code" href="../../df/dc0/rpmalloc_8c.html#da/d15/structspan__cache__t">span_cache_t</a> *)(heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#aea02bb1ed60acc428d5a2d2db2cd9a7b">span_large_cache</a> + (iclass - 1));</div>
<div class="line"><a name="l01603"></a><span class="lineno"> 1603</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> ispan = 0; ispan &lt; span_cache-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a894a66f329862f01de7619aee1954d19">count</a>; ++ispan)</div>
<div class="line"><a name="l01604"></a><span class="lineno"> 1604</span>&#160;            <a class="code" href="../../df/dc0/rpmalloc_8c.html#a1b31ff8fa0abcdb205dadd8afc026014">_rpmalloc_span_unmap</a>(span_cache-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a8cc6a9b0d6d8d6bf8367bca0101b1ae3">span</a>[ispan]);</div>
<div class="line"><a name="l01605"></a><span class="lineno"> 1605</span>&#160;        span_cache-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a894a66f329862f01de7619aee1954d19">count</a> = 0;</div>
<div class="line"><a name="l01606"></a><span class="lineno"> 1606</span>&#160;    }</div>
<div class="line"><a name="l01607"></a><span class="lineno"> 1607</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01608"></a><span class="lineno"> 1608</span>&#160; </div>
<div class="line"><a name="l01609"></a><span class="lineno"> 1609</span>&#160;    <span class="keywordflow">if</span> (heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a6aa789c3cdf7e70df144c248d18c5f4c">full_span_count</a>)</div>
<div class="line"><a name="l01610"></a><span class="lineno"> 1610</span>&#160;    {</div>
<div class="line"><a name="l01611"></a><span class="lineno"> 1611</span>&#160;        --heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a13ccab5430ace95c471aacf1fab0fcd6">finalize</a>;</div>
<div class="line"><a name="l01612"></a><span class="lineno"> 1612</span>&#160;        <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l01613"></a><span class="lineno"> 1613</span>&#160;    }</div>
<div class="line"><a name="l01614"></a><span class="lineno"> 1614</span>&#160; </div>
<div class="line"><a name="l01615"></a><span class="lineno"> 1615</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> iclass = 0; iclass &lt; <a class="code" href="../../df/dc0/rpmalloc_8c.html#aa74d427b2b9955ff2d9719693d9fc80e">SIZE_CLASS_COUNT</a>; ++iclass)</div>
<div class="line"><a name="l01616"></a><span class="lineno"> 1616</span>&#160;    {</div>
<div class="line"><a name="l01617"></a><span class="lineno"> 1617</span>&#160;        <span class="keywordflow">if</span> (heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a70f9a96b9071ccb6642894f5a7f56432">size_class</a>[iclass].<a class="code" href="../../df/dc0/rpmalloc_8c.html#ac411b0f198d4e31569fc30ca2c174f65">free_list</a> || heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a70f9a96b9071ccb6642894f5a7f56432">size_class</a>[iclass].<a class="code" href="../../df/dc0/rpmalloc_8c.html#af829c49d9fc4d933c14113ba0d694e7c">partial_span</a>)</div>
<div class="line"><a name="l01618"></a><span class="lineno"> 1618</span>&#160;        {</div>
<div class="line"><a name="l01619"></a><span class="lineno"> 1619</span>&#160;            --heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a13ccab5430ace95c471aacf1fab0fcd6">finalize</a>;</div>
<div class="line"><a name="l01620"></a><span class="lineno"> 1620</span>&#160;            <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l01621"></a><span class="lineno"> 1621</span>&#160;        }</div>
<div class="line"><a name="l01622"></a><span class="lineno"> 1622</span>&#160;    }</div>
<div class="line"><a name="l01623"></a><span class="lineno"> 1623</span>&#160;    <span class="comment">// Heap is now completely free, unmap and remove from heap list</span></div>
<div class="line"><a name="l01624"></a><span class="lineno"> 1624</span>&#160;    <span class="keywordtype">size_t</span> list_idx = (<a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#aa9d55e2f20e580b7445617d0d12fff6e">size_t</a>)heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a2342224142317f85fca91614fc973131">id</a> % <a class="code" href="../../df/dc0/rpmalloc_8c.html#ac7e4a352a230ef04d4372db43a454b7f">HEAP_ARRAY_SIZE</a>;</div>
<div class="line"><a name="l01625"></a><span class="lineno"> 1625</span>&#160;    <a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#d9/d8a/structheap__t">heap_t</a> *list_heap = <a class="code" href="../../df/dc0/rpmalloc_8c.html#a3e39052a111a2e243645494f1d6ca439">_memory_heaps</a>[list_idx];</div>
<div class="line"><a name="l01626"></a><span class="lineno"> 1626</span>&#160;    <a class="code" href="../../d9/def/mb__64bit__map_8cpp.html#a7d5d79792cdea43010184ab50d14ac5a">if</a> (list_heap == heap)</div>
<div class="line"><a name="l01627"></a><span class="lineno"> 1627</span>&#160;    {</div>
<div class="line"><a name="l01628"></a><span class="lineno"> 1628</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#a3e39052a111a2e243645494f1d6ca439">_memory_heaps</a>[list_idx] = heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a74b47a0eacf313fe421d32379a2b942c">next_heap</a>;</div>
<div class="line"><a name="l01629"></a><span class="lineno"> 1629</span>&#160;    }</div>
<div class="line"><a name="l01630"></a><span class="lineno"> 1630</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l01631"></a><span class="lineno"> 1631</span>&#160;    {</div>
<div class="line"><a name="l01632"></a><span class="lineno"> 1632</span>&#160;        <span class="keywordflow">while</span> (list_heap-&gt;next_heap != heap)</div>
<div class="line"><a name="l01633"></a><span class="lineno"> 1633</span>&#160;            list_heap = list_heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a74b47a0eacf313fe421d32379a2b942c">next_heap</a>;</div>
<div class="line"><a name="l01634"></a><span class="lineno"> 1634</span>&#160;        list_heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a74b47a0eacf313fe421d32379a2b942c">next_heap</a> = heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a74b47a0eacf313fe421d32379a2b942c">next_heap</a>;</div>
<div class="line"><a name="l01635"></a><span class="lineno"> 1635</span>&#160;    }</div>
<div class="line"><a name="l01636"></a><span class="lineno"> 1636</span>&#160; </div>
<div class="line"><a name="l01637"></a><span class="lineno"> 1637</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#a0d896198d6c5673397704f9f6bdadbdf">_rpmalloc_heap_unmap</a>(heap);</div>
<div class="line"><a name="l01638"></a><span class="lineno"> 1638</span>&#160;}</div>
<div class="line"><a name="l01639"></a><span class="lineno"> 1639</span>&#160; </div>
<div class="line"><a name="l01641"></a><span class="lineno"> 1641</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="l01642"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#abdbbc20ab63d76c1709722f3f2305610"> 1642</a></span>&#160;<a class="code" href="../../df/dc0/rpmalloc_8c.html#abdbbc20ab63d76c1709722f3f2305610">_rpmalloc_heap_cache_insert</a>(<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#d9/d8a/structheap__t">heap_t</a> *heap, <a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *span)</div>
<div class="line"><a name="l01643"></a><span class="lineno"> 1643</span>&#160;{</div>
<div class="line"><a name="l01644"></a><span class="lineno"> 1644</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="../../df/dc0/rpmalloc_8c.html#af8f864d9fe0055b43dc8034fe9060630">UNEXPECTED</a>(heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a13ccab5430ace95c471aacf1fab0fcd6">finalize</a> != 0))</div>
<div class="line"><a name="l01645"></a><span class="lineno"> 1645</span>&#160;    {</div>
<div class="line"><a name="l01646"></a><span class="lineno"> 1646</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#a1b31ff8fa0abcdb205dadd8afc026014">_rpmalloc_span_unmap</a>(span);</div>
<div class="line"><a name="l01647"></a><span class="lineno"> 1647</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#a2f7a67a3403fd19a70e7a0418714af57">_rpmalloc_heap_global_finalize</a>(heap);</div>
<div class="line"><a name="l01648"></a><span class="lineno"> 1648</span>&#160;        <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l01649"></a><span class="lineno"> 1649</span>&#160;    }</div>
<div class="line"><a name="l01650"></a><span class="lineno"> 1650</span>&#160;<span class="preprocessor">#if ENABLE_THREAD_CACHE</span></div>
<div class="line"><a name="l01651"></a><span class="lineno"> 1651</span>&#160;    <span class="keywordtype">size_t</span> span_count = span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#ae77d9a2cdd2a2fd46e3b27739d6c88cc">span_count</a>;</div>
<div class="line"><a name="l01652"></a><span class="lineno"> 1652</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#ab51bbcd0d9d41ba9c6f4ad547ba77405">_rpmalloc_stat_inc</a>(&amp;heap-&gt;span_use[span_count - 1].spans_to_cache);</div>
<div class="line"><a name="l01653"></a><span class="lineno"> 1653</span>&#160;    <span class="keywordflow">if</span> (span_count == 1)</div>
<div class="line"><a name="l01654"></a><span class="lineno"> 1654</span>&#160;    {</div>
<div class="line"><a name="l01655"></a><span class="lineno"> 1655</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#da/d15/structspan__cache__t">span_cache_t</a> *span_cache = &amp;heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#ae112aace519bbe14edb9127cefb59705">span_cache</a>;</div>
<div class="line"><a name="l01656"></a><span class="lineno"> 1656</span>&#160;        span_cache-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a8cc6a9b0d6d8d6bf8367bca0101b1ae3">span</a>[span_cache-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a894a66f329862f01de7619aee1954d19">count</a>++] = span;</div>
<div class="line"><a name="l01657"></a><span class="lineno"> 1657</span>&#160;        <span class="keywordflow">if</span> (span_cache-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a894a66f329862f01de7619aee1954d19">count</a> == <a class="code" href="../../df/dc0/rpmalloc_8c.html#aebbd8639c3b627f526bd557e065f1c00">MAX_THREAD_SPAN_CACHE</a>)</div>
<div class="line"><a name="l01658"></a><span class="lineno"> 1658</span>&#160;        {</div>
<div class="line"><a name="l01659"></a><span class="lineno"> 1659</span>&#160;            <span class="keyword">const</span> <span class="keywordtype">size_t</span> remain_count = <a class="code" href="../../df/dc0/rpmalloc_8c.html#aebbd8639c3b627f526bd557e065f1c00">MAX_THREAD_SPAN_CACHE</a> - <a class="code" href="../../df/dc0/rpmalloc_8c.html#a24ad9380461f94f601227da3fe3676da">THREAD_SPAN_CACHE_TRANSFER</a>;</div>
<div class="line"><a name="l01660"></a><span class="lineno"> 1660</span>&#160;<span class="preprocessor">#if ENABLE_GLOBAL_CACHE</span></div>
<div class="line"><a name="l01661"></a><span class="lineno"> 1661</span>&#160;            <a class="code" href="../../df/dc0/rpmalloc_8c.html#a49e532a65b873a6c3315aa769299687c">_rpmalloc_stat_add64</a>(&amp;heap-&gt;thread_to_global, <a class="code" href="../../df/dc0/rpmalloc_8c.html#a24ad9380461f94f601227da3fe3676da">THREAD_SPAN_CACHE_TRANSFER</a> * <a class="code" href="../../df/dc0/rpmalloc_8c.html#a9fefa5277fefa0c58f69d5b86d679ccb">_memory_span_size</a>);</div>
<div class="line"><a name="l01662"></a><span class="lineno"> 1662</span>&#160;            <a class="code" href="../../df/dc0/rpmalloc_8c.html#a4a53d0cfdcf755d4fbbae446a055440c">_rpmalloc_stat_add</a>(&amp;heap-&gt;span_use[span_count - 1].spans_to_global, <a class="code" href="../../df/dc0/rpmalloc_8c.html#a24ad9380461f94f601227da3fe3676da">THREAD_SPAN_CACHE_TRANSFER</a>);</div>
<div class="line"><a name="l01663"></a><span class="lineno"> 1663</span>&#160;            <a class="code" href="../../df/dc0/rpmalloc_8c.html#a06d0861a56c7d5aac6e215ab0dceb9ca">_rpmalloc_global_cache_insert_spans</a>(span_cache-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a8cc6a9b0d6d8d6bf8367bca0101b1ae3">span</a> + remain_count, span_count, <a class="code" href="../../df/dc0/rpmalloc_8c.html#a24ad9380461f94f601227da3fe3676da">THREAD_SPAN_CACHE_TRANSFER</a>);</div>
<div class="line"><a name="l01664"></a><span class="lineno"> 1664</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l01665"></a><span class="lineno"> 1665</span>&#160;            <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> ispan = 0; ispan &lt; <a class="code" href="../../df/dc0/rpmalloc_8c.html#a24ad9380461f94f601227da3fe3676da">THREAD_SPAN_CACHE_TRANSFER</a>; ++ispan)</div>
<div class="line"><a name="l01666"></a><span class="lineno"> 1666</span>&#160;                <a class="code" href="../../df/dc0/rpmalloc_8c.html#a1b31ff8fa0abcdb205dadd8afc026014">_rpmalloc_span_unmap</a>(span_cache-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a8cc6a9b0d6d8d6bf8367bca0101b1ae3">span</a>[remain_count + ispan]);</div>
<div class="line"><a name="l01667"></a><span class="lineno"> 1667</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01668"></a><span class="lineno"> 1668</span>&#160;            span_cache-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a894a66f329862f01de7619aee1954d19">count</a> = remain_count;</div>
<div class="line"><a name="l01669"></a><span class="lineno"> 1669</span>&#160;        }</div>
<div class="line"><a name="l01670"></a><span class="lineno"> 1670</span>&#160;    }</div>
<div class="line"><a name="l01671"></a><span class="lineno"> 1671</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l01672"></a><span class="lineno"> 1672</span>&#160;    {</div>
<div class="line"><a name="l01673"></a><span class="lineno"> 1673</span>&#160;        <span class="keywordtype">size_t</span> cache_idx = span_count - 2;</div>
<div class="line"><a name="l01674"></a><span class="lineno"> 1674</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#d5/dec/structspan__large__cache__t">span_large_cache_t</a> *span_cache = heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#aea02bb1ed60acc428d5a2d2db2cd9a7b">span_large_cache</a> + cache_idx;</div>
<div class="line"><a name="l01675"></a><span class="lineno"> 1675</span>&#160;        span_cache-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a77eff1faca249ec6ae27881769f7d979">span</a>[span_cache-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a07da73cfe1c11642973a6eb1386a3a1c">count</a>++] = span;</div>
<div class="line"><a name="l01676"></a><span class="lineno"> 1676</span>&#160;        <span class="keyword">const</span> <span class="keywordtype">size_t</span> cache_limit = (<a class="code" href="../../df/dc0/rpmalloc_8c.html#a51b78975d481805f29847ad91c77d6ad">MAX_THREAD_SPAN_LARGE_CACHE</a> - (span_count &gt;&gt; 1));</div>
<div class="line"><a name="l01677"></a><span class="lineno"> 1677</span>&#160;        <span class="keywordflow">if</span> (span_cache-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a07da73cfe1c11642973a6eb1386a3a1c">count</a> == cache_limit)</div>
<div class="line"><a name="l01678"></a><span class="lineno"> 1678</span>&#160;        {</div>
<div class="line"><a name="l01679"></a><span class="lineno"> 1679</span>&#160;            <span class="keyword">const</span> <span class="keywordtype">size_t</span> transfer_limit = 2 + (cache_limit &gt;&gt; 2);</div>
<div class="line"><a name="l01680"></a><span class="lineno"> 1680</span>&#160;            <span class="keyword">const</span> <span class="keywordtype">size_t</span> transfer_count = (<a class="code" href="../../df/dc0/rpmalloc_8c.html#a2e9cc04738eb37814086f557943373d8">THREAD_SPAN_LARGE_CACHE_TRANSFER</a> &lt;= transfer_limit ? <a class="code" href="../../df/dc0/rpmalloc_8c.html#a2e9cc04738eb37814086f557943373d8">THREAD_SPAN_LARGE_CACHE_TRANSFER</a> : transfer_limit);</div>
<div class="line"><a name="l01681"></a><span class="lineno"> 1681</span>&#160;            <span class="keyword">const</span> <span class="keywordtype">size_t</span> remain_count = cache_limit - transfer_count;</div>
<div class="line"><a name="l01682"></a><span class="lineno"> 1682</span>&#160;<span class="preprocessor">#if ENABLE_GLOBAL_CACHE</span></div>
<div class="line"><a name="l01683"></a><span class="lineno"> 1683</span>&#160;            <a class="code" href="../../df/dc0/rpmalloc_8c.html#a49e532a65b873a6c3315aa769299687c">_rpmalloc_stat_add64</a>(&amp;heap-&gt;thread_to_global, transfer_count * span_count * <a class="code" href="../../df/dc0/rpmalloc_8c.html#a9fefa5277fefa0c58f69d5b86d679ccb">_memory_span_size</a>);</div>
<div class="line"><a name="l01684"></a><span class="lineno"> 1684</span>&#160;            <a class="code" href="../../df/dc0/rpmalloc_8c.html#a4a53d0cfdcf755d4fbbae446a055440c">_rpmalloc_stat_add</a>(&amp;heap-&gt;span_use[span_count - 1].spans_to_global, transfer_count);</div>
<div class="line"><a name="l01685"></a><span class="lineno"> 1685</span>&#160;            <a class="code" href="../../df/dc0/rpmalloc_8c.html#a06d0861a56c7d5aac6e215ab0dceb9ca">_rpmalloc_global_cache_insert_spans</a>(span_cache-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a77eff1faca249ec6ae27881769f7d979">span</a> + remain_count, span_count, transfer_count);</div>
<div class="line"><a name="l01686"></a><span class="lineno"> 1686</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l01687"></a><span class="lineno"> 1687</span>&#160;            <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> ispan = 0; ispan &lt; transfer_count; ++ispan)</div>
<div class="line"><a name="l01688"></a><span class="lineno"> 1688</span>&#160;                <a class="code" href="../../df/dc0/rpmalloc_8c.html#a1b31ff8fa0abcdb205dadd8afc026014">_rpmalloc_span_unmap</a>(span_cache-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a77eff1faca249ec6ae27881769f7d979">span</a>[remain_count + ispan]);</div>
<div class="line"><a name="l01689"></a><span class="lineno"> 1689</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01690"></a><span class="lineno"> 1690</span>&#160;            span_cache-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a07da73cfe1c11642973a6eb1386a3a1c">count</a> = remain_count;</div>
<div class="line"><a name="l01691"></a><span class="lineno"> 1691</span>&#160;        }</div>
<div class="line"><a name="l01692"></a><span class="lineno"> 1692</span>&#160;    }</div>
<div class="line"><a name="l01693"></a><span class="lineno"> 1693</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l01694"></a><span class="lineno"> 1694</span>&#160;    (void)<span class="keyword">sizeof</span>(heap);</div>
<div class="line"><a name="l01695"></a><span class="lineno"> 1695</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#a1b31ff8fa0abcdb205dadd8afc026014">_rpmalloc_span_unmap</a>(span);</div>
<div class="line"><a name="l01696"></a><span class="lineno"> 1696</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01697"></a><span class="lineno"> 1697</span>&#160;}</div>
<div class="line"><a name="l01698"></a><span class="lineno"> 1698</span>&#160; </div>
<div class="line"><a name="l01700"></a><span class="lineno"> 1700</span>&#160;<span class="keyword">static</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *</div>
<div class="line"><a name="l01701"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a2c70a492ba1920b405001750ab3e6622"> 1701</a></span>&#160;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a2c70a492ba1920b405001750ab3e6622">_rpmalloc_heap_thread_cache_extract</a>(<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#d9/d8a/structheap__t">heap_t</a> *heap, <span class="keywordtype">size_t</span> span_count)</div>
<div class="line"><a name="l01702"></a><span class="lineno"> 1702</span>&#160;{</div>
<div class="line"><a name="l01703"></a><span class="lineno"> 1703</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *span = 0;</div>
<div class="line"><a name="l01704"></a><span class="lineno"> 1704</span>&#160;<span class="preprocessor">#if ENABLE_THREAD_CACHE</span></div>
<div class="line"><a name="l01705"></a><span class="lineno"> 1705</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#da/d15/structspan__cache__t">span_cache_t</a> *span_cache;</div>
<div class="line"><a name="l01706"></a><span class="lineno"> 1706</span>&#160;    <span class="keywordflow">if</span> (span_count == 1)</div>
<div class="line"><a name="l01707"></a><span class="lineno"> 1707</span>&#160;        span_cache = &amp;heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#ae112aace519bbe14edb9127cefb59705">span_cache</a>;</div>
<div class="line"><a name="l01708"></a><span class="lineno"> 1708</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l01709"></a><span class="lineno"> 1709</span>&#160;        span_cache = (<a class="code" href="../../df/dc0/rpmalloc_8c.html#da/d15/structspan__cache__t">span_cache_t</a> *)(heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#aea02bb1ed60acc428d5a2d2db2cd9a7b">span_large_cache</a> + (span_count - 2));</div>
<div class="line"><a name="l01710"></a><span class="lineno"> 1710</span>&#160;    <span class="keywordflow">if</span> (span_cache-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a894a66f329862f01de7619aee1954d19">count</a>)</div>
<div class="line"><a name="l01711"></a><span class="lineno"> 1711</span>&#160;    {</div>
<div class="line"><a name="l01712"></a><span class="lineno"> 1712</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#ab51bbcd0d9d41ba9c6f4ad547ba77405">_rpmalloc_stat_inc</a>(&amp;heap-&gt;span_use[span_count - 1].spans_from_cache);</div>
<div class="line"><a name="l01713"></a><span class="lineno"> 1713</span>&#160;        <span class="keywordflow">return</span> span_cache-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a8cc6a9b0d6d8d6bf8367bca0101b1ae3">span</a>[--span_cache-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a894a66f329862f01de7619aee1954d19">count</a>];</div>
<div class="line"><a name="l01714"></a><span class="lineno"> 1714</span>&#160;    }</div>
<div class="line"><a name="l01715"></a><span class="lineno"> 1715</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01716"></a><span class="lineno"> 1716</span>&#160;    <span class="keywordflow">return</span> span;</div>
<div class="line"><a name="l01717"></a><span class="lineno"> 1717</span>&#160;}</div>
<div class="line"><a name="l01718"></a><span class="lineno"> 1718</span>&#160; </div>
<div class="line"><a name="l01719"></a><span class="lineno"> 1719</span>&#160;<span class="keyword">static</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *</div>
<div class="line"><a name="l01720"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a6a8bcd4676dfdcfd084cfe9d0c81c3d5"> 1720</a></span>&#160;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a6a8bcd4676dfdcfd084cfe9d0c81c3d5">_rpmalloc_heap_thread_cache_deferred_extract</a>(<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#d9/d8a/structheap__t">heap_t</a> *heap, <span class="keywordtype">size_t</span> span_count)</div>
<div class="line"><a name="l01721"></a><span class="lineno"> 1721</span>&#160;{</div>
<div class="line"><a name="l01722"></a><span class="lineno"> 1722</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *span = 0;</div>
<div class="line"><a name="l01723"></a><span class="lineno"> 1723</span>&#160;    <span class="keywordflow">if</span> (span_count == 1)</div>
<div class="line"><a name="l01724"></a><span class="lineno"> 1724</span>&#160;    {</div>
<div class="line"><a name="l01725"></a><span class="lineno"> 1725</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#af44e92f7ed42c434bd33a0ae98210a3f">_rpmalloc_heap_cache_adopt_deferred</a>(heap, &amp;span);</div>
<div class="line"><a name="l01726"></a><span class="lineno"> 1726</span>&#160;    }</div>
<div class="line"><a name="l01727"></a><span class="lineno"> 1727</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l01728"></a><span class="lineno"> 1728</span>&#160;    {</div>
<div class="line"><a name="l01729"></a><span class="lineno"> 1729</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#af44e92f7ed42c434bd33a0ae98210a3f">_rpmalloc_heap_cache_adopt_deferred</a>(heap, 0);</div>
<div class="line"><a name="l01730"></a><span class="lineno"> 1730</span>&#160;        span = <a class="code" href="../../df/dc0/rpmalloc_8c.html#a2c70a492ba1920b405001750ab3e6622">_rpmalloc_heap_thread_cache_extract</a>(heap, span_count);</div>
<div class="line"><a name="l01731"></a><span class="lineno"> 1731</span>&#160;    }</div>
<div class="line"><a name="l01732"></a><span class="lineno"> 1732</span>&#160;    <span class="keywordflow">return</span> span;</div>
<div class="line"><a name="l01733"></a><span class="lineno"> 1733</span>&#160;}</div>
<div class="line"><a name="l01734"></a><span class="lineno"> 1734</span>&#160; </div>
<div class="line"><a name="l01735"></a><span class="lineno"> 1735</span>&#160;<span class="keyword">static</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *</div>
<div class="line"><a name="l01736"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#af1cf3243cc57cc5033ae07b71984abcf"> 1736</a></span>&#160;<a class="code" href="../../df/dc0/rpmalloc_8c.html#af1cf3243cc57cc5033ae07b71984abcf">_rpmalloc_heap_reserved_extract</a>(<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#d9/d8a/structheap__t">heap_t</a> *heap, <span class="keywordtype">size_t</span> span_count)</div>
<div class="line"><a name="l01737"></a><span class="lineno"> 1737</span>&#160;{</div>
<div class="line"><a name="l01738"></a><span class="lineno"> 1738</span>&#160;    <span class="keywordflow">if</span> (heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a8d5b27011e1ab5140090f90a75584329">spans_reserved</a> &gt;= span_count)</div>
<div class="line"><a name="l01739"></a><span class="lineno"> 1739</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#a80aeb0b9294d1463006c963e7073244e">_rpmalloc_span_map</a>(heap, span_count);</div>
<div class="line"><a name="l01740"></a><span class="lineno"> 1740</span>&#160;    <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l01741"></a><span class="lineno"> 1741</span>&#160;}</div>
<div class="line"><a name="l01742"></a><span class="lineno"> 1742</span>&#160; </div>
<div class="line"><a name="l01744"></a><span class="lineno"> 1744</span>&#160;<span class="keyword">static</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *</div>
<div class="line"><a name="l01745"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#ad9fade5754c34dc5e3ee99c1e432ccb7"> 1745</a></span>&#160;<a class="code" href="../../df/dc0/rpmalloc_8c.html#ad9fade5754c34dc5e3ee99c1e432ccb7">_rpmalloc_heap_global_cache_extract</a>(<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#d9/d8a/structheap__t">heap_t</a> *heap, <span class="keywordtype">size_t</span> span_count)</div>
<div class="line"><a name="l01746"></a><span class="lineno"> 1746</span>&#160;{</div>
<div class="line"><a name="l01747"></a><span class="lineno"> 1747</span>&#160;<span class="preprocessor">#if ENABLE_GLOBAL_CACHE</span></div>
<div class="line"><a name="l01748"></a><span class="lineno"> 1748</span>&#160;<span class="preprocessor">#if ENABLE_THREAD_CACHE</span></div>
<div class="line"><a name="l01749"></a><span class="lineno"> 1749</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#da/d15/structspan__cache__t">span_cache_t</a> *span_cache;</div>
<div class="line"><a name="l01750"></a><span class="lineno"> 1750</span>&#160;    <span class="keywordtype">size_t</span> wanted_count;</div>
<div class="line"><a name="l01751"></a><span class="lineno"> 1751</span>&#160;    <span class="keywordflow">if</span> (span_count == 1)</div>
<div class="line"><a name="l01752"></a><span class="lineno"> 1752</span>&#160;    {</div>
<div class="line"><a name="l01753"></a><span class="lineno"> 1753</span>&#160;        span_cache = &amp;heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#ae112aace519bbe14edb9127cefb59705">span_cache</a>;</div>
<div class="line"><a name="l01754"></a><span class="lineno"> 1754</span>&#160;        wanted_count = <a class="code" href="../../df/dc0/rpmalloc_8c.html#a24ad9380461f94f601227da3fe3676da">THREAD_SPAN_CACHE_TRANSFER</a>;</div>
<div class="line"><a name="l01755"></a><span class="lineno"> 1755</span>&#160;    }</div>
<div class="line"><a name="l01756"></a><span class="lineno"> 1756</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l01757"></a><span class="lineno"> 1757</span>&#160;    {</div>
<div class="line"><a name="l01758"></a><span class="lineno"> 1758</span>&#160;        span_cache = (<a class="code" href="../../df/dc0/rpmalloc_8c.html#da/d15/structspan__cache__t">span_cache_t</a> *)(heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#aea02bb1ed60acc428d5a2d2db2cd9a7b">span_large_cache</a> + (span_count - 2));</div>
<div class="line"><a name="l01759"></a><span class="lineno"> 1759</span>&#160;        wanted_count = <a class="code" href="../../df/dc0/rpmalloc_8c.html#a2e9cc04738eb37814086f557943373d8">THREAD_SPAN_LARGE_CACHE_TRANSFER</a>;</div>
<div class="line"><a name="l01760"></a><span class="lineno"> 1760</span>&#160;    }</div>
<div class="line"><a name="l01761"></a><span class="lineno"> 1761</span>&#160;    span_cache-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a894a66f329862f01de7619aee1954d19">count</a> = <a class="code" href="../../df/dc0/rpmalloc_8c.html#ac0d9f7ba6a7fbb2c64e323a0f55c66d7">_rpmalloc_global_cache_extract_spans</a>(span_cache-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a8cc6a9b0d6d8d6bf8367bca0101b1ae3">span</a>, span_count, wanted_count);</div>
<div class="line"><a name="l01762"></a><span class="lineno"> 1762</span>&#160;    <span class="keywordflow">if</span> (span_cache-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a894a66f329862f01de7619aee1954d19">count</a>)</div>
<div class="line"><a name="l01763"></a><span class="lineno"> 1763</span>&#160;    {</div>
<div class="line"><a name="l01764"></a><span class="lineno"> 1764</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#a49e532a65b873a6c3315aa769299687c">_rpmalloc_stat_add64</a>(&amp;heap-&gt;global_to_thread, span_count * span_cache-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a894a66f329862f01de7619aee1954d19">count</a> * <a class="code" href="../../df/dc0/rpmalloc_8c.html#a9fefa5277fefa0c58f69d5b86d679ccb">_memory_span_size</a>);</div>
<div class="line"><a name="l01765"></a><span class="lineno"> 1765</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#a4a53d0cfdcf755d4fbbae446a055440c">_rpmalloc_stat_add</a>(&amp;heap-&gt;span_use[span_count - 1].spans_from_global, span_cache-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a894a66f329862f01de7619aee1954d19">count</a>);</div>
<div class="line"><a name="l01766"></a><span class="lineno"> 1766</span>&#160;        <span class="keywordflow">return</span> span_cache-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a8cc6a9b0d6d8d6bf8367bca0101b1ae3">span</a>[--span_cache-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a894a66f329862f01de7619aee1954d19">count</a>];</div>
<div class="line"><a name="l01767"></a><span class="lineno"> 1767</span>&#160;    }</div>
<div class="line"><a name="l01768"></a><span class="lineno"> 1768</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l01769"></a><span class="lineno"> 1769</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *span = 0;</div>
<div class="line"><a name="l01770"></a><span class="lineno"> 1770</span>&#160;    <span class="keywordtype">size_t</span> <a class="code" href="../../d0/d64/syscall_8cpp.html#a7801f18982e0e5d2853680593ff81c04">count</a> = <a class="code" href="../../df/dc0/rpmalloc_8c.html#ac0d9f7ba6a7fbb2c64e323a0f55c66d7">_rpmalloc_global_cache_extract_spans</a>(&amp;span, span_count, 1);</div>
<div class="line"><a name="l01771"></a><span class="lineno"> 1771</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="../../d0/d64/syscall_8cpp.html#a7801f18982e0e5d2853680593ff81c04">count</a>)</div>
<div class="line"><a name="l01772"></a><span class="lineno"> 1772</span>&#160;    {</div>
<div class="line"><a name="l01773"></a><span class="lineno"> 1773</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#a49e532a65b873a6c3315aa769299687c">_rpmalloc_stat_add64</a>(&amp;heap-&gt;global_to_thread, span_count * <a class="code" href="../../d0/d64/syscall_8cpp.html#a7801f18982e0e5d2853680593ff81c04">count</a> * <a class="code" href="../../df/dc0/rpmalloc_8c.html#a9fefa5277fefa0c58f69d5b86d679ccb">_memory_span_size</a>);</div>
<div class="line"><a name="l01774"></a><span class="lineno"> 1774</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#a4a53d0cfdcf755d4fbbae446a055440c">_rpmalloc_stat_add</a>(&amp;heap-&gt;span_use[span_count - 1].spans_from_global, <a class="code" href="../../d0/d64/syscall_8cpp.html#a7801f18982e0e5d2853680593ff81c04">count</a>);</div>
<div class="line"><a name="l01775"></a><span class="lineno"> 1775</span>&#160;        <span class="keywordflow">return</span> span;</div>
<div class="line"><a name="l01776"></a><span class="lineno"> 1776</span>&#160;    }</div>
<div class="line"><a name="l01777"></a><span class="lineno"> 1777</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01778"></a><span class="lineno"> 1778</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01779"></a><span class="lineno"> 1779</span>&#160;    (void)<span class="keyword">sizeof</span>(heap);</div>
<div class="line"><a name="l01780"></a><span class="lineno"> 1780</span>&#160;    (void)<span class="keyword">sizeof</span>(span_count);</div>
<div class="line"><a name="l01781"></a><span class="lineno"> 1781</span>&#160;    <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l01782"></a><span class="lineno"> 1782</span>&#160;}</div>
<div class="line"><a name="l01783"></a><span class="lineno"> 1783</span>&#160; </div>
<div class="line"><a name="l01784"></a><span class="lineno"> 1784</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="l01785"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a56211c3481cd02195d9bac3c1475cdfb"> 1785</a></span>&#160;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a56211c3481cd02195d9bac3c1475cdfb">_rpmalloc_inc_span_statistics</a>(<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#d9/d8a/structheap__t">heap_t</a> *heap, <span class="keywordtype">size_t</span> span_count, <a class="code" href="../../dd/ddd/arithmetic__operations_8c.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a> class_idx)</div>
<div class="line"><a name="l01786"></a><span class="lineno"> 1786</span>&#160;{</div>
<div class="line"><a name="l01787"></a><span class="lineno"> 1787</span>&#160;    (void)<span class="keyword">sizeof</span>(heap);</div>
<div class="line"><a name="l01788"></a><span class="lineno"> 1788</span>&#160;    (void)<span class="keyword">sizeof</span>(span_count);</div>
<div class="line"><a name="l01789"></a><span class="lineno"> 1789</span>&#160;    (void)<span class="keyword">sizeof</span>(class_idx);</div>
<div class="line"><a name="l01790"></a><span class="lineno"> 1790</span>&#160;<span class="preprocessor">#if ENABLE_ADAPTIVE_THREAD_CACHE || ENABLE_STATISTICS</span></div>
<div class="line"><a name="l01791"></a><span class="lineno"> 1791</span>&#160;    <a class="code" href="../../dd/ddd/arithmetic__operations_8c.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a> <a class="code" href="../../dc/d3d/proto_8c.html#ae40354a1051342eb5a9db005715dcfa9">idx</a> = (<a class="code" href="../../dd/ddd/arithmetic__operations_8c.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a>)span_count - 1;</div>
<div class="line"><a name="l01792"></a><span class="lineno"> 1792</span>&#160;    <a class="code" href="../../dd/ddd/arithmetic__operations_8c.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a> current_count = (<a class="code" href="../../dd/ddd/arithmetic__operations_8c.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a>)<a class="code" href="../../df/dc0/rpmalloc_8c.html#a1fe9c932f58e2baffed3ea33fd299691">atomic_incr32</a>(&amp;heap-&gt;span_use[<a class="code" href="../../dc/d3d/proto_8c.html#ae40354a1051342eb5a9db005715dcfa9">idx</a>].current);</div>
<div class="line"><a name="l01793"></a><span class="lineno"> 1793</span>&#160;    <span class="keywordflow">if</span> (current_count &gt; (<a class="code" href="../../dd/ddd/arithmetic__operations_8c.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a>)atomic_load32(&amp;heap-&gt;span_use[<a class="code" href="../../dc/d3d/proto_8c.html#ae40354a1051342eb5a9db005715dcfa9">idx</a>].high))</div>
<div class="line"><a name="l01794"></a><span class="lineno"> 1794</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#aa1ee77cdccf0341222f64395d0be2626">atomic_store32</a>(&amp;heap-&gt;span_use[<a class="code" href="../../dc/d3d/proto_8c.html#ae40354a1051342eb5a9db005715dcfa9">idx</a>].high, (<a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#a0c18914b3041c2f583aba76f418399c2">int32_t</a>)current_count);</div>
<div class="line"><a name="l01795"></a><span class="lineno"> 1795</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#a599c57201987cc23a9787a745296e575">_rpmalloc_stat_add_peak</a>(&amp;heap-&gt;size_class_use[class_idx].spans_current, 1, heap-&gt;size_class_use[class_idx].spans_peak);</div>
<div class="line"><a name="l01796"></a><span class="lineno"> 1796</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01797"></a><span class="lineno"> 1797</span>&#160;}</div>
<div class="line"><a name="l01798"></a><span class="lineno"> 1798</span>&#160; </div>
<div class="line"><a name="l01800"></a><span class="lineno"> 1800</span>&#160;<span class="keyword">static</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *</div>
<div class="line"><a name="l01801"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a435bea54b94450010a1a6d0c4f22a0c5"> 1801</a></span>&#160;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a435bea54b94450010a1a6d0c4f22a0c5">_rpmalloc_heap_extract_new_span</a>(<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#d9/d8a/structheap__t">heap_t</a> *heap, <a class="code" href="../../df/dc0/rpmalloc_8c.html#d3/dad/structheap__size__class__t">heap_size_class_t</a> *heap_size_class, <span class="keywordtype">size_t</span> span_count, <a class="code" href="../../dd/ddd/arithmetic__operations_8c.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a> class_idx)</div>
<div class="line"><a name="l01802"></a><span class="lineno"> 1802</span>&#160;{</div>
<div class="line"><a name="l01803"></a><span class="lineno"> 1803</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *span;</div>
<div class="line"><a name="l01804"></a><span class="lineno"> 1804</span>&#160;<span class="preprocessor">#if ENABLE_THREAD_CACHE</span></div>
<div class="line"><a name="l01805"></a><span class="lineno"> 1805</span>&#160;    <span class="keywordflow">if</span> (heap_size_class &amp;&amp; heap_size_class-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a72cb3beffa763418cb7c8e89ff257b8e">cache</a>)</div>
<div class="line"><a name="l01806"></a><span class="lineno"> 1806</span>&#160;    {</div>
<div class="line"><a name="l01807"></a><span class="lineno"> 1807</span>&#160;        span = heap_size_class-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a72cb3beffa763418cb7c8e89ff257b8e">cache</a>;</div>
<div class="line"><a name="l01808"></a><span class="lineno"> 1808</span>&#160;        heap_size_class-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a72cb3beffa763418cb7c8e89ff257b8e">cache</a> = (heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#ae112aace519bbe14edb9127cefb59705">span_cache</a>.<a class="code" href="../../df/dc0/rpmalloc_8c.html#a894a66f329862f01de7619aee1954d19">count</a> ? heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#ae112aace519bbe14edb9127cefb59705">span_cache</a>.<a class="code" href="../../df/dc0/rpmalloc_8c.html#a8cc6a9b0d6d8d6bf8367bca0101b1ae3">span</a>[--heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#ae112aace519bbe14edb9127cefb59705">span_cache</a>.<a class="code" href="../../df/dc0/rpmalloc_8c.html#a894a66f329862f01de7619aee1954d19">count</a>] : 0);</div>
<div class="line"><a name="l01809"></a><span class="lineno"> 1809</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#a56211c3481cd02195d9bac3c1475cdfb">_rpmalloc_inc_span_statistics</a>(heap, span_count, class_idx);</div>
<div class="line"><a name="l01810"></a><span class="lineno"> 1810</span>&#160;        <span class="keywordflow">return</span> span;</div>
<div class="line"><a name="l01811"></a><span class="lineno"> 1811</span>&#160;    }</div>
<div class="line"><a name="l01812"></a><span class="lineno"> 1812</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01813"></a><span class="lineno"> 1813</span>&#160;    (void)<span class="keyword">sizeof</span>(class_idx);</div>
<div class="line"><a name="l01814"></a><span class="lineno"> 1814</span>&#160;    <span class="comment">// Allow 50% overhead to increase cache hits</span></div>
<div class="line"><a name="l01815"></a><span class="lineno"> 1815</span>&#160;    <span class="keywordtype">size_t</span> base_span_count = span_count;</div>
<div class="line"><a name="l01816"></a><span class="lineno"> 1816</span>&#160;    <span class="keywordtype">size_t</span> limit_span_count = (span_count &gt; 2) ? (span_count + (span_count &gt;&gt; 1)) : span_count;</div>
<div class="line"><a name="l01817"></a><span class="lineno"> 1817</span>&#160;    <span class="keywordflow">if</span> (limit_span_count &gt; <a class="code" href="../../df/dc0/rpmalloc_8c.html#a04406da3f5ff4e24f155c97591678ed9">LARGE_CLASS_COUNT</a>)</div>
<div class="line"><a name="l01818"></a><span class="lineno"> 1818</span>&#160;        limit_span_count = <a class="code" href="../../df/dc0/rpmalloc_8c.html#a04406da3f5ff4e24f155c97591678ed9">LARGE_CLASS_COUNT</a>;</div>
<div class="line"><a name="l01819"></a><span class="lineno"> 1819</span>&#160;    <span class="keywordflow">do</span></div>
<div class="line"><a name="l01820"></a><span class="lineno"> 1820</span>&#160;    {</div>
<div class="line"><a name="l01821"></a><span class="lineno"> 1821</span>&#160;        span = <a class="code" href="../../df/dc0/rpmalloc_8c.html#a2c70a492ba1920b405001750ab3e6622">_rpmalloc_heap_thread_cache_extract</a>(heap, span_count);</div>
<div class="line"><a name="l01822"></a><span class="lineno"> 1822</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="../../df/dc0/rpmalloc_8c.html#a90593dceacf0c04f14d084bed7e7eabe">EXPECTED</a>(span != 0))</div>
<div class="line"><a name="l01823"></a><span class="lineno"> 1823</span>&#160;        {</div>
<div class="line"><a name="l01824"></a><span class="lineno"> 1824</span>&#160;            <a class="code" href="../../df/dc0/rpmalloc_8c.html#ab51bbcd0d9d41ba9c6f4ad547ba77405">_rpmalloc_stat_inc</a>(&amp;heap-&gt;size_class_use[class_idx].spans_from_cache);</div>
<div class="line"><a name="l01825"></a><span class="lineno"> 1825</span>&#160;            <a class="code" href="../../df/dc0/rpmalloc_8c.html#a56211c3481cd02195d9bac3c1475cdfb">_rpmalloc_inc_span_statistics</a>(heap, span_count, class_idx);</div>
<div class="line"><a name="l01826"></a><span class="lineno"> 1826</span>&#160;            <span class="keywordflow">return</span> span;</div>
<div class="line"><a name="l01827"></a><span class="lineno"> 1827</span>&#160;        }</div>
<div class="line"><a name="l01828"></a><span class="lineno"> 1828</span>&#160;        span = <a class="code" href="../../df/dc0/rpmalloc_8c.html#a6a8bcd4676dfdcfd084cfe9d0c81c3d5">_rpmalloc_heap_thread_cache_deferred_extract</a>(heap, span_count);</div>
<div class="line"><a name="l01829"></a><span class="lineno"> 1829</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="../../df/dc0/rpmalloc_8c.html#a90593dceacf0c04f14d084bed7e7eabe">EXPECTED</a>(span != 0))</div>
<div class="line"><a name="l01830"></a><span class="lineno"> 1830</span>&#160;        {</div>
<div class="line"><a name="l01831"></a><span class="lineno"> 1831</span>&#160;            <a class="code" href="../../df/dc0/rpmalloc_8c.html#ab51bbcd0d9d41ba9c6f4ad547ba77405">_rpmalloc_stat_inc</a>(&amp;heap-&gt;size_class_use[class_idx].spans_from_cache);</div>
<div class="line"><a name="l01832"></a><span class="lineno"> 1832</span>&#160;            <a class="code" href="../../df/dc0/rpmalloc_8c.html#a56211c3481cd02195d9bac3c1475cdfb">_rpmalloc_inc_span_statistics</a>(heap, span_count, class_idx);</div>
<div class="line"><a name="l01833"></a><span class="lineno"> 1833</span>&#160;            <span class="keywordflow">return</span> span;</div>
<div class="line"><a name="l01834"></a><span class="lineno"> 1834</span>&#160;        }</div>
<div class="line"><a name="l01835"></a><span class="lineno"> 1835</span>&#160;        span = <a class="code" href="../../df/dc0/rpmalloc_8c.html#af1cf3243cc57cc5033ae07b71984abcf">_rpmalloc_heap_reserved_extract</a>(heap, span_count);</div>
<div class="line"><a name="l01836"></a><span class="lineno"> 1836</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="../../df/dc0/rpmalloc_8c.html#a90593dceacf0c04f14d084bed7e7eabe">EXPECTED</a>(span != 0))</div>
<div class="line"><a name="l01837"></a><span class="lineno"> 1837</span>&#160;        {</div>
<div class="line"><a name="l01838"></a><span class="lineno"> 1838</span>&#160;            <a class="code" href="../../df/dc0/rpmalloc_8c.html#ab51bbcd0d9d41ba9c6f4ad547ba77405">_rpmalloc_stat_inc</a>(&amp;heap-&gt;size_class_use[class_idx].spans_from_reserved);</div>
<div class="line"><a name="l01839"></a><span class="lineno"> 1839</span>&#160;            <a class="code" href="../../df/dc0/rpmalloc_8c.html#a56211c3481cd02195d9bac3c1475cdfb">_rpmalloc_inc_span_statistics</a>(heap, span_count, class_idx);</div>
<div class="line"><a name="l01840"></a><span class="lineno"> 1840</span>&#160;            <span class="keywordflow">return</span> span;</div>
<div class="line"><a name="l01841"></a><span class="lineno"> 1841</span>&#160;        }</div>
<div class="line"><a name="l01842"></a><span class="lineno"> 1842</span>&#160;        span = <a class="code" href="../../df/dc0/rpmalloc_8c.html#ad9fade5754c34dc5e3ee99c1e432ccb7">_rpmalloc_heap_global_cache_extract</a>(heap, span_count);</div>
<div class="line"><a name="l01843"></a><span class="lineno"> 1843</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="../../df/dc0/rpmalloc_8c.html#a90593dceacf0c04f14d084bed7e7eabe">EXPECTED</a>(span != 0))</div>
<div class="line"><a name="l01844"></a><span class="lineno"> 1844</span>&#160;        {</div>
<div class="line"><a name="l01845"></a><span class="lineno"> 1845</span>&#160;            <a class="code" href="../../df/dc0/rpmalloc_8c.html#ab51bbcd0d9d41ba9c6f4ad547ba77405">_rpmalloc_stat_inc</a>(&amp;heap-&gt;size_class_use[class_idx].spans_from_cache);</div>
<div class="line"><a name="l01846"></a><span class="lineno"> 1846</span>&#160;            <a class="code" href="../../df/dc0/rpmalloc_8c.html#a56211c3481cd02195d9bac3c1475cdfb">_rpmalloc_inc_span_statistics</a>(heap, span_count, class_idx);</div>
<div class="line"><a name="l01847"></a><span class="lineno"> 1847</span>&#160;            <span class="keywordflow">return</span> span;</div>
<div class="line"><a name="l01848"></a><span class="lineno"> 1848</span>&#160;        }</div>
<div class="line"><a name="l01849"></a><span class="lineno"> 1849</span>&#160;        ++span_count;</div>
<div class="line"><a name="l01850"></a><span class="lineno"> 1850</span>&#160;    } <span class="keywordflow">while</span> (span_count &lt;= limit_span_count);</div>
<div class="line"><a name="l01851"></a><span class="lineno"> 1851</span>&#160;    <span class="comment">// Final fallback, map in more virtual memory</span></div>
<div class="line"><a name="l01852"></a><span class="lineno"> 1852</span>&#160;    span = <a class="code" href="../../df/dc0/rpmalloc_8c.html#a80aeb0b9294d1463006c963e7073244e">_rpmalloc_span_map</a>(heap, base_span_count);</div>
<div class="line"><a name="l01853"></a><span class="lineno"> 1853</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#a56211c3481cd02195d9bac3c1475cdfb">_rpmalloc_inc_span_statistics</a>(heap, base_span_count, class_idx);</div>
<div class="line"><a name="l01854"></a><span class="lineno"> 1854</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#ab51bbcd0d9d41ba9c6f4ad547ba77405">_rpmalloc_stat_inc</a>(&amp;heap-&gt;size_class_use[class_idx].spans_map_calls);</div>
<div class="line"><a name="l01855"></a><span class="lineno"> 1855</span>&#160;    <span class="keywordflow">return</span> span;</div>
<div class="line"><a name="l01856"></a><span class="lineno"> 1856</span>&#160;}</div>
<div class="line"><a name="l01857"></a><span class="lineno"> 1857</span>&#160; </div>
<div class="line"><a name="l01858"></a><span class="lineno"> 1858</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="l01859"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a58f109a58b8e38970cda041f4ea96772"> 1859</a></span>&#160;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a58f109a58b8e38970cda041f4ea96772">_rpmalloc_heap_initialize</a>(<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#d9/d8a/structheap__t">heap_t</a> *heap)</div>
<div class="line"><a name="l01860"></a><span class="lineno"> 1860</span>&#160;{</div>
<div class="line"><a name="l01861"></a><span class="lineno"> 1861</span>&#160;    <a class="code" href="../../d3/d82/convert_8h.html#a9c1f204516a55affa9ba118907e5ab6b">memset_unsafe</a>(heap, 0, <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#d9/d8a/structheap__t">heap_t</a>));</div>
<div class="line"><a name="l01862"></a><span class="lineno"> 1862</span>&#160;    <span class="comment">// Get a new heap ID</span></div>
<div class="line"><a name="l01863"></a><span class="lineno"> 1863</span>&#160;    heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a2342224142317f85fca91614fc973131">id</a> = 1 + <a class="code" href="../../df/dc0/rpmalloc_8c.html#a1fe9c932f58e2baffed3ea33fd299691">atomic_incr32</a>(&amp;<a class="code" href="../../df/dc0/rpmalloc_8c.html#af42cdefbf9addf1c268ba19e63c60f29">_memory_heap_id</a>);</div>
<div class="line"><a name="l01864"></a><span class="lineno"> 1864</span>&#160; </div>
<div class="line"><a name="l01865"></a><span class="lineno"> 1865</span>&#160;    <span class="comment">// Link in heap in heap ID map</span></div>
<div class="line"><a name="l01866"></a><span class="lineno"> 1866</span>&#160;    <span class="keywordtype">size_t</span> list_idx = (<a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#aa9d55e2f20e580b7445617d0d12fff6e">size_t</a>)heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a2342224142317f85fca91614fc973131">id</a> % <a class="code" href="../../df/dc0/rpmalloc_8c.html#ac7e4a352a230ef04d4372db43a454b7f">HEAP_ARRAY_SIZE</a>;</div>
<div class="line"><a name="l01867"></a><span class="lineno"> 1867</span>&#160;    heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a74b47a0eacf313fe421d32379a2b942c">next_heap</a> = <a class="code" href="../../df/dc0/rpmalloc_8c.html#a3e39052a111a2e243645494f1d6ca439">_memory_heaps</a>[list_idx];</div>
<div class="line"><a name="l01868"></a><span class="lineno"> 1868</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#a3e39052a111a2e243645494f1d6ca439">_memory_heaps</a>[list_idx] = heap;</div>
<div class="line"><a name="l01869"></a><span class="lineno"> 1869</span>&#160;}</div>
<div class="line"><a name="l01870"></a><span class="lineno"> 1870</span>&#160; </div>
<div class="line"><a name="l01871"></a><span class="lineno"> 1871</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="l01872"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a5bd98ea2cfee2186b2aa2b921450807f"> 1872</a></span>&#160;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a5bd98ea2cfee2186b2aa2b921450807f">_rpmalloc_heap_orphan</a>(<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#d9/d8a/structheap__t">heap_t</a> *heap, <span class="keywordtype">int</span> first_class)</div>
<div class="line"><a name="l01873"></a><span class="lineno"> 1873</span>&#160;{</div>
<div class="line"><a name="l01874"></a><span class="lineno"> 1874</span>&#160;    heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a436e67271364d132c12f2f5f0d4c79ef">owner_thread</a> = (<a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#a4788399d1d0b37ccf098a7da82254808">uintptr_t</a>)-1;</div>
<div class="line"><a name="l01875"></a><span class="lineno"> 1875</span>&#160;<span class="preprocessor">#if RPMALLOC_FIRST_CLASS_HEAPS</span></div>
<div class="line"><a name="l01876"></a><span class="lineno"> 1876</span>&#160;    <a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#d9/d8a/structheap__t">heap_t</a> **heap_list = (first_class ? &amp;_memory_first_class_orphan_heaps : &amp;<a class="code" href="../../df/dc0/rpmalloc_8c.html#ae3a524405e2a853229e95546df284be2">_memory_orphan_heaps</a>);</div>
<div class="line"><a name="l01877"></a><span class="lineno"> 1877</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l01878"></a><span class="lineno"> 1878</span>&#160;    (void)<span class="keyword">sizeof</span>(first_class);</div>
<div class="line"><a name="l01879"></a><span class="lineno"> 1879</span>&#160;    <a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#d9/d8a/structheap__t">heap_t</a> **heap_list = &amp;<a class="code" href="../../df/dc0/rpmalloc_8c.html#ae3a524405e2a853229e95546df284be2">_memory_orphan_heaps</a>;</div>
<div class="line"><a name="l01880"></a><span class="lineno"> 1880</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01881"></a><span class="lineno"> 1881</span>&#160;    heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a87e83453c93d1e6de70f6a45044e510d">next_orphan</a> = *heap_list;</div>
<div class="line"><a name="l01882"></a><span class="lineno"> 1882</span>&#160;    *heap_list = heap;</div>
<div class="line"><a name="l01883"></a><span class="lineno"> 1883</span>&#160;}</div>
<div class="line"><a name="l01884"></a><span class="lineno"> 1884</span>&#160; </div>
<div class="line"><a name="l01886"></a><span class="lineno"> 1886</span>&#160;<span class="keyword">static</span> <a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#d9/d8a/structheap__t">heap_t</a> *</div>
<div class="line"><a name="l01887"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a34805759f2f107ac549c3394840ebf35"> 1887</a></span>&#160;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a34805759f2f107ac549c3394840ebf35">_rpmalloc_heap_allocate_new</a>(<span class="keywordtype">void</span>)</div>
<div class="line"><a name="l01888"></a><span class="lineno"> 1888</span>&#160;{</div>
<div class="line"><a name="l01889"></a><span class="lineno"> 1889</span>&#160;    <span class="comment">// Map in pages for a 16 heaps. If page size is greater than required size for this, map a page and</span></div>
<div class="line"><a name="l01890"></a><span class="lineno"> 1890</span>&#160;    <span class="comment">// use first part for heaps and remaining part for spans for allocations. Adds a lot of complexity,</span></div>
<div class="line"><a name="l01891"></a><span class="lineno"> 1891</span>&#160;    <span class="comment">// but saves a lot of memory on systems where page size &gt; 64 spans (4MiB)</span></div>
<div class="line"><a name="l01892"></a><span class="lineno"> 1892</span>&#160;    <span class="keywordtype">size_t</span> heap_size = <span class="keyword">sizeof</span>(<a class="code" href="../../df/dc0/rpmalloc_8c.html#a75c19bcef00dee4542c1ddab212e29a8">heap_t</a>);</div>
<div class="line"><a name="l01893"></a><span class="lineno"> 1893</span>&#160;    <span class="keywordtype">size_t</span> aligned_heap_size = 16 * ((heap_size + 15) / 16);</div>
<div class="line"><a name="l01894"></a><span class="lineno"> 1894</span>&#160;    <span class="keywordtype">size_t</span> request_heap_count = 16;</div>
<div class="line"><a name="l01895"></a><span class="lineno"> 1895</span>&#160;    <span class="keywordtype">size_t</span> heap_span_count = ((aligned_heap_size * request_heap_count) + <span class="keyword">sizeof</span>(<a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a>) + <a class="code" href="../../df/dc0/rpmalloc_8c.html#a9fefa5277fefa0c58f69d5b86d679ccb">_memory_span_size</a> - 1) / <a class="code" href="../../df/dc0/rpmalloc_8c.html#a9fefa5277fefa0c58f69d5b86d679ccb">_memory_span_size</a>;</div>
<div class="line"><a name="l01896"></a><span class="lineno"> 1896</span>&#160;    <span class="keywordtype">size_t</span> block_size = <a class="code" href="../../df/dc0/rpmalloc_8c.html#a9fefa5277fefa0c58f69d5b86d679ccb">_memory_span_size</a> * heap_span_count;</div>
<div class="line"><a name="l01897"></a><span class="lineno"> 1897</span>&#160;    <span class="keywordtype">size_t</span> span_count = heap_span_count;</div>
<div class="line"><a name="l01898"></a><span class="lineno"> 1898</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *span = 0;</div>
<div class="line"><a name="l01899"></a><span class="lineno"> 1899</span>&#160;    <span class="comment">// If there are global reserved spans, use these first</span></div>
<div class="line"><a name="l01900"></a><span class="lineno"> 1900</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="../../df/dc0/rpmalloc_8c.html#a19d785146ca5053c2da69ad1ec4de94c">_memory_global_reserve_count</a> &gt;= heap_span_count)</div>
<div class="line"><a name="l01901"></a><span class="lineno"> 1901</span>&#160;    {</div>
<div class="line"><a name="l01902"></a><span class="lineno"> 1902</span>&#160;        span = <a class="code" href="../../df/dc0/rpmalloc_8c.html#abc75935ba437c535deefc42928807231">_rpmalloc_global_get_reserved_spans</a>(heap_span_count);</div>
<div class="line"><a name="l01903"></a><span class="lineno"> 1903</span>&#160;    }</div>
<div class="line"><a name="l01904"></a><span class="lineno"> 1904</span>&#160;    <span class="keywordflow">if</span> (!span)</div>
<div class="line"><a name="l01905"></a><span class="lineno"> 1905</span>&#160;    {</div>
<div class="line"><a name="l01906"></a><span class="lineno"> 1906</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="../../df/dc0/rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a> &gt; block_size)</div>
<div class="line"><a name="l01907"></a><span class="lineno"> 1907</span>&#160;        {</div>
<div class="line"><a name="l01908"></a><span class="lineno"> 1908</span>&#160;            span_count = <a class="code" href="../../df/dc0/rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a> / <a class="code" href="../../df/dc0/rpmalloc_8c.html#a9fefa5277fefa0c58f69d5b86d679ccb">_memory_span_size</a>;</div>
<div class="line"><a name="l01909"></a><span class="lineno"> 1909</span>&#160;            block_size = <a class="code" href="../../df/dc0/rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a>;</div>
<div class="line"><a name="l01910"></a><span class="lineno"> 1910</span>&#160;            <span class="comment">// If using huge pages, make sure to grab enough heaps to avoid reallocating a huge page just to serve new heaps</span></div>
<div class="line"><a name="l01911"></a><span class="lineno"> 1911</span>&#160;            <span class="keywordtype">size_t</span> possible_heap_count = (block_size - <span class="keyword">sizeof</span>(<a class="code" href="../../df/dc0/rpmalloc_8c.html#aa34fdcc23a2d119e7436a33e05ddb665">span_t</a>)) / aligned_heap_size;</div>
<div class="line"><a name="l01912"></a><span class="lineno"> 1912</span>&#160;            <span class="keywordflow">if</span> (possible_heap_count &gt;= (request_heap_count * 16))</div>
<div class="line"><a name="l01913"></a><span class="lineno"> 1913</span>&#160;                request_heap_count *= 16;</div>
<div class="line"><a name="l01914"></a><span class="lineno"> 1914</span>&#160;            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (possible_heap_count &lt; request_heap_count)</div>
<div class="line"><a name="l01915"></a><span class="lineno"> 1915</span>&#160;                request_heap_count = possible_heap_count;</div>
<div class="line"><a name="l01916"></a><span class="lineno"> 1916</span>&#160;            heap_span_count = ((aligned_heap_size * request_heap_count) + <span class="keyword">sizeof</span>(<a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a>) + <a class="code" href="../../df/dc0/rpmalloc_8c.html#a9fefa5277fefa0c58f69d5b86d679ccb">_memory_span_size</a> - 1) / <a class="code" href="../../df/dc0/rpmalloc_8c.html#a9fefa5277fefa0c58f69d5b86d679ccb">_memory_span_size</a>;</div>
<div class="line"><a name="l01917"></a><span class="lineno"> 1917</span>&#160;        }</div>
<div class="line"><a name="l01918"></a><span class="lineno"> 1918</span>&#160; </div>
<div class="line"><a name="l01919"></a><span class="lineno"> 1919</span>&#160;        <span class="keywordtype">size_t</span> align_offset = 0;</div>
<div class="line"><a name="l01920"></a><span class="lineno"> 1920</span>&#160;        span = (<a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *)<a class="code" href="../../df/dc0/rpmalloc_8c.html#a2d8a3eac487ff2943f8aae4dd20badd3">_rpmalloc_mmap</a>(block_size, &amp;align_offset);</div>
<div class="line"><a name="l01921"></a><span class="lineno"> 1921</span>&#160;        <span class="keywordflow">if</span> (!span)</div>
<div class="line"><a name="l01922"></a><span class="lineno"> 1922</span>&#160;            <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l01923"></a><span class="lineno"> 1923</span>&#160; </div>
<div class="line"><a name="l01924"></a><span class="lineno"> 1924</span>&#160;        <span class="comment">// Master span will contain the heaps</span></div>
<div class="line"><a name="l01925"></a><span class="lineno"> 1925</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#ab51bbcd0d9d41ba9c6f4ad547ba77405">_rpmalloc_stat_inc</a>(&amp;_master_spans);</div>
<div class="line"><a name="l01926"></a><span class="lineno"> 1926</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#ad5eb163989618d4ea0eff254cdbdd596">_rpmalloc_span_initialize</a>(span, span_count, heap_span_count, align_offset);</div>
<div class="line"><a name="l01927"></a><span class="lineno"> 1927</span>&#160;    }</div>
<div class="line"><a name="l01928"></a><span class="lineno"> 1928</span>&#160; </div>
<div class="line"><a name="l01929"></a><span class="lineno"> 1929</span>&#160;    <span class="keywordtype">size_t</span> remain_size = <a class="code" href="../../df/dc0/rpmalloc_8c.html#a9fefa5277fefa0c58f69d5b86d679ccb">_memory_span_size</a> - <span class="keyword">sizeof</span>(<a class="code" href="../../df/dc0/rpmalloc_8c.html#aa34fdcc23a2d119e7436a33e05ddb665">span_t</a>);</div>
<div class="line"><a name="l01930"></a><span class="lineno"> 1930</span>&#160;    <a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#d9/d8a/structheap__t">heap_t</a> *heap = (<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#d9/d8a/structheap__t">heap_t</a> *)<a class="code" href="../../df/dc0/rpmalloc_8c.html#ab4225911698b67188e1538c334cfe16c">pointer_offset</a>(span, <span class="keyword">sizeof</span>(<a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a>));</div>
<div class="line"><a name="l01931"></a><span class="lineno"> 1931</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#a58f109a58b8e38970cda041f4ea96772">_rpmalloc_heap_initialize</a>(heap);</div>
<div class="line"><a name="l01932"></a><span class="lineno"> 1932</span>&#160; </div>
<div class="line"><a name="l01933"></a><span class="lineno"> 1933</span>&#160;    <span class="comment">// Put extra heaps as orphans</span></div>
<div class="line"><a name="l01934"></a><span class="lineno"> 1934</span>&#160;    <span class="keywordtype">size_t</span> num_heaps = remain_size / aligned_heap_size;</div>
<div class="line"><a name="l01935"></a><span class="lineno"> 1935</span>&#160;    <span class="keywordflow">if</span> (num_heaps &lt; request_heap_count)</div>
<div class="line"><a name="l01936"></a><span class="lineno"> 1936</span>&#160;        num_heaps = request_heap_count;</div>
<div class="line"><a name="l01937"></a><span class="lineno"> 1937</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#aa1ee77cdccf0341222f64395d0be2626">atomic_store32</a>(&amp;heap-&gt;child_count, (<a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#a0c18914b3041c2f583aba76f418399c2">int32_t</a>)num_heaps - 1);</div>
<div class="line"><a name="l01938"></a><span class="lineno"> 1938</span>&#160;    <a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#d9/d8a/structheap__t">heap_t</a> *extra_heap = (<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#d9/d8a/structheap__t">heap_t</a> *)<a class="code" href="../../df/dc0/rpmalloc_8c.html#ab4225911698b67188e1538c334cfe16c">pointer_offset</a>(heap, aligned_heap_size);</div>
<div class="line"><a name="l01939"></a><span class="lineno"> 1939</span>&#160;    <span class="keywordflow">while</span> (num_heaps &gt; 1)</div>
<div class="line"><a name="l01940"></a><span class="lineno"> 1940</span>&#160;    {</div>
<div class="line"><a name="l01941"></a><span class="lineno"> 1941</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#a58f109a58b8e38970cda041f4ea96772">_rpmalloc_heap_initialize</a>(extra_heap);</div>
<div class="line"><a name="l01942"></a><span class="lineno"> 1942</span>&#160;        extra_heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a348c1835d21f0af4a3776f96bdba64fb">master_heap</a> = heap;</div>
<div class="line"><a name="l01943"></a><span class="lineno"> 1943</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#a5bd98ea2cfee2186b2aa2b921450807f">_rpmalloc_heap_orphan</a>(extra_heap, 1);</div>
<div class="line"><a name="l01944"></a><span class="lineno"> 1944</span>&#160;        extra_heap = (<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#d9/d8a/structheap__t">heap_t</a> *)<a class="code" href="../../df/dc0/rpmalloc_8c.html#ab4225911698b67188e1538c334cfe16c">pointer_offset</a>(extra_heap, aligned_heap_size);</div>
<div class="line"><a name="l01945"></a><span class="lineno"> 1945</span>&#160;        --num_heaps;</div>
<div class="line"><a name="l01946"></a><span class="lineno"> 1946</span>&#160;    }</div>
<div class="line"><a name="l01947"></a><span class="lineno"> 1947</span>&#160; </div>
<div class="line"><a name="l01948"></a><span class="lineno"> 1948</span>&#160;    <span class="keywordflow">if</span> (span_count &gt; heap_span_count)</div>
<div class="line"><a name="l01949"></a><span class="lineno"> 1949</span>&#160;    {</div>
<div class="line"><a name="l01950"></a><span class="lineno"> 1950</span>&#160;        <span class="comment">// Cap reserved spans</span></div>
<div class="line"><a name="l01951"></a><span class="lineno"> 1951</span>&#160;        <span class="keywordtype">size_t</span> remain_count = span_count - heap_span_count;</div>
<div class="line"><a name="l01952"></a><span class="lineno"> 1952</span>&#160;        <span class="keywordtype">size_t</span> reserve_count = (remain_count &gt; <a class="code" href="../../df/dc0/rpmalloc_8c.html#ada12637cd22672d5ad52ceba482b7f5c">_memory_heap_reserve_count</a> ? <a class="code" href="../../df/dc0/rpmalloc_8c.html#ada12637cd22672d5ad52ceba482b7f5c">_memory_heap_reserve_count</a> : remain_count);</div>
<div class="line"><a name="l01953"></a><span class="lineno"> 1953</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *remain_span = (<a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *)<a class="code" href="../../df/dc0/rpmalloc_8c.html#ab4225911698b67188e1538c334cfe16c">pointer_offset</a>(span, heap_span_count * <a class="code" href="../../df/dc0/rpmalloc_8c.html#a9fefa5277fefa0c58f69d5b86d679ccb">_memory_span_size</a>);</div>
<div class="line"><a name="l01954"></a><span class="lineno"> 1954</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#ae4a00ccf859d64a7519ae121563a56e7">_rpmalloc_heap_set_reserved_spans</a>(heap, span, remain_span, reserve_count);</div>
<div class="line"><a name="l01955"></a><span class="lineno"> 1955</span>&#160; </div>
<div class="line"><a name="l01956"></a><span class="lineno"> 1956</span>&#160;        <span class="keywordflow">if</span> (remain_count &gt; reserve_count)</div>
<div class="line"><a name="l01957"></a><span class="lineno"> 1957</span>&#160;        {</div>
<div class="line"><a name="l01958"></a><span class="lineno"> 1958</span>&#160;            <span class="comment">// Set to global reserved spans</span></div>
<div class="line"><a name="l01959"></a><span class="lineno"> 1959</span>&#160;            remain_span = (<a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *)<a class="code" href="../../df/dc0/rpmalloc_8c.html#ab4225911698b67188e1538c334cfe16c">pointer_offset</a>(remain_span, reserve_count * <a class="code" href="../../df/dc0/rpmalloc_8c.html#a9fefa5277fefa0c58f69d5b86d679ccb">_memory_span_size</a>);</div>
<div class="line"><a name="l01960"></a><span class="lineno"> 1960</span>&#160;            reserve_count = remain_count - reserve_count;</div>
<div class="line"><a name="l01961"></a><span class="lineno"> 1961</span>&#160;            <a class="code" href="../../df/dc0/rpmalloc_8c.html#aa6d37b325f0f3c68f89cdf681681a09f">_rpmalloc_global_set_reserved_spans</a>(span, remain_span, reserve_count);</div>
<div class="line"><a name="l01962"></a><span class="lineno"> 1962</span>&#160;        }</div>
<div class="line"><a name="l01963"></a><span class="lineno"> 1963</span>&#160;    }</div>
<div class="line"><a name="l01964"></a><span class="lineno"> 1964</span>&#160; </div>
<div class="line"><a name="l01965"></a><span class="lineno"> 1965</span>&#160;    <span class="keywordflow">return</span> heap;</div>
<div class="line"><a name="l01966"></a><span class="lineno"> 1966</span>&#160;}</div>
<div class="line"><a name="l01967"></a><span class="lineno"> 1967</span>&#160; </div>
<div class="line"><a name="l01968"></a><span class="lineno"> 1968</span>&#160;<span class="keyword">static</span> <a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#d9/d8a/structheap__t">heap_t</a> *</div>
<div class="line"><a name="l01969"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#af281178bc271d4b4a2f2bd11f17adc04"> 1969</a></span>&#160;<a class="code" href="../../df/dc0/rpmalloc_8c.html#af281178bc271d4b4a2f2bd11f17adc04">_rpmalloc_heap_extract_orphan</a>(<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#d9/d8a/structheap__t">heap_t</a> **heap_list)</div>
<div class="line"><a name="l01970"></a><span class="lineno"> 1970</span>&#160;{</div>
<div class="line"><a name="l01971"></a><span class="lineno"> 1971</span>&#160;    <a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#d9/d8a/structheap__t">heap_t</a> *heap = *heap_list;</div>
<div class="line"><a name="l01972"></a><span class="lineno"> 1972</span>&#160;    *heap_list = (heap ? heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a87e83453c93d1e6de70f6a45044e510d">next_orphan</a> : 0);</div>
<div class="line"><a name="l01973"></a><span class="lineno"> 1973</span>&#160;    <span class="keywordflow">return</span> heap;</div>
<div class="line"><a name="l01974"></a><span class="lineno"> 1974</span>&#160;}</div>
<div class="line"><a name="l01975"></a><span class="lineno"> 1975</span>&#160; </div>
<div class="line"><a name="l01977"></a><span class="lineno"> 1977</span>&#160;<span class="keyword">static</span> <a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#d9/d8a/structheap__t">heap_t</a> *</div>
<div class="line"><a name="l01978"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a4ca7faed398dff40d231cbce5ebcc845"> 1978</a></span>&#160;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a4ca7faed398dff40d231cbce5ebcc845">_rpmalloc_heap_allocate</a>(<span class="keywordtype">int</span> first_class)</div>
<div class="line"><a name="l01979"></a><span class="lineno"> 1979</span>&#160;{</div>
<div class="line"><a name="l01980"></a><span class="lineno"> 1980</span>&#160;    <a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#d9/d8a/structheap__t">heap_t</a> *heap = 0;</div>
<div class="line"><a name="l01981"></a><span class="lineno"> 1981</span>&#160;    <span class="keywordflow">while</span> (!<a class="code" href="../../df/dc0/rpmalloc_8c.html#a2071bf7ebae50eced1f16b359f9d5c7d">atomic_cas32_acquire</a>(&amp;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a1cb428169705ddd63fb35383132dbc40">_memory_global_lock</a>, 1, 0))</div>
<div class="line"><a name="l01982"></a><span class="lineno"> 1982</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#a335307d78e0ff77d4da9cf42156803ec">_rpmalloc_spin</a>();</div>
<div class="line"><a name="l01983"></a><span class="lineno"> 1983</span>&#160;    <span class="keywordflow">if</span> (first_class == 0)</div>
<div class="line"><a name="l01984"></a><span class="lineno"> 1984</span>&#160;        heap = <a class="code" href="../../df/dc0/rpmalloc_8c.html#af281178bc271d4b4a2f2bd11f17adc04">_rpmalloc_heap_extract_orphan</a>(&amp;<a class="code" href="../../df/dc0/rpmalloc_8c.html#ae3a524405e2a853229e95546df284be2">_memory_orphan_heaps</a>);</div>
<div class="line"><a name="l01985"></a><span class="lineno"> 1985</span>&#160;<span class="preprocessor">#if RPMALLOC_FIRST_CLASS_HEAPS</span></div>
<div class="line"><a name="l01986"></a><span class="lineno"> 1986</span>&#160;    <span class="keywordflow">if</span> (!heap)</div>
<div class="line"><a name="l01987"></a><span class="lineno"> 1987</span>&#160;        heap = <a class="code" href="../../df/dc0/rpmalloc_8c.html#af281178bc271d4b4a2f2bd11f17adc04">_rpmalloc_heap_extract_orphan</a>(&amp;_memory_first_class_orphan_heaps);</div>
<div class="line"><a name="l01988"></a><span class="lineno"> 1988</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01989"></a><span class="lineno"> 1989</span>&#160;    <span class="keywordflow">if</span> (!heap)</div>
<div class="line"><a name="l01990"></a><span class="lineno"> 1990</span>&#160;        heap = <a class="code" href="../../df/dc0/rpmalloc_8c.html#a34805759f2f107ac549c3394840ebf35">_rpmalloc_heap_allocate_new</a>();</div>
<div class="line"><a name="l01991"></a><span class="lineno"> 1991</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#a2a87a6060d5387fe8491a00600073687">atomic_store32_release</a>(&amp;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a1cb428169705ddd63fb35383132dbc40">_memory_global_lock</a>, 0);</div>
<div class="line"><a name="l01992"></a><span class="lineno"> 1992</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#af44e92f7ed42c434bd33a0ae98210a3f">_rpmalloc_heap_cache_adopt_deferred</a>(heap, 0);</div>
<div class="line"><a name="l01993"></a><span class="lineno"> 1993</span>&#160;    <span class="keywordflow">return</span> heap;</div>
<div class="line"><a name="l01994"></a><span class="lineno"> 1994</span>&#160;}</div>
<div class="line"><a name="l01995"></a><span class="lineno"> 1995</span>&#160; </div>
<div class="line"><a name="l01996"></a><span class="lineno"> 1996</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="l01997"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a1b9ab55b2401b2d4240bbca4b313f6a2"> 1997</a></span>&#160;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a1b9ab55b2401b2d4240bbca4b313f6a2">_rpmalloc_heap_release</a>(<span class="keywordtype">void</span> *heapptr, <span class="keywordtype">int</span> first_class, <span class="keywordtype">int</span> release_cache)</div>
<div class="line"><a name="l01998"></a><span class="lineno"> 1998</span>&#160;{</div>
<div class="line"><a name="l01999"></a><span class="lineno"> 1999</span>&#160;    <a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#d9/d8a/structheap__t">heap_t</a> *heap = (<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#d9/d8a/structheap__t">heap_t</a> *)heapptr;</div>
<div class="line"><a name="l02000"></a><span class="lineno"> 2000</span>&#160;    <span class="keywordflow">if</span> (!heap)</div>
<div class="line"><a name="l02001"></a><span class="lineno"> 2001</span>&#160;        <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l02002"></a><span class="lineno"> 2002</span>&#160;    <span class="comment">// Release thread cache spans back to global cache</span></div>
<div class="line"><a name="l02003"></a><span class="lineno"> 2003</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#af44e92f7ed42c434bd33a0ae98210a3f">_rpmalloc_heap_cache_adopt_deferred</a>(heap, 0);</div>
<div class="line"><a name="l02004"></a><span class="lineno"> 2004</span>&#160;    <span class="keywordflow">if</span> (release_cache || heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a13ccab5430ace95c471aacf1fab0fcd6">finalize</a>)</div>
<div class="line"><a name="l02005"></a><span class="lineno"> 2005</span>&#160;    {</div>
<div class="line"><a name="l02006"></a><span class="lineno"> 2006</span>&#160;<span class="preprocessor">#if ENABLE_THREAD_CACHE</span></div>
<div class="line"><a name="l02007"></a><span class="lineno"> 2007</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> iclass = 0; iclass &lt; <a class="code" href="../../df/dc0/rpmalloc_8c.html#a04406da3f5ff4e24f155c97591678ed9">LARGE_CLASS_COUNT</a>; ++iclass)</div>
<div class="line"><a name="l02008"></a><span class="lineno"> 2008</span>&#160;        {</div>
<div class="line"><a name="l02009"></a><span class="lineno"> 2009</span>&#160;            <a class="code" href="../../df/dc0/rpmalloc_8c.html#da/d15/structspan__cache__t">span_cache_t</a> *span_cache;</div>
<div class="line"><a name="l02010"></a><span class="lineno"> 2010</span>&#160;            <span class="keywordflow">if</span> (!iclass)</div>
<div class="line"><a name="l02011"></a><span class="lineno"> 2011</span>&#160;                span_cache = &amp;heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#ae112aace519bbe14edb9127cefb59705">span_cache</a>;</div>
<div class="line"><a name="l02012"></a><span class="lineno"> 2012</span>&#160;            <span class="keywordflow">else</span></div>
<div class="line"><a name="l02013"></a><span class="lineno"> 2013</span>&#160;                span_cache = (<a class="code" href="../../df/dc0/rpmalloc_8c.html#da/d15/structspan__cache__t">span_cache_t</a> *)(heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#aea02bb1ed60acc428d5a2d2db2cd9a7b">span_large_cache</a> + (iclass - 1));</div>
<div class="line"><a name="l02014"></a><span class="lineno"> 2014</span>&#160;            <span class="keywordflow">if</span> (!span_cache-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a894a66f329862f01de7619aee1954d19">count</a>)</div>
<div class="line"><a name="l02015"></a><span class="lineno"> 2015</span>&#160;                <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l02016"></a><span class="lineno"> 2016</span>&#160;<span class="preprocessor">#if ENABLE_GLOBAL_CACHE</span></div>
<div class="line"><a name="l02017"></a><span class="lineno"> 2017</span>&#160;            <span class="keywordflow">if</span> (heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a13ccab5430ace95c471aacf1fab0fcd6">finalize</a>)</div>
<div class="line"><a name="l02018"></a><span class="lineno"> 2018</span>&#160;            {</div>
<div class="line"><a name="l02019"></a><span class="lineno"> 2019</span>&#160;                <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> ispan = 0; ispan &lt; span_cache-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a894a66f329862f01de7619aee1954d19">count</a>; ++ispan)</div>
<div class="line"><a name="l02020"></a><span class="lineno"> 2020</span>&#160;                    <a class="code" href="../../df/dc0/rpmalloc_8c.html#a1b31ff8fa0abcdb205dadd8afc026014">_rpmalloc_span_unmap</a>(span_cache-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a8cc6a9b0d6d8d6bf8367bca0101b1ae3">span</a>[ispan]);</div>
<div class="line"><a name="l02021"></a><span class="lineno"> 2021</span>&#160;            }</div>
<div class="line"><a name="l02022"></a><span class="lineno"> 2022</span>&#160;            <span class="keywordflow">else</span></div>
<div class="line"><a name="l02023"></a><span class="lineno"> 2023</span>&#160;            {</div>
<div class="line"><a name="l02024"></a><span class="lineno"> 2024</span>&#160;                <a class="code" href="../../df/dc0/rpmalloc_8c.html#a49e532a65b873a6c3315aa769299687c">_rpmalloc_stat_add64</a>(&amp;heap-&gt;thread_to_global, span_cache-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a894a66f329862f01de7619aee1954d19">count</a> * (iclass + 1) * <a class="code" href="../../df/dc0/rpmalloc_8c.html#a9fefa5277fefa0c58f69d5b86d679ccb">_memory_span_size</a>);</div>
<div class="line"><a name="l02025"></a><span class="lineno"> 2025</span>&#160;                <a class="code" href="../../df/dc0/rpmalloc_8c.html#a4a53d0cfdcf755d4fbbae446a055440c">_rpmalloc_stat_add</a>(&amp;heap-&gt;span_use[iclass].spans_to_global, span_cache-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a894a66f329862f01de7619aee1954d19">count</a>);</div>
<div class="line"><a name="l02026"></a><span class="lineno"> 2026</span>&#160;                <a class="code" href="../../df/dc0/rpmalloc_8c.html#a06d0861a56c7d5aac6e215ab0dceb9ca">_rpmalloc_global_cache_insert_spans</a>(span_cache-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a8cc6a9b0d6d8d6bf8367bca0101b1ae3">span</a>, iclass + 1, span_cache-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a894a66f329862f01de7619aee1954d19">count</a>);</div>
<div class="line"><a name="l02027"></a><span class="lineno"> 2027</span>&#160;            }</div>
<div class="line"><a name="l02028"></a><span class="lineno"> 2028</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l02029"></a><span class="lineno"> 2029</span>&#160;            <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> ispan = 0; ispan &lt; span_cache-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a894a66f329862f01de7619aee1954d19">count</a>; ++ispan)</div>
<div class="line"><a name="l02030"></a><span class="lineno"> 2030</span>&#160;                <a class="code" href="../../df/dc0/rpmalloc_8c.html#a1b31ff8fa0abcdb205dadd8afc026014">_rpmalloc_span_unmap</a>(span_cache-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a8cc6a9b0d6d8d6bf8367bca0101b1ae3">span</a>[ispan]);</div>
<div class="line"><a name="l02031"></a><span class="lineno"> 2031</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02032"></a><span class="lineno"> 2032</span>&#160;            span_cache-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a894a66f329862f01de7619aee1954d19">count</a> = 0;</div>
<div class="line"><a name="l02033"></a><span class="lineno"> 2033</span>&#160;        }</div>
<div class="line"><a name="l02034"></a><span class="lineno"> 2034</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02035"></a><span class="lineno"> 2035</span>&#160;    }</div>
<div class="line"><a name="l02036"></a><span class="lineno"> 2036</span>&#160; </div>
<div class="line"><a name="l02037"></a><span class="lineno"> 2037</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="../../df/dc0/rpmalloc_8c.html#af7213260e19fbad385988302247150d4">get_thread_heap_raw</a>() == heap)</div>
<div class="line"><a name="l02038"></a><span class="lineno"> 2038</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#a4a224c6ef987eb60f3e3be98239109ec">set_thread_heap</a>(0);</div>
<div class="line"><a name="l02039"></a><span class="lineno"> 2039</span>&#160; </div>
<div class="line"><a name="l02040"></a><span class="lineno"> 2040</span>&#160;<span class="preprocessor">#if ENABLE_STATISTICS</span></div>
<div class="line"><a name="l02041"></a><span class="lineno"> 2041</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#a4f0dc3c548801773a4da1c96f39b04c9">atomic_decr32</a>(&amp;_memory_active_heaps);</div>
<div class="line"><a name="l02042"></a><span class="lineno"> 2042</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#ad008ddf766a4f56fbde2edf2c51d9a87">rpmalloc_assert</a>(atomic_load32(&amp;_memory_active_heaps) &gt;= 0, <span class="stringliteral">&quot;Still active heaps during finalization&quot;</span>);</div>
<div class="line"><a name="l02043"></a><span class="lineno"> 2043</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02044"></a><span class="lineno"> 2044</span>&#160; </div>
<div class="line"><a name="l02045"></a><span class="lineno"> 2045</span>&#160;    <span class="comment">// If we are forcibly terminating with _exit the state of the</span></div>
<div class="line"><a name="l02046"></a><span class="lineno"> 2046</span>&#160;    <span class="comment">// lock atomic is unknown and it&#39;s best to just go ahead and exit</span></div>
<div class="line"><a name="l02047"></a><span class="lineno"> 2047</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="../../df/dc0/rpmalloc_8c.html#a84e326ca88dee0bd7ca995727bb52381">get_thread_id</a>() != <a class="code" href="../../df/dc0/rpmalloc_8c.html#aacc7bcb924cab5e38c3fe65c5d0b4ab0">_rpmalloc_main_thread_id</a>)</div>
<div class="line"><a name="l02048"></a><span class="lineno"> 2048</span>&#160;    {</div>
<div class="line"><a name="l02049"></a><span class="lineno"> 2049</span>&#160;        <span class="keywordflow">while</span> (!<a class="code" href="../../df/dc0/rpmalloc_8c.html#a2071bf7ebae50eced1f16b359f9d5c7d">atomic_cas32_acquire</a>(&amp;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a1cb428169705ddd63fb35383132dbc40">_memory_global_lock</a>, 1, 0))</div>
<div class="line"><a name="l02050"></a><span class="lineno"> 2050</span>&#160;            <a class="code" href="../../df/dc0/rpmalloc_8c.html#a335307d78e0ff77d4da9cf42156803ec">_rpmalloc_spin</a>();</div>
<div class="line"><a name="l02051"></a><span class="lineno"> 2051</span>&#160;    }</div>
<div class="line"><a name="l02052"></a><span class="lineno"> 2052</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#a5bd98ea2cfee2186b2aa2b921450807f">_rpmalloc_heap_orphan</a>(heap, first_class);</div>
<div class="line"><a name="l02053"></a><span class="lineno"> 2053</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#a2a87a6060d5387fe8491a00600073687">atomic_store32_release</a>(&amp;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a1cb428169705ddd63fb35383132dbc40">_memory_global_lock</a>, 0);</div>
<div class="line"><a name="l02054"></a><span class="lineno"> 2054</span>&#160;}</div>
<div class="line"><a name="l02055"></a><span class="lineno"> 2055</span>&#160; </div>
<div class="line"><a name="l02056"></a><span class="lineno"> 2056</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="l02057"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#aa378f245dd9ff587c375db42472ac954"> 2057</a></span>&#160;<a class="code" href="../../df/dc0/rpmalloc_8c.html#aa378f245dd9ff587c375db42472ac954">_rpmalloc_heap_release_raw</a>(<span class="keywordtype">void</span> *heapptr, <span class="keywordtype">int</span> release_cache)</div>
<div class="line"><a name="l02058"></a><span class="lineno"> 2058</span>&#160;{</div>
<div class="line"><a name="l02059"></a><span class="lineno"> 2059</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#a1b9ab55b2401b2d4240bbca4b313f6a2">_rpmalloc_heap_release</a>(heapptr, 0, release_cache);</div>
<div class="line"><a name="l02060"></a><span class="lineno"> 2060</span>&#160;}</div>
<div class="line"><a name="l02061"></a><span class="lineno"> 2061</span>&#160; </div>
<div class="line"><a name="l02062"></a><span class="lineno"> 2062</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="l02063"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a375befcec19545c40cb27c22512501bb"> 2063</a></span>&#160;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a375befcec19545c40cb27c22512501bb">_rpmalloc_heap_release_raw_fc</a>(<span class="keywordtype">void</span> *heapptr)</div>
<div class="line"><a name="l02064"></a><span class="lineno"> 2064</span>&#160;{</div>
<div class="line"><a name="l02065"></a><span class="lineno"> 2065</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#aa378f245dd9ff587c375db42472ac954">_rpmalloc_heap_release_raw</a>(heapptr, 1);</div>
<div class="line"><a name="l02066"></a><span class="lineno"> 2066</span>&#160;}</div>
<div class="line"><a name="l02067"></a><span class="lineno"> 2067</span>&#160; </div>
<div class="line"><a name="l02068"></a><span class="lineno"> 2068</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="l02069"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a2a1e3b11c0a8fc714d6def51250c6906"> 2069</a></span>&#160;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a2a1e3b11c0a8fc714d6def51250c6906">_rpmalloc_heap_finalize</a>(<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#d9/d8a/structheap__t">heap_t</a> *heap)</div>
<div class="line"><a name="l02070"></a><span class="lineno"> 2070</span>&#160;{</div>
<div class="line"><a name="l02071"></a><span class="lineno"> 2071</span>&#160;    <span class="keywordflow">if</span> (heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a8d5b27011e1ab5140090f90a75584329">spans_reserved</a>)</div>
<div class="line"><a name="l02072"></a><span class="lineno"> 2072</span>&#160;    {</div>
<div class="line"><a name="l02073"></a><span class="lineno"> 2073</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *span = <a class="code" href="../../df/dc0/rpmalloc_8c.html#a80aeb0b9294d1463006c963e7073244e">_rpmalloc_span_map</a>(heap, heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a8d5b27011e1ab5140090f90a75584329">spans_reserved</a>);</div>
<div class="line"><a name="l02074"></a><span class="lineno"> 2074</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#a1b31ff8fa0abcdb205dadd8afc026014">_rpmalloc_span_unmap</a>(span);</div>
<div class="line"><a name="l02075"></a><span class="lineno"> 2075</span>&#160;        heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a8d5b27011e1ab5140090f90a75584329">spans_reserved</a> = 0;</div>
<div class="line"><a name="l02076"></a><span class="lineno"> 2076</span>&#160;    }</div>
<div class="line"><a name="l02077"></a><span class="lineno"> 2077</span>&#160; </div>
<div class="line"><a name="l02078"></a><span class="lineno"> 2078</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#af44e92f7ed42c434bd33a0ae98210a3f">_rpmalloc_heap_cache_adopt_deferred</a>(heap, 0);</div>
<div class="line"><a name="l02079"></a><span class="lineno"> 2079</span>&#160; </div>
<div class="line"><a name="l02080"></a><span class="lineno"> 2080</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> iclass = 0; iclass &lt; <a class="code" href="../../df/dc0/rpmalloc_8c.html#aa74d427b2b9955ff2d9719693d9fc80e">SIZE_CLASS_COUNT</a>; ++iclass)</div>
<div class="line"><a name="l02081"></a><span class="lineno"> 2081</span>&#160;    {</div>
<div class="line"><a name="l02082"></a><span class="lineno"> 2082</span>&#160;        <span class="keywordflow">if</span> (heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a70f9a96b9071ccb6642894f5a7f56432">size_class</a>[iclass].<a class="code" href="../../df/dc0/rpmalloc_8c.html#a72cb3beffa763418cb7c8e89ff257b8e">cache</a>)</div>
<div class="line"><a name="l02083"></a><span class="lineno"> 2083</span>&#160;            <a class="code" href="../../df/dc0/rpmalloc_8c.html#a1b31ff8fa0abcdb205dadd8afc026014">_rpmalloc_span_unmap</a>(heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a70f9a96b9071ccb6642894f5a7f56432">size_class</a>[iclass].<a class="code" href="../../df/dc0/rpmalloc_8c.html#a72cb3beffa763418cb7c8e89ff257b8e">cache</a>);</div>
<div class="line"><a name="l02084"></a><span class="lineno"> 2084</span>&#160;        heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a70f9a96b9071ccb6642894f5a7f56432">size_class</a>[iclass].<a class="code" href="../../df/dc0/rpmalloc_8c.html#a72cb3beffa763418cb7c8e89ff257b8e">cache</a> = 0;</div>
<div class="line"><a name="l02085"></a><span class="lineno"> 2085</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *span = heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a70f9a96b9071ccb6642894f5a7f56432">size_class</a>[iclass].<a class="code" href="../../df/dc0/rpmalloc_8c.html#af829c49d9fc4d933c14113ba0d694e7c">partial_span</a>;</div>
<div class="line"><a name="l02086"></a><span class="lineno"> 2086</span>&#160;        <span class="keywordflow">while</span> (span)</div>
<div class="line"><a name="l02087"></a><span class="lineno"> 2087</span>&#160;        {</div>
<div class="line"><a name="l02088"></a><span class="lineno"> 2088</span>&#160;            <a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *next = span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#ac62e0e77eb38ebff4443eb5db3ccd45c">next</a>;</div>
<div class="line"><a name="l02089"></a><span class="lineno"> 2089</span>&#160;            <a class="code" href="../../df/dc0/rpmalloc_8c.html#aa776faada2c6d5b7edda58a3a1d701c4">_rpmalloc_span_finalize</a>(heap, iclass, span, &amp;heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a70f9a96b9071ccb6642894f5a7f56432">size_class</a>[iclass].<a class="code" href="../../df/dc0/rpmalloc_8c.html#af829c49d9fc4d933c14113ba0d694e7c">partial_span</a>);</div>
<div class="line"><a name="l02090"></a><span class="lineno"> 2090</span>&#160;            span = next;</div>
<div class="line"><a name="l02091"></a><span class="lineno"> 2091</span>&#160;        }</div>
<div class="line"><a name="l02092"></a><span class="lineno"> 2092</span>&#160;        <span class="comment">// If class still has a free list it must be a full span</span></div>
<div class="line"><a name="l02093"></a><span class="lineno"> 2093</span>&#160;        <span class="keywordflow">if</span> (heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a70f9a96b9071ccb6642894f5a7f56432">size_class</a>[iclass].<a class="code" href="../../df/dc0/rpmalloc_8c.html#ac411b0f198d4e31569fc30ca2c174f65">free_list</a>)</div>
<div class="line"><a name="l02094"></a><span class="lineno"> 2094</span>&#160;        {</div>
<div class="line"><a name="l02095"></a><span class="lineno"> 2095</span>&#160;            <a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *class_span = (<a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *)((<a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#a4788399d1d0b37ccf098a7da82254808">uintptr_t</a>)heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a70f9a96b9071ccb6642894f5a7f56432">size_class</a>[iclass].<a class="code" href="../../df/dc0/rpmalloc_8c.html#ac411b0f198d4e31569fc30ca2c174f65">free_list</a> &amp; <a class="code" href="../../df/dc0/rpmalloc_8c.html#ae7b97ba12e15609b6d63926ed2e30238">_memory_span_mask</a>);</div>
<div class="line"><a name="l02096"></a><span class="lineno"> 2096</span>&#160;            <a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> **list = 0;</div>
<div class="line"><a name="l02097"></a><span class="lineno"> 2097</span>&#160;<span class="preprocessor">#if RPMALLOC_FIRST_CLASS_HEAPS</span></div>
<div class="line"><a name="l02098"></a><span class="lineno"> 2098</span>&#160;            list = &amp;heap-&gt;full_span[iclass];</div>
<div class="line"><a name="l02099"></a><span class="lineno"> 2099</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02100"></a><span class="lineno"> 2100</span>&#160;            --heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a6aa789c3cdf7e70df144c248d18c5f4c">full_span_count</a>;</div>
<div class="line"><a name="l02101"></a><span class="lineno"> 2101</span>&#160;            <span class="keywordflow">if</span> (!<a class="code" href="../../df/dc0/rpmalloc_8c.html#aa776faada2c6d5b7edda58a3a1d701c4">_rpmalloc_span_finalize</a>(heap, iclass, class_span, list))</div>
<div class="line"><a name="l02102"></a><span class="lineno"> 2102</span>&#160;            {</div>
<div class="line"><a name="l02103"></a><span class="lineno"> 2103</span>&#160;                <span class="keywordflow">if</span> (list)</div>
<div class="line"><a name="l02104"></a><span class="lineno"> 2104</span>&#160;                    <a class="code" href="../../df/dc0/rpmalloc_8c.html#aec7913670102d551e3fd60509cd381a3">_rpmalloc_span_double_link_list_remove</a>(list, class_span);</div>
<div class="line"><a name="l02105"></a><span class="lineno"> 2105</span>&#160;                <a class="code" href="../../df/dc0/rpmalloc_8c.html#ac32a750ddf4072d46c28f52b9f3ee018">_rpmalloc_span_double_link_list_add</a>(&amp;heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a70f9a96b9071ccb6642894f5a7f56432">size_class</a>[iclass].<a class="code" href="../../df/dc0/rpmalloc_8c.html#af829c49d9fc4d933c14113ba0d694e7c">partial_span</a>, class_span);</div>
<div class="line"><a name="l02106"></a><span class="lineno"> 2106</span>&#160;            }</div>
<div class="line"><a name="l02107"></a><span class="lineno"> 2107</span>&#160;        }</div>
<div class="line"><a name="l02108"></a><span class="lineno"> 2108</span>&#160;    }</div>
<div class="line"><a name="l02109"></a><span class="lineno"> 2109</span>&#160; </div>
<div class="line"><a name="l02110"></a><span class="lineno"> 2110</span>&#160;<span class="preprocessor">#if ENABLE_THREAD_CACHE</span></div>
<div class="line"><a name="l02111"></a><span class="lineno"> 2111</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> iclass = 0; iclass &lt; <a class="code" href="../../df/dc0/rpmalloc_8c.html#a04406da3f5ff4e24f155c97591678ed9">LARGE_CLASS_COUNT</a>; ++iclass)</div>
<div class="line"><a name="l02112"></a><span class="lineno"> 2112</span>&#160;    {</div>
<div class="line"><a name="l02113"></a><span class="lineno"> 2113</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#da/d15/structspan__cache__t">span_cache_t</a> *span_cache;</div>
<div class="line"><a name="l02114"></a><span class="lineno"> 2114</span>&#160;        <span class="keywordflow">if</span> (!iclass)</div>
<div class="line"><a name="l02115"></a><span class="lineno"> 2115</span>&#160;            span_cache = &amp;heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#ae112aace519bbe14edb9127cefb59705">span_cache</a>;</div>
<div class="line"><a name="l02116"></a><span class="lineno"> 2116</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l02117"></a><span class="lineno"> 2117</span>&#160;            span_cache = (<a class="code" href="../../df/dc0/rpmalloc_8c.html#da/d15/structspan__cache__t">span_cache_t</a> *)(heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#aea02bb1ed60acc428d5a2d2db2cd9a7b">span_large_cache</a> + (iclass - 1));</div>
<div class="line"><a name="l02118"></a><span class="lineno"> 2118</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> ispan = 0; ispan &lt; span_cache-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a894a66f329862f01de7619aee1954d19">count</a>; ++ispan)</div>
<div class="line"><a name="l02119"></a><span class="lineno"> 2119</span>&#160;            <a class="code" href="../../df/dc0/rpmalloc_8c.html#a1b31ff8fa0abcdb205dadd8afc026014">_rpmalloc_span_unmap</a>(span_cache-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a8cc6a9b0d6d8d6bf8367bca0101b1ae3">span</a>[ispan]);</div>
<div class="line"><a name="l02120"></a><span class="lineno"> 2120</span>&#160;        span_cache-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a894a66f329862f01de7619aee1954d19">count</a> = 0;</div>
<div class="line"><a name="l02121"></a><span class="lineno"> 2121</span>&#160;    }</div>
<div class="line"><a name="l02122"></a><span class="lineno"> 2122</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02123"></a><span class="lineno"> 2123</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#ad008ddf766a4f56fbde2edf2c51d9a87">rpmalloc_assert</a>(!<a class="code" href="../../df/dc0/rpmalloc_8c.html#a83ddc23debb02a3c47f0b00939fc8f35">atomic_load_ptr</a>(&amp;heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a354c0beb35fd982bc4dbd3783b2dd1ff">span_free_deferred</a>), <span class="stringliteral">&quot;Heaps still active during finalization&quot;</span>);</div>
<div class="line"><a name="l02124"></a><span class="lineno"> 2124</span>&#160;}</div>
<div class="line"><a name="l02125"></a><span class="lineno"> 2125</span>&#160; </div>
<div class="line"><a name="l02131"></a><span class="lineno"> 2131</span>&#160; </div>
<div class="line"><a name="l02133"></a><span class="lineno"> 2133</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> *</div>
<div class="line"><a name="l02134"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a21ea40b81bca2d791bb633dd5602dee8"> 2134</a></span>&#160;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a21ea40b81bca2d791bb633dd5602dee8">free_list_pop</a>(<span class="keywordtype">void</span> **list)</div>
<div class="line"><a name="l02135"></a><span class="lineno"> 2135</span>&#160;{</div>
<div class="line"><a name="l02136"></a><span class="lineno"> 2136</span>&#160;    <span class="keywordtype">void</span> *block = *list;</div>
<div class="line"><a name="l02137"></a><span class="lineno"> 2137</span>&#160;    *list = *((<span class="keywordtype">void</span> **)block);</div>
<div class="line"><a name="l02138"></a><span class="lineno"> 2138</span>&#160;    <span class="keywordflow">return</span> block;</div>
<div class="line"><a name="l02139"></a><span class="lineno"> 2139</span>&#160;}</div>
<div class="line"><a name="l02140"></a><span class="lineno"> 2140</span>&#160; </div>
<div class="line"><a name="l02142"></a><span class="lineno"> 2142</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> *</div>
<div class="line"><a name="l02143"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#af080b8796eb59bb59da90cb8536f0891"> 2143</a></span>&#160;<a class="code" href="../../df/dc0/rpmalloc_8c.html#af080b8796eb59bb59da90cb8536f0891">_rpmalloc_allocate_from_heap_fallback</a>(<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#d9/d8a/structheap__t">heap_t</a> *heap, <a class="code" href="../../df/dc0/rpmalloc_8c.html#d3/dad/structheap__size__class__t">heap_size_class_t</a> *heap_size_class, <a class="code" href="../../dd/ddd/arithmetic__operations_8c.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a> class_idx)</div>
<div class="line"><a name="l02144"></a><span class="lineno"> 2144</span>&#160;{</div>
<div class="line"><a name="l02145"></a><span class="lineno"> 2145</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *span = heap_size_class-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#af829c49d9fc4d933c14113ba0d694e7c">partial_span</a>;</div>
<div class="line"><a name="l02146"></a><span class="lineno"> 2146</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="../../df/dc0/rpmalloc_8c.html#a90593dceacf0c04f14d084bed7e7eabe">EXPECTED</a>(span != 0))</div>
<div class="line"><a name="l02147"></a><span class="lineno"> 2147</span>&#160;    {</div>
<div class="line"><a name="l02148"></a><span class="lineno"> 2148</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#ad008ddf766a4f56fbde2edf2c51d9a87">rpmalloc_assert</a>(span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a7ee7892ce3c5d8342af193f1824a5098">block_count</a> == <a class="code" href="../../df/dc0/rpmalloc_8c.html#a33cddb08b9ee0f969cc82dbf9cddb947">_memory_size_class</a>[span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a5a977febdd2e9ae15bcf66f83d0cf817">size_class</a>].<a class="code" href="../../df/dc0/rpmalloc_8c.html#aeded978bd21c13b71d9b0310b5bb09ec">block_count</a>, <span class="stringliteral">&quot;Span block count corrupted&quot;</span>);</div>
<div class="line"><a name="l02149"></a><span class="lineno"> 2149</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#ad008ddf766a4f56fbde2edf2c51d9a87">rpmalloc_assert</a>(!<a class="code" href="../../df/dc0/rpmalloc_8c.html#ade7fb930b30a5a8bd04ecc97cad60e6b">_rpmalloc_span_is_fully_utilized</a>(span), <span class="stringliteral">&quot;Internal failure&quot;</span>);</div>
<div class="line"><a name="l02150"></a><span class="lineno"> 2150</span>&#160;        <span class="keywordtype">void</span> *block;</div>
<div class="line"><a name="l02151"></a><span class="lineno"> 2151</span>&#160;        <span class="keywordflow">if</span> (span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a85527ad364915bcb39b7d421524d0bd6">free_list</a>)</div>
<div class="line"><a name="l02152"></a><span class="lineno"> 2152</span>&#160;        {</div>
<div class="line"><a name="l02153"></a><span class="lineno"> 2153</span>&#160;            <span class="comment">// Span local free list is not empty, swap to size class free list</span></div>
<div class="line"><a name="l02154"></a><span class="lineno"> 2154</span>&#160;            block = <a class="code" href="../../df/dc0/rpmalloc_8c.html#a21ea40b81bca2d791bb633dd5602dee8">free_list_pop</a>(&amp;span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a85527ad364915bcb39b7d421524d0bd6">free_list</a>);</div>
<div class="line"><a name="l02155"></a><span class="lineno"> 2155</span>&#160;            heap_size_class-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#ac411b0f198d4e31569fc30ca2c174f65">free_list</a> = span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a85527ad364915bcb39b7d421524d0bd6">free_list</a>;</div>
<div class="line"><a name="l02156"></a><span class="lineno"> 2156</span>&#160;            span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a85527ad364915bcb39b7d421524d0bd6">free_list</a> = 0;</div>
<div class="line"><a name="l02157"></a><span class="lineno"> 2157</span>&#160;        }</div>
<div class="line"><a name="l02158"></a><span class="lineno"> 2158</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l02159"></a><span class="lineno"> 2159</span>&#160;        {</div>
<div class="line"><a name="l02160"></a><span class="lineno"> 2160</span>&#160;            <span class="comment">// If the span did not fully initialize free list, link up another page worth of blocks</span></div>
<div class="line"><a name="l02161"></a><span class="lineno"> 2161</span>&#160;            <span class="keywordtype">void</span> *block_start = <a class="code" href="../../df/dc0/rpmalloc_8c.html#ab4225911698b67188e1538c334cfe16c">pointer_offset</a>(span, <a class="code" href="../../df/dc0/rpmalloc_8c.html#a645356809d937167848705edabde7d44">SPAN_HEADER_SIZE</a> + ((<span class="keywordtype">size_t</span>)span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#af093d9cb1719d72c20f96a9b467590f5">free_list_limit</a> * span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a97df83853dc6ddf7e0114691b15edb49">block_size</a>));</div>
<div class="line"><a name="l02162"></a><span class="lineno"> 2162</span>&#160;            span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#af093d9cb1719d72c20f96a9b467590f5">free_list_limit</a> += <a class="code" href="../../df/dc0/rpmalloc_8c.html#addf543f30c5eefc1dded60025c78a816">free_list_partial_init</a>(&amp;heap_size_class-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#ac411b0f198d4e31569fc30ca2c174f65">free_list</a>, &amp;block,</div>
<div class="line"><a name="l02163"></a><span class="lineno"> 2163</span>&#160;                                                            (<span class="keywordtype">void</span> *)((<a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#a4788399d1d0b37ccf098a7da82254808">uintptr_t</a>)block_start &amp; ~(<a class="code" href="../../df/dc0/rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a> - 1)), block_start,</div>
<div class="line"><a name="l02164"></a><span class="lineno"> 2164</span>&#160;                                                            span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a7ee7892ce3c5d8342af193f1824a5098">block_count</a> - span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#af093d9cb1719d72c20f96a9b467590f5">free_list_limit</a>, span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a97df83853dc6ddf7e0114691b15edb49">block_size</a>);</div>
<div class="line"><a name="l02165"></a><span class="lineno"> 2165</span>&#160;        }</div>
<div class="line"><a name="l02166"></a><span class="lineno"> 2166</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#ad008ddf766a4f56fbde2edf2c51d9a87">rpmalloc_assert</a>(span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#af093d9cb1719d72c20f96a9b467590f5">free_list_limit</a> &lt;= span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a7ee7892ce3c5d8342af193f1824a5098">block_count</a>, <span class="stringliteral">&quot;Span block count corrupted&quot;</span>);</div>
<div class="line"><a name="l02167"></a><span class="lineno"> 2167</span>&#160;        span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#abf4fa6f8f0e7baff0d6a7a96df58bcca">used_count</a> = span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#af093d9cb1719d72c20f96a9b467590f5">free_list_limit</a>;</div>
<div class="line"><a name="l02168"></a><span class="lineno"> 2168</span>&#160; </div>
<div class="line"><a name="l02169"></a><span class="lineno"> 2169</span>&#160;        <span class="comment">// Swap in deferred free list if present</span></div>
<div class="line"><a name="l02170"></a><span class="lineno"> 2170</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="../../df/dc0/rpmalloc_8c.html#a83ddc23debb02a3c47f0b00939fc8f35">atomic_load_ptr</a>(&amp;span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a22b0340927d02f0c7c4486f01c31358e">free_list_deferred</a>))</div>
<div class="line"><a name="l02171"></a><span class="lineno"> 2171</span>&#160;            <a class="code" href="../../df/dc0/rpmalloc_8c.html#af2ca2fcf7e544c9458ef49057a40b78e">_rpmalloc_span_extract_free_list_deferred</a>(span);</div>
<div class="line"><a name="l02172"></a><span class="lineno"> 2172</span>&#160; </div>
<div class="line"><a name="l02173"></a><span class="lineno"> 2173</span>&#160;        <span class="comment">// If span is still not fully utilized keep it in partial list and early return block</span></div>
<div class="line"><a name="l02174"></a><span class="lineno"> 2174</span>&#160;        <span class="keywordflow">if</span> (!<a class="code" href="../../df/dc0/rpmalloc_8c.html#ade7fb930b30a5a8bd04ecc97cad60e6b">_rpmalloc_span_is_fully_utilized</a>(span))</div>
<div class="line"><a name="l02175"></a><span class="lineno"> 2175</span>&#160;            <span class="keywordflow">return</span> block;</div>
<div class="line"><a name="l02176"></a><span class="lineno"> 2176</span>&#160; </div>
<div class="line"><a name="l02177"></a><span class="lineno"> 2177</span>&#160;        <span class="comment">// The span is fully utilized, unlink from partial list and add to fully utilized list</span></div>
<div class="line"><a name="l02178"></a><span class="lineno"> 2178</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#a49d22808308e599742e41ef2d4671cfa">_rpmalloc_span_double_link_list_pop_head</a>(&amp;heap_size_class-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#af829c49d9fc4d933c14113ba0d694e7c">partial_span</a>, span);</div>
<div class="line"><a name="l02179"></a><span class="lineno"> 2179</span>&#160;<span class="preprocessor">#if RPMALLOC_FIRST_CLASS_HEAPS</span></div>
<div class="line"><a name="l02180"></a><span class="lineno"> 2180</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#ac32a750ddf4072d46c28f52b9f3ee018">_rpmalloc_span_double_link_list_add</a>(&amp;heap-&gt;full_span[class_idx], span);</div>
<div class="line"><a name="l02181"></a><span class="lineno"> 2181</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02182"></a><span class="lineno"> 2182</span>&#160;        ++heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a6aa789c3cdf7e70df144c248d18c5f4c">full_span_count</a>;</div>
<div class="line"><a name="l02183"></a><span class="lineno"> 2183</span>&#160;        <span class="keywordflow">return</span> block;</div>
<div class="line"><a name="l02184"></a><span class="lineno"> 2184</span>&#160;    }</div>
<div class="line"><a name="l02185"></a><span class="lineno"> 2185</span>&#160; </div>
<div class="line"><a name="l02186"></a><span class="lineno"> 2186</span>&#160;    <span class="comment">// Find a span in one of the cache levels</span></div>
<div class="line"><a name="l02187"></a><span class="lineno"> 2187</span>&#160;    span = <a class="code" href="../../df/dc0/rpmalloc_8c.html#a435bea54b94450010a1a6d0c4f22a0c5">_rpmalloc_heap_extract_new_span</a>(heap, heap_size_class, 1, class_idx);</div>
<div class="line"><a name="l02188"></a><span class="lineno"> 2188</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="../../df/dc0/rpmalloc_8c.html#a90593dceacf0c04f14d084bed7e7eabe">EXPECTED</a>(span != 0))</div>
<div class="line"><a name="l02189"></a><span class="lineno"> 2189</span>&#160;    {</div>
<div class="line"><a name="l02190"></a><span class="lineno"> 2190</span>&#160;        <span class="comment">// Mark span as owned by this heap and set base data, return first block</span></div>
<div class="line"><a name="l02191"></a><span class="lineno"> 2191</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#addaef25db6ed1f3f0308ad7464745828">_rpmalloc_span_initialize_new</a>(heap, heap_size_class, span, class_idx);</div>
<div class="line"><a name="l02192"></a><span class="lineno"> 2192</span>&#160;    }</div>
<div class="line"><a name="l02193"></a><span class="lineno"> 2193</span>&#160; </div>
<div class="line"><a name="l02194"></a><span class="lineno"> 2194</span>&#160;    <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l02195"></a><span class="lineno"> 2195</span>&#160;}</div>
<div class="line"><a name="l02196"></a><span class="lineno"> 2196</span>&#160; </div>
<div class="line"><a name="l02198"></a><span class="lineno"> 2198</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> *</div>
<div class="line"><a name="l02199"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a2a7ceea1aafc39d3196091847b88e701"> 2199</a></span>&#160;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a2a7ceea1aafc39d3196091847b88e701">_rpmalloc_allocate_small</a>(<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#d9/d8a/structheap__t">heap_t</a> *heap, <span class="keywordtype">size_t</span> <a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a>)</div>
<div class="line"><a name="l02200"></a><span class="lineno"> 2200</span>&#160;{</div>
<div class="line"><a name="l02201"></a><span class="lineno"> 2201</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#ad008ddf766a4f56fbde2edf2c51d9a87">rpmalloc_assert</a>(heap, <span class="stringliteral">&quot;No thread heap&quot;</span>);</div>
<div class="line"><a name="l02202"></a><span class="lineno"> 2202</span>&#160;    <span class="comment">// Small sizes have unique size classes</span></div>
<div class="line"><a name="l02203"></a><span class="lineno"> 2203</span>&#160;    <span class="keyword">const</span> <a class="code" href="../../dd/ddd/arithmetic__operations_8c.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a> class_idx = (<a class="code" href="../../dd/ddd/arithmetic__operations_8c.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a>)((<a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a> + (<a class="code" href="../../df/dc0/rpmalloc_8c.html#a000afcda168a6fd19a9435e049508463">SMALL_GRANULARITY</a> - 1)) &gt;&gt; <a class="code" href="../../df/dc0/rpmalloc_8c.html#a66893939b9053e9bf8a97a5f50bc773a">SMALL_GRANULARITY_SHIFT</a>);</div>
<div class="line"><a name="l02204"></a><span class="lineno"> 2204</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#d3/dad/structheap__size__class__t">heap_size_class_t</a> *heap_size_class = heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a70f9a96b9071ccb6642894f5a7f56432">size_class</a> + class_idx;</div>
<div class="line"><a name="l02205"></a><span class="lineno"> 2205</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#abd4c41e806e09b0468b6db0ae56ed461">_rpmalloc_stat_inc_alloc</a>(heap, class_idx);</div>
<div class="line"><a name="l02206"></a><span class="lineno"> 2206</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="../../df/dc0/rpmalloc_8c.html#a90593dceacf0c04f14d084bed7e7eabe">EXPECTED</a>(heap_size_class-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#ac411b0f198d4e31569fc30ca2c174f65">free_list</a> != 0))</div>
<div class="line"><a name="l02207"></a><span class="lineno"> 2207</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#a21ea40b81bca2d791bb633dd5602dee8">free_list_pop</a>(&amp;heap_size_class-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#ac411b0f198d4e31569fc30ca2c174f65">free_list</a>);</div>
<div class="line"><a name="l02208"></a><span class="lineno"> 2208</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#af080b8796eb59bb59da90cb8536f0891">_rpmalloc_allocate_from_heap_fallback</a>(heap, heap_size_class, class_idx);</div>
<div class="line"><a name="l02209"></a><span class="lineno"> 2209</span>&#160;}</div>
<div class="line"><a name="l02210"></a><span class="lineno"> 2210</span>&#160; </div>
<div class="line"><a name="l02212"></a><span class="lineno"> 2212</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> *</div>
<div class="line"><a name="l02213"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a63b187e233e7b190db2bac536cf8a09b"> 2213</a></span>&#160;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a63b187e233e7b190db2bac536cf8a09b">_rpmalloc_allocate_medium</a>(<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#d9/d8a/structheap__t">heap_t</a> *heap, <span class="keywordtype">size_t</span> <a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a>)</div>
<div class="line"><a name="l02214"></a><span class="lineno"> 2214</span>&#160;{</div>
<div class="line"><a name="l02215"></a><span class="lineno"> 2215</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#ad008ddf766a4f56fbde2edf2c51d9a87">rpmalloc_assert</a>(heap, <span class="stringliteral">&quot;No thread heap&quot;</span>);</div>
<div class="line"><a name="l02216"></a><span class="lineno"> 2216</span>&#160;    <span class="comment">// Calculate the size class index and do a dependent lookup of the final class index (in case of merged classes)</span></div>
<div class="line"><a name="l02217"></a><span class="lineno"> 2217</span>&#160;    <span class="keyword">const</span> <a class="code" href="../../dd/ddd/arithmetic__operations_8c.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a> base_idx = (<a class="code" href="../../dd/ddd/arithmetic__operations_8c.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a>)(<a class="code" href="../../df/dc0/rpmalloc_8c.html#afef7a20458b75404cdbba364a751694a">SMALL_CLASS_COUNT</a> + ((<a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a> - (<a class="code" href="../../df/dc0/rpmalloc_8c.html#aecf578949f89fb109c5f6f527a2dc49d">SMALL_SIZE_LIMIT</a> + 1)) &gt;&gt; <a class="code" href="../../df/dc0/rpmalloc_8c.html#a95449a66565995789e144cfc3f538261">MEDIUM_GRANULARITY_SHIFT</a>));</div>
<div class="line"><a name="l02218"></a><span class="lineno"> 2218</span>&#160;    <span class="keyword">const</span> <a class="code" href="../../dd/ddd/arithmetic__operations_8c.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a> class_idx = <a class="code" href="../../df/dc0/rpmalloc_8c.html#a33cddb08b9ee0f969cc82dbf9cddb947">_memory_size_class</a>[base_idx].<a class="code" href="../../df/dc0/rpmalloc_8c.html#a7524fc81b83a0b54ef5ec3fb4563b69d">class_idx</a>;</div>
<div class="line"><a name="l02219"></a><span class="lineno"> 2219</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#d3/dad/structheap__size__class__t">heap_size_class_t</a> *heap_size_class = heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a70f9a96b9071ccb6642894f5a7f56432">size_class</a> + class_idx;</div>
<div class="line"><a name="l02220"></a><span class="lineno"> 2220</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#abd4c41e806e09b0468b6db0ae56ed461">_rpmalloc_stat_inc_alloc</a>(heap, class_idx);</div>
<div class="line"><a name="l02221"></a><span class="lineno"> 2221</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="../../df/dc0/rpmalloc_8c.html#a90593dceacf0c04f14d084bed7e7eabe">EXPECTED</a>(heap_size_class-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#ac411b0f198d4e31569fc30ca2c174f65">free_list</a> != 0))</div>
<div class="line"><a name="l02222"></a><span class="lineno"> 2222</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#a21ea40b81bca2d791bb633dd5602dee8">free_list_pop</a>(&amp;heap_size_class-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#ac411b0f198d4e31569fc30ca2c174f65">free_list</a>);</div>
<div class="line"><a name="l02223"></a><span class="lineno"> 2223</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#af080b8796eb59bb59da90cb8536f0891">_rpmalloc_allocate_from_heap_fallback</a>(heap, heap_size_class, class_idx);</div>
<div class="line"><a name="l02224"></a><span class="lineno"> 2224</span>&#160;}</div>
<div class="line"><a name="l02225"></a><span class="lineno"> 2225</span>&#160; </div>
<div class="line"><a name="l02227"></a><span class="lineno"> 2227</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> *</div>
<div class="line"><a name="l02228"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a9891bc299af5a3533139ca76ce76cd70"> 2228</a></span>&#160;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a9891bc299af5a3533139ca76ce76cd70">_rpmalloc_allocate_large</a>(<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#d9/d8a/structheap__t">heap_t</a> *heap, <span class="keywordtype">size_t</span> <a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a>)</div>
<div class="line"><a name="l02229"></a><span class="lineno"> 2229</span>&#160;{</div>
<div class="line"><a name="l02230"></a><span class="lineno"> 2230</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#ad008ddf766a4f56fbde2edf2c51d9a87">rpmalloc_assert</a>(heap, <span class="stringliteral">&quot;No thread heap&quot;</span>);</div>
<div class="line"><a name="l02231"></a><span class="lineno"> 2231</span>&#160;    <span class="comment">// Calculate number of needed max sized spans (including header)</span></div>
<div class="line"><a name="l02232"></a><span class="lineno"> 2232</span>&#160;    <span class="comment">// Since this function is never called if size &gt; LARGE_SIZE_LIMIT</span></div>
<div class="line"><a name="l02233"></a><span class="lineno"> 2233</span>&#160;    <span class="comment">// the span_count is guaranteed to be &lt;= LARGE_CLASS_COUNT</span></div>
<div class="line"><a name="l02234"></a><span class="lineno"> 2234</span>&#160;    <a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a> += <a class="code" href="../../df/dc0/rpmalloc_8c.html#a645356809d937167848705edabde7d44">SPAN_HEADER_SIZE</a>;</div>
<div class="line"><a name="l02235"></a><span class="lineno"> 2235</span>&#160;    <span class="keywordtype">size_t</span> span_count = <a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a> &gt;&gt; <a class="code" href="../../df/dc0/rpmalloc_8c.html#adb538a1ad8a86db6b92895d9ebf6d907">_memory_span_size_shift</a>;</div>
<div class="line"><a name="l02236"></a><span class="lineno"> 2236</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a> &amp; (<a class="code" href="../../df/dc0/rpmalloc_8c.html#a9fefa5277fefa0c58f69d5b86d679ccb">_memory_span_size</a> - 1))</div>
<div class="line"><a name="l02237"></a><span class="lineno"> 2237</span>&#160;        ++span_count;</div>
<div class="line"><a name="l02238"></a><span class="lineno"> 2238</span>&#160; </div>
<div class="line"><a name="l02239"></a><span class="lineno"> 2239</span>&#160;    <span class="comment">// Find a span in one of the cache levels</span></div>
<div class="line"><a name="l02240"></a><span class="lineno"> 2240</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *span = <a class="code" href="../../df/dc0/rpmalloc_8c.html#a435bea54b94450010a1a6d0c4f22a0c5">_rpmalloc_heap_extract_new_span</a>(heap, 0, span_count, <a class="code" href="../../df/dc0/rpmalloc_8c.html#a3f84dd23eb0ef3cf54aeb6afff0618ae">SIZE_CLASS_LARGE</a>);</div>
<div class="line"><a name="l02241"></a><span class="lineno"> 2241</span>&#160;    <span class="keywordflow">if</span> (!span)</div>
<div class="line"><a name="l02242"></a><span class="lineno"> 2242</span>&#160;        <span class="keywordflow">return</span> span;</div>
<div class="line"><a name="l02243"></a><span class="lineno"> 2243</span>&#160; </div>
<div class="line"><a name="l02244"></a><span class="lineno"> 2244</span>&#160;    <span class="comment">// Mark span as owned by this heap and set base data</span></div>
<div class="line"><a name="l02245"></a><span class="lineno"> 2245</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#ad008ddf766a4f56fbde2edf2c51d9a87">rpmalloc_assert</a>(span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#ae77d9a2cdd2a2fd46e3b27739d6c88cc">span_count</a> &gt;= span_count, <span class="stringliteral">&quot;Internal failure&quot;</span>);</div>
<div class="line"><a name="l02246"></a><span class="lineno"> 2246</span>&#160;    span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a5a977febdd2e9ae15bcf66f83d0cf817">size_class</a> = <a class="code" href="../../df/dc0/rpmalloc_8c.html#a3f84dd23eb0ef3cf54aeb6afff0618ae">SIZE_CLASS_LARGE</a>;</div>
<div class="line"><a name="l02247"></a><span class="lineno"> 2247</span>&#160;    span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a345270ce5d1e5e112b45cfde43f37da0">heap</a> = heap;</div>
<div class="line"><a name="l02248"></a><span class="lineno"> 2248</span>&#160; </div>
<div class="line"><a name="l02249"></a><span class="lineno"> 2249</span>&#160;<span class="preprocessor">#if RPMALLOC_FIRST_CLASS_HEAPS</span></div>
<div class="line"><a name="l02250"></a><span class="lineno"> 2250</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#ac32a750ddf4072d46c28f52b9f3ee018">_rpmalloc_span_double_link_list_add</a>(&amp;heap-&gt;large_huge_span, span);</div>
<div class="line"><a name="l02251"></a><span class="lineno"> 2251</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02252"></a><span class="lineno"> 2252</span>&#160;    ++heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a6aa789c3cdf7e70df144c248d18c5f4c">full_span_count</a>;</div>
<div class="line"><a name="l02253"></a><span class="lineno"> 2253</span>&#160; </div>
<div class="line"><a name="l02254"></a><span class="lineno"> 2254</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#ab4225911698b67188e1538c334cfe16c">pointer_offset</a>(span, <a class="code" href="../../df/dc0/rpmalloc_8c.html#a645356809d937167848705edabde7d44">SPAN_HEADER_SIZE</a>);</div>
<div class="line"><a name="l02255"></a><span class="lineno"> 2255</span>&#160;}</div>
<div class="line"><a name="l02256"></a><span class="lineno"> 2256</span>&#160; </div>
<div class="line"><a name="l02258"></a><span class="lineno"> 2258</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> *</div>
<div class="line"><a name="l02259"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a00b91d87f9efd9b1073443761130d595"> 2259</a></span>&#160;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a00b91d87f9efd9b1073443761130d595">_rpmalloc_allocate_huge</a>(<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#d9/d8a/structheap__t">heap_t</a> *heap, <span class="keywordtype">size_t</span> <a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a>)</div>
<div class="line"><a name="l02260"></a><span class="lineno"> 2260</span>&#160;{</div>
<div class="line"><a name="l02261"></a><span class="lineno"> 2261</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#ad008ddf766a4f56fbde2edf2c51d9a87">rpmalloc_assert</a>(heap, <span class="stringliteral">&quot;No thread heap&quot;</span>);</div>
<div class="line"><a name="l02262"></a><span class="lineno"> 2262</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#af44e92f7ed42c434bd33a0ae98210a3f">_rpmalloc_heap_cache_adopt_deferred</a>(heap, 0);</div>
<div class="line"><a name="l02263"></a><span class="lineno"> 2263</span>&#160;    <a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a> += <a class="code" href="../../df/dc0/rpmalloc_8c.html#a645356809d937167848705edabde7d44">SPAN_HEADER_SIZE</a>;</div>
<div class="line"><a name="l02264"></a><span class="lineno"> 2264</span>&#160;    <span class="keywordtype">size_t</span> num_pages = <a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a> &gt;&gt; <a class="code" href="../../df/dc0/rpmalloc_8c.html#a9d7ec974d864302bb4f8516859c4b212">_memory_page_size_shift</a>;</div>
<div class="line"><a name="l02265"></a><span class="lineno"> 2265</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a> &amp; (<a class="code" href="../../df/dc0/rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a> - 1))</div>
<div class="line"><a name="l02266"></a><span class="lineno"> 2266</span>&#160;        ++num_pages;</div>
<div class="line"><a name="l02267"></a><span class="lineno"> 2267</span>&#160;    <span class="keywordtype">size_t</span> align_offset = 0;</div>
<div class="line"><a name="l02268"></a><span class="lineno"> 2268</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *span = (<a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *)<a class="code" href="../../df/dc0/rpmalloc_8c.html#a2d8a3eac487ff2943f8aae4dd20badd3">_rpmalloc_mmap</a>(num_pages * <a class="code" href="../../df/dc0/rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a>, &amp;align_offset);</div>
<div class="line"><a name="l02269"></a><span class="lineno"> 2269</span>&#160;    <span class="keywordflow">if</span> (!span)</div>
<div class="line"><a name="l02270"></a><span class="lineno"> 2270</span>&#160;        <span class="keywordflow">return</span> span;</div>
<div class="line"><a name="l02271"></a><span class="lineno"> 2271</span>&#160; </div>
<div class="line"><a name="l02272"></a><span class="lineno"> 2272</span>&#160;    <span class="comment">// Store page count in span_count</span></div>
<div class="line"><a name="l02273"></a><span class="lineno"> 2273</span>&#160;    span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a5a977febdd2e9ae15bcf66f83d0cf817">size_class</a> = <a class="code" href="../../df/dc0/rpmalloc_8c.html#a284460248778c94b6ee9ea1529299439">SIZE_CLASS_HUGE</a>;</div>
<div class="line"><a name="l02274"></a><span class="lineno"> 2274</span>&#160;    span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#ae77d9a2cdd2a2fd46e3b27739d6c88cc">span_count</a> = (<a class="code" href="../../dd/ddd/arithmetic__operations_8c.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a>)num_pages;</div>
<div class="line"><a name="l02275"></a><span class="lineno"> 2275</span>&#160;    span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a13753de75bc52a5b8a1a9532083c9ba4">align_offset</a> = (<a class="code" href="../../dd/ddd/arithmetic__operations_8c.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a>)align_offset;</div>
<div class="line"><a name="l02276"></a><span class="lineno"> 2276</span>&#160;    span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a345270ce5d1e5e112b45cfde43f37da0">heap</a> = heap;</div>
<div class="line"><a name="l02277"></a><span class="lineno"> 2277</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#a599c57201987cc23a9787a745296e575">_rpmalloc_stat_add_peak</a>(&amp;_huge_pages_current, num_pages, _huge_pages_peak);</div>
<div class="line"><a name="l02278"></a><span class="lineno"> 2278</span>&#160; </div>
<div class="line"><a name="l02279"></a><span class="lineno"> 2279</span>&#160;<span class="preprocessor">#if RPMALLOC_FIRST_CLASS_HEAPS</span></div>
<div class="line"><a name="l02280"></a><span class="lineno"> 2280</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#ac32a750ddf4072d46c28f52b9f3ee018">_rpmalloc_span_double_link_list_add</a>(&amp;heap-&gt;large_huge_span, span);</div>
<div class="line"><a name="l02281"></a><span class="lineno"> 2281</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02282"></a><span class="lineno"> 2282</span>&#160;    ++heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a6aa789c3cdf7e70df144c248d18c5f4c">full_span_count</a>;</div>
<div class="line"><a name="l02283"></a><span class="lineno"> 2283</span>&#160; </div>
<div class="line"><a name="l02284"></a><span class="lineno"> 2284</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#ab4225911698b67188e1538c334cfe16c">pointer_offset</a>(span, <a class="code" href="../../df/dc0/rpmalloc_8c.html#a645356809d937167848705edabde7d44">SPAN_HEADER_SIZE</a>);</div>
<div class="line"><a name="l02285"></a><span class="lineno"> 2285</span>&#160;}</div>
<div class="line"><a name="l02286"></a><span class="lineno"> 2286</span>&#160; </div>
<div class="line"><a name="l02288"></a><span class="lineno"> 2288</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> *</div>
<div class="line"><a name="l02289"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#af8bd0cd08a93d20cb117e18d85f877cd"> 2289</a></span>&#160;<a class="code" href="../../df/dc0/rpmalloc_8c.html#af8bd0cd08a93d20cb117e18d85f877cd">_rpmalloc_allocate</a>(<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#d9/d8a/structheap__t">heap_t</a> *heap, <span class="keywordtype">size_t</span> <a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a>)</div>
<div class="line"><a name="l02290"></a><span class="lineno"> 2290</span>&#160;{</div>
<div class="line"><a name="l02291"></a><span class="lineno"> 2291</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#a49e532a65b873a6c3315aa769299687c">_rpmalloc_stat_add64</a>(&amp;_allocation_counter, 1);</div>
<div class="line"><a name="l02292"></a><span class="lineno"> 2292</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="../../df/dc0/rpmalloc_8c.html#a90593dceacf0c04f14d084bed7e7eabe">EXPECTED</a>(<a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a> &lt;= <a class="code" href="../../df/dc0/rpmalloc_8c.html#aecf578949f89fb109c5f6f527a2dc49d">SMALL_SIZE_LIMIT</a>))</div>
<div class="line"><a name="l02293"></a><span class="lineno"> 2293</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#a2a7ceea1aafc39d3196091847b88e701">_rpmalloc_allocate_small</a>(heap, <a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a>);</div>
<div class="line"><a name="l02294"></a><span class="lineno"> 2294</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a> &lt;= <a class="code" href="../../df/dc0/rpmalloc_8c.html#a9641beb0030ad56b2df025775823b2af">_memory_medium_size_limit</a>)</div>
<div class="line"><a name="l02295"></a><span class="lineno"> 2295</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#a63b187e233e7b190db2bac536cf8a09b">_rpmalloc_allocate_medium</a>(heap, <a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a>);</div>
<div class="line"><a name="l02296"></a><span class="lineno"> 2296</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a> &lt;= <a class="code" href="../../df/dc0/rpmalloc_8c.html#a6866e2b7c1e8f60d6c74ea8fba6be44d">LARGE_SIZE_LIMIT</a>)</div>
<div class="line"><a name="l02297"></a><span class="lineno"> 2297</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#a9891bc299af5a3533139ca76ce76cd70">_rpmalloc_allocate_large</a>(heap, <a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a>);</div>
<div class="line"><a name="l02298"></a><span class="lineno"> 2298</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#a00b91d87f9efd9b1073443761130d595">_rpmalloc_allocate_huge</a>(heap, <a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a>);</div>
<div class="line"><a name="l02299"></a><span class="lineno"> 2299</span>&#160;}</div>
<div class="line"><a name="l02300"></a><span class="lineno"> 2300</span>&#160; </div>
<div class="line"><a name="l02301"></a><span class="lineno"> 2301</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> *</div>
<div class="line"><a name="l02302"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a4be7846b7aabc5b469a4cc66dbc6fb36"> 2302</a></span>&#160;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a4be7846b7aabc5b469a4cc66dbc6fb36">_rpmalloc_aligned_allocate</a>(<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#d9/d8a/structheap__t">heap_t</a> *heap, <span class="keywordtype">size_t</span> alignment, <span class="keywordtype">size_t</span> <a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a>)</div>
<div class="line"><a name="l02303"></a><span class="lineno"> 2303</span>&#160;{</div>
<div class="line"><a name="l02304"></a><span class="lineno"> 2304</span>&#160;    <span class="keywordflow">if</span> (alignment &lt;= <a class="code" href="../../df/dc0/rpmalloc_8c.html#a000afcda168a6fd19a9435e049508463">SMALL_GRANULARITY</a>)</div>
<div class="line"><a name="l02305"></a><span class="lineno"> 2305</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#af8bd0cd08a93d20cb117e18d85f877cd">_rpmalloc_allocate</a>(heap, <a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a>);</div>
<div class="line"><a name="l02306"></a><span class="lineno"> 2306</span>&#160; </div>
<div class="line"><a name="l02307"></a><span class="lineno"> 2307</span>&#160;<span class="preprocessor">#if ENABLE_VALIDATE_ARGS</span></div>
<div class="line"><a name="l02308"></a><span class="lineno"> 2308</span>&#160;    <a class="code" href="../../dc/d6b/Kernel_2include__std_2assert_8h.html#af576bf8ffa22a44e53018c67095ffbf0">assert</a>((<a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a> + alignment) &gt; <a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a>);</div>
<div class="line"><a name="l02309"></a><span class="lineno"> 2309</span>&#160;    <a class="code" href="../../dc/d6b/Kernel_2include__std_2assert_8h.html#af576bf8ffa22a44e53018c67095ffbf0">assert</a>((alignment &amp; (alignment - 1)) == 0);</div>
<div class="line"><a name="l02310"></a><span class="lineno"> 2310</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02311"></a><span class="lineno"> 2311</span>&#160; </div>
<div class="line"><a name="l02312"></a><span class="lineno"> 2312</span>&#160;    <span class="keywordflow">if</span> ((alignment &lt;= <a class="code" href="../../df/dc0/rpmalloc_8c.html#a645356809d937167848705edabde7d44">SPAN_HEADER_SIZE</a>) &amp;&amp; (<a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a> &lt; <a class="code" href="../../df/dc0/rpmalloc_8c.html#a9641beb0030ad56b2df025775823b2af">_memory_medium_size_limit</a>))</div>
<div class="line"><a name="l02313"></a><span class="lineno"> 2313</span>&#160;    {</div>
<div class="line"><a name="l02314"></a><span class="lineno"> 2314</span>&#160;        <span class="comment">// If alignment is less or equal to span header size (which is power of two),</span></div>
<div class="line"><a name="l02315"></a><span class="lineno"> 2315</span>&#160;        <span class="comment">// and size aligned to span header size multiples is less than size + alignment,</span></div>
<div class="line"><a name="l02316"></a><span class="lineno"> 2316</span>&#160;        <span class="comment">// then use natural alignment of blocks to provide alignment</span></div>
<div class="line"><a name="l02317"></a><span class="lineno"> 2317</span>&#160;        <span class="keywordtype">size_t</span> multiple_size = <a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a> ? (<a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a> + (<a class="code" href="../../df/dc0/rpmalloc_8c.html#a645356809d937167848705edabde7d44">SPAN_HEADER_SIZE</a> - 1)) &amp; ~(<a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#a4788399d1d0b37ccf098a7da82254808">uintptr_t</a>)(<a class="code" href="../../df/dc0/rpmalloc_8c.html#a645356809d937167848705edabde7d44">SPAN_HEADER_SIZE</a> - 1) : <a class="code" href="../../df/dc0/rpmalloc_8c.html#a645356809d937167848705edabde7d44">SPAN_HEADER_SIZE</a>;</div>
<div class="line"><a name="l02318"></a><span class="lineno"> 2318</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#ad008ddf766a4f56fbde2edf2c51d9a87">rpmalloc_assert</a>(!(multiple_size % <a class="code" href="../../df/dc0/rpmalloc_8c.html#a645356809d937167848705edabde7d44">SPAN_HEADER_SIZE</a>), <span class="stringliteral">&quot;Failed alignment calculation&quot;</span>);</div>
<div class="line"><a name="l02319"></a><span class="lineno"> 2319</span>&#160;        <span class="keywordflow">if</span> (multiple_size &lt;= (<a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a> + alignment))</div>
<div class="line"><a name="l02320"></a><span class="lineno"> 2320</span>&#160;            <span class="keywordflow">return</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#af8bd0cd08a93d20cb117e18d85f877cd">_rpmalloc_allocate</a>(heap, multiple_size);</div>
<div class="line"><a name="l02321"></a><span class="lineno"> 2321</span>&#160;    }</div>
<div class="line"><a name="l02322"></a><span class="lineno"> 2322</span>&#160; </div>
<div class="line"><a name="l02323"></a><span class="lineno"> 2323</span>&#160;    <span class="keywordtype">void</span> *ptr = 0;</div>
<div class="line"><a name="l02324"></a><span class="lineno"> 2324</span>&#160;    <span class="keywordtype">size_t</span> align_mask = alignment - 1;</div>
<div class="line"><a name="l02325"></a><span class="lineno"> 2325</span>&#160;    <span class="keywordflow">if</span> (alignment &lt;= <a class="code" href="../../df/dc0/rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a>)</div>
<div class="line"><a name="l02326"></a><span class="lineno"> 2326</span>&#160;    {</div>
<div class="line"><a name="l02327"></a><span class="lineno"> 2327</span>&#160;        ptr = <a class="code" href="../../df/dc0/rpmalloc_8c.html#af8bd0cd08a93d20cb117e18d85f877cd">_rpmalloc_allocate</a>(heap, <a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a> + alignment);</div>
<div class="line"><a name="l02328"></a><span class="lineno"> 2328</span>&#160;        <span class="keywordflow">if</span> ((<a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#a4788399d1d0b37ccf098a7da82254808">uintptr_t</a>)ptr &amp; align_mask)</div>
<div class="line"><a name="l02329"></a><span class="lineno"> 2329</span>&#160;        {</div>
<div class="line"><a name="l02330"></a><span class="lineno"> 2330</span>&#160;            ptr = (<span class="keywordtype">void</span> *)(((<a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#a4788399d1d0b37ccf098a7da82254808">uintptr_t</a>)ptr &amp; ~(<a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#a4788399d1d0b37ccf098a7da82254808">uintptr_t</a>)align_mask) + alignment);</div>
<div class="line"><a name="l02331"></a><span class="lineno"> 2331</span>&#160;            <span class="comment">// Mark as having aligned blocks</span></div>
<div class="line"><a name="l02332"></a><span class="lineno"> 2332</span>&#160;            <a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *span = (<a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *)((<a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#a4788399d1d0b37ccf098a7da82254808">uintptr_t</a>)ptr &amp; <a class="code" href="../../df/dc0/rpmalloc_8c.html#ae7b97ba12e15609b6d63926ed2e30238">_memory_span_mask</a>);</div>
<div class="line"><a name="l02333"></a><span class="lineno"> 2333</span>&#160;            span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a4de89d484559557bb639a2703c750b17">flags</a> |= <a class="code" href="../../df/dc0/rpmalloc_8c.html#ad1094486bd3e5ee282e7a4ce7de9c7db">SPAN_FLAG_ALIGNED_BLOCKS</a>;</div>
<div class="line"><a name="l02334"></a><span class="lineno"> 2334</span>&#160;        }</div>
<div class="line"><a name="l02335"></a><span class="lineno"> 2335</span>&#160;        <span class="keywordflow">return</span> ptr;</div>
<div class="line"><a name="l02336"></a><span class="lineno"> 2336</span>&#160;    }</div>
<div class="line"><a name="l02337"></a><span class="lineno"> 2337</span>&#160; </div>
<div class="line"><a name="l02338"></a><span class="lineno"> 2338</span>&#160;    <span class="comment">// Fallback to mapping new pages for this request. Since pointers passed</span></div>
<div class="line"><a name="l02339"></a><span class="lineno"> 2339</span>&#160;    <span class="comment">// to rpfree must be able to reach the start of the span by bitmasking of</span></div>
<div class="line"><a name="l02340"></a><span class="lineno"> 2340</span>&#160;    <span class="comment">// the address with the span size, the returned aligned pointer from this</span></div>
<div class="line"><a name="l02341"></a><span class="lineno"> 2341</span>&#160;    <span class="comment">// function must be with a span size of the start of the mapped area.</span></div>
<div class="line"><a name="l02342"></a><span class="lineno"> 2342</span>&#160;    <span class="comment">// In worst case this requires us to loop and map pages until we get a</span></div>
<div class="line"><a name="l02343"></a><span class="lineno"> 2343</span>&#160;    <span class="comment">// suitable memory address. It also means we can never align to span size</span></div>
<div class="line"><a name="l02344"></a><span class="lineno"> 2344</span>&#160;    <span class="comment">// or greater, since the span header will push alignment more than one</span></div>
<div class="line"><a name="l02345"></a><span class="lineno"> 2345</span>&#160;    <span class="comment">// span size away from span start (thus causing pointer mask to give us</span></div>
<div class="line"><a name="l02346"></a><span class="lineno"> 2346</span>&#160;    <span class="comment">// an invalid span start on free)</span></div>
<div class="line"><a name="l02347"></a><span class="lineno"> 2347</span>&#160;    <span class="keywordflow">if</span> (alignment &amp; align_mask)</div>
<div class="line"><a name="l02348"></a><span class="lineno"> 2348</span>&#160;    {</div>
<div class="line"><a name="l02349"></a><span class="lineno"> 2349</span>&#160;        <a class="code" href="../../df/d9b/Kernel_2include_2interface_2errno_8h.html#ab03f640d90fbc5bcb75285d08a0f25ed">errno</a> = <a class="code" href="../../df/d53/Userspace_2libc_2include_2errno_8h.html#a2d1678d5a7cc8ce499643f3b8957def4">EINVAL</a>;</div>
<div class="line"><a name="l02350"></a><span class="lineno"> 2350</span>&#160;        <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l02351"></a><span class="lineno"> 2351</span>&#160;    }</div>
<div class="line"><a name="l02352"></a><span class="lineno"> 2352</span>&#160;    <span class="keywordflow">if</span> (alignment &gt;= <a class="code" href="../../df/dc0/rpmalloc_8c.html#a9fefa5277fefa0c58f69d5b86d679ccb">_memory_span_size</a>)</div>
<div class="line"><a name="l02353"></a><span class="lineno"> 2353</span>&#160;    {</div>
<div class="line"><a name="l02354"></a><span class="lineno"> 2354</span>&#160;        <a class="code" href="../../df/d9b/Kernel_2include_2interface_2errno_8h.html#ab03f640d90fbc5bcb75285d08a0f25ed">errno</a> = <a class="code" href="../../df/d53/Userspace_2libc_2include_2errno_8h.html#a2d1678d5a7cc8ce499643f3b8957def4">EINVAL</a>;</div>
<div class="line"><a name="l02355"></a><span class="lineno"> 2355</span>&#160;        <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l02356"></a><span class="lineno"> 2356</span>&#160;    }</div>
<div class="line"><a name="l02357"></a><span class="lineno"> 2357</span>&#160; </div>
<div class="line"><a name="l02358"></a><span class="lineno"> 2358</span>&#160;    <span class="keywordtype">size_t</span> extra_pages = alignment / <a class="code" href="../../df/dc0/rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a>;</div>
<div class="line"><a name="l02359"></a><span class="lineno"> 2359</span>&#160; </div>
<div class="line"><a name="l02360"></a><span class="lineno"> 2360</span>&#160;    <span class="comment">// Since each span has a header, we will at least need one extra memory page</span></div>
<div class="line"><a name="l02361"></a><span class="lineno"> 2361</span>&#160;    <span class="keywordtype">size_t</span> num_pages = 1 + (<a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a> / <a class="code" href="../../df/dc0/rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a>);</div>
<div class="line"><a name="l02362"></a><span class="lineno"> 2362</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a> &amp; (<a class="code" href="../../df/dc0/rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a> - 1))</div>
<div class="line"><a name="l02363"></a><span class="lineno"> 2363</span>&#160;        ++num_pages;</div>
<div class="line"><a name="l02364"></a><span class="lineno"> 2364</span>&#160; </div>
<div class="line"><a name="l02365"></a><span class="lineno"> 2365</span>&#160;    <span class="keywordflow">if</span> (extra_pages &gt; num_pages)</div>
<div class="line"><a name="l02366"></a><span class="lineno"> 2366</span>&#160;        num_pages = 1 + extra_pages;</div>
<div class="line"><a name="l02367"></a><span class="lineno"> 2367</span>&#160; </div>
<div class="line"><a name="l02368"></a><span class="lineno"> 2368</span>&#160;    <span class="keywordtype">size_t</span> original_pages = num_pages;</div>
<div class="line"><a name="l02369"></a><span class="lineno"> 2369</span>&#160;    <span class="keywordtype">size_t</span> limit_pages = (<a class="code" href="../../df/dc0/rpmalloc_8c.html#a9fefa5277fefa0c58f69d5b86d679ccb">_memory_span_size</a> / <a class="code" href="../../df/dc0/rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a>) * 2;</div>
<div class="line"><a name="l02370"></a><span class="lineno"> 2370</span>&#160;    <span class="keywordflow">if</span> (limit_pages &lt; (original_pages * 2))</div>
<div class="line"><a name="l02371"></a><span class="lineno"> 2371</span>&#160;        limit_pages = original_pages * 2;</div>
<div class="line"><a name="l02372"></a><span class="lineno"> 2372</span>&#160; </div>
<div class="line"><a name="l02373"></a><span class="lineno"> 2373</span>&#160;    <span class="keywordtype">size_t</span> mapped_size, align_offset;</div>
<div class="line"><a name="l02374"></a><span class="lineno"> 2374</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *span;</div>
<div class="line"><a name="l02375"></a><span class="lineno"> 2375</span>&#160; </div>
<div class="line"><a name="l02376"></a><span class="lineno"> 2376</span>&#160;retry:</div>
<div class="line"><a name="l02377"></a><span class="lineno"> 2377</span>&#160;    align_offset = 0;</div>
<div class="line"><a name="l02378"></a><span class="lineno"> 2378</span>&#160;    mapped_size = num_pages * <a class="code" href="../../df/dc0/rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a>;</div>
<div class="line"><a name="l02379"></a><span class="lineno"> 2379</span>&#160; </div>
<div class="line"><a name="l02380"></a><span class="lineno"> 2380</span>&#160;    span = (<a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *)<a class="code" href="../../df/dc0/rpmalloc_8c.html#a2d8a3eac487ff2943f8aae4dd20badd3">_rpmalloc_mmap</a>(mapped_size, &amp;align_offset);</div>
<div class="line"><a name="l02381"></a><span class="lineno"> 2381</span>&#160;    <span class="keywordflow">if</span> (!span)</div>
<div class="line"><a name="l02382"></a><span class="lineno"> 2382</span>&#160;    {</div>
<div class="line"><a name="l02383"></a><span class="lineno"> 2383</span>&#160;        <a class="code" href="../../df/d9b/Kernel_2include_2interface_2errno_8h.html#ab03f640d90fbc5bcb75285d08a0f25ed">errno</a> = <a class="code" href="../../df/d53/Userspace_2libc_2include_2errno_8h.html#a6a05c923dad0c1208043e9c20a58c8e5">ENOMEM</a>;</div>
<div class="line"><a name="l02384"></a><span class="lineno"> 2384</span>&#160;        <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l02385"></a><span class="lineno"> 2385</span>&#160;    }</div>
<div class="line"><a name="l02386"></a><span class="lineno"> 2386</span>&#160;    ptr = <a class="code" href="../../df/dc0/rpmalloc_8c.html#ab4225911698b67188e1538c334cfe16c">pointer_offset</a>(span, <a class="code" href="../../df/dc0/rpmalloc_8c.html#a645356809d937167848705edabde7d44">SPAN_HEADER_SIZE</a>);</div>
<div class="line"><a name="l02387"></a><span class="lineno"> 2387</span>&#160; </div>
<div class="line"><a name="l02388"></a><span class="lineno"> 2388</span>&#160;    <span class="keywordflow">if</span> ((<a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#a4788399d1d0b37ccf098a7da82254808">uintptr_t</a>)ptr &amp; align_mask)</div>
<div class="line"><a name="l02389"></a><span class="lineno"> 2389</span>&#160;        ptr = (<span class="keywordtype">void</span> *)(((<a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#a4788399d1d0b37ccf098a7da82254808">uintptr_t</a>)ptr &amp; ~(<a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#a4788399d1d0b37ccf098a7da82254808">uintptr_t</a>)align_mask) + alignment);</div>
<div class="line"><a name="l02390"></a><span class="lineno"> 2390</span>&#160; </div>
<div class="line"><a name="l02391"></a><span class="lineno"> 2391</span>&#160;    <span class="keywordflow">if</span> (((<span class="keywordtype">size_t</span>)<a class="code" href="../../df/dc0/rpmalloc_8c.html#af51a6ed47e80b1b57187f1d5be6c8b4c">pointer_diff</a>(ptr, span) &gt;= <a class="code" href="../../df/dc0/rpmalloc_8c.html#a9fefa5277fefa0c58f69d5b86d679ccb">_memory_span_size</a>) ||</div>
<div class="line"><a name="l02392"></a><span class="lineno"> 2392</span>&#160;        (<a class="code" href="../../df/dc0/rpmalloc_8c.html#ab4225911698b67188e1538c334cfe16c">pointer_offset</a>(ptr, <a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a>) &gt; <a class="code" href="../../df/dc0/rpmalloc_8c.html#ab4225911698b67188e1538c334cfe16c">pointer_offset</a>(span, mapped_size)) ||</div>
<div class="line"><a name="l02393"></a><span class="lineno"> 2393</span>&#160;        (((<a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#a4788399d1d0b37ccf098a7da82254808">uintptr_t</a>)ptr &amp; <a class="code" href="../../df/dc0/rpmalloc_8c.html#ae7b97ba12e15609b6d63926ed2e30238">_memory_span_mask</a>) != (<a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#a4788399d1d0b37ccf098a7da82254808">uintptr_t</a>)span))</div>
<div class="line"><a name="l02394"></a><span class="lineno"> 2394</span>&#160;    {</div>
<div class="line"><a name="l02395"></a><span class="lineno"> 2395</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#abfbbb8e2f9b086d466fe2898a283c98d">_rpmalloc_unmap</a>(span, mapped_size, align_offset, mapped_size);</div>
<div class="line"><a name="l02396"></a><span class="lineno"> 2396</span>&#160;        ++num_pages;</div>
<div class="line"><a name="l02397"></a><span class="lineno"> 2397</span>&#160;        <span class="keywordflow">if</span> (num_pages &gt; limit_pages)</div>
<div class="line"><a name="l02398"></a><span class="lineno"> 2398</span>&#160;        {</div>
<div class="line"><a name="l02399"></a><span class="lineno"> 2399</span>&#160;            <a class="code" href="../../df/d9b/Kernel_2include_2interface_2errno_8h.html#ab03f640d90fbc5bcb75285d08a0f25ed">errno</a> = <a class="code" href="../../df/d53/Userspace_2libc_2include_2errno_8h.html#a2d1678d5a7cc8ce499643f3b8957def4">EINVAL</a>;</div>
<div class="line"><a name="l02400"></a><span class="lineno"> 2400</span>&#160;            <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l02401"></a><span class="lineno"> 2401</span>&#160;        }</div>
<div class="line"><a name="l02402"></a><span class="lineno"> 2402</span>&#160;        <span class="keywordflow">goto</span> retry;</div>
<div class="line"><a name="l02403"></a><span class="lineno"> 2403</span>&#160;    }</div>
<div class="line"><a name="l02404"></a><span class="lineno"> 2404</span>&#160; </div>
<div class="line"><a name="l02405"></a><span class="lineno"> 2405</span>&#160;    <span class="comment">// Store page count in span_count</span></div>
<div class="line"><a name="l02406"></a><span class="lineno"> 2406</span>&#160;    span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a5a977febdd2e9ae15bcf66f83d0cf817">size_class</a> = <a class="code" href="../../df/dc0/rpmalloc_8c.html#a284460248778c94b6ee9ea1529299439">SIZE_CLASS_HUGE</a>;</div>
<div class="line"><a name="l02407"></a><span class="lineno"> 2407</span>&#160;    span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#ae77d9a2cdd2a2fd46e3b27739d6c88cc">span_count</a> = (<a class="code" href="../../dd/ddd/arithmetic__operations_8c.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a>)num_pages;</div>
<div class="line"><a name="l02408"></a><span class="lineno"> 2408</span>&#160;    span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a13753de75bc52a5b8a1a9532083c9ba4">align_offset</a> = (<a class="code" href="../../dd/ddd/arithmetic__operations_8c.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a>)align_offset;</div>
<div class="line"><a name="l02409"></a><span class="lineno"> 2409</span>&#160;    span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a345270ce5d1e5e112b45cfde43f37da0">heap</a> = heap;</div>
<div class="line"><a name="l02410"></a><span class="lineno"> 2410</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#a599c57201987cc23a9787a745296e575">_rpmalloc_stat_add_peak</a>(&amp;_huge_pages_current, num_pages, _huge_pages_peak);</div>
<div class="line"><a name="l02411"></a><span class="lineno"> 2411</span>&#160; </div>
<div class="line"><a name="l02412"></a><span class="lineno"> 2412</span>&#160;<span class="preprocessor">#if RPMALLOC_FIRST_CLASS_HEAPS</span></div>
<div class="line"><a name="l02413"></a><span class="lineno"> 2413</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#ac32a750ddf4072d46c28f52b9f3ee018">_rpmalloc_span_double_link_list_add</a>(&amp;heap-&gt;large_huge_span, span);</div>
<div class="line"><a name="l02414"></a><span class="lineno"> 2414</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02415"></a><span class="lineno"> 2415</span>&#160;    ++heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a6aa789c3cdf7e70df144c248d18c5f4c">full_span_count</a>;</div>
<div class="line"><a name="l02416"></a><span class="lineno"> 2416</span>&#160; </div>
<div class="line"><a name="l02417"></a><span class="lineno"> 2417</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#a49e532a65b873a6c3315aa769299687c">_rpmalloc_stat_add64</a>(&amp;_allocation_counter, 1);</div>
<div class="line"><a name="l02418"></a><span class="lineno"> 2418</span>&#160; </div>
<div class="line"><a name="l02419"></a><span class="lineno"> 2419</span>&#160;    <span class="keywordflow">return</span> ptr;</div>
<div class="line"><a name="l02420"></a><span class="lineno"> 2420</span>&#160;}</div>
<div class="line"><a name="l02421"></a><span class="lineno"> 2421</span>&#160; </div>
<div class="line"><a name="l02427"></a><span class="lineno"> 2427</span>&#160; </div>
<div class="line"><a name="l02429"></a><span class="lineno"> 2429</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="l02430"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a6c1102ef8a3812f1098cad573ea7794e"> 2430</a></span>&#160;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a6c1102ef8a3812f1098cad573ea7794e">_rpmalloc_deallocate_direct_small_or_medium</a>(<a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *span, <span class="keywordtype">void</span> *block)</div>
<div class="line"><a name="l02431"></a><span class="lineno"> 2431</span>&#160;{</div>
<div class="line"><a name="l02432"></a><span class="lineno"> 2432</span>&#160;    <a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#d9/d8a/structheap__t">heap_t</a> *heap = span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a345270ce5d1e5e112b45cfde43f37da0">heap</a>;</div>
<div class="line"><a name="l02433"></a><span class="lineno"> 2433</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#ad008ddf766a4f56fbde2edf2c51d9a87">rpmalloc_assert</a>(heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a436e67271364d132c12f2f5f0d4c79ef">owner_thread</a> == <a class="code" href="../../df/dc0/rpmalloc_8c.html#a84e326ca88dee0bd7ca995727bb52381">get_thread_id</a>() || !heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a436e67271364d132c12f2f5f0d4c79ef">owner_thread</a> || heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a13ccab5430ace95c471aacf1fab0fcd6">finalize</a>, <span class="stringliteral">&quot;Internal failure&quot;</span>);</div>
<div class="line"><a name="l02434"></a><span class="lineno"> 2434</span>&#160;    <span class="comment">// Add block to free list</span></div>
<div class="line"><a name="l02435"></a><span class="lineno"> 2435</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="../../df/dc0/rpmalloc_8c.html#af8f864d9fe0055b43dc8034fe9060630">UNEXPECTED</a>(<a class="code" href="../../df/dc0/rpmalloc_8c.html#ade7fb930b30a5a8bd04ecc97cad60e6b">_rpmalloc_span_is_fully_utilized</a>(span)))</div>
<div class="line"><a name="l02436"></a><span class="lineno"> 2436</span>&#160;    {</div>
<div class="line"><a name="l02437"></a><span class="lineno"> 2437</span>&#160;        span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#abf4fa6f8f0e7baff0d6a7a96df58bcca">used_count</a> = span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a7ee7892ce3c5d8342af193f1824a5098">block_count</a>;</div>
<div class="line"><a name="l02438"></a><span class="lineno"> 2438</span>&#160;<span class="preprocessor">#if RPMALLOC_FIRST_CLASS_HEAPS</span></div>
<div class="line"><a name="l02439"></a><span class="lineno"> 2439</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#aec7913670102d551e3fd60509cd381a3">_rpmalloc_span_double_link_list_remove</a>(&amp;heap-&gt;full_span[span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a5a977febdd2e9ae15bcf66f83d0cf817">size_class</a>], span);</div>
<div class="line"><a name="l02440"></a><span class="lineno"> 2440</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02441"></a><span class="lineno"> 2441</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#ac32a750ddf4072d46c28f52b9f3ee018">_rpmalloc_span_double_link_list_add</a>(&amp;heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a70f9a96b9071ccb6642894f5a7f56432">size_class</a>[span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a5a977febdd2e9ae15bcf66f83d0cf817">size_class</a>].<a class="code" href="../../df/dc0/rpmalloc_8c.html#af829c49d9fc4d933c14113ba0d694e7c">partial_span</a>, span);</div>
<div class="line"><a name="l02442"></a><span class="lineno"> 2442</span>&#160;        --heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a6aa789c3cdf7e70df144c248d18c5f4c">full_span_count</a>;</div>
<div class="line"><a name="l02443"></a><span class="lineno"> 2443</span>&#160;    }</div>
<div class="line"><a name="l02444"></a><span class="lineno"> 2444</span>&#160;    *((<span class="keywordtype">void</span> **)block) = span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a85527ad364915bcb39b7d421524d0bd6">free_list</a>;</div>
<div class="line"><a name="l02445"></a><span class="lineno"> 2445</span>&#160;    --span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#abf4fa6f8f0e7baff0d6a7a96df58bcca">used_count</a>;</div>
<div class="line"><a name="l02446"></a><span class="lineno"> 2446</span>&#160;    span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a85527ad364915bcb39b7d421524d0bd6">free_list</a> = block;</div>
<div class="line"><a name="l02447"></a><span class="lineno"> 2447</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="../../df/dc0/rpmalloc_8c.html#af8f864d9fe0055b43dc8034fe9060630">UNEXPECTED</a>(span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#abf4fa6f8f0e7baff0d6a7a96df58bcca">used_count</a> == span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#ad842dbc76a30fb5beee77a2d773a3e91">list_size</a>))</div>
<div class="line"><a name="l02448"></a><span class="lineno"> 2448</span>&#160;    {</div>
<div class="line"><a name="l02449"></a><span class="lineno"> 2449</span>&#160;        <span class="comment">// If there are no used blocks it is guaranteed that no other external thread is accessing the span</span></div>
<div class="line"><a name="l02450"></a><span class="lineno"> 2450</span>&#160;        <span class="keywordflow">if</span> (span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#abf4fa6f8f0e7baff0d6a7a96df58bcca">used_count</a>)</div>
<div class="line"><a name="l02451"></a><span class="lineno"> 2451</span>&#160;        {</div>
<div class="line"><a name="l02452"></a><span class="lineno"> 2452</span>&#160;            <span class="comment">// Make sure we have synchronized the deferred list and list size by using acquire semantics</span></div>
<div class="line"><a name="l02453"></a><span class="lineno"> 2453</span>&#160;            <span class="comment">// and guarantee that no external thread is accessing span concurrently</span></div>
<div class="line"><a name="l02454"></a><span class="lineno"> 2454</span>&#160;            <span class="keywordtype">void</span> *free_list;</div>
<div class="line"><a name="l02455"></a><span class="lineno"> 2455</span>&#160;            <span class="keywordflow">do</span></div>
<div class="line"><a name="l02456"></a><span class="lineno"> 2456</span>&#160;            {</div>
<div class="line"><a name="l02457"></a><span class="lineno"> 2457</span>&#160;                free_list = <a class="code" href="../../df/dc0/rpmalloc_8c.html#af6f24a9d51e940bbad434106b1d56e20">atomic_exchange_ptr_acquire</a>(&amp;span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a22b0340927d02f0c7c4486f01c31358e">free_list_deferred</a>, <a class="code" href="../../df/dc0/rpmalloc_8c.html#a95d666267d99d22454086d5fa0390bff">INVALID_POINTER</a>);</div>
<div class="line"><a name="l02458"></a><span class="lineno"> 2458</span>&#160;            } <span class="keywordflow">while</span> (free_list == <a class="code" href="../../df/dc0/rpmalloc_8c.html#a95d666267d99d22454086d5fa0390bff">INVALID_POINTER</a>);</div>
<div class="line"><a name="l02459"></a><span class="lineno"> 2459</span>&#160;            <a class="code" href="../../df/dc0/rpmalloc_8c.html#a94d4ba8d2181723f35b45da39c91d8ab">atomic_store_ptr_release</a>(&amp;span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a22b0340927d02f0c7c4486f01c31358e">free_list_deferred</a>, free_list);</div>
<div class="line"><a name="l02460"></a><span class="lineno"> 2460</span>&#160;        }</div>
<div class="line"><a name="l02461"></a><span class="lineno"> 2461</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#aec7913670102d551e3fd60509cd381a3">_rpmalloc_span_double_link_list_remove</a>(&amp;heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a70f9a96b9071ccb6642894f5a7f56432">size_class</a>[span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a5a977febdd2e9ae15bcf66f83d0cf817">size_class</a>].<a class="code" href="../../df/dc0/rpmalloc_8c.html#af829c49d9fc4d933c14113ba0d694e7c">partial_span</a>, span);</div>
<div class="line"><a name="l02462"></a><span class="lineno"> 2462</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#a62b31eca2760e37676716c54c5b64947">_rpmalloc_span_release_to_cache</a>(heap, span);</div>
<div class="line"><a name="l02463"></a><span class="lineno"> 2463</span>&#160;    }</div>
<div class="line"><a name="l02464"></a><span class="lineno"> 2464</span>&#160;}</div>
<div class="line"><a name="l02465"></a><span class="lineno"> 2465</span>&#160; </div>
<div class="line"><a name="l02466"></a><span class="lineno"> 2466</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="l02467"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#ac8a96725f034c08fdff774eb54785947"> 2467</a></span>&#160;<a class="code" href="../../df/dc0/rpmalloc_8c.html#ac8a96725f034c08fdff774eb54785947">_rpmalloc_deallocate_defer_free_span</a>(<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#d9/d8a/structheap__t">heap_t</a> *heap, <a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *span)</div>
<div class="line"><a name="l02468"></a><span class="lineno"> 2468</span>&#160;{</div>
<div class="line"><a name="l02469"></a><span class="lineno"> 2469</span>&#160;    <span class="keywordflow">if</span> (span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a5a977febdd2e9ae15bcf66f83d0cf817">size_class</a> != <a class="code" href="../../df/dc0/rpmalloc_8c.html#a284460248778c94b6ee9ea1529299439">SIZE_CLASS_HUGE</a>)</div>
<div class="line"><a name="l02470"></a><span class="lineno"> 2470</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#ab51bbcd0d9d41ba9c6f4ad547ba77405">_rpmalloc_stat_inc</a>(&amp;heap-&gt;span_use[span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#ae77d9a2cdd2a2fd46e3b27739d6c88cc">span_count</a> - 1].spans_deferred);</div>
<div class="line"><a name="l02471"></a><span class="lineno"> 2471</span>&#160;    <span class="comment">// This list does not need ABA protection, no mutable side state</span></div>
<div class="line"><a name="l02472"></a><span class="lineno"> 2472</span>&#160;    <span class="keywordflow">do</span></div>
<div class="line"><a name="l02473"></a><span class="lineno"> 2473</span>&#160;    {</div>
<div class="line"><a name="l02474"></a><span class="lineno"> 2474</span>&#160;        span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a85527ad364915bcb39b7d421524d0bd6">free_list</a> = (<span class="keywordtype">void</span> *)<a class="code" href="../../df/dc0/rpmalloc_8c.html#a83ddc23debb02a3c47f0b00939fc8f35">atomic_load_ptr</a>(&amp;heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a354c0beb35fd982bc4dbd3783b2dd1ff">span_free_deferred</a>);</div>
<div class="line"><a name="l02475"></a><span class="lineno"> 2475</span>&#160;    } <span class="keywordflow">while</span> (!<a class="code" href="../../df/dc0/rpmalloc_8c.html#a303f700546874a81e694eda44cc3174d">atomic_cas_ptr</a>(&amp;heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a354c0beb35fd982bc4dbd3783b2dd1ff">span_free_deferred</a>, span, span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a85527ad364915bcb39b7d421524d0bd6">free_list</a>));</div>
<div class="line"><a name="l02476"></a><span class="lineno"> 2476</span>&#160;}</div>
<div class="line"><a name="l02477"></a><span class="lineno"> 2477</span>&#160; </div>
<div class="line"><a name="l02479"></a><span class="lineno"> 2479</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="l02480"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a6cc5147be3d12c47a533a9cd14e36801"> 2480</a></span>&#160;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a6cc5147be3d12c47a533a9cd14e36801">_rpmalloc_deallocate_defer_small_or_medium</a>(<a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *span, <span class="keywordtype">void</span> *block)</div>
<div class="line"><a name="l02481"></a><span class="lineno"> 2481</span>&#160;{</div>
<div class="line"><a name="l02482"></a><span class="lineno"> 2482</span>&#160;    <span class="comment">// The memory ordering here is a bit tricky, to avoid having to ABA protect</span></div>
<div class="line"><a name="l02483"></a><span class="lineno"> 2483</span>&#160;    <span class="comment">// the deferred free list to avoid desynchronization of list and list size</span></div>
<div class="line"><a name="l02484"></a><span class="lineno"> 2484</span>&#160;    <span class="comment">// we need to have acquire semantics on successful CAS of the pointer to</span></div>
<div class="line"><a name="l02485"></a><span class="lineno"> 2485</span>&#160;    <span class="comment">// guarantee the list_size variable validity + release semantics on pointer store</span></div>
<div class="line"><a name="l02486"></a><span class="lineno"> 2486</span>&#160;    <span class="keywordtype">void</span> *free_list;</div>
<div class="line"><a name="l02487"></a><span class="lineno"> 2487</span>&#160;    <span class="keywordflow">do</span></div>
<div class="line"><a name="l02488"></a><span class="lineno"> 2488</span>&#160;    {</div>
<div class="line"><a name="l02489"></a><span class="lineno"> 2489</span>&#160;        free_list = <a class="code" href="../../df/dc0/rpmalloc_8c.html#af6f24a9d51e940bbad434106b1d56e20">atomic_exchange_ptr_acquire</a>(&amp;span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a22b0340927d02f0c7c4486f01c31358e">free_list_deferred</a>, <a class="code" href="../../df/dc0/rpmalloc_8c.html#a95d666267d99d22454086d5fa0390bff">INVALID_POINTER</a>);</div>
<div class="line"><a name="l02490"></a><span class="lineno"> 2490</span>&#160;    } <span class="keywordflow">while</span> (free_list == <a class="code" href="../../df/dc0/rpmalloc_8c.html#a95d666267d99d22454086d5fa0390bff">INVALID_POINTER</a>);</div>
<div class="line"><a name="l02491"></a><span class="lineno"> 2491</span>&#160;    *((<span class="keywordtype">void</span> **)block) = free_list;</div>
<div class="line"><a name="l02492"></a><span class="lineno"> 2492</span>&#160;    <a class="code" href="../../dd/ddd/arithmetic__operations_8c.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a> free_count = ++span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#ad842dbc76a30fb5beee77a2d773a3e91">list_size</a>;</div>
<div class="line"><a name="l02493"></a><span class="lineno"> 2493</span>&#160;    <span class="keywordtype">int</span> all_deferred_free = (free_count == span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a7ee7892ce3c5d8342af193f1824a5098">block_count</a>);</div>
<div class="line"><a name="l02494"></a><span class="lineno"> 2494</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#a94d4ba8d2181723f35b45da39c91d8ab">atomic_store_ptr_release</a>(&amp;span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a22b0340927d02f0c7c4486f01c31358e">free_list_deferred</a>, block);</div>
<div class="line"><a name="l02495"></a><span class="lineno"> 2495</span>&#160;    <span class="keywordflow">if</span> (all_deferred_free)</div>
<div class="line"><a name="l02496"></a><span class="lineno"> 2496</span>&#160;    {</div>
<div class="line"><a name="l02497"></a><span class="lineno"> 2497</span>&#160;        <span class="comment">// Span was completely freed by this block. Due to the INVALID_POINTER spin lock</span></div>
<div class="line"><a name="l02498"></a><span class="lineno"> 2498</span>&#160;        <span class="comment">// no other thread can reach this state simultaneously on this span.</span></div>
<div class="line"><a name="l02499"></a><span class="lineno"> 2499</span>&#160;        <span class="comment">// Safe to move to owner heap deferred cache</span></div>
<div class="line"><a name="l02500"></a><span class="lineno"> 2500</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#ac8a96725f034c08fdff774eb54785947">_rpmalloc_deallocate_defer_free_span</a>(span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a345270ce5d1e5e112b45cfde43f37da0">heap</a>, span);</div>
<div class="line"><a name="l02501"></a><span class="lineno"> 2501</span>&#160;    }</div>
<div class="line"><a name="l02502"></a><span class="lineno"> 2502</span>&#160;}</div>
<div class="line"><a name="l02503"></a><span class="lineno"> 2503</span>&#160; </div>
<div class="line"><a name="l02504"></a><span class="lineno"> 2504</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="l02505"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a7fdcd37f930a06ca527ab10334bf1d1e"> 2505</a></span>&#160;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a7fdcd37f930a06ca527ab10334bf1d1e">_rpmalloc_deallocate_small_or_medium</a>(<a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *span, <span class="keywordtype">void</span> *<a class="code" href="../../df/d55/userspace__test_8c.html#a83de08c56df151f990dc392523079284">p</a>)</div>
<div class="line"><a name="l02506"></a><span class="lineno"> 2506</span>&#160;{</div>
<div class="line"><a name="l02507"></a><span class="lineno"> 2507</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#ab3168e56cb172bc471c410e9daaf7ca1">_rpmalloc_stat_inc_free</a>(span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a345270ce5d1e5e112b45cfde43f37da0">heap</a>, span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a5a977febdd2e9ae15bcf66f83d0cf817">size_class</a>);</div>
<div class="line"><a name="l02508"></a><span class="lineno"> 2508</span>&#160;    <span class="keywordflow">if</span> (span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a4de89d484559557bb639a2703c750b17">flags</a> &amp; <a class="code" href="../../df/dc0/rpmalloc_8c.html#ad1094486bd3e5ee282e7a4ce7de9c7db">SPAN_FLAG_ALIGNED_BLOCKS</a>)</div>
<div class="line"><a name="l02509"></a><span class="lineno"> 2509</span>&#160;    {</div>
<div class="line"><a name="l02510"></a><span class="lineno"> 2510</span>&#160;        <span class="comment">// Realign pointer to block start</span></div>
<div class="line"><a name="l02511"></a><span class="lineno"> 2511</span>&#160;        <span class="keywordtype">void</span> *blocks_start = <a class="code" href="../../df/dc0/rpmalloc_8c.html#ab4225911698b67188e1538c334cfe16c">pointer_offset</a>(span, <a class="code" href="../../df/dc0/rpmalloc_8c.html#a645356809d937167848705edabde7d44">SPAN_HEADER_SIZE</a>);</div>
<div class="line"><a name="l02512"></a><span class="lineno"> 2512</span>&#160;        <a class="code" href="../../dd/ddd/arithmetic__operations_8c.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a> block_offset = (<a class="code" href="../../dd/ddd/arithmetic__operations_8c.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a>)<a class="code" href="../../df/dc0/rpmalloc_8c.html#af51a6ed47e80b1b57187f1d5be6c8b4c">pointer_diff</a>(<a class="code" href="../../df/d55/userspace__test_8c.html#a83de08c56df151f990dc392523079284">p</a>, blocks_start);</div>
<div class="line"><a name="l02513"></a><span class="lineno"> 2513</span>&#160;        <a class="code" href="../../df/d55/userspace__test_8c.html#a83de08c56df151f990dc392523079284">p</a> = <a class="code" href="../../df/dc0/rpmalloc_8c.html#ab4225911698b67188e1538c334cfe16c">pointer_offset</a>(<a class="code" href="../../df/d55/userspace__test_8c.html#a83de08c56df151f990dc392523079284">p</a>, -(<a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#a0c18914b3041c2f583aba76f418399c2">int32_t</a>)(block_offset % span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a97df83853dc6ddf7e0114691b15edb49">block_size</a>));</div>
<div class="line"><a name="l02514"></a><span class="lineno"> 2514</span>&#160;    }</div>
<div class="line"><a name="l02515"></a><span class="lineno"> 2515</span>&#160;    <span class="comment">// Check if block belongs to this heap or if deallocation should be deferred</span></div>
<div class="line"><a name="l02516"></a><span class="lineno"> 2516</span>&#160;<span class="preprocessor">#if RPMALLOC_FIRST_CLASS_HEAPS</span></div>
<div class="line"><a name="l02517"></a><span class="lineno"> 2517</span>&#160;    <span class="keywordtype">int</span> defer = (span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a345270ce5d1e5e112b45cfde43f37da0">heap</a>-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a436e67271364d132c12f2f5f0d4c79ef">owner_thread</a> &amp;&amp; (span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a345270ce5d1e5e112b45cfde43f37da0">heap</a>-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a436e67271364d132c12f2f5f0d4c79ef">owner_thread</a> != <a class="code" href="../../df/dc0/rpmalloc_8c.html#a84e326ca88dee0bd7ca995727bb52381">get_thread_id</a>()) &amp;&amp; !span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a345270ce5d1e5e112b45cfde43f37da0">heap</a>-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a13ccab5430ace95c471aacf1fab0fcd6">finalize</a>);</div>
<div class="line"><a name="l02518"></a><span class="lineno"> 2518</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l02519"></a><span class="lineno"> 2519</span>&#160;    <span class="keywordtype">int</span> defer = ((span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a345270ce5d1e5e112b45cfde43f37da0">heap</a>-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a436e67271364d132c12f2f5f0d4c79ef">owner_thread</a> != <a class="code" href="../../df/dc0/rpmalloc_8c.html#a84e326ca88dee0bd7ca995727bb52381">get_thread_id</a>()) &amp;&amp; !span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a345270ce5d1e5e112b45cfde43f37da0">heap</a>-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a13ccab5430ace95c471aacf1fab0fcd6">finalize</a>);</div>
<div class="line"><a name="l02520"></a><span class="lineno"> 2520</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02521"></a><span class="lineno"> 2521</span>&#160;    <span class="keywordflow">if</span> (!defer)</div>
<div class="line"><a name="l02522"></a><span class="lineno"> 2522</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#a6c1102ef8a3812f1098cad573ea7794e">_rpmalloc_deallocate_direct_small_or_medium</a>(span, <a class="code" href="../../df/d55/userspace__test_8c.html#a83de08c56df151f990dc392523079284">p</a>);</div>
<div class="line"><a name="l02523"></a><span class="lineno"> 2523</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l02524"></a><span class="lineno"> 2524</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#a6cc5147be3d12c47a533a9cd14e36801">_rpmalloc_deallocate_defer_small_or_medium</a>(span, <a class="code" href="../../df/d55/userspace__test_8c.html#a83de08c56df151f990dc392523079284">p</a>);</div>
<div class="line"><a name="l02525"></a><span class="lineno"> 2525</span>&#160;}</div>
<div class="line"><a name="l02526"></a><span class="lineno"> 2526</span>&#160; </div>
<div class="line"><a name="l02528"></a><span class="lineno"> 2528</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="l02529"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a573fc7baab7be24c6bac115b7f62192f"> 2529</a></span>&#160;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a573fc7baab7be24c6bac115b7f62192f">_rpmalloc_deallocate_large</a>(<a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *span)</div>
<div class="line"><a name="l02530"></a><span class="lineno"> 2530</span>&#160;{</div>
<div class="line"><a name="l02531"></a><span class="lineno"> 2531</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#ad008ddf766a4f56fbde2edf2c51d9a87">rpmalloc_assert</a>(span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a5a977febdd2e9ae15bcf66f83d0cf817">size_class</a> == <a class="code" href="../../df/dc0/rpmalloc_8c.html#a3f84dd23eb0ef3cf54aeb6afff0618ae">SIZE_CLASS_LARGE</a>, <span class="stringliteral">&quot;Bad span size class&quot;</span>);</div>
<div class="line"><a name="l02532"></a><span class="lineno"> 2532</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#ad008ddf766a4f56fbde2edf2c51d9a87">rpmalloc_assert</a>(!(span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a4de89d484559557bb639a2703c750b17">flags</a> &amp; <a class="code" href="../../df/dc0/rpmalloc_8c.html#a98c82279e204e31a5dc89b64d2c6c27c">SPAN_FLAG_MASTER</a>) || !(span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a4de89d484559557bb639a2703c750b17">flags</a> &amp; <a class="code" href="../../df/dc0/rpmalloc_8c.html#a2fcaea32cf5846f1f5b40a882175dbb0">SPAN_FLAG_SUBSPAN</a>), <span class="stringliteral">&quot;Span flag corrupted&quot;</span>);</div>
<div class="line"><a name="l02533"></a><span class="lineno"> 2533</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#ad008ddf766a4f56fbde2edf2c51d9a87">rpmalloc_assert</a>((span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a4de89d484559557bb639a2703c750b17">flags</a> &amp; <a class="code" href="../../df/dc0/rpmalloc_8c.html#a98c82279e204e31a5dc89b64d2c6c27c">SPAN_FLAG_MASTER</a>) || (span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a4de89d484559557bb639a2703c750b17">flags</a> &amp; <a class="code" href="../../df/dc0/rpmalloc_8c.html#a2fcaea32cf5846f1f5b40a882175dbb0">SPAN_FLAG_SUBSPAN</a>), <span class="stringliteral">&quot;Span flag corrupted&quot;</span>);</div>
<div class="line"><a name="l02534"></a><span class="lineno"> 2534</span>&#160;    <span class="comment">// We must always defer (unless finalizing) if from another heap since we cannot touch the list or counters of another heap</span></div>
<div class="line"><a name="l02535"></a><span class="lineno"> 2535</span>&#160;<span class="preprocessor">#if RPMALLOC_FIRST_CLASS_HEAPS</span></div>
<div class="line"><a name="l02536"></a><span class="lineno"> 2536</span>&#160;    <span class="keywordtype">int</span> defer = (span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a345270ce5d1e5e112b45cfde43f37da0">heap</a>-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a436e67271364d132c12f2f5f0d4c79ef">owner_thread</a> &amp;&amp; (span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a345270ce5d1e5e112b45cfde43f37da0">heap</a>-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a436e67271364d132c12f2f5f0d4c79ef">owner_thread</a> != <a class="code" href="../../df/dc0/rpmalloc_8c.html#a84e326ca88dee0bd7ca995727bb52381">get_thread_id</a>()) &amp;&amp; !span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a345270ce5d1e5e112b45cfde43f37da0">heap</a>-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a13ccab5430ace95c471aacf1fab0fcd6">finalize</a>);</div>
<div class="line"><a name="l02537"></a><span class="lineno"> 2537</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l02538"></a><span class="lineno"> 2538</span>&#160;    <span class="keywordtype">int</span> defer = ((span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a345270ce5d1e5e112b45cfde43f37da0">heap</a>-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a436e67271364d132c12f2f5f0d4c79ef">owner_thread</a> != <a class="code" href="../../df/dc0/rpmalloc_8c.html#a84e326ca88dee0bd7ca995727bb52381">get_thread_id</a>()) &amp;&amp; !span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a345270ce5d1e5e112b45cfde43f37da0">heap</a>-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a13ccab5430ace95c471aacf1fab0fcd6">finalize</a>);</div>
<div class="line"><a name="l02539"></a><span class="lineno"> 2539</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02540"></a><span class="lineno"> 2540</span>&#160;    <span class="keywordflow">if</span> (defer)</div>
<div class="line"><a name="l02541"></a><span class="lineno"> 2541</span>&#160;    {</div>
<div class="line"><a name="l02542"></a><span class="lineno"> 2542</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#ac8a96725f034c08fdff774eb54785947">_rpmalloc_deallocate_defer_free_span</a>(span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a345270ce5d1e5e112b45cfde43f37da0">heap</a>, span);</div>
<div class="line"><a name="l02543"></a><span class="lineno"> 2543</span>&#160;        <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l02544"></a><span class="lineno"> 2544</span>&#160;    }</div>
<div class="line"><a name="l02545"></a><span class="lineno"> 2545</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#ad008ddf766a4f56fbde2edf2c51d9a87">rpmalloc_assert</a>(span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a345270ce5d1e5e112b45cfde43f37da0">heap</a>-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a6aa789c3cdf7e70df144c248d18c5f4c">full_span_count</a>, <span class="stringliteral">&quot;Heap span counter corrupted&quot;</span>);</div>
<div class="line"><a name="l02546"></a><span class="lineno"> 2546</span>&#160;    --span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a345270ce5d1e5e112b45cfde43f37da0">heap</a>-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a6aa789c3cdf7e70df144c248d18c5f4c">full_span_count</a>;</div>
<div class="line"><a name="l02547"></a><span class="lineno"> 2547</span>&#160;<span class="preprocessor">#if RPMALLOC_FIRST_CLASS_HEAPS</span></div>
<div class="line"><a name="l02548"></a><span class="lineno"> 2548</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#aec7913670102d551e3fd60509cd381a3">_rpmalloc_span_double_link_list_remove</a>(&amp;span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a345270ce5d1e5e112b45cfde43f37da0">heap</a>-&gt;large_huge_span, span);</div>
<div class="line"><a name="l02549"></a><span class="lineno"> 2549</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02550"></a><span class="lineno"> 2550</span>&#160;<span class="preprocessor">#if ENABLE_ADAPTIVE_THREAD_CACHE || ENABLE_STATISTICS</span></div>
<div class="line"><a name="l02551"></a><span class="lineno"> 2551</span>&#160;    <span class="comment">// Decrease counter</span></div>
<div class="line"><a name="l02552"></a><span class="lineno"> 2552</span>&#160;    <span class="keywordtype">size_t</span> <a class="code" href="../../dc/d3d/proto_8c.html#ae40354a1051342eb5a9db005715dcfa9">idx</a> = span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#ae77d9a2cdd2a2fd46e3b27739d6c88cc">span_count</a> - 1;</div>
<div class="line"><a name="l02553"></a><span class="lineno"> 2553</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#a4f0dc3c548801773a4da1c96f39b04c9">atomic_decr32</a>(&amp;span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a345270ce5d1e5e112b45cfde43f37da0">heap</a>-&gt;span_use[<a class="code" href="../../dc/d3d/proto_8c.html#ae40354a1051342eb5a9db005715dcfa9">idx</a>].current);</div>
<div class="line"><a name="l02554"></a><span class="lineno"> 2554</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02555"></a><span class="lineno"> 2555</span>&#160;    <a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#d9/d8a/structheap__t">heap_t</a> *heap = span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a345270ce5d1e5e112b45cfde43f37da0">heap</a>;</div>
<div class="line"><a name="l02556"></a><span class="lineno"> 2556</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#ad008ddf766a4f56fbde2edf2c51d9a87">rpmalloc_assert</a>(heap, <span class="stringliteral">&quot;No thread heap&quot;</span>);</div>
<div class="line"><a name="l02557"></a><span class="lineno"> 2557</span>&#160;<span class="preprocessor">#if ENABLE_THREAD_CACHE</span></div>
<div class="line"><a name="l02558"></a><span class="lineno"> 2558</span>&#160;    <span class="keyword">const</span> <span class="keywordtype">int</span> set_as_reserved = ((span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#ae77d9a2cdd2a2fd46e3b27739d6c88cc">span_count</a> &gt; 1) &amp;&amp; (heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#ae112aace519bbe14edb9127cefb59705">span_cache</a>.<a class="code" href="../../df/dc0/rpmalloc_8c.html#a894a66f329862f01de7619aee1954d19">count</a> == 0) &amp;&amp; !heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a13ccab5430ace95c471aacf1fab0fcd6">finalize</a> &amp;&amp; !heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a8d5b27011e1ab5140090f90a75584329">spans_reserved</a>);</div>
<div class="line"><a name="l02559"></a><span class="lineno"> 2559</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l02560"></a><span class="lineno"> 2560</span>&#160;    <span class="keyword">const</span> <span class="keywordtype">int</span> set_as_reserved = ((span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#ae77d9a2cdd2a2fd46e3b27739d6c88cc">span_count</a> &gt; 1) &amp;&amp; !heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a13ccab5430ace95c471aacf1fab0fcd6">finalize</a> &amp;&amp; !heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a8d5b27011e1ab5140090f90a75584329">spans_reserved</a>);</div>
<div class="line"><a name="l02561"></a><span class="lineno"> 2561</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02562"></a><span class="lineno"> 2562</span>&#160;    <span class="keywordflow">if</span> (set_as_reserved)</div>
<div class="line"><a name="l02563"></a><span class="lineno"> 2563</span>&#160;    {</div>
<div class="line"><a name="l02564"></a><span class="lineno"> 2564</span>&#160;        heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#aa549da79e540bdd3e963e294a39f64cf">span_reserve</a> = span;</div>
<div class="line"><a name="l02565"></a><span class="lineno"> 2565</span>&#160;        heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a8d5b27011e1ab5140090f90a75584329">spans_reserved</a> = span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#ae77d9a2cdd2a2fd46e3b27739d6c88cc">span_count</a>;</div>
<div class="line"><a name="l02566"></a><span class="lineno"> 2566</span>&#160;        <span class="keywordflow">if</span> (span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a4de89d484559557bb639a2703c750b17">flags</a> &amp; <a class="code" href="../../df/dc0/rpmalloc_8c.html#a98c82279e204e31a5dc89b64d2c6c27c">SPAN_FLAG_MASTER</a>)</div>
<div class="line"><a name="l02567"></a><span class="lineno"> 2567</span>&#160;        {</div>
<div class="line"><a name="l02568"></a><span class="lineno"> 2568</span>&#160;            heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#aa6719c6b21d6c30ce96e404a63cc4bae">span_reserve_master</a> = span;</div>
<div class="line"><a name="l02569"></a><span class="lineno"> 2569</span>&#160;        }</div>
<div class="line"><a name="l02570"></a><span class="lineno"> 2570</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l02571"></a><span class="lineno"> 2571</span>&#160;        { <span class="comment">// SPAN_FLAG_SUBSPAN</span></div>
<div class="line"><a name="l02572"></a><span class="lineno"> 2572</span>&#160;            <a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *master = (<a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *)<a class="code" href="../../df/dc0/rpmalloc_8c.html#ab4225911698b67188e1538c334cfe16c">pointer_offset</a>(span, -(<a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#a0bd5dec00e345e69027427f8621d6a6c">intptr_t</a>)((<a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#aa9d55e2f20e580b7445617d0d12fff6e">size_t</a>)span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a07d2ba73260e7e5dbe98c76436888c5f">offset_from_master</a> * <a class="code" href="../../df/dc0/rpmalloc_8c.html#a9fefa5277fefa0c58f69d5b86d679ccb">_memory_span_size</a>));</div>
<div class="line"><a name="l02573"></a><span class="lineno"> 2573</span>&#160;            heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#aa6719c6b21d6c30ce96e404a63cc4bae">span_reserve_master</a> = master;</div>
<div class="line"><a name="l02574"></a><span class="lineno"> 2574</span>&#160;            <a class="code" href="../../df/dc0/rpmalloc_8c.html#ad008ddf766a4f56fbde2edf2c51d9a87">rpmalloc_assert</a>(master-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a4de89d484559557bb639a2703c750b17">flags</a> &amp; <a class="code" href="../../df/dc0/rpmalloc_8c.html#a98c82279e204e31a5dc89b64d2c6c27c">SPAN_FLAG_MASTER</a>, <span class="stringliteral">&quot;Span flag corrupted&quot;</span>);</div>
<div class="line"><a name="l02575"></a><span class="lineno"> 2575</span>&#160;            <a class="code" href="../../df/dc0/rpmalloc_8c.html#ad008ddf766a4f56fbde2edf2c51d9a87">rpmalloc_assert</a>(atomic_load32(&amp;master-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a4aecbd1cbb36425fddd53125ea1a84c7">remaining_spans</a>) &gt;= (<a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#a0c18914b3041c2f583aba76f418399c2">int32_t</a>)span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#ae77d9a2cdd2a2fd46e3b27739d6c88cc">span_count</a>, <span class="stringliteral">&quot;Master span count corrupted&quot;</span>);</div>
<div class="line"><a name="l02576"></a><span class="lineno"> 2576</span>&#160;        }</div>
<div class="line"><a name="l02577"></a><span class="lineno"> 2577</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#ab51bbcd0d9d41ba9c6f4ad547ba77405">_rpmalloc_stat_inc</a>(&amp;heap-&gt;span_use[<a class="code" href="../../dc/d3d/proto_8c.html#ae40354a1051342eb5a9db005715dcfa9">idx</a>].spans_to_reserved);</div>
<div class="line"><a name="l02578"></a><span class="lineno"> 2578</span>&#160;    }</div>
<div class="line"><a name="l02579"></a><span class="lineno"> 2579</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l02580"></a><span class="lineno"> 2580</span>&#160;    {</div>
<div class="line"><a name="l02581"></a><span class="lineno"> 2581</span>&#160;        <span class="comment">// Insert into cache list</span></div>
<div class="line"><a name="l02582"></a><span class="lineno"> 2582</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#abdbbc20ab63d76c1709722f3f2305610">_rpmalloc_heap_cache_insert</a>(heap, span);</div>
<div class="line"><a name="l02583"></a><span class="lineno"> 2583</span>&#160;    }</div>
<div class="line"><a name="l02584"></a><span class="lineno"> 2584</span>&#160;}</div>
<div class="line"><a name="l02585"></a><span class="lineno"> 2585</span>&#160; </div>
<div class="line"><a name="l02587"></a><span class="lineno"> 2587</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="l02588"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a428539d1600391a04bfc27f74980df5e"> 2588</a></span>&#160;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a428539d1600391a04bfc27f74980df5e">_rpmalloc_deallocate_huge</a>(<a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *span)</div>
<div class="line"><a name="l02589"></a><span class="lineno"> 2589</span>&#160;{</div>
<div class="line"><a name="l02590"></a><span class="lineno"> 2590</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#ad008ddf766a4f56fbde2edf2c51d9a87">rpmalloc_assert</a>(span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a345270ce5d1e5e112b45cfde43f37da0">heap</a>, <span class="stringliteral">&quot;No span heap&quot;</span>);</div>
<div class="line"><a name="l02591"></a><span class="lineno"> 2591</span>&#160;<span class="preprocessor">#if RPMALLOC_FIRST_CLASS_HEAPS</span></div>
<div class="line"><a name="l02592"></a><span class="lineno"> 2592</span>&#160;    <span class="keywordtype">int</span> defer = (span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a345270ce5d1e5e112b45cfde43f37da0">heap</a>-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a436e67271364d132c12f2f5f0d4c79ef">owner_thread</a> &amp;&amp; (span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a345270ce5d1e5e112b45cfde43f37da0">heap</a>-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a436e67271364d132c12f2f5f0d4c79ef">owner_thread</a> != <a class="code" href="../../df/dc0/rpmalloc_8c.html#a84e326ca88dee0bd7ca995727bb52381">get_thread_id</a>()) &amp;&amp; !span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a345270ce5d1e5e112b45cfde43f37da0">heap</a>-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a13ccab5430ace95c471aacf1fab0fcd6">finalize</a>);</div>
<div class="line"><a name="l02593"></a><span class="lineno"> 2593</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l02594"></a><span class="lineno"> 2594</span>&#160;    <span class="keywordtype">int</span> defer = ((span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a345270ce5d1e5e112b45cfde43f37da0">heap</a>-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a436e67271364d132c12f2f5f0d4c79ef">owner_thread</a> != <a class="code" href="../../df/dc0/rpmalloc_8c.html#a84e326ca88dee0bd7ca995727bb52381">get_thread_id</a>()) &amp;&amp; !span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a345270ce5d1e5e112b45cfde43f37da0">heap</a>-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a13ccab5430ace95c471aacf1fab0fcd6">finalize</a>);</div>
<div class="line"><a name="l02595"></a><span class="lineno"> 2595</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02596"></a><span class="lineno"> 2596</span>&#160;    <span class="keywordflow">if</span> (defer)</div>
<div class="line"><a name="l02597"></a><span class="lineno"> 2597</span>&#160;    {</div>
<div class="line"><a name="l02598"></a><span class="lineno"> 2598</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#ac8a96725f034c08fdff774eb54785947">_rpmalloc_deallocate_defer_free_span</a>(span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a345270ce5d1e5e112b45cfde43f37da0">heap</a>, span);</div>
<div class="line"><a name="l02599"></a><span class="lineno"> 2599</span>&#160;        <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l02600"></a><span class="lineno"> 2600</span>&#160;    }</div>
<div class="line"><a name="l02601"></a><span class="lineno"> 2601</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#ad008ddf766a4f56fbde2edf2c51d9a87">rpmalloc_assert</a>(span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a345270ce5d1e5e112b45cfde43f37da0">heap</a>-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a6aa789c3cdf7e70df144c248d18c5f4c">full_span_count</a>, <span class="stringliteral">&quot;Heap span counter corrupted&quot;</span>);</div>
<div class="line"><a name="l02602"></a><span class="lineno"> 2602</span>&#160;    --span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a345270ce5d1e5e112b45cfde43f37da0">heap</a>-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a6aa789c3cdf7e70df144c248d18c5f4c">full_span_count</a>;</div>
<div class="line"><a name="l02603"></a><span class="lineno"> 2603</span>&#160;<span class="preprocessor">#if RPMALLOC_FIRST_CLASS_HEAPS</span></div>
<div class="line"><a name="l02604"></a><span class="lineno"> 2604</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#aec7913670102d551e3fd60509cd381a3">_rpmalloc_span_double_link_list_remove</a>(&amp;span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a345270ce5d1e5e112b45cfde43f37da0">heap</a>-&gt;large_huge_span, span);</div>
<div class="line"><a name="l02605"></a><span class="lineno"> 2605</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02606"></a><span class="lineno"> 2606</span>&#160; </div>
<div class="line"><a name="l02607"></a><span class="lineno"> 2607</span>&#160;    <span class="comment">// Oversized allocation, page count is stored in span_count</span></div>
<div class="line"><a name="l02608"></a><span class="lineno"> 2608</span>&#160;    <span class="keywordtype">size_t</span> num_pages = span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#ae77d9a2cdd2a2fd46e3b27739d6c88cc">span_count</a>;</div>
<div class="line"><a name="l02609"></a><span class="lineno"> 2609</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#abfbbb8e2f9b086d466fe2898a283c98d">_rpmalloc_unmap</a>(span, num_pages * <a class="code" href="../../df/dc0/rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a>, span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a13753de75bc52a5b8a1a9532083c9ba4">align_offset</a>, num_pages * <a class="code" href="../../df/dc0/rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a>);</div>
<div class="line"><a name="l02610"></a><span class="lineno"> 2610</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#a829d3a1ca51d0ba687990a8111940c42">_rpmalloc_stat_sub</a>(&amp;_huge_pages_current, num_pages);</div>
<div class="line"><a name="l02611"></a><span class="lineno"> 2611</span>&#160;}</div>
<div class="line"><a name="l02612"></a><span class="lineno"> 2612</span>&#160; </div>
<div class="line"><a name="l02614"></a><span class="lineno"> 2614</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="l02615"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#ae324fa158db468143544693dfe539800"> 2615</a></span>&#160;<a class="code" href="../../df/dc0/rpmalloc_8c.html#ae324fa158db468143544693dfe539800">_rpmalloc_deallocate</a>(<span class="keywordtype">void</span> *<a class="code" href="../../df/d55/userspace__test_8c.html#a83de08c56df151f990dc392523079284">p</a>)</div>
<div class="line"><a name="l02616"></a><span class="lineno"> 2616</span>&#160;{</div>
<div class="line"><a name="l02617"></a><span class="lineno"> 2617</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#a49e532a65b873a6c3315aa769299687c">_rpmalloc_stat_add64</a>(&amp;_deallocation_counter, 1);</div>
<div class="line"><a name="l02618"></a><span class="lineno"> 2618</span>&#160;    <span class="comment">// Grab the span (always at start of span, using span alignment)</span></div>
<div class="line"><a name="l02619"></a><span class="lineno"> 2619</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *span = (<a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *)((<a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#a4788399d1d0b37ccf098a7da82254808">uintptr_t</a>)<a class="code" href="../../df/d55/userspace__test_8c.html#a83de08c56df151f990dc392523079284">p</a> &amp; <a class="code" href="../../df/dc0/rpmalloc_8c.html#ae7b97ba12e15609b6d63926ed2e30238">_memory_span_mask</a>);</div>
<div class="line"><a name="l02620"></a><span class="lineno"> 2620</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="../../df/dc0/rpmalloc_8c.html#af8f864d9fe0055b43dc8034fe9060630">UNEXPECTED</a>(!span))</div>
<div class="line"><a name="l02621"></a><span class="lineno"> 2621</span>&#160;        <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l02622"></a><span class="lineno"> 2622</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="../../df/dc0/rpmalloc_8c.html#a90593dceacf0c04f14d084bed7e7eabe">EXPECTED</a>(span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a5a977febdd2e9ae15bcf66f83d0cf817">size_class</a> &lt; <a class="code" href="../../df/dc0/rpmalloc_8c.html#aa74d427b2b9955ff2d9719693d9fc80e">SIZE_CLASS_COUNT</a>))</div>
<div class="line"><a name="l02623"></a><span class="lineno"> 2623</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#a7fdcd37f930a06ca527ab10334bf1d1e">_rpmalloc_deallocate_small_or_medium</a>(span, <a class="code" href="../../df/d55/userspace__test_8c.html#a83de08c56df151f990dc392523079284">p</a>);</div>
<div class="line"><a name="l02624"></a><span class="lineno"> 2624</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a5a977febdd2e9ae15bcf66f83d0cf817">size_class</a> == <a class="code" href="../../df/dc0/rpmalloc_8c.html#a3f84dd23eb0ef3cf54aeb6afff0618ae">SIZE_CLASS_LARGE</a>)</div>
<div class="line"><a name="l02625"></a><span class="lineno"> 2625</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#a573fc7baab7be24c6bac115b7f62192f">_rpmalloc_deallocate_large</a>(span);</div>
<div class="line"><a name="l02626"></a><span class="lineno"> 2626</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l02627"></a><span class="lineno"> 2627</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#a428539d1600391a04bfc27f74980df5e">_rpmalloc_deallocate_huge</a>(span);</div>
<div class="line"><a name="l02628"></a><span class="lineno"> 2628</span>&#160;}</div>
<div class="line"><a name="l02629"></a><span class="lineno"> 2629</span>&#160; </div>
<div class="line"><a name="l02635"></a><span class="lineno"> 2635</span>&#160; </div>
<div class="line"><a name="l02636"></a><span class="lineno"> 2636</span>&#160;<span class="keyword">static</span> <span class="keywordtype">size_t</span></div>
<div class="line"><a name="l02637"></a><span class="lineno"> 2637</span>&#160;<a class="code" href="../../df/dc0/rpmalloc_8c.html#adc5743a6b15192da5b7e023f85360208">_rpmalloc_usable_size</a>(<span class="keywordtype">void</span> *<a class="code" href="../../df/d55/userspace__test_8c.html#a83de08c56df151f990dc392523079284">p</a>);</div>
<div class="line"><a name="l02638"></a><span class="lineno"> 2638</span>&#160; </div>
<div class="line"><a name="l02640"></a><span class="lineno"> 2640</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> *</div>
<div class="line"><a name="l02641"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a5c46183a2d82b761e9438c65b0dbad62"> 2641</a></span>&#160;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a5c46183a2d82b761e9438c65b0dbad62">_rpmalloc_reallocate</a>(<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#d9/d8a/structheap__t">heap_t</a> *heap, <span class="keywordtype">void</span> *<a class="code" href="../../df/d55/userspace__test_8c.html#a83de08c56df151f990dc392523079284">p</a>, <span class="keywordtype">size_t</span> <a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a>, <span class="keywordtype">size_t</span> oldsize, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> flags)</div>
<div class="line"><a name="l02642"></a><span class="lineno"> 2642</span>&#160;{</div>
<div class="line"><a name="l02643"></a><span class="lineno"> 2643</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="../../df/d55/userspace__test_8c.html#a83de08c56df151f990dc392523079284">p</a>)</div>
<div class="line"><a name="l02644"></a><span class="lineno"> 2644</span>&#160;    {</div>
<div class="line"><a name="l02645"></a><span class="lineno"> 2645</span>&#160;        <span class="comment">// Grab the span using guaranteed span alignment</span></div>
<div class="line"><a name="l02646"></a><span class="lineno"> 2646</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *span = (<a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *)((<a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#a4788399d1d0b37ccf098a7da82254808">uintptr_t</a>)<a class="code" href="../../df/d55/userspace__test_8c.html#a83de08c56df151f990dc392523079284">p</a> &amp; <a class="code" href="../../df/dc0/rpmalloc_8c.html#ae7b97ba12e15609b6d63926ed2e30238">_memory_span_mask</a>);</div>
<div class="line"><a name="l02647"></a><span class="lineno"> 2647</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="../../df/dc0/rpmalloc_8c.html#a90593dceacf0c04f14d084bed7e7eabe">EXPECTED</a>(span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a5a977febdd2e9ae15bcf66f83d0cf817">size_class</a> &lt; <a class="code" href="../../df/dc0/rpmalloc_8c.html#aa74d427b2b9955ff2d9719693d9fc80e">SIZE_CLASS_COUNT</a>))</div>
<div class="line"><a name="l02648"></a><span class="lineno"> 2648</span>&#160;        {</div>
<div class="line"><a name="l02649"></a><span class="lineno"> 2649</span>&#160;            <span class="comment">// Small/medium sized block</span></div>
<div class="line"><a name="l02650"></a><span class="lineno"> 2650</span>&#160;            <a class="code" href="../../df/dc0/rpmalloc_8c.html#ad008ddf766a4f56fbde2edf2c51d9a87">rpmalloc_assert</a>(span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#ae77d9a2cdd2a2fd46e3b27739d6c88cc">span_count</a> == 1, <span class="stringliteral">&quot;Span counter corrupted&quot;</span>);</div>
<div class="line"><a name="l02651"></a><span class="lineno"> 2651</span>&#160;            <span class="keywordtype">void</span> *blocks_start = <a class="code" href="../../df/dc0/rpmalloc_8c.html#ab4225911698b67188e1538c334cfe16c">pointer_offset</a>(span, <a class="code" href="../../df/dc0/rpmalloc_8c.html#a645356809d937167848705edabde7d44">SPAN_HEADER_SIZE</a>);</div>
<div class="line"><a name="l02652"></a><span class="lineno"> 2652</span>&#160;            <a class="code" href="../../dd/ddd/arithmetic__operations_8c.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a> block_offset = (<a class="code" href="../../dd/ddd/arithmetic__operations_8c.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a>)<a class="code" href="../../df/dc0/rpmalloc_8c.html#af51a6ed47e80b1b57187f1d5be6c8b4c">pointer_diff</a>(<a class="code" href="../../df/d55/userspace__test_8c.html#a83de08c56df151f990dc392523079284">p</a>, blocks_start);</div>
<div class="line"><a name="l02653"></a><span class="lineno"> 2653</span>&#160;            <a class="code" href="../../dd/ddd/arithmetic__operations_8c.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a> block_idx = block_offset / span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a97df83853dc6ddf7e0114691b15edb49">block_size</a>;</div>
<div class="line"><a name="l02654"></a><span class="lineno"> 2654</span>&#160;            <span class="keywordtype">void</span> *block = <a class="code" href="../../df/dc0/rpmalloc_8c.html#ab4225911698b67188e1538c334cfe16c">pointer_offset</a>(blocks_start, (<span class="keywordtype">size_t</span>)block_idx * span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a97df83853dc6ddf7e0114691b15edb49">block_size</a>);</div>
<div class="line"><a name="l02655"></a><span class="lineno"> 2655</span>&#160;            <span class="keywordflow">if</span> (!oldsize)</div>
<div class="line"><a name="l02656"></a><span class="lineno"> 2656</span>&#160;                oldsize = (<a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#aa9d55e2f20e580b7445617d0d12fff6e">size_t</a>)((<a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#a6d26a0475a6d6c897e655cdc5d8019d2">ptrdiff_t</a>)span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a97df83853dc6ddf7e0114691b15edb49">block_size</a> - <a class="code" href="../../df/dc0/rpmalloc_8c.html#af51a6ed47e80b1b57187f1d5be6c8b4c">pointer_diff</a>(<a class="code" href="../../df/d55/userspace__test_8c.html#a83de08c56df151f990dc392523079284">p</a>, block));</div>
<div class="line"><a name="l02657"></a><span class="lineno"> 2657</span>&#160;            <span class="keywordflow">if</span> ((<span class="keywordtype">size_t</span>)span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a97df83853dc6ddf7e0114691b15edb49">block_size</a> &gt;= <a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a>)</div>
<div class="line"><a name="l02658"></a><span class="lineno"> 2658</span>&#160;            {</div>
<div class="line"><a name="l02659"></a><span class="lineno"> 2659</span>&#160;                <span class="comment">// Still fits in block, never mind trying to save memory, but preserve data if alignment changed</span></div>
<div class="line"><a name="l02660"></a><span class="lineno"> 2660</span>&#160;                <span class="keywordflow">if</span> ((<a class="code" href="../../df/d55/userspace__test_8c.html#a83de08c56df151f990dc392523079284">p</a> != block) &amp;&amp; !(flags &amp; <a class="code" href="../../d2/d43/rpmalloc_8h.html#affda05352198b9ef86d42be851a1349f">RPMALLOC_NO_PRESERVE</a>))</div>
<div class="line"><a name="l02661"></a><span class="lineno"> 2661</span>&#160;                    <a class="code" href="../../d3/d82/convert_8h.html#a7c4011320424e41e3875a3c9312242b0">memmove_unsafe</a>(block, <a class="code" href="../../df/d55/userspace__test_8c.html#a83de08c56df151f990dc392523079284">p</a>, oldsize);</div>
<div class="line"><a name="l02662"></a><span class="lineno"> 2662</span>&#160;                <span class="keywordflow">return</span> block;</div>
<div class="line"><a name="l02663"></a><span class="lineno"> 2663</span>&#160;            }</div>
<div class="line"><a name="l02664"></a><span class="lineno"> 2664</span>&#160;        }</div>
<div class="line"><a name="l02665"></a><span class="lineno"> 2665</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a5a977febdd2e9ae15bcf66f83d0cf817">size_class</a> == <a class="code" href="../../df/dc0/rpmalloc_8c.html#a3f84dd23eb0ef3cf54aeb6afff0618ae">SIZE_CLASS_LARGE</a>)</div>
<div class="line"><a name="l02666"></a><span class="lineno"> 2666</span>&#160;        {</div>
<div class="line"><a name="l02667"></a><span class="lineno"> 2667</span>&#160;            <span class="comment">// Large block</span></div>
<div class="line"><a name="l02668"></a><span class="lineno"> 2668</span>&#160;            <span class="keywordtype">size_t</span> total_size = <a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a> + <a class="code" href="../../df/dc0/rpmalloc_8c.html#a645356809d937167848705edabde7d44">SPAN_HEADER_SIZE</a>;</div>
<div class="line"><a name="l02669"></a><span class="lineno"> 2669</span>&#160;            <span class="keywordtype">size_t</span> num_spans = total_size &gt;&gt; <a class="code" href="../../df/dc0/rpmalloc_8c.html#adb538a1ad8a86db6b92895d9ebf6d907">_memory_span_size_shift</a>;</div>
<div class="line"><a name="l02670"></a><span class="lineno"> 2670</span>&#160;            <span class="keywordflow">if</span> (total_size &amp; (<a class="code" href="../../df/dc0/rpmalloc_8c.html#ae7b97ba12e15609b6d63926ed2e30238">_memory_span_mask</a> - 1))</div>
<div class="line"><a name="l02671"></a><span class="lineno"> 2671</span>&#160;                ++num_spans;</div>
<div class="line"><a name="l02672"></a><span class="lineno"> 2672</span>&#160;            <span class="keywordtype">size_t</span> current_spans = span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#ae77d9a2cdd2a2fd46e3b27739d6c88cc">span_count</a>;</div>
<div class="line"><a name="l02673"></a><span class="lineno"> 2673</span>&#160;            <span class="keywordtype">void</span> *block = <a class="code" href="../../df/dc0/rpmalloc_8c.html#ab4225911698b67188e1538c334cfe16c">pointer_offset</a>(span, <a class="code" href="../../df/dc0/rpmalloc_8c.html#a645356809d937167848705edabde7d44">SPAN_HEADER_SIZE</a>);</div>
<div class="line"><a name="l02674"></a><span class="lineno"> 2674</span>&#160;            <span class="keywordflow">if</span> (!oldsize)</div>
<div class="line"><a name="l02675"></a><span class="lineno"> 2675</span>&#160;                oldsize = (current_spans * <a class="code" href="../../df/dc0/rpmalloc_8c.html#a9fefa5277fefa0c58f69d5b86d679ccb">_memory_span_size</a>) - (<span class="keywordtype">size_t</span>)<a class="code" href="../../df/dc0/rpmalloc_8c.html#af51a6ed47e80b1b57187f1d5be6c8b4c">pointer_diff</a>(<a class="code" href="../../df/d55/userspace__test_8c.html#a83de08c56df151f990dc392523079284">p</a>, block) - <a class="code" href="../../df/dc0/rpmalloc_8c.html#a645356809d937167848705edabde7d44">SPAN_HEADER_SIZE</a>;</div>
<div class="line"><a name="l02676"></a><span class="lineno"> 2676</span>&#160;            <span class="keywordflow">if</span> ((current_spans &gt;= num_spans) &amp;&amp; (total_size &gt;= (oldsize / 2)))</div>
<div class="line"><a name="l02677"></a><span class="lineno"> 2677</span>&#160;            {</div>
<div class="line"><a name="l02678"></a><span class="lineno"> 2678</span>&#160;                <span class="comment">// Still fits in block, never mind trying to save memory, but preserve data if alignment changed</span></div>
<div class="line"><a name="l02679"></a><span class="lineno"> 2679</span>&#160;                <span class="keywordflow">if</span> ((<a class="code" href="../../df/d55/userspace__test_8c.html#a83de08c56df151f990dc392523079284">p</a> != block) &amp;&amp; !(flags &amp; <a class="code" href="../../d2/d43/rpmalloc_8h.html#affda05352198b9ef86d42be851a1349f">RPMALLOC_NO_PRESERVE</a>))</div>
<div class="line"><a name="l02680"></a><span class="lineno"> 2680</span>&#160;                    <a class="code" href="../../d3/d82/convert_8h.html#a7c4011320424e41e3875a3c9312242b0">memmove_unsafe</a>(block, <a class="code" href="../../df/d55/userspace__test_8c.html#a83de08c56df151f990dc392523079284">p</a>, oldsize);</div>
<div class="line"><a name="l02681"></a><span class="lineno"> 2681</span>&#160;                <span class="keywordflow">return</span> block;</div>
<div class="line"><a name="l02682"></a><span class="lineno"> 2682</span>&#160;            }</div>
<div class="line"><a name="l02683"></a><span class="lineno"> 2683</span>&#160;        }</div>
<div class="line"><a name="l02684"></a><span class="lineno"> 2684</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l02685"></a><span class="lineno"> 2685</span>&#160;        {</div>
<div class="line"><a name="l02686"></a><span class="lineno"> 2686</span>&#160;            <span class="comment">// Oversized block</span></div>
<div class="line"><a name="l02687"></a><span class="lineno"> 2687</span>&#160;            <span class="keywordtype">size_t</span> total_size = <a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a> + <a class="code" href="../../df/dc0/rpmalloc_8c.html#a645356809d937167848705edabde7d44">SPAN_HEADER_SIZE</a>;</div>
<div class="line"><a name="l02688"></a><span class="lineno"> 2688</span>&#160;            <span class="keywordtype">size_t</span> num_pages = total_size &gt;&gt; <a class="code" href="../../df/dc0/rpmalloc_8c.html#a9d7ec974d864302bb4f8516859c4b212">_memory_page_size_shift</a>;</div>
<div class="line"><a name="l02689"></a><span class="lineno"> 2689</span>&#160;            <span class="keywordflow">if</span> (total_size &amp; (<a class="code" href="../../df/dc0/rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a> - 1))</div>
<div class="line"><a name="l02690"></a><span class="lineno"> 2690</span>&#160;                ++num_pages;</div>
<div class="line"><a name="l02691"></a><span class="lineno"> 2691</span>&#160;            <span class="comment">// Page count is stored in span_count</span></div>
<div class="line"><a name="l02692"></a><span class="lineno"> 2692</span>&#160;            <span class="keywordtype">size_t</span> current_pages = span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#ae77d9a2cdd2a2fd46e3b27739d6c88cc">span_count</a>;</div>
<div class="line"><a name="l02693"></a><span class="lineno"> 2693</span>&#160;            <span class="keywordtype">void</span> *block = <a class="code" href="../../df/dc0/rpmalloc_8c.html#ab4225911698b67188e1538c334cfe16c">pointer_offset</a>(span, <a class="code" href="../../df/dc0/rpmalloc_8c.html#a645356809d937167848705edabde7d44">SPAN_HEADER_SIZE</a>);</div>
<div class="line"><a name="l02694"></a><span class="lineno"> 2694</span>&#160;            <span class="keywordflow">if</span> (!oldsize)</div>
<div class="line"><a name="l02695"></a><span class="lineno"> 2695</span>&#160;                oldsize = (current_pages * <a class="code" href="../../df/dc0/rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a>) - (<span class="keywordtype">size_t</span>)<a class="code" href="../../df/dc0/rpmalloc_8c.html#af51a6ed47e80b1b57187f1d5be6c8b4c">pointer_diff</a>(<a class="code" href="../../df/d55/userspace__test_8c.html#a83de08c56df151f990dc392523079284">p</a>, block) - <a class="code" href="../../df/dc0/rpmalloc_8c.html#a645356809d937167848705edabde7d44">SPAN_HEADER_SIZE</a>;</div>
<div class="line"><a name="l02696"></a><span class="lineno"> 2696</span>&#160;            <span class="keywordflow">if</span> ((current_pages &gt;= num_pages) &amp;&amp; (num_pages &gt;= (current_pages / 2)))</div>
<div class="line"><a name="l02697"></a><span class="lineno"> 2697</span>&#160;            {</div>
<div class="line"><a name="l02698"></a><span class="lineno"> 2698</span>&#160;                <span class="comment">// Still fits in block, never mind trying to save memory, but preserve data if alignment changed</span></div>
<div class="line"><a name="l02699"></a><span class="lineno"> 2699</span>&#160;                <span class="keywordflow">if</span> ((<a class="code" href="../../df/d55/userspace__test_8c.html#a83de08c56df151f990dc392523079284">p</a> != block) &amp;&amp; !(flags &amp; <a class="code" href="../../d2/d43/rpmalloc_8h.html#affda05352198b9ef86d42be851a1349f">RPMALLOC_NO_PRESERVE</a>))</div>
<div class="line"><a name="l02700"></a><span class="lineno"> 2700</span>&#160;                    <a class="code" href="../../d3/d82/convert_8h.html#a7c4011320424e41e3875a3c9312242b0">memmove_unsafe</a>(block, <a class="code" href="../../df/d55/userspace__test_8c.html#a83de08c56df151f990dc392523079284">p</a>, oldsize);</div>
<div class="line"><a name="l02701"></a><span class="lineno"> 2701</span>&#160;                <span class="keywordflow">return</span> block;</div>
<div class="line"><a name="l02702"></a><span class="lineno"> 2702</span>&#160;            }</div>
<div class="line"><a name="l02703"></a><span class="lineno"> 2703</span>&#160;        }</div>
<div class="line"><a name="l02704"></a><span class="lineno"> 2704</span>&#160;    }</div>
<div class="line"><a name="l02705"></a><span class="lineno"> 2705</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l02706"></a><span class="lineno"> 2706</span>&#160;    {</div>
<div class="line"><a name="l02707"></a><span class="lineno"> 2707</span>&#160;        oldsize = 0;</div>
<div class="line"><a name="l02708"></a><span class="lineno"> 2708</span>&#160;    }</div>
<div class="line"><a name="l02709"></a><span class="lineno"> 2709</span>&#160; </div>
<div class="line"><a name="l02710"></a><span class="lineno"> 2710</span>&#160;    <span class="keywordflow">if</span> (!!(flags &amp; <a class="code" href="../../d2/d43/rpmalloc_8h.html#ab3774a093749aeca1d4e387b11e79395">RPMALLOC_GROW_OR_FAIL</a>))</div>
<div class="line"><a name="l02711"></a><span class="lineno"> 2711</span>&#160;        <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l02712"></a><span class="lineno"> 2712</span>&#160; </div>
<div class="line"><a name="l02713"></a><span class="lineno"> 2713</span>&#160;    <span class="comment">// Size is greater than block size, need to allocate a new block and deallocate the old</span></div>
<div class="line"><a name="l02714"></a><span class="lineno"> 2714</span>&#160;    <span class="comment">// Avoid hysteresis by overallocating if increase is small (below 37%)</span></div>
<div class="line"><a name="l02715"></a><span class="lineno"> 2715</span>&#160;    <span class="keywordtype">size_t</span> lower_bound = oldsize + (oldsize &gt;&gt; 2) + (oldsize &gt;&gt; 3);</div>
<div class="line"><a name="l02716"></a><span class="lineno"> 2716</span>&#160;    <span class="keywordtype">size_t</span> new_size = (<a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a> &gt; lower_bound) ? <a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a> : ((<a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a> &gt; oldsize) ? lower_bound : <a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a>);</div>
<div class="line"><a name="l02717"></a><span class="lineno"> 2717</span>&#160;    <span class="keywordtype">void</span> *block = <a class="code" href="../../df/dc0/rpmalloc_8c.html#af8bd0cd08a93d20cb117e18d85f877cd">_rpmalloc_allocate</a>(heap, new_size);</div>
<div class="line"><a name="l02718"></a><span class="lineno"> 2718</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="../../df/d55/userspace__test_8c.html#a83de08c56df151f990dc392523079284">p</a> &amp;&amp; block)</div>
<div class="line"><a name="l02719"></a><span class="lineno"> 2719</span>&#160;    {</div>
<div class="line"><a name="l02720"></a><span class="lineno"> 2720</span>&#160;        <span class="keywordflow">if</span> (!(flags &amp; <a class="code" href="../../d2/d43/rpmalloc_8h.html#affda05352198b9ef86d42be851a1349f">RPMALLOC_NO_PRESERVE</a>))</div>
<div class="line"><a name="l02721"></a><span class="lineno"> 2721</span>&#160;            <a class="code" href="../../d3/d82/convert_8h.html#a7a71051d6440816fca3ad080ae2539f4">memcpy_unsafe</a>(block, <a class="code" href="../../df/d55/userspace__test_8c.html#a83de08c56df151f990dc392523079284">p</a>, oldsize &lt; new_size ? oldsize : new_size);</div>
<div class="line"><a name="l02722"></a><span class="lineno"> 2722</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#ae324fa158db468143544693dfe539800">_rpmalloc_deallocate</a>(<a class="code" href="../../df/d55/userspace__test_8c.html#a83de08c56df151f990dc392523079284">p</a>);</div>
<div class="line"><a name="l02723"></a><span class="lineno"> 2723</span>&#160;    }</div>
<div class="line"><a name="l02724"></a><span class="lineno"> 2724</span>&#160; </div>
<div class="line"><a name="l02725"></a><span class="lineno"> 2725</span>&#160;    <span class="keywordflow">return</span> block;</div>
<div class="line"><a name="l02726"></a><span class="lineno"> 2726</span>&#160;}</div>
<div class="line"><a name="l02727"></a><span class="lineno"> 2727</span>&#160; </div>
<div class="line"><a name="l02728"></a><span class="lineno"> 2728</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> *</div>
<div class="line"><a name="l02729"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a0d0546abbe1244019d00ecf28aac359c"> 2729</a></span>&#160;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a0d0546abbe1244019d00ecf28aac359c">_rpmalloc_aligned_reallocate</a>(<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#d9/d8a/structheap__t">heap_t</a> *heap, <span class="keywordtype">void</span> *ptr, <span class="keywordtype">size_t</span> alignment, <span class="keywordtype">size_t</span> <a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a>, <span class="keywordtype">size_t</span> oldsize,</div>
<div class="line"><a name="l02730"></a><span class="lineno"> 2730</span>&#160;                             <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> flags)</div>
<div class="line"><a name="l02731"></a><span class="lineno"> 2731</span>&#160;{</div>
<div class="line"><a name="l02732"></a><span class="lineno"> 2732</span>&#160;    <span class="keywordflow">if</span> (alignment &lt;= <a class="code" href="../../df/dc0/rpmalloc_8c.html#a000afcda168a6fd19a9435e049508463">SMALL_GRANULARITY</a>)</div>
<div class="line"><a name="l02733"></a><span class="lineno"> 2733</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#a5c46183a2d82b761e9438c65b0dbad62">_rpmalloc_reallocate</a>(heap, ptr, <a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a>, oldsize, flags);</div>
<div class="line"><a name="l02734"></a><span class="lineno"> 2734</span>&#160; </div>
<div class="line"><a name="l02735"></a><span class="lineno"> 2735</span>&#160;    <span class="keywordtype">int</span> no_alloc = !!(flags &amp; <a class="code" href="../../d2/d43/rpmalloc_8h.html#ab3774a093749aeca1d4e387b11e79395">RPMALLOC_GROW_OR_FAIL</a>);</div>
<div class="line"><a name="l02736"></a><span class="lineno"> 2736</span>&#160;    <span class="keywordtype">size_t</span> usablesize = (ptr ? <a class="code" href="../../df/dc0/rpmalloc_8c.html#adc5743a6b15192da5b7e023f85360208">_rpmalloc_usable_size</a>(ptr) : 0);</div>
<div class="line"><a name="l02737"></a><span class="lineno"> 2737</span>&#160;    <span class="keywordflow">if</span> ((usablesize &gt;= <a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a>) &amp;&amp; !((<a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#a4788399d1d0b37ccf098a7da82254808">uintptr_t</a>)ptr &amp; (alignment - 1)))</div>
<div class="line"><a name="l02738"></a><span class="lineno"> 2738</span>&#160;    {</div>
<div class="line"><a name="l02739"></a><span class="lineno"> 2739</span>&#160;        <span class="keywordflow">if</span> (no_alloc || (<a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a> &gt;= (usablesize / 2)))</div>
<div class="line"><a name="l02740"></a><span class="lineno"> 2740</span>&#160;            <span class="keywordflow">return</span> ptr;</div>
<div class="line"><a name="l02741"></a><span class="lineno"> 2741</span>&#160;    }</div>
<div class="line"><a name="l02742"></a><span class="lineno"> 2742</span>&#160;    <span class="comment">// Aligned alloc marks span as having aligned blocks</span></div>
<div class="line"><a name="l02743"></a><span class="lineno"> 2743</span>&#160;    <span class="keywordtype">void</span> *block = (!no_alloc ? <a class="code" href="../../df/dc0/rpmalloc_8c.html#a4be7846b7aabc5b469a4cc66dbc6fb36">_rpmalloc_aligned_allocate</a>(heap, alignment, <a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a>) : 0);</div>
<div class="line"><a name="l02744"></a><span class="lineno"> 2744</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="../../df/dc0/rpmalloc_8c.html#a90593dceacf0c04f14d084bed7e7eabe">EXPECTED</a>(block != 0))</div>
<div class="line"><a name="l02745"></a><span class="lineno"> 2745</span>&#160;    {</div>
<div class="line"><a name="l02746"></a><span class="lineno"> 2746</span>&#160;        <span class="keywordflow">if</span> (!(flags &amp; <a class="code" href="../../d2/d43/rpmalloc_8h.html#affda05352198b9ef86d42be851a1349f">RPMALLOC_NO_PRESERVE</a>) &amp;&amp; ptr)</div>
<div class="line"><a name="l02747"></a><span class="lineno"> 2747</span>&#160;        {</div>
<div class="line"><a name="l02748"></a><span class="lineno"> 2748</span>&#160;            <span class="keywordflow">if</span> (!oldsize)</div>
<div class="line"><a name="l02749"></a><span class="lineno"> 2749</span>&#160;                oldsize = usablesize;</div>
<div class="line"><a name="l02750"></a><span class="lineno"> 2750</span>&#160;            <a class="code" href="../../d3/d82/convert_8h.html#a7a71051d6440816fca3ad080ae2539f4">memcpy_unsafe</a>(block, ptr, oldsize &lt; <a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a> ? oldsize : <a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a>);</div>
<div class="line"><a name="l02751"></a><span class="lineno"> 2751</span>&#160;        }</div>
<div class="line"><a name="l02752"></a><span class="lineno"> 2752</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#ae324fa158db468143544693dfe539800">_rpmalloc_deallocate</a>(ptr);</div>
<div class="line"><a name="l02753"></a><span class="lineno"> 2753</span>&#160;    }</div>
<div class="line"><a name="l02754"></a><span class="lineno"> 2754</span>&#160;    <span class="keywordflow">return</span> block;</div>
<div class="line"><a name="l02755"></a><span class="lineno"> 2755</span>&#160;}</div>
<div class="line"><a name="l02756"></a><span class="lineno"> 2756</span>&#160; </div>
<div class="line"><a name="l02762"></a><span class="lineno"> 2762</span>&#160; </div>
<div class="line"><a name="l02764"></a><span class="lineno"> 2764</span>&#160;<span class="keyword">static</span> <span class="keywordtype">size_t</span></div>
<div class="line"><a name="l02765"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#adc5743a6b15192da5b7e023f85360208"> 2765</a></span>&#160;<a class="code" href="../../df/dc0/rpmalloc_8c.html#adc5743a6b15192da5b7e023f85360208">_rpmalloc_usable_size</a>(<span class="keywordtype">void</span> *<a class="code" href="../../df/d55/userspace__test_8c.html#a83de08c56df151f990dc392523079284">p</a>)</div>
<div class="line"><a name="l02766"></a><span class="lineno"> 2766</span>&#160;{</div>
<div class="line"><a name="l02767"></a><span class="lineno"> 2767</span>&#160;    <span class="comment">// Grab the span using guaranteed span alignment</span></div>
<div class="line"><a name="l02768"></a><span class="lineno"> 2768</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *span = (<a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *)((<a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#a4788399d1d0b37ccf098a7da82254808">uintptr_t</a>)<a class="code" href="../../df/d55/userspace__test_8c.html#a83de08c56df151f990dc392523079284">p</a> &amp; <a class="code" href="../../df/dc0/rpmalloc_8c.html#ae7b97ba12e15609b6d63926ed2e30238">_memory_span_mask</a>);</div>
<div class="line"><a name="l02769"></a><span class="lineno"> 2769</span>&#160;    <span class="keywordflow">if</span> (span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a5a977febdd2e9ae15bcf66f83d0cf817">size_class</a> &lt; <a class="code" href="../../df/dc0/rpmalloc_8c.html#aa74d427b2b9955ff2d9719693d9fc80e">SIZE_CLASS_COUNT</a>)</div>
<div class="line"><a name="l02770"></a><span class="lineno"> 2770</span>&#160;    {</div>
<div class="line"><a name="l02771"></a><span class="lineno"> 2771</span>&#160;        <span class="comment">// Small/medium block</span></div>
<div class="line"><a name="l02772"></a><span class="lineno"> 2772</span>&#160;        <span class="keywordtype">void</span> *blocks_start = <a class="code" href="../../df/dc0/rpmalloc_8c.html#ab4225911698b67188e1538c334cfe16c">pointer_offset</a>(span, <a class="code" href="../../df/dc0/rpmalloc_8c.html#a645356809d937167848705edabde7d44">SPAN_HEADER_SIZE</a>);</div>
<div class="line"><a name="l02773"></a><span class="lineno"> 2773</span>&#160;        <span class="keywordflow">return</span> span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a97df83853dc6ddf7e0114691b15edb49">block_size</a> - ((<a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#aa9d55e2f20e580b7445617d0d12fff6e">size_t</a>)<a class="code" href="../../df/dc0/rpmalloc_8c.html#af51a6ed47e80b1b57187f1d5be6c8b4c">pointer_diff</a>(<a class="code" href="../../df/d55/userspace__test_8c.html#a83de08c56df151f990dc392523079284">p</a>, blocks_start) % span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a97df83853dc6ddf7e0114691b15edb49">block_size</a>);</div>
<div class="line"><a name="l02774"></a><span class="lineno"> 2774</span>&#160;    }</div>
<div class="line"><a name="l02775"></a><span class="lineno"> 2775</span>&#160;    <span class="keywordflow">if</span> (span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a5a977febdd2e9ae15bcf66f83d0cf817">size_class</a> == <a class="code" href="../../df/dc0/rpmalloc_8c.html#a3f84dd23eb0ef3cf54aeb6afff0618ae">SIZE_CLASS_LARGE</a>)</div>
<div class="line"><a name="l02776"></a><span class="lineno"> 2776</span>&#160;    {</div>
<div class="line"><a name="l02777"></a><span class="lineno"> 2777</span>&#160;        <span class="comment">// Large block</span></div>
<div class="line"><a name="l02778"></a><span class="lineno"> 2778</span>&#160;        <span class="keywordtype">size_t</span> current_spans = span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#ae77d9a2cdd2a2fd46e3b27739d6c88cc">span_count</a>;</div>
<div class="line"><a name="l02779"></a><span class="lineno"> 2779</span>&#160;        <span class="keywordflow">return</span> (current_spans * <a class="code" href="../../df/dc0/rpmalloc_8c.html#a9fefa5277fefa0c58f69d5b86d679ccb">_memory_span_size</a>) - (<a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#aa9d55e2f20e580b7445617d0d12fff6e">size_t</a>)<a class="code" href="../../df/dc0/rpmalloc_8c.html#af51a6ed47e80b1b57187f1d5be6c8b4c">pointer_diff</a>(<a class="code" href="../../df/d55/userspace__test_8c.html#a83de08c56df151f990dc392523079284">p</a>, span);</div>
<div class="line"><a name="l02780"></a><span class="lineno"> 2780</span>&#160;    }</div>
<div class="line"><a name="l02781"></a><span class="lineno"> 2781</span>&#160;    <span class="comment">// Oversized block, page count is stored in span_count</span></div>
<div class="line"><a name="l02782"></a><span class="lineno"> 2782</span>&#160;    <span class="keywordtype">size_t</span> current_pages = span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#ae77d9a2cdd2a2fd46e3b27739d6c88cc">span_count</a>;</div>
<div class="line"><a name="l02783"></a><span class="lineno"> 2783</span>&#160;    <span class="keywordflow">return</span> (current_pages * <a class="code" href="../../df/dc0/rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a>) - (<a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#aa9d55e2f20e580b7445617d0d12fff6e">size_t</a>)<a class="code" href="../../df/dc0/rpmalloc_8c.html#af51a6ed47e80b1b57187f1d5be6c8b4c">pointer_diff</a>(<a class="code" href="../../df/d55/userspace__test_8c.html#a83de08c56df151f990dc392523079284">p</a>, span);</div>
<div class="line"><a name="l02784"></a><span class="lineno"> 2784</span>&#160;}</div>
<div class="line"><a name="l02785"></a><span class="lineno"> 2785</span>&#160; </div>
<div class="line"><a name="l02787"></a><span class="lineno"> 2787</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="l02788"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a223c890fd871bff9081258f6520fc8a9"> 2788</a></span>&#160;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a223c890fd871bff9081258f6520fc8a9">_rpmalloc_adjust_size_class</a>(<span class="keywordtype">size_t</span> iclass)</div>
<div class="line"><a name="l02789"></a><span class="lineno"> 2789</span>&#160;{</div>
<div class="line"><a name="l02790"></a><span class="lineno"> 2790</span>&#160;    <span class="keywordtype">size_t</span> block_size = <a class="code" href="../../df/dc0/rpmalloc_8c.html#a33cddb08b9ee0f969cc82dbf9cddb947">_memory_size_class</a>[iclass].<a class="code" href="../../df/dc0/rpmalloc_8c.html#a007fc7dd52ba1f95d9a6ce88f47a614b">block_size</a>;</div>
<div class="line"><a name="l02791"></a><span class="lineno"> 2791</span>&#160;    <span class="keywordtype">size_t</span> block_count = (<a class="code" href="../../df/dc0/rpmalloc_8c.html#a9fefa5277fefa0c58f69d5b86d679ccb">_memory_span_size</a> - <a class="code" href="../../df/dc0/rpmalloc_8c.html#a645356809d937167848705edabde7d44">SPAN_HEADER_SIZE</a>) / block_size;</div>
<div class="line"><a name="l02792"></a><span class="lineno"> 2792</span>&#160; </div>
<div class="line"><a name="l02793"></a><span class="lineno"> 2793</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#a33cddb08b9ee0f969cc82dbf9cddb947">_memory_size_class</a>[iclass].<a class="code" href="../../df/dc0/rpmalloc_8c.html#aeded978bd21c13b71d9b0310b5bb09ec">block_count</a> = (<a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#a5debae8b2a1ec20a6694c0c443ee399e">uint16_t</a>)block_count;</div>
<div class="line"><a name="l02794"></a><span class="lineno"> 2794</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#a33cddb08b9ee0f969cc82dbf9cddb947">_memory_size_class</a>[iclass].<a class="code" href="../../df/dc0/rpmalloc_8c.html#a7524fc81b83a0b54ef5ec3fb4563b69d">class_idx</a> = (<a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#a5debae8b2a1ec20a6694c0c443ee399e">uint16_t</a>)iclass;</div>
<div class="line"><a name="l02795"></a><span class="lineno"> 2795</span>&#160; </div>
<div class="line"><a name="l02796"></a><span class="lineno"> 2796</span>&#160;    <span class="comment">// Check if previous size classes can be merged</span></div>
<div class="line"><a name="l02797"></a><span class="lineno"> 2797</span>&#160;    <span class="keywordflow">if</span> (iclass &gt;= <a class="code" href="../../df/dc0/rpmalloc_8c.html#afef7a20458b75404cdbba364a751694a">SMALL_CLASS_COUNT</a>)</div>
<div class="line"><a name="l02798"></a><span class="lineno"> 2798</span>&#160;    {</div>
<div class="line"><a name="l02799"></a><span class="lineno"> 2799</span>&#160;        <span class="keywordtype">size_t</span> prevclass = iclass;</div>
<div class="line"><a name="l02800"></a><span class="lineno"> 2800</span>&#160;        <span class="keywordflow">while</span> (prevclass &gt; 0)</div>
<div class="line"><a name="l02801"></a><span class="lineno"> 2801</span>&#160;        {</div>
<div class="line"><a name="l02802"></a><span class="lineno"> 2802</span>&#160;            --prevclass;</div>
<div class="line"><a name="l02803"></a><span class="lineno"> 2803</span>&#160;            <span class="comment">// A class can be merged if number of pages and number of blocks are equal</span></div>
<div class="line"><a name="l02804"></a><span class="lineno"> 2804</span>&#160;            <span class="keywordflow">if</span> (<a class="code" href="../../df/dc0/rpmalloc_8c.html#a33cddb08b9ee0f969cc82dbf9cddb947">_memory_size_class</a>[prevclass].block_count == <a class="code" href="../../df/dc0/rpmalloc_8c.html#a33cddb08b9ee0f969cc82dbf9cddb947">_memory_size_class</a>[iclass].block_count)</div>
<div class="line"><a name="l02805"></a><span class="lineno"> 2805</span>&#160;                <a class="code" href="../../d3/d82/convert_8h.html#a7a71051d6440816fca3ad080ae2539f4">memcpy_unsafe</a>(<a class="code" href="../../df/dc0/rpmalloc_8c.html#a33cddb08b9ee0f969cc82dbf9cddb947">_memory_size_class</a> + prevclass, <a class="code" href="../../df/dc0/rpmalloc_8c.html#a33cddb08b9ee0f969cc82dbf9cddb947">_memory_size_class</a> + iclass, <span class="keyword">sizeof</span>(<a class="code" href="../../df/dc0/rpmalloc_8c.html#a33cddb08b9ee0f969cc82dbf9cddb947">_memory_size_class</a>[iclass]));</div>
<div class="line"><a name="l02806"></a><span class="lineno"> 2806</span>&#160;            <span class="keywordflow">else</span></div>
<div class="line"><a name="l02807"></a><span class="lineno"> 2807</span>&#160;                <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l02808"></a><span class="lineno"> 2808</span>&#160;        }</div>
<div class="line"><a name="l02809"></a><span class="lineno"> 2809</span>&#160;    }</div>
<div class="line"><a name="l02810"></a><span class="lineno"> 2810</span>&#160;}</div>
<div class="line"><a name="l02811"></a><span class="lineno"> 2811</span>&#160; </div>
<div class="line"><a name="l02813"></a><span class="lineno"> 2813</span>&#160;<span class="keyword">extern</span> <span class="keyword">inline</span> <span class="keywordtype">int</span></div>
<div class="line"><a name="l02814"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a995ec0e5a8f40e3fb178abab89dc7fd5"> 2814</a></span>&#160;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a995ec0e5a8f40e3fb178abab89dc7fd5">rpmalloc_initialize</a>(<span class="keywordtype">void</span>)</div>
<div class="line"><a name="l02815"></a><span class="lineno"> 2815</span>&#160;{</div>
<div class="line"><a name="l02816"></a><span class="lineno"> 2816</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="../../df/dc0/rpmalloc_8c.html#a6414f61e9643ce358f1a33e6a2c6aeaa">_rpmalloc_initialized</a>)</div>
<div class="line"><a name="l02817"></a><span class="lineno"> 2817</span>&#160;    {</div>
<div class="line"><a name="l02818"></a><span class="lineno"> 2818</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#a85a64540090a42380ee6d969ec1897c1">rpmalloc_thread_initialize</a>();</div>
<div class="line"><a name="l02819"></a><span class="lineno"> 2819</span>&#160;        <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l02820"></a><span class="lineno"> 2820</span>&#160;    }</div>
<div class="line"><a name="l02821"></a><span class="lineno"> 2821</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#a2ae01990651a75a352409fb1fbf85d05">rpmalloc_initialize_config</a>(0);</div>
<div class="line"><a name="l02822"></a><span class="lineno"> 2822</span>&#160;}</div>
<div class="line"><a name="l02823"></a><span class="lineno"> 2823</span>&#160; </div>
<div class="line"><a name="l02824"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a2ae01990651a75a352409fb1fbf85d05"> 2824</a></span>&#160;<span class="keywordtype">int</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#a2ae01990651a75a352409fb1fbf85d05">rpmalloc_initialize_config</a>(<span class="keyword">const</span> <a class="code" href="../../df/d42/structrpmalloc__config__t.html">rpmalloc_config_t</a> *config)</div>
<div class="line"><a name="l02825"></a><span class="lineno"> 2825</span>&#160;{</div>
<div class="line"><a name="l02826"></a><span class="lineno"> 2826</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="../../df/dc0/rpmalloc_8c.html#a6414f61e9643ce358f1a33e6a2c6aeaa">_rpmalloc_initialized</a>)</div>
<div class="line"><a name="l02827"></a><span class="lineno"> 2827</span>&#160;    {</div>
<div class="line"><a name="l02828"></a><span class="lineno"> 2828</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#a85a64540090a42380ee6d969ec1897c1">rpmalloc_thread_initialize</a>();</div>
<div class="line"><a name="l02829"></a><span class="lineno"> 2829</span>&#160;        <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l02830"></a><span class="lineno"> 2830</span>&#160;    }</div>
<div class="line"><a name="l02831"></a><span class="lineno"> 2831</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#a6414f61e9643ce358f1a33e6a2c6aeaa">_rpmalloc_initialized</a> = 1;</div>
<div class="line"><a name="l02832"></a><span class="lineno"> 2832</span>&#160; </div>
<div class="line"><a name="l02833"></a><span class="lineno"> 2833</span>&#160;    <span class="keywordflow">if</span> (config)</div>
<div class="line"><a name="l02834"></a><span class="lineno"> 2834</span>&#160;        <a class="code" href="../../d3/d82/convert_8h.html#a7a71051d6440816fca3ad080ae2539f4">memcpy_unsafe</a>(&amp;<a class="code" href="../../df/dc0/rpmalloc_8c.html#ae1f1297fe3d143e41deac95ee7a7f8d4">_memory_config</a>, config, <span class="keyword">sizeof</span>(<a class="code" href="../../df/d42/structrpmalloc__config__t.html">rpmalloc_config_t</a>));</div>
<div class="line"><a name="l02835"></a><span class="lineno"> 2835</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l02836"></a><span class="lineno"> 2836</span>&#160;        <a class="code" href="../../d3/d82/convert_8h.html#a9c1f204516a55affa9ba118907e5ab6b">memset_unsafe</a>(&amp;<a class="code" href="../../df/dc0/rpmalloc_8c.html#ae1f1297fe3d143e41deac95ee7a7f8d4">_memory_config</a>, 0, <span class="keyword">sizeof</span>(<a class="code" href="../../df/d42/structrpmalloc__config__t.html">rpmalloc_config_t</a>));</div>
<div class="line"><a name="l02837"></a><span class="lineno"> 2837</span>&#160; </div>
<div class="line"><a name="l02838"></a><span class="lineno"> 2838</span>&#160;    <span class="keywordflow">if</span> (!<a class="code" href="../../df/dc0/rpmalloc_8c.html#ae1f1297fe3d143e41deac95ee7a7f8d4">_memory_config</a>.<a class="code" href="../../df/d42/structrpmalloc__config__t.html#ab1a81b9e7c3dee077fafc85b5327ea6b">memory_map</a> || !<a class="code" href="../../df/dc0/rpmalloc_8c.html#ae1f1297fe3d143e41deac95ee7a7f8d4">_memory_config</a>.<a class="code" href="../../df/d42/structrpmalloc__config__t.html#a10fb22a2f8775aafd70b1c79f6b80630">memory_unmap</a>)</div>
<div class="line"><a name="l02839"></a><span class="lineno"> 2839</span>&#160;    {</div>
<div class="line"><a name="l02840"></a><span class="lineno"> 2840</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#ae1f1297fe3d143e41deac95ee7a7f8d4">_memory_config</a>.<a class="code" href="../../df/d42/structrpmalloc__config__t.html#ab1a81b9e7c3dee077fafc85b5327ea6b">memory_map</a> = <a class="code" href="../../df/dc0/rpmalloc_8c.html#aa3b1a6473db3c198691da8c7b8918f7a">_rpmalloc_mmap_os</a>;</div>
<div class="line"><a name="l02841"></a><span class="lineno"> 2841</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#ae1f1297fe3d143e41deac95ee7a7f8d4">_memory_config</a>.<a class="code" href="../../df/d42/structrpmalloc__config__t.html#a10fb22a2f8775aafd70b1c79f6b80630">memory_unmap</a> = <a class="code" href="../../df/dc0/rpmalloc_8c.html#a693c463bae081b54b0b799e97bf84fb5">_rpmalloc_unmap_os</a>;</div>
<div class="line"><a name="l02842"></a><span class="lineno"> 2842</span>&#160;    }</div>
<div class="line"><a name="l02843"></a><span class="lineno"> 2843</span>&#160; </div>
<div class="line"><a name="l02844"></a><span class="lineno"> 2844</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#a1e29d8d18139babda354d5d92d46ca02">_memory_map_granularity</a> = (<a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#aa9d55e2f20e580b7445617d0d12fff6e">size_t</a>)<a class="code" href="../../df/dc0/rpmalloc_8c.html#a97f4a6378f5e22e4e38e32cf9f370430">__rpmalloc_sysconf</a>(<a class="code" href="../../d2/d58/Kernel_2include__std_2unistd_8h.html#af8524bbbaf09850389a58789b72caf52">_SC_PAGESIZE</a>);</div>
<div class="line"><a name="l02845"></a><span class="lineno"> 2845</span>&#160; </div>
<div class="line"><a name="l02846"></a><span class="lineno"> 2846</span>&#160;<span class="preprocessor">#if RPMALLOC_CONFIGURABLE</span></div>
<div class="line"><a name="l02847"></a><span class="lineno"> 2847</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a> = <a class="code" href="../../df/dc0/rpmalloc_8c.html#ae1f1297fe3d143e41deac95ee7a7f8d4">_memory_config</a>.<a class="code" href="../../df/d42/structrpmalloc__config__t.html#adcf8dfc992b8b4a4e6cd72e213bf1035">page_size</a>;</div>
<div class="line"><a name="l02848"></a><span class="lineno"> 2848</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l02849"></a><span class="lineno"> 2849</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a> = 0;</div>
<div class="line"><a name="l02850"></a><span class="lineno"> 2850</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02851"></a><span class="lineno"> 2851</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#a4cdf64413eaa3e80f8a1dfe158bd2525">_memory_huge_pages</a> = 0;</div>
<div class="line"><a name="l02852"></a><span class="lineno"> 2852</span>&#160;    <span class="keywordflow">if</span> (!<a class="code" href="../../df/dc0/rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a>)</div>
<div class="line"><a name="l02853"></a><span class="lineno"> 2853</span>&#160;    {</div>
<div class="line"><a name="l02854"></a><span class="lineno"> 2854</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a> = <a class="code" href="../../df/dc0/rpmalloc_8c.html#a1e29d8d18139babda354d5d92d46ca02">_memory_map_granularity</a>;</div>
<div class="line"><a name="l02855"></a><span class="lineno"> 2855</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="../../df/dc0/rpmalloc_8c.html#ae1f1297fe3d143e41deac95ee7a7f8d4">_memory_config</a>.<a class="code" href="../../df/d42/structrpmalloc__config__t.html#a9cfb1a2f571e8ebe68185b387f04260b">enable_huge_pages</a>)</div>
<div class="line"><a name="l02856"></a><span class="lineno"> 2856</span>&#160;        {</div>
<div class="line"><a name="l02857"></a><span class="lineno"> 2857</span>&#160;<span class="preprocessor">#if defined(__linux__)</span></div>
<div class="line"><a name="l02858"></a><span class="lineno"> 2858</span>&#160;            <span class="keywordtype">size_t</span> huge_page_size = 0;</div>
<div class="line"><a name="l02859"></a><span class="lineno"> 2859</span>&#160;            <a class="code" href="../../d8/d67/Kernel_2include__std_2stdio_8h.html#de/dc3/structFILE">FILE</a> *meminfo = <a class="code" href="../../dd/d69/Userspace_2libc_2include_2stdio_8h.html#afffa3e442e49895773d564f422e1be1c">fopen</a>(<span class="stringliteral">&quot;/proc/meminfo&quot;</span>, <span class="stringliteral">&quot;r&quot;</span>);</div>
<div class="line"><a name="l02860"></a><span class="lineno"> 2860</span>&#160;            <span class="keywordflow">if</span> (meminfo)</div>
<div class="line"><a name="l02861"></a><span class="lineno"> 2861</span>&#160;            {</div>
<div class="line"><a name="l02862"></a><span class="lineno"> 2862</span>&#160;                <span class="keywordtype">char</span> <a class="code" href="../../d0/dd9/getusershell_8c.html#a8adb30f4f6669f927fd9232f686c637b">line</a>[128];</div>
<div class="line"><a name="l02863"></a><span class="lineno"> 2863</span>&#160;                <span class="keywordflow">while</span> (!huge_page_size &amp;&amp; <a class="code" href="../../d7/d0a/Userspace_2musl_2include_2stdio_8h.html#a7fef8c27f707dff1fda32d2fed33693e">fgets</a>(<a class="code" href="../../d0/dd9/getusershell_8c.html#a8adb30f4f6669f927fd9232f686c637b">line</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d0/dd9/getusershell_8c.html#a8adb30f4f6669f927fd9232f686c637b">line</a>) - 1, meminfo))</div>
<div class="line"><a name="l02864"></a><span class="lineno"> 2864</span>&#160;                {</div>
<div class="line"><a name="l02865"></a><span class="lineno"> 2865</span>&#160;                    <a class="code" href="../../d0/dd9/getusershell_8c.html#a8adb30f4f6669f927fd9232f686c637b">line</a>[<span class="keyword">sizeof</span>(<a class="code" href="../../d0/dd9/getusershell_8c.html#a8adb30f4f6669f927fd9232f686c637b">line</a>) - 1] = 0;</div>
<div class="line"><a name="l02866"></a><span class="lineno"> 2866</span>&#160;                    <span class="keywordflow">if</span> (<a class="code" href="../../d3/d82/convert_8h.html#a4a710d86541afc6b7dafddcdb4b1c94f">strstr</a>(<a class="code" href="../../d0/dd9/getusershell_8c.html#a8adb30f4f6669f927fd9232f686c637b">line</a>, <span class="stringliteral">&quot;Hugepagesize:&quot;</span>))</div>
<div class="line"><a name="l02867"></a><span class="lineno"> 2867</span>&#160;                        huge_page_size = (<span class="keywordtype">size_t</span>)<a class="code" href="../../d3/d82/convert_8h.html#a2ce966cd04da3c32320f54c332569e03">strtol</a>(<a class="code" href="../../d0/dd9/getusershell_8c.html#a8adb30f4f6669f927fd9232f686c637b">line</a> + 13, 0, 10) * 1024;</div>
<div class="line"><a name="l02868"></a><span class="lineno"> 2868</span>&#160;                }</div>
<div class="line"><a name="l02869"></a><span class="lineno"> 2869</span>&#160;                <a class="code" href="../../dd/d69/Userspace_2libc_2include_2stdio_8h.html#a3abd78c220b4b49d1b088f0dfe40bf23">fclose</a>(meminfo);</div>
<div class="line"><a name="l02870"></a><span class="lineno"> 2870</span>&#160;            }</div>
<div class="line"><a name="l02871"></a><span class="lineno"> 2871</span>&#160;            <span class="keywordflow">if</span> (huge_page_size)</div>
<div class="line"><a name="l02872"></a><span class="lineno"> 2872</span>&#160;            {</div>
<div class="line"><a name="l02873"></a><span class="lineno"> 2873</span>&#160;                <a class="code" href="../../df/dc0/rpmalloc_8c.html#a4cdf64413eaa3e80f8a1dfe158bd2525">_memory_huge_pages</a> = 1;</div>
<div class="line"><a name="l02874"></a><span class="lineno"> 2874</span>&#160;                <a class="code" href="../../df/dc0/rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a> = huge_page_size;</div>
<div class="line"><a name="l02875"></a><span class="lineno"> 2875</span>&#160;                <a class="code" href="../../df/dc0/rpmalloc_8c.html#a1e29d8d18139babda354d5d92d46ca02">_memory_map_granularity</a> = huge_page_size;</div>
<div class="line"><a name="l02876"></a><span class="lineno"> 2876</span>&#160;            }</div>
<div class="line"><a name="l02877"></a><span class="lineno"> 2877</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02878"></a><span class="lineno"> 2878</span>&#160;        }</div>
<div class="line"><a name="l02879"></a><span class="lineno"> 2879</span>&#160;    }</div>
<div class="line"><a name="l02880"></a><span class="lineno"> 2880</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l02881"></a><span class="lineno"> 2881</span>&#160;    {</div>
<div class="line"><a name="l02882"></a><span class="lineno"> 2882</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="../../df/dc0/rpmalloc_8c.html#ae1f1297fe3d143e41deac95ee7a7f8d4">_memory_config</a>.<a class="code" href="../../df/d42/structrpmalloc__config__t.html#a9cfb1a2f571e8ebe68185b387f04260b">enable_huge_pages</a>)</div>
<div class="line"><a name="l02883"></a><span class="lineno"> 2883</span>&#160;            <a class="code" href="../../df/dc0/rpmalloc_8c.html#a4cdf64413eaa3e80f8a1dfe158bd2525">_memory_huge_pages</a> = 1;</div>
<div class="line"><a name="l02884"></a><span class="lineno"> 2884</span>&#160;    }</div>
<div class="line"><a name="l02885"></a><span class="lineno"> 2885</span>&#160; </div>
<div class="line"><a name="l02886"></a><span class="lineno"> 2886</span>&#160;    <span class="keywordtype">size_t</span> min_span_size = 256;</div>
<div class="line"><a name="l02887"></a><span class="lineno"> 2887</span>&#160;    <span class="keywordtype">size_t</span> max_page_size;</div>
<div class="line"><a name="l02888"></a><span class="lineno"> 2888</span>&#160;<span class="preprocessor">#if UINTPTR_MAX &gt; 0xFFFFFFFF</span></div>
<div class="line"><a name="l02889"></a><span class="lineno"> 2889</span>&#160;    max_page_size = 4096ULL * 1024ULL * 1024ULL;</div>
<div class="line"><a name="l02890"></a><span class="lineno"> 2890</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l02891"></a><span class="lineno"> 2891</span>&#160;    max_page_size = 4 * 1024 * 1024;</div>
<div class="line"><a name="l02892"></a><span class="lineno"> 2892</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02893"></a><span class="lineno"> 2893</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="../../df/dc0/rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a> &lt; min_span_size)</div>
<div class="line"><a name="l02894"></a><span class="lineno"> 2894</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a> = min_span_size;</div>
<div class="line"><a name="l02895"></a><span class="lineno"> 2895</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="../../df/dc0/rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a> &gt; max_page_size)</div>
<div class="line"><a name="l02896"></a><span class="lineno"> 2896</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a> = max_page_size;</div>
<div class="line"><a name="l02897"></a><span class="lineno"> 2897</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#a9d7ec974d864302bb4f8516859c4b212">_memory_page_size_shift</a> = 0;</div>
<div class="line"><a name="l02898"></a><span class="lineno"> 2898</span>&#160;    <span class="keywordtype">size_t</span> page_size_bit = <a class="code" href="../../df/dc0/rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a>;</div>
<div class="line"><a name="l02899"></a><span class="lineno"> 2899</span>&#160;    <span class="keywordflow">while</span> (page_size_bit != 1)</div>
<div class="line"><a name="l02900"></a><span class="lineno"> 2900</span>&#160;    {</div>
<div class="line"><a name="l02901"></a><span class="lineno"> 2901</span>&#160;        ++<a class="code" href="../../df/dc0/rpmalloc_8c.html#a9d7ec974d864302bb4f8516859c4b212">_memory_page_size_shift</a>;</div>
<div class="line"><a name="l02902"></a><span class="lineno"> 2902</span>&#160;        page_size_bit &gt;&gt;= 1;</div>
<div class="line"><a name="l02903"></a><span class="lineno"> 2903</span>&#160;    }</div>
<div class="line"><a name="l02904"></a><span class="lineno"> 2904</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a> = ((<a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#aa9d55e2f20e580b7445617d0d12fff6e">size_t</a>)1 &lt;&lt; <a class="code" href="../../df/dc0/rpmalloc_8c.html#a9d7ec974d864302bb4f8516859c4b212">_memory_page_size_shift</a>);</div>
<div class="line"><a name="l02905"></a><span class="lineno"> 2905</span>&#160; </div>
<div class="line"><a name="l02906"></a><span class="lineno"> 2906</span>&#160;<span class="preprocessor">#if RPMALLOC_CONFIGURABLE</span></div>
<div class="line"><a name="l02907"></a><span class="lineno"> 2907</span>&#160;    <span class="keywordflow">if</span> (!<a class="code" href="../../df/dc0/rpmalloc_8c.html#ae1f1297fe3d143e41deac95ee7a7f8d4">_memory_config</a>.<a class="code" href="../../df/d42/structrpmalloc__config__t.html#ab730f9de6da78affe64497f859d6d345">span_size</a>)</div>
<div class="line"><a name="l02908"></a><span class="lineno"> 2908</span>&#160;    {</div>
<div class="line"><a name="l02909"></a><span class="lineno"> 2909</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#a9fefa5277fefa0c58f69d5b86d679ccb">_memory_span_size</a> = <a class="code" href="../../df/dc0/rpmalloc_8c.html#a04a025a8c2529bc60cb95c78d3948c52">_memory_default_span_size</a>;</div>
<div class="line"><a name="l02910"></a><span class="lineno"> 2910</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#adb538a1ad8a86db6b92895d9ebf6d907">_memory_span_size_shift</a> = <a class="code" href="../../df/dc0/rpmalloc_8c.html#a3dedf1d71cda4a8f3d1f372934ddad30">_memory_default_span_size_shift</a>;</div>
<div class="line"><a name="l02911"></a><span class="lineno"> 2911</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#ae7b97ba12e15609b6d63926ed2e30238">_memory_span_mask</a> = <a class="code" href="../../df/dc0/rpmalloc_8c.html#ada0a343b3498bb882ebd7e0c3caa0935">_memory_default_span_mask</a>;</div>
<div class="line"><a name="l02912"></a><span class="lineno"> 2912</span>&#160;    }</div>
<div class="line"><a name="l02913"></a><span class="lineno"> 2913</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l02914"></a><span class="lineno"> 2914</span>&#160;    {</div>
<div class="line"><a name="l02915"></a><span class="lineno"> 2915</span>&#160;        <span class="keywordtype">size_t</span> span_size = <a class="code" href="../../df/dc0/rpmalloc_8c.html#ae1f1297fe3d143e41deac95ee7a7f8d4">_memory_config</a>.<a class="code" href="../../df/d42/structrpmalloc__config__t.html#ab730f9de6da78affe64497f859d6d345">span_size</a>;</div>
<div class="line"><a name="l02916"></a><span class="lineno"> 2916</span>&#160;        <span class="keywordflow">if</span> (span_size &gt; (256 * 1024))</div>
<div class="line"><a name="l02917"></a><span class="lineno"> 2917</span>&#160;            span_size = (256 * 1024);</div>
<div class="line"><a name="l02918"></a><span class="lineno"> 2918</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#a9fefa5277fefa0c58f69d5b86d679ccb">_memory_span_size</a> = 4096;</div>
<div class="line"><a name="l02919"></a><span class="lineno"> 2919</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#adb538a1ad8a86db6b92895d9ebf6d907">_memory_span_size_shift</a> = 12;</div>
<div class="line"><a name="l02920"></a><span class="lineno"> 2920</span>&#160;        <span class="keywordflow">while</span> (<a class="code" href="../../df/dc0/rpmalloc_8c.html#a9fefa5277fefa0c58f69d5b86d679ccb">_memory_span_size</a> &lt; span_size)</div>
<div class="line"><a name="l02921"></a><span class="lineno"> 2921</span>&#160;        {</div>
<div class="line"><a name="l02922"></a><span class="lineno"> 2922</span>&#160;            <a class="code" href="../../df/dc0/rpmalloc_8c.html#a9fefa5277fefa0c58f69d5b86d679ccb">_memory_span_size</a> &lt;&lt;= 1;</div>
<div class="line"><a name="l02923"></a><span class="lineno"> 2923</span>&#160;            ++<a class="code" href="../../df/dc0/rpmalloc_8c.html#adb538a1ad8a86db6b92895d9ebf6d907">_memory_span_size_shift</a>;</div>
<div class="line"><a name="l02924"></a><span class="lineno"> 2924</span>&#160;        }</div>
<div class="line"><a name="l02925"></a><span class="lineno"> 2925</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#ae7b97ba12e15609b6d63926ed2e30238">_memory_span_mask</a> = ~(<a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#a4788399d1d0b37ccf098a7da82254808">uintptr_t</a>)(<a class="code" href="../../df/dc0/rpmalloc_8c.html#a9fefa5277fefa0c58f69d5b86d679ccb">_memory_span_size</a> - 1);</div>
<div class="line"><a name="l02926"></a><span class="lineno"> 2926</span>&#160;    }</div>
<div class="line"><a name="l02927"></a><span class="lineno"> 2927</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02928"></a><span class="lineno"> 2928</span>&#160; </div>
<div class="line"><a name="l02929"></a><span class="lineno"> 2929</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#a3d9a7f69f3e3cc2dc7ea18d8c58b274c">_memory_span_map_count</a> = (<a class="code" href="../../df/dc0/rpmalloc_8c.html#ae1f1297fe3d143e41deac95ee7a7f8d4">_memory_config</a>.<a class="code" href="../../df/d42/structrpmalloc__config__t.html#a84cfc60f2a133ca255a762778cc024c6">span_map_count</a> ? <a class="code" href="../../df/dc0/rpmalloc_8c.html#ae1f1297fe3d143e41deac95ee7a7f8d4">_memory_config</a>.<a class="code" href="../../df/d42/structrpmalloc__config__t.html#a84cfc60f2a133ca255a762778cc024c6">span_map_count</a> : <a class="code" href="../../df/dc0/rpmalloc_8c.html#af8803f4eab133ac4c823104577553d78">DEFAULT_SPAN_MAP_COUNT</a>);</div>
<div class="line"><a name="l02930"></a><span class="lineno"> 2930</span>&#160;    <span class="keywordflow">if</span> ((<a class="code" href="../../df/dc0/rpmalloc_8c.html#a9fefa5277fefa0c58f69d5b86d679ccb">_memory_span_size</a> * <a class="code" href="../../df/dc0/rpmalloc_8c.html#a3d9a7f69f3e3cc2dc7ea18d8c58b274c">_memory_span_map_count</a>) &lt; <a class="code" href="../../df/dc0/rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a>)</div>
<div class="line"><a name="l02931"></a><span class="lineno"> 2931</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#a3d9a7f69f3e3cc2dc7ea18d8c58b274c">_memory_span_map_count</a> = (<a class="code" href="../../df/dc0/rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a> / <a class="code" href="../../df/dc0/rpmalloc_8c.html#a9fefa5277fefa0c58f69d5b86d679ccb">_memory_span_size</a>);</div>
<div class="line"><a name="l02932"></a><span class="lineno"> 2932</span>&#160;    <span class="keywordflow">if</span> ((<a class="code" href="../../df/dc0/rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a> &gt;= <a class="code" href="../../df/dc0/rpmalloc_8c.html#a9fefa5277fefa0c58f69d5b86d679ccb">_memory_span_size</a>) &amp;&amp; ((<a class="code" href="../../df/dc0/rpmalloc_8c.html#a3d9a7f69f3e3cc2dc7ea18d8c58b274c">_memory_span_map_count</a> * <a class="code" href="../../df/dc0/rpmalloc_8c.html#a9fefa5277fefa0c58f69d5b86d679ccb">_memory_span_size</a>) % <a class="code" href="../../df/dc0/rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a>))</div>
<div class="line"><a name="l02933"></a><span class="lineno"> 2933</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#a3d9a7f69f3e3cc2dc7ea18d8c58b274c">_memory_span_map_count</a> = (<a class="code" href="../../df/dc0/rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a> / <a class="code" href="../../df/dc0/rpmalloc_8c.html#a9fefa5277fefa0c58f69d5b86d679ccb">_memory_span_size</a>);</div>
<div class="line"><a name="l02934"></a><span class="lineno"> 2934</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#ada12637cd22672d5ad52ceba482b7f5c">_memory_heap_reserve_count</a> = (<a class="code" href="../../df/dc0/rpmalloc_8c.html#a3d9a7f69f3e3cc2dc7ea18d8c58b274c">_memory_span_map_count</a> &gt; <a class="code" href="../../df/dc0/rpmalloc_8c.html#af8803f4eab133ac4c823104577553d78">DEFAULT_SPAN_MAP_COUNT</a>) ? <a class="code" href="../../df/dc0/rpmalloc_8c.html#af8803f4eab133ac4c823104577553d78">DEFAULT_SPAN_MAP_COUNT</a> : <a class="code" href="../../df/dc0/rpmalloc_8c.html#a3d9a7f69f3e3cc2dc7ea18d8c58b274c">_memory_span_map_count</a>;</div>
<div class="line"><a name="l02935"></a><span class="lineno"> 2935</span>&#160; </div>
<div class="line"><a name="l02936"></a><span class="lineno"> 2936</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#ae1f1297fe3d143e41deac95ee7a7f8d4">_memory_config</a>.<a class="code" href="../../df/d42/structrpmalloc__config__t.html#adcf8dfc992b8b4a4e6cd72e213bf1035">page_size</a> = <a class="code" href="../../df/dc0/rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a>;</div>
<div class="line"><a name="l02937"></a><span class="lineno"> 2937</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#ae1f1297fe3d143e41deac95ee7a7f8d4">_memory_config</a>.<a class="code" href="../../df/d42/structrpmalloc__config__t.html#ab730f9de6da78affe64497f859d6d345">span_size</a> = <a class="code" href="../../df/dc0/rpmalloc_8c.html#a9fefa5277fefa0c58f69d5b86d679ccb">_memory_span_size</a>;</div>
<div class="line"><a name="l02938"></a><span class="lineno"> 2938</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#ae1f1297fe3d143e41deac95ee7a7f8d4">_memory_config</a>.<a class="code" href="../../df/d42/structrpmalloc__config__t.html#a84cfc60f2a133ca255a762778cc024c6">span_map_count</a> = <a class="code" href="../../df/dc0/rpmalloc_8c.html#a3d9a7f69f3e3cc2dc7ea18d8c58b274c">_memory_span_map_count</a>;</div>
<div class="line"><a name="l02939"></a><span class="lineno"> 2939</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#ae1f1297fe3d143e41deac95ee7a7f8d4">_memory_config</a>.<a class="code" href="../../df/d42/structrpmalloc__config__t.html#a9cfb1a2f571e8ebe68185b387f04260b">enable_huge_pages</a> = <a class="code" href="../../df/dc0/rpmalloc_8c.html#a4cdf64413eaa3e80f8a1dfe158bd2525">_memory_huge_pages</a>;</div>
<div class="line"><a name="l02940"></a><span class="lineno"> 2940</span>&#160; </div>
<div class="line"><a name="l02941"></a><span class="lineno"> 2941</span>&#160;<span class="preprocessor">#if ((defined(__APPLE__) || defined(__HAIKU__)) &amp;&amp; ENABLE_PRELOAD) || defined(__TINYC__)</span></div>
<div class="line"><a name="l02942"></a><span class="lineno"> 2942</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="../../df/d00/Userspace_2musl_2include_2pthread_8h.html#a74969d08c03097db757218adda625264">pthread_key_create</a>(&amp;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a0c3d121b2c7e431b109863973cff023c">_memory_thread_heap</a>, <a class="code" href="../../df/dc0/rpmalloc_8c.html#a375befcec19545c40cb27c22512501bb">_rpmalloc_heap_release_raw_fc</a>))</div>
<div class="line"><a name="l02943"></a><span class="lineno"> 2943</span>&#160;        <span class="keywordflow">return</span> -1;</div>
<div class="line"><a name="l02944"></a><span class="lineno"> 2944</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02945"></a><span class="lineno"> 2945</span>&#160; </div>
<div class="line"><a name="l02946"></a><span class="lineno"> 2946</span>&#160;    <span class="comment">// Setup all small and medium size classes</span></div>
<div class="line"><a name="l02947"></a><span class="lineno"> 2947</span>&#160;    <span class="keywordtype">size_t</span> iclass = 0;</div>
<div class="line"><a name="l02948"></a><span class="lineno"> 2948</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#a33cddb08b9ee0f969cc82dbf9cddb947">_memory_size_class</a>[iclass].<a class="code" href="../../df/dc0/rpmalloc_8c.html#a007fc7dd52ba1f95d9a6ce88f47a614b">block_size</a> = <a class="code" href="../../df/dc0/rpmalloc_8c.html#a000afcda168a6fd19a9435e049508463">SMALL_GRANULARITY</a>;</div>
<div class="line"><a name="l02949"></a><span class="lineno"> 2949</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#a223c890fd871bff9081258f6520fc8a9">_rpmalloc_adjust_size_class</a>(iclass);</div>
<div class="line"><a name="l02950"></a><span class="lineno"> 2950</span>&#160;    <span class="keywordflow">for</span> (iclass = 1; iclass &lt; <a class="code" href="../../df/dc0/rpmalloc_8c.html#afef7a20458b75404cdbba364a751694a">SMALL_CLASS_COUNT</a>; ++iclass)</div>
<div class="line"><a name="l02951"></a><span class="lineno"> 2951</span>&#160;    {</div>
<div class="line"><a name="l02952"></a><span class="lineno"> 2952</span>&#160;        <span class="keywordtype">size_t</span> <a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a> = iclass * <a class="code" href="../../df/dc0/rpmalloc_8c.html#a000afcda168a6fd19a9435e049508463">SMALL_GRANULARITY</a>;</div>
<div class="line"><a name="l02953"></a><span class="lineno"> 2953</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#a33cddb08b9ee0f969cc82dbf9cddb947">_memory_size_class</a>[iclass].<a class="code" href="../../df/dc0/rpmalloc_8c.html#a007fc7dd52ba1f95d9a6ce88f47a614b">block_size</a> = (<a class="code" href="../../dd/ddd/arithmetic__operations_8c.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a>)<a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a>;</div>
<div class="line"><a name="l02954"></a><span class="lineno"> 2954</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#a223c890fd871bff9081258f6520fc8a9">_rpmalloc_adjust_size_class</a>(iclass);</div>
<div class="line"><a name="l02955"></a><span class="lineno"> 2955</span>&#160;    }</div>
<div class="line"><a name="l02956"></a><span class="lineno"> 2956</span>&#160;    <span class="comment">// At least two blocks per span, then fall back to large allocations</span></div>
<div class="line"><a name="l02957"></a><span class="lineno"> 2957</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#a9641beb0030ad56b2df025775823b2af">_memory_medium_size_limit</a> = (<a class="code" href="../../df/dc0/rpmalloc_8c.html#a9fefa5277fefa0c58f69d5b86d679ccb">_memory_span_size</a> - <a class="code" href="../../df/dc0/rpmalloc_8c.html#a645356809d937167848705edabde7d44">SPAN_HEADER_SIZE</a>) &gt;&gt; 1;</div>
<div class="line"><a name="l02958"></a><span class="lineno"> 2958</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="../../df/dc0/rpmalloc_8c.html#a9641beb0030ad56b2df025775823b2af">_memory_medium_size_limit</a> &gt; <a class="code" href="../../df/dc0/rpmalloc_8c.html#aecb085054ab2d682b41748925519c084">MEDIUM_SIZE_LIMIT</a>)</div>
<div class="line"><a name="l02959"></a><span class="lineno"> 2959</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#a9641beb0030ad56b2df025775823b2af">_memory_medium_size_limit</a> = <a class="code" href="../../df/dc0/rpmalloc_8c.html#aecb085054ab2d682b41748925519c084">MEDIUM_SIZE_LIMIT</a>;</div>
<div class="line"><a name="l02960"></a><span class="lineno"> 2960</span>&#160;    <span class="keywordflow">for</span> (iclass = 0; iclass &lt; <a class="code" href="../../df/dc0/rpmalloc_8c.html#a554df4bc024ffaa8328e6ef37cec5c77">MEDIUM_CLASS_COUNT</a>; ++iclass)</div>
<div class="line"><a name="l02961"></a><span class="lineno"> 2961</span>&#160;    {</div>
<div class="line"><a name="l02962"></a><span class="lineno"> 2962</span>&#160;        <span class="keywordtype">size_t</span> <a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a> = <a class="code" href="../../df/dc0/rpmalloc_8c.html#aecf578949f89fb109c5f6f527a2dc49d">SMALL_SIZE_LIMIT</a> + ((iclass + 1) * <a class="code" href="../../df/dc0/rpmalloc_8c.html#a0cbe158c682e307dc9372ee5a0b5167a">MEDIUM_GRANULARITY</a>);</div>
<div class="line"><a name="l02963"></a><span class="lineno"> 2963</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a> &gt; <a class="code" href="../../df/dc0/rpmalloc_8c.html#a9641beb0030ad56b2df025775823b2af">_memory_medium_size_limit</a>)</div>
<div class="line"><a name="l02964"></a><span class="lineno"> 2964</span>&#160;            <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l02965"></a><span class="lineno"> 2965</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#a33cddb08b9ee0f969cc82dbf9cddb947">_memory_size_class</a>[<a class="code" href="../../df/dc0/rpmalloc_8c.html#afef7a20458b75404cdbba364a751694a">SMALL_CLASS_COUNT</a> + iclass].<a class="code" href="../../df/dc0/rpmalloc_8c.html#a007fc7dd52ba1f95d9a6ce88f47a614b">block_size</a> = (<a class="code" href="../../dd/ddd/arithmetic__operations_8c.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a>)<a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a>;</div>
<div class="line"><a name="l02966"></a><span class="lineno"> 2966</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#a223c890fd871bff9081258f6520fc8a9">_rpmalloc_adjust_size_class</a>(<a class="code" href="../../df/dc0/rpmalloc_8c.html#afef7a20458b75404cdbba364a751694a">SMALL_CLASS_COUNT</a> + iclass);</div>
<div class="line"><a name="l02967"></a><span class="lineno"> 2967</span>&#160;    }</div>
<div class="line"><a name="l02968"></a><span class="lineno"> 2968</span>&#160; </div>
<div class="line"><a name="l02969"></a><span class="lineno"> 2969</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#ae3a524405e2a853229e95546df284be2">_memory_orphan_heaps</a> = 0;</div>
<div class="line"><a name="l02970"></a><span class="lineno"> 2970</span>&#160;<span class="preprocessor">#if RPMALLOC_FIRST_CLASS_HEAPS</span></div>
<div class="line"><a name="l02971"></a><span class="lineno"> 2971</span>&#160;    _memory_first_class_orphan_heaps = 0;</div>
<div class="line"><a name="l02972"></a><span class="lineno"> 2972</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02973"></a><span class="lineno"> 2973</span>&#160;<span class="preprocessor">#if ENABLE_STATISTICS</span></div>
<div class="line"><a name="l02974"></a><span class="lineno"> 2974</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#aa1ee77cdccf0341222f64395d0be2626">atomic_store32</a>(&amp;_memory_active_heaps, 0);</div>
<div class="line"><a name="l02975"></a><span class="lineno"> 2975</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#aa1ee77cdccf0341222f64395d0be2626">atomic_store32</a>(&amp;_mapped_pages, 0);</div>
<div class="line"><a name="l02976"></a><span class="lineno"> 2976</span>&#160;    _mapped_pages_peak = 0;</div>
<div class="line"><a name="l02977"></a><span class="lineno"> 2977</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#aa1ee77cdccf0341222f64395d0be2626">atomic_store32</a>(&amp;_master_spans, 0);</div>
<div class="line"><a name="l02978"></a><span class="lineno"> 2978</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#aa1ee77cdccf0341222f64395d0be2626">atomic_store32</a>(&amp;_mapped_total, 0);</div>
<div class="line"><a name="l02979"></a><span class="lineno"> 2979</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#aa1ee77cdccf0341222f64395d0be2626">atomic_store32</a>(&amp;_unmapped_total, 0);</div>
<div class="line"><a name="l02980"></a><span class="lineno"> 2980</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#aa1ee77cdccf0341222f64395d0be2626">atomic_store32</a>(&amp;_mapped_pages_os, 0);</div>
<div class="line"><a name="l02981"></a><span class="lineno"> 2981</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#aa1ee77cdccf0341222f64395d0be2626">atomic_store32</a>(&amp;_huge_pages_current, 0);</div>
<div class="line"><a name="l02982"></a><span class="lineno"> 2982</span>&#160;    _huge_pages_peak = 0;</div>
<div class="line"><a name="l02983"></a><span class="lineno"> 2983</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02984"></a><span class="lineno"> 2984</span>&#160;    <a class="code" href="../../d3/d82/convert_8h.html#a9c1f204516a55affa9ba118907e5ab6b">memset_unsafe</a>(<a class="code" href="../../df/dc0/rpmalloc_8c.html#a3e39052a111a2e243645494f1d6ca439">_memory_heaps</a>, 0, <span class="keyword">sizeof</span>(<a class="code" href="../../df/dc0/rpmalloc_8c.html#a3e39052a111a2e243645494f1d6ca439">_memory_heaps</a>));</div>
<div class="line"><a name="l02985"></a><span class="lineno"> 2985</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#a2a87a6060d5387fe8491a00600073687">atomic_store32_release</a>(&amp;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a1cb428169705ddd63fb35383132dbc40">_memory_global_lock</a>, 0);</div>
<div class="line"><a name="l02986"></a><span class="lineno"> 2986</span>&#160; </div>
<div class="line"><a name="l02987"></a><span class="lineno"> 2987</span>&#160;    <span class="comment">// Initialize this thread</span></div>
<div class="line"><a name="l02988"></a><span class="lineno"> 2988</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#a85a64540090a42380ee6d969ec1897c1">rpmalloc_thread_initialize</a>();</div>
<div class="line"><a name="l02989"></a><span class="lineno"> 2989</span>&#160;    <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l02990"></a><span class="lineno"> 2990</span>&#160;}</div>
<div class="line"><a name="l02991"></a><span class="lineno"> 2991</span>&#160; </div>
<div class="line"><a name="l02993"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#aff58cf54f7ebc5d3d71a2ad80a0dab94"> 2993</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#aff58cf54f7ebc5d3d71a2ad80a0dab94">rpmalloc_finalize</a>(<span class="keywordtype">void</span>)</div>
<div class="line"><a name="l02994"></a><span class="lineno"> 2994</span>&#160;{</div>
<div class="line"><a name="l02995"></a><span class="lineno"> 2995</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#a6e5fc3857f84254caa88503e02bf163c">rpmalloc_thread_finalize</a>(1);</div>
<div class="line"><a name="l02996"></a><span class="lineno"> 2996</span>&#160;    <span class="comment">// rpmalloc_dump_statistics(stdout);</span></div>
<div class="line"><a name="l02997"></a><span class="lineno"> 2997</span>&#160; </div>
<div class="line"><a name="l02998"></a><span class="lineno"> 2998</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="../../df/dc0/rpmalloc_8c.html#a411d5d6c063a099c1a08fa853851b764">_memory_global_reserve</a>)</div>
<div class="line"><a name="l02999"></a><span class="lineno"> 2999</span>&#160;    {</div>
<div class="line"><a name="l03000"></a><span class="lineno"> 3000</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#af327588f7260778f453d9a212396e0e0">atomic_add32</a>(&amp;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a1d5126b78d2bb31fe3476abcd07dd801">_memory_global_reserve_master</a>-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a4aecbd1cbb36425fddd53125ea1a84c7">remaining_spans</a>, -(<a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#a0c18914b3041c2f583aba76f418399c2">int32_t</a>)<a class="code" href="../../df/dc0/rpmalloc_8c.html#a19d785146ca5053c2da69ad1ec4de94c">_memory_global_reserve_count</a>);</div>
<div class="line"><a name="l03001"></a><span class="lineno"> 3001</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#a1d5126b78d2bb31fe3476abcd07dd801">_memory_global_reserve_master</a> = 0;</div>
<div class="line"><a name="l03002"></a><span class="lineno"> 3002</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#a19d785146ca5053c2da69ad1ec4de94c">_memory_global_reserve_count</a> = 0;</div>
<div class="line"><a name="l03003"></a><span class="lineno"> 3003</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#a411d5d6c063a099c1a08fa853851b764">_memory_global_reserve</a> = 0;</div>
<div class="line"><a name="l03004"></a><span class="lineno"> 3004</span>&#160;    }</div>
<div class="line"><a name="l03005"></a><span class="lineno"> 3005</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#a2a87a6060d5387fe8491a00600073687">atomic_store32_release</a>(&amp;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a1cb428169705ddd63fb35383132dbc40">_memory_global_lock</a>, 0);</div>
<div class="line"><a name="l03006"></a><span class="lineno"> 3006</span>&#160; </div>
<div class="line"><a name="l03007"></a><span class="lineno"> 3007</span>&#160;    <span class="comment">// Free all thread caches and fully free spans</span></div>
<div class="line"><a name="l03008"></a><span class="lineno"> 3008</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> list_idx = 0; list_idx &lt; <a class="code" href="../../df/dc0/rpmalloc_8c.html#ac7e4a352a230ef04d4372db43a454b7f">HEAP_ARRAY_SIZE</a>; ++list_idx)</div>
<div class="line"><a name="l03009"></a><span class="lineno"> 3009</span>&#160;    {</div>
<div class="line"><a name="l03010"></a><span class="lineno"> 3010</span>&#160;        <a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#d9/d8a/structheap__t">heap_t</a> *heap = <a class="code" href="../../df/dc0/rpmalloc_8c.html#a3e39052a111a2e243645494f1d6ca439">_memory_heaps</a>[list_idx];</div>
<div class="line"><a name="l03011"></a><span class="lineno"> 3011</span>&#160;        <span class="keywordflow">while</span> (heap)</div>
<div class="line"><a name="l03012"></a><span class="lineno"> 3012</span>&#160;        {</div>
<div class="line"><a name="l03013"></a><span class="lineno"> 3013</span>&#160;            <a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#d9/d8a/structheap__t">heap_t</a> *next_heap = heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a74b47a0eacf313fe421d32379a2b942c">next_heap</a>;</div>
<div class="line"><a name="l03014"></a><span class="lineno"> 3014</span>&#160;            heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a13ccab5430ace95c471aacf1fab0fcd6">finalize</a> = 1;</div>
<div class="line"><a name="l03015"></a><span class="lineno"> 3015</span>&#160;            <a class="code" href="../../df/dc0/rpmalloc_8c.html#a2f7a67a3403fd19a70e7a0418714af57">_rpmalloc_heap_global_finalize</a>(heap);</div>
<div class="line"><a name="l03016"></a><span class="lineno"> 3016</span>&#160;            heap = next_heap;</div>
<div class="line"><a name="l03017"></a><span class="lineno"> 3017</span>&#160;        }</div>
<div class="line"><a name="l03018"></a><span class="lineno"> 3018</span>&#160;    }</div>
<div class="line"><a name="l03019"></a><span class="lineno"> 3019</span>&#160; </div>
<div class="line"><a name="l03020"></a><span class="lineno"> 3020</span>&#160;<span class="preprocessor">#if ENABLE_GLOBAL_CACHE</span></div>
<div class="line"><a name="l03021"></a><span class="lineno"> 3021</span>&#160;    <span class="comment">// Free global caches</span></div>
<div class="line"><a name="l03022"></a><span class="lineno"> 3022</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> iclass = 0; iclass &lt; <a class="code" href="../../df/dc0/rpmalloc_8c.html#a04406da3f5ff4e24f155c97591678ed9">LARGE_CLASS_COUNT</a>; ++iclass)</div>
<div class="line"><a name="l03023"></a><span class="lineno"> 3023</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#ad3b62974f1bafcc293cde80eb05a7abe">_rpmalloc_global_cache_finalize</a>(&amp;<a class="code" href="../../df/dc0/rpmalloc_8c.html#ad7af40ab0c9174515ec06efb45ebdd73">_memory_span_cache</a>[iclass]);</div>
<div class="line"><a name="l03024"></a><span class="lineno"> 3024</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l03025"></a><span class="lineno"> 3025</span>&#160; </div>
<div class="line"><a name="l03026"></a><span class="lineno"> 3026</span>&#160;<span class="preprocessor">#if (defined(__APPLE__) || defined(__HAIKU__)) &amp;&amp; ENABLE_PRELOAD</span></div>
<div class="line"><a name="l03027"></a><span class="lineno"> 3027</span>&#160;    <a class="code" href="../../df/d00/Userspace_2musl_2include_2pthread_8h.html#a8d29d10e1e6b4fa6c05a427bb86fc4cb">pthread_key_delete</a>(<a class="code" href="../../df/dc0/rpmalloc_8c.html#a0c3d121b2c7e431b109863973cff023c">_memory_thread_heap</a>);</div>
<div class="line"><a name="l03028"></a><span class="lineno"> 3028</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l03029"></a><span class="lineno"> 3029</span>&#160;<span class="preprocessor">#if defined(_WIN32) &amp;&amp; (!defined(BUILD_DYNAMIC_LINK) || !BUILD_DYNAMIC_LINK)</span></div>
<div class="line"><a name="l03030"></a><span class="lineno"> 3030</span>&#160;    FlsFree(fls_key);</div>
<div class="line"><a name="l03031"></a><span class="lineno"> 3031</span>&#160;    fls_key = 0;</div>
<div class="line"><a name="l03032"></a><span class="lineno"> 3032</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l03033"></a><span class="lineno"> 3033</span>&#160;<span class="preprocessor">#if ENABLE_STATISTICS</span></div>
<div class="line"><a name="l03034"></a><span class="lineno"> 3034</span>&#160;    <span class="comment">// If you hit these asserts you probably have memory leaks (perhaps global scope data doing dynamic allocations) or double frees in your code</span></div>
<div class="line"><a name="l03035"></a><span class="lineno"> 3035</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#ad008ddf766a4f56fbde2edf2c51d9a87">rpmalloc_assert</a>(atomic_load32(&amp;_mapped_pages) == 0, <span class="stringliteral">&quot;Memory leak detected&quot;</span>);</div>
<div class="line"><a name="l03036"></a><span class="lineno"> 3036</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#ad008ddf766a4f56fbde2edf2c51d9a87">rpmalloc_assert</a>(atomic_load32(&amp;_mapped_pages_os) == 0, <span class="stringliteral">&quot;Memory leak detected&quot;</span>);</div>
<div class="line"><a name="l03037"></a><span class="lineno"> 3037</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l03038"></a><span class="lineno"> 3038</span>&#160; </div>
<div class="line"><a name="l03039"></a><span class="lineno"> 3039</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#a6414f61e9643ce358f1a33e6a2c6aeaa">_rpmalloc_initialized</a> = 0;</div>
<div class="line"><a name="l03040"></a><span class="lineno"> 3040</span>&#160;}</div>
<div class="line"><a name="l03041"></a><span class="lineno"> 3041</span>&#160; </div>
<div class="line"><a name="l03043"></a><span class="lineno"> 3043</span>&#160;<span class="keyword">extern</span> <span class="keyword">inline</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="l03044"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a85a64540090a42380ee6d969ec1897c1"> 3044</a></span>&#160;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a85a64540090a42380ee6d969ec1897c1">rpmalloc_thread_initialize</a>(<span class="keywordtype">void</span>)</div>
<div class="line"><a name="l03045"></a><span class="lineno"> 3045</span>&#160;{</div>
<div class="line"><a name="l03046"></a><span class="lineno"> 3046</span>&#160;    <span class="keywordflow">if</span> (!<a class="code" href="../../df/dc0/rpmalloc_8c.html#af7213260e19fbad385988302247150d4">get_thread_heap_raw</a>())</div>
<div class="line"><a name="l03047"></a><span class="lineno"> 3047</span>&#160;    {</div>
<div class="line"><a name="l03048"></a><span class="lineno"> 3048</span>&#160;        <a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#d9/d8a/structheap__t">heap_t</a> *heap = <a class="code" href="../../df/dc0/rpmalloc_8c.html#a4ca7faed398dff40d231cbce5ebcc845">_rpmalloc_heap_allocate</a>(0);</div>
<div class="line"><a name="l03049"></a><span class="lineno"> 3049</span>&#160;        <span class="keywordflow">if</span> (heap)</div>
<div class="line"><a name="l03050"></a><span class="lineno"> 3050</span>&#160;        {</div>
<div class="line"><a name="l03051"></a><span class="lineno"> 3051</span>&#160;            <a class="code" href="../../df/dc0/rpmalloc_8c.html#ab51bbcd0d9d41ba9c6f4ad547ba77405">_rpmalloc_stat_inc</a>(&amp;_memory_active_heaps);</div>
<div class="line"><a name="l03052"></a><span class="lineno"> 3052</span>&#160;            <a class="code" href="../../df/dc0/rpmalloc_8c.html#a4a224c6ef987eb60f3e3be98239109ec">set_thread_heap</a>(heap);</div>
<div class="line"><a name="l03053"></a><span class="lineno"> 3053</span>&#160;<span class="preprocessor">#if defined(_WIN32) &amp;&amp; (!defined(BUILD_DYNAMIC_LINK) || !BUILD_DYNAMIC_LINK)</span></div>
<div class="line"><a name="l03054"></a><span class="lineno"> 3054</span>&#160;            FlsSetValue(fls_key, heap);</div>
<div class="line"><a name="l03055"></a><span class="lineno"> 3055</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l03056"></a><span class="lineno"> 3056</span>&#160;        }</div>
<div class="line"><a name="l03057"></a><span class="lineno"> 3057</span>&#160;    }</div>
<div class="line"><a name="l03058"></a><span class="lineno"> 3058</span>&#160;}</div>
<div class="line"><a name="l03059"></a><span class="lineno"> 3059</span>&#160; </div>
<div class="line"><a name="l03061"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a6e5fc3857f84254caa88503e02bf163c"> 3061</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#a6e5fc3857f84254caa88503e02bf163c">rpmalloc_thread_finalize</a>(<span class="keywordtype">int</span> release_caches)</div>
<div class="line"><a name="l03062"></a><span class="lineno"> 3062</span>&#160;{</div>
<div class="line"><a name="l03063"></a><span class="lineno"> 3063</span>&#160;    <a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#d9/d8a/structheap__t">heap_t</a> *heap = <a class="code" href="../../df/dc0/rpmalloc_8c.html#af7213260e19fbad385988302247150d4">get_thread_heap_raw</a>();</div>
<div class="line"><a name="l03064"></a><span class="lineno"> 3064</span>&#160;    <span class="keywordflow">if</span> (heap)</div>
<div class="line"><a name="l03065"></a><span class="lineno"> 3065</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#aa378f245dd9ff587c375db42472ac954">_rpmalloc_heap_release_raw</a>(heap, release_caches);</div>
<div class="line"><a name="l03066"></a><span class="lineno"> 3066</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#a4a224c6ef987eb60f3e3be98239109ec">set_thread_heap</a>(0);</div>
<div class="line"><a name="l03067"></a><span class="lineno"> 3067</span>&#160;<span class="preprocessor">#if defined(_WIN32) &amp;&amp; (!defined(BUILD_DYNAMIC_LINK) || !BUILD_DYNAMIC_LINK)</span></div>
<div class="line"><a name="l03068"></a><span class="lineno"> 3068</span>&#160;    FlsSetValue(fls_key, 0);</div>
<div class="line"><a name="l03069"></a><span class="lineno"> 3069</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l03070"></a><span class="lineno"> 3070</span>&#160;}</div>
<div class="line"><a name="l03071"></a><span class="lineno"> 3071</span>&#160; </div>
<div class="line"><a name="l03072"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a6f18b8696daac522d93e448aadd7cd4b"> 3072</a></span>&#160;<span class="keywordtype">int</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#a6f18b8696daac522d93e448aadd7cd4b">rpmalloc_is_thread_initialized</a>(<span class="keywordtype">void</span>)</div>
<div class="line"><a name="l03073"></a><span class="lineno"> 3073</span>&#160;{</div>
<div class="line"><a name="l03074"></a><span class="lineno"> 3074</span>&#160;    <span class="keywordflow">return</span> (<a class="code" href="../../df/dc0/rpmalloc_8c.html#af7213260e19fbad385988302247150d4">get_thread_heap_raw</a>() != 0) ? 1 : 0;</div>
<div class="line"><a name="l03075"></a><span class="lineno"> 3075</span>&#160;}</div>
<div class="line"><a name="l03076"></a><span class="lineno"> 3076</span>&#160; </div>
<div class="line"><a name="l03077"></a><span class="lineno"> 3077</span>&#160;<span class="keyword">const</span> <a class="code" href="../../df/d42/structrpmalloc__config__t.html">rpmalloc_config_t</a> *</div>
<div class="line"><a name="l03078"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#afed57ac88686e15e2d9cee4743e31857"> 3078</a></span>&#160;<a class="code" href="../../df/dc0/rpmalloc_8c.html#afed57ac88686e15e2d9cee4743e31857">rpmalloc_config</a>(<span class="keywordtype">void</span>)</div>
<div class="line"><a name="l03079"></a><span class="lineno"> 3079</span>&#160;{</div>
<div class="line"><a name="l03080"></a><span class="lineno"> 3080</span>&#160;    <span class="keywordflow">return</span> &amp;<a class="code" href="../../df/dc0/rpmalloc_8c.html#ae1f1297fe3d143e41deac95ee7a7f8d4">_memory_config</a>;</div>
<div class="line"><a name="l03081"></a><span class="lineno"> 3081</span>&#160;}</div>
<div class="line"><a name="l03082"></a><span class="lineno"> 3082</span>&#160; </div>
<div class="line"><a name="l03083"></a><span class="lineno"> 3083</span>&#160;<span class="comment">// Extern interface</span></div>
<div class="line"><a name="l03084"></a><span class="lineno"> 3084</span>&#160; </div>
<div class="line"><a name="l03085"></a><span class="lineno"> 3085</span>&#160;<span class="keyword">extern</span> <span class="keyword">inline</span> <a class="code" href="../../d2/d43/rpmalloc_8h.html#a85561f3ac6a729bf480cdf706d6c75dc">RPMALLOC_ALLOCATOR</a> <span class="keywordtype">void</span> *</div>
<div class="line"><a name="l03086"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#af330a53810a7e9a1d2a151bc229a9dc4"> 3086</a></span>&#160;<a class="code" href="../../df/dc0/rpmalloc_8c.html#af330a53810a7e9a1d2a151bc229a9dc4">rpmalloc</a>(<span class="keywordtype">size_t</span> <a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a>)</div>
<div class="line"><a name="l03087"></a><span class="lineno"> 3087</span>&#160;{</div>
<div class="line"><a name="l03088"></a><span class="lineno"> 3088</span>&#160;<span class="preprocessor">#if ENABLE_VALIDATE_ARGS</span></div>
<div class="line"><a name="l03089"></a><span class="lineno"> 3089</span>&#160;    <a class="code" href="../../dc/d6b/Kernel_2include__std_2assert_8h.html#af576bf8ffa22a44e53018c67095ffbf0">assert</a>(<a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a> &lt; <a class="code" href="../../df/dc0/rpmalloc_8c.html#a6ea14607e2b19ee5aa336addd0fdde01">MAX_ALLOC_SIZE</a>);</div>
<div class="line"><a name="l03090"></a><span class="lineno"> 3090</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l03091"></a><span class="lineno"> 3091</span>&#160;    <a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#d9/d8a/structheap__t">heap_t</a> *heap = <a class="code" href="../../df/dc0/rpmalloc_8c.html#ae75d84f0a9ac27b96d18fcd652249cda">get_thread_heap</a>();</div>
<div class="line"><a name="l03092"></a><span class="lineno"> 3092</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#af8bd0cd08a93d20cb117e18d85f877cd">_rpmalloc_allocate</a>(heap, <a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a>);</div>
<div class="line"><a name="l03093"></a><span class="lineno"> 3093</span>&#160;}</div>
<div class="line"><a name="l03094"></a><span class="lineno"> 3094</span>&#160; </div>
<div class="line"><a name="l03095"></a><span class="lineno"> 3095</span>&#160;<span class="keyword">extern</span> <span class="keyword">inline</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="l03096"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a19186eb24d08ef02b924951abb865b51"> 3096</a></span>&#160;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a19186eb24d08ef02b924951abb865b51">rpfree</a>(<span class="keywordtype">void</span> *ptr)</div>
<div class="line"><a name="l03097"></a><span class="lineno"> 3097</span>&#160;{</div>
<div class="line"><a name="l03098"></a><span class="lineno"> 3098</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#ae324fa158db468143544693dfe539800">_rpmalloc_deallocate</a>(ptr);</div>
<div class="line"><a name="l03099"></a><span class="lineno"> 3099</span>&#160;}</div>
<div class="line"><a name="l03100"></a><span class="lineno"> 3100</span>&#160; </div>
<div class="line"><a name="l03101"></a><span class="lineno"> 3101</span>&#160;<span class="keyword">extern</span> <span class="keyword">inline</span> <a class="code" href="../../d2/d43/rpmalloc_8h.html#a85561f3ac6a729bf480cdf706d6c75dc">RPMALLOC_ALLOCATOR</a> <span class="keywordtype">void</span> *</div>
<div class="line"><a name="l03102"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a2aaa6595462b280c7c95e7804ab6f9fd"> 3102</a></span>&#160;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a2aaa6595462b280c7c95e7804ab6f9fd">rpcalloc</a>(<span class="keywordtype">size_t</span> <a class="code" href="../../d7/da1/fma_8c.html#d6/df8/structnum">num</a>, <span class="keywordtype">size_t</span> <a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a>)</div>
<div class="line"><a name="l03103"></a><span class="lineno"> 3103</span>&#160;{</div>
<div class="line"><a name="l03104"></a><span class="lineno"> 3104</span>&#160;    <span class="keywordtype">size_t</span> <a class="code" href="../../d6/d23/wi__stuff_8c.html#a81ad3ca73b21fc89fbb692189bb4031b">total</a>;</div>
<div class="line"><a name="l03105"></a><span class="lineno"> 3105</span>&#160;<span class="preprocessor">#if ENABLE_VALIDATE_ARGS</span></div>
<div class="line"><a name="l03106"></a><span class="lineno"> 3106</span>&#160;    <span class="keywordtype">int</span> <a class="code" href="../../d6/d40/err_8h.html#aa31bca214cc8f135a43aa7fbea017326">err</a> = __builtin_umull_overflow(<a class="code" href="../../d7/da1/fma_8c.html#d6/df8/structnum">num</a>, <a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a>, &amp;<a class="code" href="../../d6/d23/wi__stuff_8c.html#a81ad3ca73b21fc89fbb692189bb4031b">total</a>);</div>
<div class="line"><a name="l03107"></a><span class="lineno"> 3107</span>&#160;    <a class="code" href="../../dc/d6b/Kernel_2include__std_2assert_8h.html#af576bf8ffa22a44e53018c67095ffbf0">assert</a>(!<a class="code" href="../../d6/d40/err_8h.html#aa31bca214cc8f135a43aa7fbea017326">err</a> &amp;&amp; (<a class="code" href="../../d6/d23/wi__stuff_8c.html#a81ad3ca73b21fc89fbb692189bb4031b">total</a> &lt; <a class="code" href="../../df/dc0/rpmalloc_8c.html#a6ea14607e2b19ee5aa336addd0fdde01">MAX_ALLOC_SIZE</a>));</div>
<div class="line"><a name="l03108"></a><span class="lineno"> 3108</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l03109"></a><span class="lineno"> 3109</span>&#160;    <a class="code" href="../../d6/d23/wi__stuff_8c.html#a81ad3ca73b21fc89fbb692189bb4031b">total</a> = <a class="code" href="../../d7/da1/fma_8c.html#d6/df8/structnum">num</a> * <a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a>;</div>
<div class="line"><a name="l03110"></a><span class="lineno"> 3110</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l03111"></a><span class="lineno"> 3111</span>&#160;    <a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#d9/d8a/structheap__t">heap_t</a> *heap = <a class="code" href="../../df/dc0/rpmalloc_8c.html#ae75d84f0a9ac27b96d18fcd652249cda">get_thread_heap</a>();</div>
<div class="line"><a name="l03112"></a><span class="lineno"> 3112</span>&#160;    <span class="keywordtype">void</span> *block = <a class="code" href="../../df/dc0/rpmalloc_8c.html#af8bd0cd08a93d20cb117e18d85f877cd">_rpmalloc_allocate</a>(heap, <a class="code" href="../../d6/d23/wi__stuff_8c.html#a81ad3ca73b21fc89fbb692189bb4031b">total</a>);</div>
<div class="line"><a name="l03113"></a><span class="lineno"> 3113</span>&#160;    <span class="keywordflow">if</span> (block)</div>
<div class="line"><a name="l03114"></a><span class="lineno"> 3114</span>&#160;        <a class="code" href="../../d3/d82/convert_8h.html#a9c1f204516a55affa9ba118907e5ab6b">memset_unsafe</a>(block, 0, <a class="code" href="../../d6/d23/wi__stuff_8c.html#a81ad3ca73b21fc89fbb692189bb4031b">total</a>);</div>
<div class="line"><a name="l03115"></a><span class="lineno"> 3115</span>&#160;    <span class="keywordflow">return</span> block;</div>
<div class="line"><a name="l03116"></a><span class="lineno"> 3116</span>&#160;}</div>
<div class="line"><a name="l03117"></a><span class="lineno"> 3117</span>&#160; </div>
<div class="line"><a name="l03118"></a><span class="lineno"> 3118</span>&#160;<span class="keyword">extern</span> <span class="keyword">inline</span> <a class="code" href="../../d2/d43/rpmalloc_8h.html#a85561f3ac6a729bf480cdf706d6c75dc">RPMALLOC_ALLOCATOR</a> <span class="keywordtype">void</span> *</div>
<div class="line"><a name="l03119"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a240396bd63b0822a9ec0ade52cab44b2"> 3119</a></span>&#160;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a240396bd63b0822a9ec0ade52cab44b2">rprealloc</a>(<span class="keywordtype">void</span> *ptr, <span class="keywordtype">size_t</span> <a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a>)</div>
<div class="line"><a name="l03120"></a><span class="lineno"> 3120</span>&#160;{</div>
<div class="line"><a name="l03121"></a><span class="lineno"> 3121</span>&#160;<span class="preprocessor">#if ENABLE_VALIDATE_ARGS</span></div>
<div class="line"><a name="l03122"></a><span class="lineno"> 3122</span>&#160;    <a class="code" href="../../dc/d6b/Kernel_2include__std_2assert_8h.html#af576bf8ffa22a44e53018c67095ffbf0">assert</a>(<a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a> &lt; <a class="code" href="../../df/dc0/rpmalloc_8c.html#a6ea14607e2b19ee5aa336addd0fdde01">MAX_ALLOC_SIZE</a>);</div>
<div class="line"><a name="l03123"></a><span class="lineno"> 3123</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l03124"></a><span class="lineno"> 3124</span>&#160;    <a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#d9/d8a/structheap__t">heap_t</a> *heap = <a class="code" href="../../df/dc0/rpmalloc_8c.html#ae75d84f0a9ac27b96d18fcd652249cda">get_thread_heap</a>();</div>
<div class="line"><a name="l03125"></a><span class="lineno"> 3125</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#a5c46183a2d82b761e9438c65b0dbad62">_rpmalloc_reallocate</a>(heap, ptr, <a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a>, 0, 0);</div>
<div class="line"><a name="l03126"></a><span class="lineno"> 3126</span>&#160;}</div>
<div class="line"><a name="l03127"></a><span class="lineno"> 3127</span>&#160; </div>
<div class="line"><a name="l03128"></a><span class="lineno"> 3128</span>&#160;<span class="keyword">extern</span> <a class="code" href="../../d2/d43/rpmalloc_8h.html#a85561f3ac6a729bf480cdf706d6c75dc">RPMALLOC_ALLOCATOR</a> <span class="keywordtype">void</span> *</div>
<div class="line"><a name="l03129"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a91e8ecc3f466b065c5d14e8506b47e3f"> 3129</a></span>&#160;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a91e8ecc3f466b065c5d14e8506b47e3f">rpaligned_realloc</a>(<span class="keywordtype">void</span> *ptr, <span class="keywordtype">size_t</span> alignment, <span class="keywordtype">size_t</span> <a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a>, <span class="keywordtype">size_t</span> oldsize,</div>
<div class="line"><a name="l03130"></a><span class="lineno"> 3130</span>&#160;                  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> flags)</div>
<div class="line"><a name="l03131"></a><span class="lineno"> 3131</span>&#160;{</div>
<div class="line"><a name="l03132"></a><span class="lineno"> 3132</span>&#160;<span class="preprocessor">#if ENABLE_VALIDATE_ARGS</span></div>
<div class="line"><a name="l03133"></a><span class="lineno"> 3133</span>&#160;    <a class="code" href="../../dc/d6b/Kernel_2include__std_2assert_8h.html#af576bf8ffa22a44e53018c67095ffbf0">assert</a>((<a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a> + alignment) &gt;= <a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a> &amp;&amp; (alignment &lt;= <a class="code" href="../../df/dc0/rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a>));</div>
<div class="line"><a name="l03134"></a><span class="lineno"> 3134</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l03135"></a><span class="lineno"> 3135</span>&#160;    <a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#d9/d8a/structheap__t">heap_t</a> *heap = <a class="code" href="../../df/dc0/rpmalloc_8c.html#ae75d84f0a9ac27b96d18fcd652249cda">get_thread_heap</a>();</div>
<div class="line"><a name="l03136"></a><span class="lineno"> 3136</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#a0d0546abbe1244019d00ecf28aac359c">_rpmalloc_aligned_reallocate</a>(heap, ptr, alignment, <a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a>, oldsize, flags);</div>
<div class="line"><a name="l03137"></a><span class="lineno"> 3137</span>&#160;}</div>
<div class="line"><a name="l03138"></a><span class="lineno"> 3138</span>&#160; </div>
<div class="line"><a name="l03139"></a><span class="lineno"> 3139</span>&#160;<span class="keyword">extern</span> <a class="code" href="../../d2/d43/rpmalloc_8h.html#a85561f3ac6a729bf480cdf706d6c75dc">RPMALLOC_ALLOCATOR</a> <span class="keywordtype">void</span> *</div>
<div class="line"><a name="l03140"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#af696dfc58704b5b75dc6b0a02c6fed66"> 3140</a></span>&#160;<a class="code" href="../../df/dc0/rpmalloc_8c.html#af696dfc58704b5b75dc6b0a02c6fed66">rpaligned_alloc</a>(<span class="keywordtype">size_t</span> alignment, <span class="keywordtype">size_t</span> <a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a>)</div>
<div class="line"><a name="l03141"></a><span class="lineno"> 3141</span>&#160;{</div>
<div class="line"><a name="l03142"></a><span class="lineno"> 3142</span>&#160;    <a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#d9/d8a/structheap__t">heap_t</a> *heap = <a class="code" href="../../df/dc0/rpmalloc_8c.html#ae75d84f0a9ac27b96d18fcd652249cda">get_thread_heap</a>();</div>
<div class="line"><a name="l03143"></a><span class="lineno"> 3143</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#a4be7846b7aabc5b469a4cc66dbc6fb36">_rpmalloc_aligned_allocate</a>(heap, alignment, <a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a>);</div>
<div class="line"><a name="l03144"></a><span class="lineno"> 3144</span>&#160;}</div>
<div class="line"><a name="l03145"></a><span class="lineno"> 3145</span>&#160; </div>
<div class="line"><a name="l03146"></a><span class="lineno"> 3146</span>&#160;<span class="keyword">extern</span> <span class="keyword">inline</span> <a class="code" href="../../d2/d43/rpmalloc_8h.html#a85561f3ac6a729bf480cdf706d6c75dc">RPMALLOC_ALLOCATOR</a> <span class="keywordtype">void</span> *</div>
<div class="line"><a name="l03147"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#afa1244471261835d7a8a2fa23464834b"> 3147</a></span>&#160;<a class="code" href="../../df/dc0/rpmalloc_8c.html#afa1244471261835d7a8a2fa23464834b">rpaligned_calloc</a>(<span class="keywordtype">size_t</span> alignment, <span class="keywordtype">size_t</span> <a class="code" href="../../d7/da1/fma_8c.html#d6/df8/structnum">num</a>, <span class="keywordtype">size_t</span> <a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a>)</div>
<div class="line"><a name="l03148"></a><span class="lineno"> 3148</span>&#160;{</div>
<div class="line"><a name="l03149"></a><span class="lineno"> 3149</span>&#160;    <span class="keywordtype">size_t</span> <a class="code" href="../../d6/d23/wi__stuff_8c.html#a81ad3ca73b21fc89fbb692189bb4031b">total</a>;</div>
<div class="line"><a name="l03150"></a><span class="lineno"> 3150</span>&#160;<span class="preprocessor">#if ENABLE_VALIDATE_ARGS</span></div>
<div class="line"><a name="l03151"></a><span class="lineno"> 3151</span>&#160;    <span class="keywordtype">int</span> <a class="code" href="../../d6/d40/err_8h.html#aa31bca214cc8f135a43aa7fbea017326">err</a> = __builtin_umull_overflow(<a class="code" href="../../d7/da1/fma_8c.html#d6/df8/structnum">num</a>, <a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a>, &amp;<a class="code" href="../../d6/d23/wi__stuff_8c.html#a81ad3ca73b21fc89fbb692189bb4031b">total</a>);</div>
<div class="line"><a name="l03152"></a><span class="lineno"> 3152</span>&#160;    <a class="code" href="../../dc/d6b/Kernel_2include__std_2assert_8h.html#af576bf8ffa22a44e53018c67095ffbf0">assert</a>(!<a class="code" href="../../d6/d40/err_8h.html#aa31bca214cc8f135a43aa7fbea017326">err</a> &amp;&amp; (<a class="code" href="../../d6/d23/wi__stuff_8c.html#a81ad3ca73b21fc89fbb692189bb4031b">total</a> &lt; <a class="code" href="../../df/dc0/rpmalloc_8c.html#a6ea14607e2b19ee5aa336addd0fdde01">MAX_ALLOC_SIZE</a>));</div>
<div class="line"><a name="l03153"></a><span class="lineno"> 3153</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l03154"></a><span class="lineno"> 3154</span>&#160;    <a class="code" href="../../d6/d23/wi__stuff_8c.html#a81ad3ca73b21fc89fbb692189bb4031b">total</a> = <a class="code" href="../../d7/da1/fma_8c.html#d6/df8/structnum">num</a> * <a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a>;</div>
<div class="line"><a name="l03155"></a><span class="lineno"> 3155</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l03156"></a><span class="lineno"> 3156</span>&#160;    <span class="keywordtype">void</span> *block = <a class="code" href="../../df/dc0/rpmalloc_8c.html#af696dfc58704b5b75dc6b0a02c6fed66">rpaligned_alloc</a>(alignment, <a class="code" href="../../d6/d23/wi__stuff_8c.html#a81ad3ca73b21fc89fbb692189bb4031b">total</a>);</div>
<div class="line"><a name="l03157"></a><span class="lineno"> 3157</span>&#160;    <span class="keywordflow">if</span> (block)</div>
<div class="line"><a name="l03158"></a><span class="lineno"> 3158</span>&#160;        <a class="code" href="../../d3/d82/convert_8h.html#a9c1f204516a55affa9ba118907e5ab6b">memset_unsafe</a>(block, 0, <a class="code" href="../../d6/d23/wi__stuff_8c.html#a81ad3ca73b21fc89fbb692189bb4031b">total</a>);</div>
<div class="line"><a name="l03159"></a><span class="lineno"> 3159</span>&#160;    <span class="keywordflow">return</span> block;</div>
<div class="line"><a name="l03160"></a><span class="lineno"> 3160</span>&#160;}</div>
<div class="line"><a name="l03161"></a><span class="lineno"> 3161</span>&#160; </div>
<div class="line"><a name="l03162"></a><span class="lineno"> 3162</span>&#160;<span class="keyword">extern</span> <span class="keyword">inline</span> <a class="code" href="../../d2/d43/rpmalloc_8h.html#a85561f3ac6a729bf480cdf706d6c75dc">RPMALLOC_ALLOCATOR</a> <span class="keywordtype">void</span> *</div>
<div class="line"><a name="l03163"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a7f0d32d7a842d13c6a15e4ddae3814eb"> 3163</a></span>&#160;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a7f0d32d7a842d13c6a15e4ddae3814eb">rpmemalign</a>(<span class="keywordtype">size_t</span> alignment, <span class="keywordtype">size_t</span> <a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a>)</div>
<div class="line"><a name="l03164"></a><span class="lineno"> 3164</span>&#160;{</div>
<div class="line"><a name="l03165"></a><span class="lineno"> 3165</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#af696dfc58704b5b75dc6b0a02c6fed66">rpaligned_alloc</a>(alignment, <a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a>);</div>
<div class="line"><a name="l03166"></a><span class="lineno"> 3166</span>&#160;}</div>
<div class="line"><a name="l03167"></a><span class="lineno"> 3167</span>&#160; </div>
<div class="line"><a name="l03168"></a><span class="lineno"> 3168</span>&#160;<span class="keyword">extern</span> <span class="keyword">inline</span> <span class="keywordtype">int</span></div>
<div class="line"><a name="l03169"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#ae6f35022f9384e2a22ed2b96c00995b2"> 3169</a></span>&#160;<a class="code" href="../../df/dc0/rpmalloc_8c.html#ae6f35022f9384e2a22ed2b96c00995b2">rpposix_memalign</a>(<span class="keywordtype">void</span> **memptr, <span class="keywordtype">size_t</span> alignment, <span class="keywordtype">size_t</span> <a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a>)</div>
<div class="line"><a name="l03170"></a><span class="lineno"> 3170</span>&#160;{</div>
<div class="line"><a name="l03171"></a><span class="lineno"> 3171</span>&#160;    <span class="keywordflow">if</span> (memptr)</div>
<div class="line"><a name="l03172"></a><span class="lineno"> 3172</span>&#160;        *memptr = <a class="code" href="../../df/dc0/rpmalloc_8c.html#af696dfc58704b5b75dc6b0a02c6fed66">rpaligned_alloc</a>(alignment, <a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a>);</div>
<div class="line"><a name="l03173"></a><span class="lineno"> 3173</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l03174"></a><span class="lineno"> 3174</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="../../df/d53/Userspace_2libc_2include_2errno_8h.html#a2d1678d5a7cc8ce499643f3b8957def4">EINVAL</a>;</div>
<div class="line"><a name="l03175"></a><span class="lineno"> 3175</span>&#160;    <span class="keywordflow">return</span> *memptr ? 0 : <a class="code" href="../../df/d53/Userspace_2libc_2include_2errno_8h.html#a6a05c923dad0c1208043e9c20a58c8e5">ENOMEM</a>;</div>
<div class="line"><a name="l03176"></a><span class="lineno"> 3176</span>&#160;}</div>
<div class="line"><a name="l03177"></a><span class="lineno"> 3177</span>&#160; </div>
<div class="line"><a name="l03178"></a><span class="lineno"> 3178</span>&#160;<span class="keyword">extern</span> <span class="keyword">inline</span> <span class="keywordtype">size_t</span></div>
<div class="line"><a name="l03179"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a7a9f597c853963de259b40e985d81113"> 3179</a></span>&#160;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a7a9f597c853963de259b40e985d81113">rpmalloc_usable_size</a>(<span class="keywordtype">void</span> *ptr)</div>
<div class="line"><a name="l03180"></a><span class="lineno"> 3180</span>&#160;{</div>
<div class="line"><a name="l03181"></a><span class="lineno"> 3181</span>&#160;    <span class="keywordflow">return</span> (ptr ? <a class="code" href="../../df/dc0/rpmalloc_8c.html#adc5743a6b15192da5b7e023f85360208">_rpmalloc_usable_size</a>(ptr) : 0);</div>
<div class="line"><a name="l03182"></a><span class="lineno"> 3182</span>&#160;}</div>
<div class="line"><a name="l03183"></a><span class="lineno"> 3183</span>&#160; </div>
<div class="line"><a name="l03184"></a><span class="lineno"> 3184</span>&#160;<span class="keyword">extern</span> <span class="keyword">inline</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="l03185"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a6db2d5852bc3af5ee8bbbfae2db30997"> 3185</a></span>&#160;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a6db2d5852bc3af5ee8bbbfae2db30997">rpmalloc_thread_collect</a>(<span class="keywordtype">void</span>)</div>
<div class="line"><a name="l03186"></a><span class="lineno"> 3186</span>&#160;{</div>
<div class="line"><a name="l03187"></a><span class="lineno"> 3187</span>&#160;}</div>
<div class="line"><a name="l03188"></a><span class="lineno"> 3188</span>&#160; </div>
<div class="line"><a name="l03189"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#acb3289e60a1c405dbb154dce3f3d6c7a"> 3189</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#acb3289e60a1c405dbb154dce3f3d6c7a">rpmalloc_thread_statistics</a>(<a class="code" href="../../d2/d43/rpmalloc_8h.html#d0/d25/structrpmalloc__thread__statistics__t">rpmalloc_thread_statistics_t</a> *stats)</div>
<div class="line"><a name="l03190"></a><span class="lineno"> 3190</span>&#160;{</div>
<div class="line"><a name="l03191"></a><span class="lineno"> 3191</span>&#160;    <a class="code" href="../../d3/d82/convert_8h.html#a9c1f204516a55affa9ba118907e5ab6b">memset_unsafe</a>(stats, 0, <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d43/rpmalloc_8h.html#d0/d25/structrpmalloc__thread__statistics__t">rpmalloc_thread_statistics_t</a>));</div>
<div class="line"><a name="l03192"></a><span class="lineno"> 3192</span>&#160;    <a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#d9/d8a/structheap__t">heap_t</a> *heap = <a class="code" href="../../df/dc0/rpmalloc_8c.html#af7213260e19fbad385988302247150d4">get_thread_heap_raw</a>();</div>
<div class="line"><a name="l03193"></a><span class="lineno"> 3193</span>&#160;    <span class="keywordflow">if</span> (!heap)</div>
<div class="line"><a name="l03194"></a><span class="lineno"> 3194</span>&#160;        <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l03195"></a><span class="lineno"> 3195</span>&#160; </div>
<div class="line"><a name="l03196"></a><span class="lineno"> 3196</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> iclass = 0; iclass &lt; <a class="code" href="../../df/dc0/rpmalloc_8c.html#aa74d427b2b9955ff2d9719693d9fc80e">SIZE_CLASS_COUNT</a>; ++iclass)</div>
<div class="line"><a name="l03197"></a><span class="lineno"> 3197</span>&#160;    {</div>
<div class="line"><a name="l03198"></a><span class="lineno"> 3198</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#d2/daa/structsize__class__t">size_class_t</a> *size_class = <a class="code" href="../../df/dc0/rpmalloc_8c.html#a33cddb08b9ee0f969cc82dbf9cddb947">_memory_size_class</a> + iclass;</div>
<div class="line"><a name="l03199"></a><span class="lineno"> 3199</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *span = heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a70f9a96b9071ccb6642894f5a7f56432">size_class</a>[iclass].<a class="code" href="../../df/dc0/rpmalloc_8c.html#af829c49d9fc4d933c14113ba0d694e7c">partial_span</a>;</div>
<div class="line"><a name="l03200"></a><span class="lineno"> 3200</span>&#160;        <span class="keywordflow">while</span> (span)</div>
<div class="line"><a name="l03201"></a><span class="lineno"> 3201</span>&#160;        {</div>
<div class="line"><a name="l03202"></a><span class="lineno"> 3202</span>&#160;            <span class="keywordtype">size_t</span> free_count = span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#ad842dbc76a30fb5beee77a2d773a3e91">list_size</a>;</div>
<div class="line"><a name="l03203"></a><span class="lineno"> 3203</span>&#160;            <span class="keywordtype">size_t</span> block_count = size_class-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#aeded978bd21c13b71d9b0310b5bb09ec">block_count</a>;</div>
<div class="line"><a name="l03204"></a><span class="lineno"> 3204</span>&#160;            <span class="keywordflow">if</span> (span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#af093d9cb1719d72c20f96a9b467590f5">free_list_limit</a> &lt; block_count)</div>
<div class="line"><a name="l03205"></a><span class="lineno"> 3205</span>&#160;                block_count = span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#af093d9cb1719d72c20f96a9b467590f5">free_list_limit</a>;</div>
<div class="line"><a name="l03206"></a><span class="lineno"> 3206</span>&#160;            free_count += (block_count - span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#abf4fa6f8f0e7baff0d6a7a96df58bcca">used_count</a>);</div>
<div class="line"><a name="l03207"></a><span class="lineno"> 3207</span>&#160;            stats-&gt;<a class="code" href="../../d2/d43/rpmalloc_8h.html#ae1b16b8970cd1354befab4f0e4b993ac">sizecache</a> = free_count * size_class-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a007fc7dd52ba1f95d9a6ce88f47a614b">block_size</a>;</div>
<div class="line"><a name="l03208"></a><span class="lineno"> 3208</span>&#160;            span = span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#ac62e0e77eb38ebff4443eb5db3ccd45c">next</a>;</div>
<div class="line"><a name="l03209"></a><span class="lineno"> 3209</span>&#160;        }</div>
<div class="line"><a name="l03210"></a><span class="lineno"> 3210</span>&#160;    }</div>
<div class="line"><a name="l03211"></a><span class="lineno"> 3211</span>&#160; </div>
<div class="line"><a name="l03212"></a><span class="lineno"> 3212</span>&#160;<span class="preprocessor">#if ENABLE_THREAD_CACHE</span></div>
<div class="line"><a name="l03213"></a><span class="lineno"> 3213</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> iclass = 0; iclass &lt; <a class="code" href="../../df/dc0/rpmalloc_8c.html#a04406da3f5ff4e24f155c97591678ed9">LARGE_CLASS_COUNT</a>; ++iclass)</div>
<div class="line"><a name="l03214"></a><span class="lineno"> 3214</span>&#160;    {</div>
<div class="line"><a name="l03215"></a><span class="lineno"> 3215</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#da/d15/structspan__cache__t">span_cache_t</a> *span_cache;</div>
<div class="line"><a name="l03216"></a><span class="lineno"> 3216</span>&#160;        <span class="keywordflow">if</span> (!iclass)</div>
<div class="line"><a name="l03217"></a><span class="lineno"> 3217</span>&#160;            span_cache = &amp;heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#ae112aace519bbe14edb9127cefb59705">span_cache</a>;</div>
<div class="line"><a name="l03218"></a><span class="lineno"> 3218</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l03219"></a><span class="lineno"> 3219</span>&#160;            span_cache = (<a class="code" href="../../df/dc0/rpmalloc_8c.html#da/d15/structspan__cache__t">span_cache_t</a> *)(heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#aea02bb1ed60acc428d5a2d2db2cd9a7b">span_large_cache</a> + (iclass - 1));</div>
<div class="line"><a name="l03220"></a><span class="lineno"> 3220</span>&#160;        stats-&gt;<a class="code" href="../../d2/d43/rpmalloc_8h.html#af75f9eeddb63a098824a555506334c8a">spancache</a> = span_cache-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a894a66f329862f01de7619aee1954d19">count</a> * (iclass + 1) * <a class="code" href="../../df/dc0/rpmalloc_8c.html#a9fefa5277fefa0c58f69d5b86d679ccb">_memory_span_size</a>;</div>
<div class="line"><a name="l03221"></a><span class="lineno"> 3221</span>&#160;    }</div>
<div class="line"><a name="l03222"></a><span class="lineno"> 3222</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l03223"></a><span class="lineno"> 3223</span>&#160; </div>
<div class="line"><a name="l03224"></a><span class="lineno"> 3224</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *deferred = (<a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *)<a class="code" href="../../df/dc0/rpmalloc_8c.html#a83ddc23debb02a3c47f0b00939fc8f35">atomic_load_ptr</a>(&amp;heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a354c0beb35fd982bc4dbd3783b2dd1ff">span_free_deferred</a>);</div>
<div class="line"><a name="l03225"></a><span class="lineno"> 3225</span>&#160;    <span class="keywordflow">while</span> (deferred)</div>
<div class="line"><a name="l03226"></a><span class="lineno"> 3226</span>&#160;    {</div>
<div class="line"><a name="l03227"></a><span class="lineno"> 3227</span>&#160;        <span class="keywordflow">if</span> (deferred-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a5a977febdd2e9ae15bcf66f83d0cf817">size_class</a> != <a class="code" href="../../df/dc0/rpmalloc_8c.html#a284460248778c94b6ee9ea1529299439">SIZE_CLASS_HUGE</a>)</div>
<div class="line"><a name="l03228"></a><span class="lineno"> 3228</span>&#160;            stats-&gt;<a class="code" href="../../d2/d43/rpmalloc_8h.html#af75f9eeddb63a098824a555506334c8a">spancache</a> = (<a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#aa9d55e2f20e580b7445617d0d12fff6e">size_t</a>)deferred-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#ae77d9a2cdd2a2fd46e3b27739d6c88cc">span_count</a> * <a class="code" href="../../df/dc0/rpmalloc_8c.html#a9fefa5277fefa0c58f69d5b86d679ccb">_memory_span_size</a>;</div>
<div class="line"><a name="l03229"></a><span class="lineno"> 3229</span>&#160;        deferred = (<a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *)deferred-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a85527ad364915bcb39b7d421524d0bd6">free_list</a>;</div>
<div class="line"><a name="l03230"></a><span class="lineno"> 3230</span>&#160;    }</div>
<div class="line"><a name="l03231"></a><span class="lineno"> 3231</span>&#160; </div>
<div class="line"><a name="l03232"></a><span class="lineno"> 3232</span>&#160;<span class="preprocessor">#if ENABLE_STATISTICS</span></div>
<div class="line"><a name="l03233"></a><span class="lineno"> 3233</span>&#160;    stats-&gt;<a class="code" href="../../d2/d43/rpmalloc_8h.html#affc9a9b9fff3b494c0f0dd63884be0e4">thread_to_global</a> = (<a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#aa9d55e2f20e580b7445617d0d12fff6e">size_t</a>)<a class="code" href="../../df/dc0/rpmalloc_8c.html#a083ecd4af0f476009595e8ee78cf2ac0">atomic_load64</a>(&amp;heap-&gt;thread_to_global);</div>
<div class="line"><a name="l03234"></a><span class="lineno"> 3234</span>&#160;    stats-&gt;<a class="code" href="../../d2/d43/rpmalloc_8h.html#a29f83756e4d2a2bdebcfdfc8a8908081">global_to_thread</a> = (<a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#aa9d55e2f20e580b7445617d0d12fff6e">size_t</a>)<a class="code" href="../../df/dc0/rpmalloc_8c.html#a083ecd4af0f476009595e8ee78cf2ac0">atomic_load64</a>(&amp;heap-&gt;global_to_thread);</div>
<div class="line"><a name="l03235"></a><span class="lineno"> 3235</span>&#160; </div>
<div class="line"><a name="l03236"></a><span class="lineno"> 3236</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> iclass = 0; iclass &lt; <a class="code" href="../../df/dc0/rpmalloc_8c.html#a04406da3f5ff4e24f155c97591678ed9">LARGE_CLASS_COUNT</a>; ++iclass)</div>
<div class="line"><a name="l03237"></a><span class="lineno"> 3237</span>&#160;    {</div>
<div class="line"><a name="l03238"></a><span class="lineno"> 3238</span>&#160;        stats-&gt;<a class="code" href="../../d2/d43/rpmalloc_8h.html#a5d0cd8aecab18855e794487437dc593a">span_use</a>[iclass].current = (<a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#aa9d55e2f20e580b7445617d0d12fff6e">size_t</a>)atomic_load32(&amp;heap-&gt;span_use[iclass].current);</div>
<div class="line"><a name="l03239"></a><span class="lineno"> 3239</span>&#160;        stats-&gt;<a class="code" href="../../d2/d43/rpmalloc_8h.html#a5d0cd8aecab18855e794487437dc593a">span_use</a>[iclass].peak = (<a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#aa9d55e2f20e580b7445617d0d12fff6e">size_t</a>)atomic_load32(&amp;heap-&gt;span_use[iclass].high);</div>
<div class="line"><a name="l03240"></a><span class="lineno"> 3240</span>&#160;        stats-&gt;<a class="code" href="../../d2/d43/rpmalloc_8h.html#a5d0cd8aecab18855e794487437dc593a">span_use</a>[iclass].to_global = (<a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#aa9d55e2f20e580b7445617d0d12fff6e">size_t</a>)atomic_load32(&amp;heap-&gt;span_use[iclass].spans_to_global);</div>
<div class="line"><a name="l03241"></a><span class="lineno"> 3241</span>&#160;        stats-&gt;<a class="code" href="../../d2/d43/rpmalloc_8h.html#a5d0cd8aecab18855e794487437dc593a">span_use</a>[iclass].from_global = (<a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#aa9d55e2f20e580b7445617d0d12fff6e">size_t</a>)atomic_load32(&amp;heap-&gt;span_use[iclass].spans_from_global);</div>
<div class="line"><a name="l03242"></a><span class="lineno"> 3242</span>&#160;        stats-&gt;<a class="code" href="../../d2/d43/rpmalloc_8h.html#a5d0cd8aecab18855e794487437dc593a">span_use</a>[iclass].to_cache = (<a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#aa9d55e2f20e580b7445617d0d12fff6e">size_t</a>)atomic_load32(&amp;heap-&gt;span_use[iclass].spans_to_cache);</div>
<div class="line"><a name="l03243"></a><span class="lineno"> 3243</span>&#160;        stats-&gt;<a class="code" href="../../d2/d43/rpmalloc_8h.html#a5d0cd8aecab18855e794487437dc593a">span_use</a>[iclass].from_cache = (<a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#aa9d55e2f20e580b7445617d0d12fff6e">size_t</a>)atomic_load32(&amp;heap-&gt;span_use[iclass].spans_from_cache);</div>
<div class="line"><a name="l03244"></a><span class="lineno"> 3244</span>&#160;        stats-&gt;<a class="code" href="../../d2/d43/rpmalloc_8h.html#a5d0cd8aecab18855e794487437dc593a">span_use</a>[iclass].to_reserved = (<a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#aa9d55e2f20e580b7445617d0d12fff6e">size_t</a>)atomic_load32(&amp;heap-&gt;span_use[iclass].spans_to_reserved);</div>
<div class="line"><a name="l03245"></a><span class="lineno"> 3245</span>&#160;        stats-&gt;<a class="code" href="../../d2/d43/rpmalloc_8h.html#a5d0cd8aecab18855e794487437dc593a">span_use</a>[iclass].from_reserved = (<a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#aa9d55e2f20e580b7445617d0d12fff6e">size_t</a>)atomic_load32(&amp;heap-&gt;span_use[iclass].spans_from_reserved);</div>
<div class="line"><a name="l03246"></a><span class="lineno"> 3246</span>&#160;        stats-&gt;<a class="code" href="../../d2/d43/rpmalloc_8h.html#a5d0cd8aecab18855e794487437dc593a">span_use</a>[iclass].map_calls = (<a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#aa9d55e2f20e580b7445617d0d12fff6e">size_t</a>)atomic_load32(&amp;heap-&gt;span_use[iclass].spans_map_calls);</div>
<div class="line"><a name="l03247"></a><span class="lineno"> 3247</span>&#160;    }</div>
<div class="line"><a name="l03248"></a><span class="lineno"> 3248</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> iclass = 0; iclass &lt; <a class="code" href="../../df/dc0/rpmalloc_8c.html#aa74d427b2b9955ff2d9719693d9fc80e">SIZE_CLASS_COUNT</a>; ++iclass)</div>
<div class="line"><a name="l03249"></a><span class="lineno"> 3249</span>&#160;    {</div>
<div class="line"><a name="l03250"></a><span class="lineno"> 3250</span>&#160;        stats-&gt;<a class="code" href="../../d2/d43/rpmalloc_8h.html#ac5a79462677dd135cae918db93f5dfe1">size_use</a>[iclass].alloc_current = (<a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#aa9d55e2f20e580b7445617d0d12fff6e">size_t</a>)atomic_load32(&amp;heap-&gt;size_class_use[iclass].alloc_current);</div>
<div class="line"><a name="l03251"></a><span class="lineno"> 3251</span>&#160;        stats-&gt;<a class="code" href="../../d2/d43/rpmalloc_8h.html#ac5a79462677dd135cae918db93f5dfe1">size_use</a>[iclass].alloc_peak = (<a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#aa9d55e2f20e580b7445617d0d12fff6e">size_t</a>)heap-&gt;size_class_use[iclass].alloc_peak;</div>
<div class="line"><a name="l03252"></a><span class="lineno"> 3252</span>&#160;        stats-&gt;<a class="code" href="../../d2/d43/rpmalloc_8h.html#ac5a79462677dd135cae918db93f5dfe1">size_use</a>[iclass].alloc_total = (<span class="keywordtype">size_t</span>)atomic_load32(&amp;heap-&gt;size_class_use[iclass].alloc_total);</div>
<div class="line"><a name="l03253"></a><span class="lineno"> 3253</span>&#160;        stats-&gt;<a class="code" href="../../d2/d43/rpmalloc_8h.html#ac5a79462677dd135cae918db93f5dfe1">size_use</a>[iclass].free_total = (<a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#aa9d55e2f20e580b7445617d0d12fff6e">size_t</a>)atomic_load32(&amp;heap-&gt;size_class_use[iclass].free_total);</div>
<div class="line"><a name="l03254"></a><span class="lineno"> 3254</span>&#160;        stats-&gt;<a class="code" href="../../d2/d43/rpmalloc_8h.html#ac5a79462677dd135cae918db93f5dfe1">size_use</a>[iclass].spans_to_cache = (<a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#aa9d55e2f20e580b7445617d0d12fff6e">size_t</a>)atomic_load32(&amp;heap-&gt;size_class_use[iclass].spans_to_cache);</div>
<div class="line"><a name="l03255"></a><span class="lineno"> 3255</span>&#160;        stats-&gt;<a class="code" href="../../d2/d43/rpmalloc_8h.html#ac5a79462677dd135cae918db93f5dfe1">size_use</a>[iclass].spans_from_cache = (<a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#aa9d55e2f20e580b7445617d0d12fff6e">size_t</a>)atomic_load32(&amp;heap-&gt;size_class_use[iclass].spans_from_cache);</div>
<div class="line"><a name="l03256"></a><span class="lineno"> 3256</span>&#160;        stats-&gt;<a class="code" href="../../d2/d43/rpmalloc_8h.html#ac5a79462677dd135cae918db93f5dfe1">size_use</a>[iclass].spans_from_reserved = (<a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#aa9d55e2f20e580b7445617d0d12fff6e">size_t</a>)atomic_load32(&amp;heap-&gt;size_class_use[iclass].spans_from_reserved);</div>
<div class="line"><a name="l03257"></a><span class="lineno"> 3257</span>&#160;        stats-&gt;<a class="code" href="../../d2/d43/rpmalloc_8h.html#ac5a79462677dd135cae918db93f5dfe1">size_use</a>[iclass].map_calls = (<a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#aa9d55e2f20e580b7445617d0d12fff6e">size_t</a>)atomic_load32(&amp;heap-&gt;size_class_use[iclass].spans_map_calls);</div>
<div class="line"><a name="l03258"></a><span class="lineno"> 3258</span>&#160;    }</div>
<div class="line"><a name="l03259"></a><span class="lineno"> 3259</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l03260"></a><span class="lineno"> 3260</span>&#160;}</div>
<div class="line"><a name="l03261"></a><span class="lineno"> 3261</span>&#160; </div>
<div class="line"><a name="l03262"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#ae6278b2864893c2bc2d86b5d6d9f2d51"> 3262</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#ae6278b2864893c2bc2d86b5d6d9f2d51">rpmalloc_global_statistics</a>(<a class="code" href="../../d2/d43/rpmalloc_8h.html#d1/d1a/structrpmalloc__global__statistics__t">rpmalloc_global_statistics_t</a> *stats)</div>
<div class="line"><a name="l03263"></a><span class="lineno"> 3263</span>&#160;{</div>
<div class="line"><a name="l03264"></a><span class="lineno"> 3264</span>&#160;    <a class="code" href="../../d3/d82/convert_8h.html#a9c1f204516a55affa9ba118907e5ab6b">memset_unsafe</a>(stats, 0, <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d43/rpmalloc_8h.html#d1/d1a/structrpmalloc__global__statistics__t">rpmalloc_global_statistics_t</a>));</div>
<div class="line"><a name="l03265"></a><span class="lineno"> 3265</span>&#160;<span class="preprocessor">#if ENABLE_STATISTICS</span></div>
<div class="line"><a name="l03266"></a><span class="lineno"> 3266</span>&#160;    stats-&gt;<a class="code" href="../../d2/d43/rpmalloc_8h.html#ab0d895a6016dd1c5937f2a74370f2727">mapped</a> = (<a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#aa9d55e2f20e580b7445617d0d12fff6e">size_t</a>)atomic_load32(&amp;_mapped_pages) * <a class="code" href="../../df/dc0/rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a>;</div>
<div class="line"><a name="l03267"></a><span class="lineno"> 3267</span>&#160;    stats-&gt;<a class="code" href="../../d2/d43/rpmalloc_8h.html#ad5723376daeb707aa20547190ced2865">mapped_peak</a> = (<a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#aa9d55e2f20e580b7445617d0d12fff6e">size_t</a>)_mapped_pages_peak * <a class="code" href="../../df/dc0/rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a>;</div>
<div class="line"><a name="l03268"></a><span class="lineno"> 3268</span>&#160;    stats-&gt;<a class="code" href="../../d2/d43/rpmalloc_8h.html#af1916b4138cfc1e46ff0787ff9206375">mapped_total</a> = (<a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#aa9d55e2f20e580b7445617d0d12fff6e">size_t</a>)atomic_load32(&amp;_mapped_total) * <a class="code" href="../../df/dc0/rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a>;</div>
<div class="line"><a name="l03269"></a><span class="lineno"> 3269</span>&#160;    stats-&gt;<a class="code" href="../../d2/d43/rpmalloc_8h.html#aa896cafa124a63254f56621fe2c5241f">unmapped_total</a> = (<a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#aa9d55e2f20e580b7445617d0d12fff6e">size_t</a>)atomic_load32(&amp;_unmapped_total) * <a class="code" href="../../df/dc0/rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a>;</div>
<div class="line"><a name="l03270"></a><span class="lineno"> 3270</span>&#160;    stats-&gt;<a class="code" href="../../d2/d43/rpmalloc_8h.html#a5db28c5567049de1e58833c061841f7e">huge_alloc</a> = (<a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#aa9d55e2f20e580b7445617d0d12fff6e">size_t</a>)atomic_load32(&amp;_huge_pages_current) * <a class="code" href="../../df/dc0/rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a>;</div>
<div class="line"><a name="l03271"></a><span class="lineno"> 3271</span>&#160;    stats-&gt;<a class="code" href="../../d2/d43/rpmalloc_8h.html#a308868b1a8740da06b79c1bdabae1997">huge_alloc_peak</a> = (<a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#aa9d55e2f20e580b7445617d0d12fff6e">size_t</a>)_huge_pages_peak * <a class="code" href="../../df/dc0/rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a>;</div>
<div class="line"><a name="l03272"></a><span class="lineno"> 3272</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l03273"></a><span class="lineno"> 3273</span>&#160;<span class="preprocessor">#if ENABLE_GLOBAL_CACHE</span></div>
<div class="line"><a name="l03274"></a><span class="lineno"> 3274</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> iclass = 0; iclass &lt; <a class="code" href="../../df/dc0/rpmalloc_8c.html#a04406da3f5ff4e24f155c97591678ed9">LARGE_CLASS_COUNT</a>; ++iclass)</div>
<div class="line"><a name="l03275"></a><span class="lineno"> 3275</span>&#160;        stats-&gt;<a class="code" href="../../d2/d43/rpmalloc_8h.html#a70b10faa79aac5df497ba5eccdd554ae">cached</a> += <a class="code" href="../../df/dc0/rpmalloc_8c.html#ad7af40ab0c9174515ec06efb45ebdd73">_memory_span_cache</a>[iclass].<a class="code" href="../../df/dc0/rpmalloc_8c.html#a440c6f31099f3836f7beb5e47d14fb2d">count</a> * (iclass + 1) * <a class="code" href="../../df/dc0/rpmalloc_8c.html#a9fefa5277fefa0c58f69d5b86d679ccb">_memory_span_size</a>;</div>
<div class="line"><a name="l03276"></a><span class="lineno"> 3276</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l03277"></a><span class="lineno"> 3277</span>&#160;}</div>
<div class="line"><a name="l03278"></a><span class="lineno"> 3278</span>&#160; </div>
<div class="line"><a name="l03279"></a><span class="lineno"> 3279</span>&#160;<span class="preprocessor">#if ENABLE_STATISTICS</span></div>
<div class="line"><a name="l03280"></a><span class="lineno"> 3280</span>&#160; </div>
<div class="line"><a name="l03281"></a><span class="lineno"> 3281</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="l03282"></a><span class="lineno"> 3282</span>&#160;_memory_heap_dump_statistics(<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#d9/d8a/structheap__t">heap_t</a> *heap, <span class="keywordtype">void</span> *<a class="code" href="../../d0/d64/syscall_8cpp.html#a0eabe900500ad25646e5905a80f204de">file</a>)</div>
<div class="line"><a name="l03283"></a><span class="lineno"> 3283</span>&#160;{</div>
<div class="line"><a name="l03284"></a><span class="lineno"> 3284</span>&#160;    <a class="code" href="../../d8/d67/Kernel_2include__std_2stdio_8h.html#a0cba47cd44d0dd910da561bdc55a25ad">fprintf</a>(<a class="code" href="../../d0/d64/syscall_8cpp.html#a0eabe900500ad25646e5905a80f204de">file</a>, <span class="stringliteral">&quot;Heap %d stats:\n&quot;</span>, heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a2342224142317f85fca91614fc973131">id</a>);</div>
<div class="line"><a name="l03285"></a><span class="lineno"> 3285</span>&#160;    <a class="code" href="../../d8/d67/Kernel_2include__std_2stdio_8h.html#a0cba47cd44d0dd910da561bdc55a25ad">fprintf</a>(<a class="code" href="../../d0/d64/syscall_8cpp.html#a0eabe900500ad25646e5905a80f204de">file</a>, <span class="stringliteral">&quot;Class   CurAlloc  PeakAlloc   TotAlloc    TotFree  BlkSize BlkCount SpansCur SpansPeak  PeakAllocMiB  ToCacheMiB FromCacheMiB FromReserveMiB MmapCalls\n&quot;</span>);</div>
<div class="line"><a name="l03286"></a><span class="lineno"> 3286</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> iclass = 0; iclass &lt; <a class="code" href="../../df/dc0/rpmalloc_8c.html#aa74d427b2b9955ff2d9719693d9fc80e">SIZE_CLASS_COUNT</a>; ++iclass)</div>
<div class="line"><a name="l03287"></a><span class="lineno"> 3287</span>&#160;    {</div>
<div class="line"><a name="l03288"></a><span class="lineno"> 3288</span>&#160;        <span class="keywordflow">if</span> (!atomic_load32(&amp;heap-&gt;size_class_use[iclass].alloc_total))</div>
<div class="line"><a name="l03289"></a><span class="lineno"> 3289</span>&#160;            <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l03290"></a><span class="lineno"> 3290</span>&#160;        <a class="code" href="../../d8/d67/Kernel_2include__std_2stdio_8h.html#a0cba47cd44d0dd910da561bdc55a25ad">fprintf</a>(<a class="code" href="../../d0/d64/syscall_8cpp.html#a0eabe900500ad25646e5905a80f204de">file</a>, <span class="stringliteral">&quot;%3u:  %10u %10u %10u %10u %8u %8u %8d %9d %13zu %11zu %12zu %14zu %9u\n&quot;</span>, (<a class="code" href="../../dd/ddd/arithmetic__operations_8c.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a>)iclass,</div>
<div class="line"><a name="l03291"></a><span class="lineno"> 3291</span>&#160;                atomic_load32(&amp;heap-&gt;size_class_use[iclass].alloc_current),</div>
<div class="line"><a name="l03292"></a><span class="lineno"> 3292</span>&#160;                heap-&gt;size_class_use[iclass].alloc_peak,</div>
<div class="line"><a name="l03293"></a><span class="lineno"> 3293</span>&#160;                atomic_load32(&amp;heap-&gt;size_class_use[iclass].alloc_total),</div>
<div class="line"><a name="l03294"></a><span class="lineno"> 3294</span>&#160;                atomic_load32(&amp;heap-&gt;size_class_use[iclass].free_total),</div>
<div class="line"><a name="l03295"></a><span class="lineno"> 3295</span>&#160;                <a class="code" href="../../df/dc0/rpmalloc_8c.html#a33cddb08b9ee0f969cc82dbf9cddb947">_memory_size_class</a>[iclass].<a class="code" href="../../df/dc0/rpmalloc_8c.html#a007fc7dd52ba1f95d9a6ce88f47a614b">block_size</a>,</div>
<div class="line"><a name="l03296"></a><span class="lineno"> 3296</span>&#160;                <a class="code" href="../../df/dc0/rpmalloc_8c.html#a33cddb08b9ee0f969cc82dbf9cddb947">_memory_size_class</a>[iclass].<a class="code" href="../../df/dc0/rpmalloc_8c.html#aeded978bd21c13b71d9b0310b5bb09ec">block_count</a>,</div>
<div class="line"><a name="l03297"></a><span class="lineno"> 3297</span>&#160;                atomic_load32(&amp;heap-&gt;size_class_use[iclass].spans_current),</div>
<div class="line"><a name="l03298"></a><span class="lineno"> 3298</span>&#160;                heap-&gt;size_class_use[iclass].spans_peak,</div>
<div class="line"><a name="l03299"></a><span class="lineno"> 3299</span>&#160;                ((<span class="keywordtype">size_t</span>)heap-&gt;size_class_use[iclass].alloc_peak * (<span class="keywordtype">size_t</span>)<a class="code" href="../../df/dc0/rpmalloc_8c.html#a33cddb08b9ee0f969cc82dbf9cddb947">_memory_size_class</a>[iclass].<a class="code" href="../../df/dc0/rpmalloc_8c.html#a007fc7dd52ba1f95d9a6ce88f47a614b">block_size</a>) / (<span class="keywordtype">size_t</span>)(1024 * 1024),</div>
<div class="line"><a name="l03300"></a><span class="lineno"> 3300</span>&#160;                ((<span class="keywordtype">size_t</span>)atomic_load32(&amp;heap-&gt;size_class_use[iclass].spans_to_cache) * <a class="code" href="../../df/dc0/rpmalloc_8c.html#a9fefa5277fefa0c58f69d5b86d679ccb">_memory_span_size</a>) / (<span class="keywordtype">size_t</span>)(1024 * 1024),</div>
<div class="line"><a name="l03301"></a><span class="lineno"> 3301</span>&#160;                ((<span class="keywordtype">size_t</span>)atomic_load32(&amp;heap-&gt;size_class_use[iclass].spans_from_cache) * <a class="code" href="../../df/dc0/rpmalloc_8c.html#a9fefa5277fefa0c58f69d5b86d679ccb">_memory_span_size</a>) / (<span class="keywordtype">size_t</span>)(1024 * 1024),</div>
<div class="line"><a name="l03302"></a><span class="lineno"> 3302</span>&#160;                ((<span class="keywordtype">size_t</span>)atomic_load32(&amp;heap-&gt;size_class_use[iclass].spans_from_reserved) * <a class="code" href="../../df/dc0/rpmalloc_8c.html#a9fefa5277fefa0c58f69d5b86d679ccb">_memory_span_size</a>) / (<span class="keywordtype">size_t</span>)(1024 * 1024),</div>
<div class="line"><a name="l03303"></a><span class="lineno"> 3303</span>&#160;                atomic_load32(&amp;heap-&gt;size_class_use[iclass].spans_map_calls));</div>
<div class="line"><a name="l03304"></a><span class="lineno"> 3304</span>&#160;    }</div>
<div class="line"><a name="l03305"></a><span class="lineno"> 3305</span>&#160;    <a class="code" href="../../d8/d67/Kernel_2include__std_2stdio_8h.html#a0cba47cd44d0dd910da561bdc55a25ad">fprintf</a>(<a class="code" href="../../d0/d64/syscall_8cpp.html#a0eabe900500ad25646e5905a80f204de">file</a>, <span class="stringliteral">&quot;Spans  Current     Peak Deferred  PeakMiB  Cached  ToCacheMiB FromCacheMiB ToReserveMiB FromReserveMiB ToGlobalMiB FromGlobalMiB  MmapCalls\n&quot;</span>);</div>
<div class="line"><a name="l03306"></a><span class="lineno"> 3306</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> iclass = 0; iclass &lt; <a class="code" href="../../df/dc0/rpmalloc_8c.html#a04406da3f5ff4e24f155c97591678ed9">LARGE_CLASS_COUNT</a>; ++iclass)</div>
<div class="line"><a name="l03307"></a><span class="lineno"> 3307</span>&#160;    {</div>
<div class="line"><a name="l03308"></a><span class="lineno"> 3308</span>&#160;        <span class="keywordflow">if</span> (!atomic_load32(&amp;heap-&gt;span_use[iclass].high) &amp;&amp; !atomic_load32(&amp;heap-&gt;span_use[iclass].spans_map_calls))</div>
<div class="line"><a name="l03309"></a><span class="lineno"> 3309</span>&#160;            <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l03310"></a><span class="lineno"> 3310</span>&#160;        <a class="code" href="../../d8/d67/Kernel_2include__std_2stdio_8h.html#a0cba47cd44d0dd910da561bdc55a25ad">fprintf</a>(<a class="code" href="../../d0/d64/syscall_8cpp.html#a0eabe900500ad25646e5905a80f204de">file</a>, <span class="stringliteral">&quot;%4u: %8d %8u %8u %8zu %7u %11zu %12zu %12zu %14zu %11zu %13zu %10u\n&quot;</span>, (<a class="code" href="../../dd/ddd/arithmetic__operations_8c.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a>)(iclass + 1),</div>
<div class="line"><a name="l03311"></a><span class="lineno"> 3311</span>&#160;                atomic_load32(&amp;heap-&gt;span_use[iclass].current),</div>
<div class="line"><a name="l03312"></a><span class="lineno"> 3312</span>&#160;                atomic_load32(&amp;heap-&gt;span_use[iclass].high),</div>
<div class="line"><a name="l03313"></a><span class="lineno"> 3313</span>&#160;                atomic_load32(&amp;heap-&gt;span_use[iclass].spans_deferred),</div>
<div class="line"><a name="l03314"></a><span class="lineno"> 3314</span>&#160;                ((<span class="keywordtype">size_t</span>)atomic_load32(&amp;heap-&gt;span_use[iclass].high) * (<span class="keywordtype">size_t</span>)<a class="code" href="../../df/dc0/rpmalloc_8c.html#a9fefa5277fefa0c58f69d5b86d679ccb">_memory_span_size</a> * (iclass + 1)) / (<span class="keywordtype">size_t</span>)(1024 * 1024),</div>
<div class="line"><a name="l03315"></a><span class="lineno"> 3315</span>&#160;#<span class="keywordflow">if</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#a69503d4619673c88e0882f291eb6d86f">ENABLE_THREAD_CACHE</a></div>
<div class="line"><a name="l03316"></a><span class="lineno"> 3316</span>&#160;                (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)(!iclass ? heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#ae112aace519bbe14edb9127cefb59705">span_cache</a>.<a class="code" href="../../df/dc0/rpmalloc_8c.html#a894a66f329862f01de7619aee1954d19">count</a> : heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#aea02bb1ed60acc428d5a2d2db2cd9a7b">span_large_cache</a>[iclass - 1].<a class="code" href="../../df/dc0/rpmalloc_8c.html#a07da73cfe1c11642973a6eb1386a3a1c">count</a>),</div>
<div class="line"><a name="l03317"></a><span class="lineno"> 3317</span>&#160;                ((<span class="keywordtype">size_t</span>)atomic_load32(&amp;heap-&gt;span_use[iclass].spans_to_cache) * (iclass + 1) * <a class="code" href="../../df/dc0/rpmalloc_8c.html#a9fefa5277fefa0c58f69d5b86d679ccb">_memory_span_size</a>) / (<span class="keywordtype">size_t</span>)(1024 * 1024),</div>
<div class="line"><a name="l03318"></a><span class="lineno"> 3318</span>&#160;                ((<span class="keywordtype">size_t</span>)atomic_load32(&amp;heap-&gt;span_use[iclass].spans_from_cache) * (iclass + 1) * <a class="code" href="../../df/dc0/rpmalloc_8c.html#a9fefa5277fefa0c58f69d5b86d679ccb">_memory_span_size</a>) / (<span class="keywordtype">size_t</span>)(1024 * 1024),</div>
<div class="line"><a name="l03319"></a><span class="lineno"> 3319</span>&#160;#<span class="keywordflow">else</span></div>
<div class="line"><a name="l03320"></a><span class="lineno"> 3320</span>&#160;                0, (<span class="keywordtype">size_t</span>)0, (<span class="keywordtype">size_t</span>)0,</div>
<div class="line"><a name="l03321"></a><span class="lineno"> 3321</span>&#160;#endif</div>
<div class="line"><a name="l03322"></a><span class="lineno"> 3322</span>&#160;                ((<span class="keywordtype">size_t</span>)atomic_load32(&amp;heap-&gt;span_use[iclass].spans_to_reserved) * (iclass + 1) * <a class="code" href="../../df/dc0/rpmalloc_8c.html#a9fefa5277fefa0c58f69d5b86d679ccb">_memory_span_size</a>) / (<span class="keywordtype">size_t</span>)(1024 * 1024),</div>
<div class="line"><a name="l03323"></a><span class="lineno"> 3323</span>&#160;                ((<span class="keywordtype">size_t</span>)atomic_load32(&amp;heap-&gt;span_use[iclass].spans_from_reserved) * (iclass + 1) * <a class="code" href="../../df/dc0/rpmalloc_8c.html#a9fefa5277fefa0c58f69d5b86d679ccb">_memory_span_size</a>) / (<span class="keywordtype">size_t</span>)(1024 * 1024),</div>
<div class="line"><a name="l03324"></a><span class="lineno"> 3324</span>&#160;                ((<span class="keywordtype">size_t</span>)atomic_load32(&amp;heap-&gt;span_use[iclass].spans_to_global) * (<span class="keywordtype">size_t</span>)<a class="code" href="../../df/dc0/rpmalloc_8c.html#a9fefa5277fefa0c58f69d5b86d679ccb">_memory_span_size</a> * (iclass + 1)) / (<span class="keywordtype">size_t</span>)(1024 * 1024),</div>
<div class="line"><a name="l03325"></a><span class="lineno"> 3325</span>&#160;                ((<span class="keywordtype">size_t</span>)atomic_load32(&amp;heap-&gt;span_use[iclass].spans_from_global) * (<span class="keywordtype">size_t</span>)<a class="code" href="../../df/dc0/rpmalloc_8c.html#a9fefa5277fefa0c58f69d5b86d679ccb">_memory_span_size</a> * (iclass + 1)) / (<span class="keywordtype">size_t</span>)(1024 * 1024),</div>
<div class="line"><a name="l03326"></a><span class="lineno"> 3326</span>&#160;                atomic_load32(&amp;heap-&gt;span_use[iclass].spans_map_calls));</div>
<div class="line"><a name="l03327"></a><span class="lineno"> 3327</span>&#160;    }</div>
<div class="line"><a name="l03328"></a><span class="lineno"> 3328</span>&#160;    <a class="code" href="../../d8/d67/Kernel_2include__std_2stdio_8h.html#a0cba47cd44d0dd910da561bdc55a25ad">fprintf</a>(<a class="code" href="../../d0/d64/syscall_8cpp.html#a0eabe900500ad25646e5905a80f204de">file</a>, <span class="stringliteral">&quot;Full spans: %zu\n&quot;</span>, heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a6aa789c3cdf7e70df144c248d18c5f4c">full_span_count</a>);</div>
<div class="line"><a name="l03329"></a><span class="lineno"> 3329</span>&#160;    <a class="code" href="../../d8/d67/Kernel_2include__std_2stdio_8h.html#a0cba47cd44d0dd910da561bdc55a25ad">fprintf</a>(<a class="code" href="../../d0/d64/syscall_8cpp.html#a0eabe900500ad25646e5905a80f204de">file</a>, <span class="stringliteral">&quot;ThreadToGlobalMiB GlobalToThreadMiB\n&quot;</span>);</div>
<div class="line"><a name="l03330"></a><span class="lineno"> 3330</span>&#160;    <a class="code" href="../../d8/d67/Kernel_2include__std_2stdio_8h.html#a0cba47cd44d0dd910da561bdc55a25ad">fprintf</a>(<a class="code" href="../../d0/d64/syscall_8cpp.html#a0eabe900500ad25646e5905a80f204de">file</a>, <span class="stringliteral">&quot;%17zu %17zu\n&quot;</span>, (<span class="keywordtype">size_t</span>)<a class="code" href="../../df/dc0/rpmalloc_8c.html#a083ecd4af0f476009595e8ee78cf2ac0">atomic_load64</a>(&amp;heap-&gt;thread_to_global) / (<span class="keywordtype">size_t</span>)(1024 * 1024), (<span class="keywordtype">size_t</span>)<a class="code" href="../../df/dc0/rpmalloc_8c.html#a083ecd4af0f476009595e8ee78cf2ac0">atomic_load64</a>(&amp;heap-&gt;global_to_thread) / (<span class="keywordtype">size_t</span>)(1024 * 1024));</div>
<div class="line"><a name="l03331"></a><span class="lineno"> 3331</span>&#160;}</div>
<div class="line"><a name="l03332"></a><span class="lineno"> 3332</span>&#160; </div>
<div class="line"><a name="l03333"></a><span class="lineno"> 3333</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l03334"></a><span class="lineno"> 3334</span>&#160; </div>
<div class="line"><a name="l03335"></a><span class="lineno"><a class="line" href="../../df/dc0/rpmalloc_8c.html#a759e72612fab78b1159ab7129a7f7e86"> 3335</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#a759e72612fab78b1159ab7129a7f7e86">rpmalloc_dump_statistics</a>(<span class="keywordtype">void</span> *<a class="code" href="../../d0/d64/syscall_8cpp.html#a0eabe900500ad25646e5905a80f204de">file</a>)</div>
<div class="line"><a name="l03336"></a><span class="lineno"> 3336</span>&#160;{</div>
<div class="line"><a name="l03337"></a><span class="lineno"> 3337</span>&#160;<span class="preprocessor">#if ENABLE_STATISTICS</span></div>
<div class="line"><a name="l03338"></a><span class="lineno"> 3338</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> list_idx = 0; list_idx &lt; <a class="code" href="../../df/dc0/rpmalloc_8c.html#ac7e4a352a230ef04d4372db43a454b7f">HEAP_ARRAY_SIZE</a>; ++list_idx)</div>
<div class="line"><a name="l03339"></a><span class="lineno"> 3339</span>&#160;    {</div>
<div class="line"><a name="l03340"></a><span class="lineno"> 3340</span>&#160;        <a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#d9/d8a/structheap__t">heap_t</a> *heap = <a class="code" href="../../df/dc0/rpmalloc_8c.html#a3e39052a111a2e243645494f1d6ca439">_memory_heaps</a>[list_idx];</div>
<div class="line"><a name="l03341"></a><span class="lineno"> 3341</span>&#160;        <span class="keywordflow">while</span> (heap)</div>
<div class="line"><a name="l03342"></a><span class="lineno"> 3342</span>&#160;        {</div>
<div class="line"><a name="l03343"></a><span class="lineno"> 3343</span>&#160;            <span class="keywordtype">int</span> need_dump = 0;</div>
<div class="line"><a name="l03344"></a><span class="lineno"> 3344</span>&#160;            <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> iclass = 0; !need_dump &amp;&amp; (iclass &lt; <a class="code" href="../../df/dc0/rpmalloc_8c.html#aa74d427b2b9955ff2d9719693d9fc80e">SIZE_CLASS_COUNT</a>); ++iclass)</div>
<div class="line"><a name="l03345"></a><span class="lineno"> 3345</span>&#160;            {</div>
<div class="line"><a name="l03346"></a><span class="lineno"> 3346</span>&#160;                <span class="keywordflow">if</span> (!atomic_load32(&amp;heap-&gt;size_class_use[iclass].alloc_total))</div>
<div class="line"><a name="l03347"></a><span class="lineno"> 3347</span>&#160;                {</div>
<div class="line"><a name="l03348"></a><span class="lineno"> 3348</span>&#160;                    <a class="code" href="../../df/dc0/rpmalloc_8c.html#ad008ddf766a4f56fbde2edf2c51d9a87">rpmalloc_assert</a>(!atomic_load32(&amp;heap-&gt;size_class_use[iclass].free_total), <span class="stringliteral">&quot;Heap statistics counter mismatch&quot;</span>);</div>
<div class="line"><a name="l03349"></a><span class="lineno"> 3349</span>&#160;                    <a class="code" href="../../df/dc0/rpmalloc_8c.html#ad008ddf766a4f56fbde2edf2c51d9a87">rpmalloc_assert</a>(!atomic_load32(&amp;heap-&gt;size_class_use[iclass].spans_map_calls), <span class="stringliteral">&quot;Heap statistics counter mismatch&quot;</span>);</div>
<div class="line"><a name="l03350"></a><span class="lineno"> 3350</span>&#160;                    <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l03351"></a><span class="lineno"> 3351</span>&#160;                }</div>
<div class="line"><a name="l03352"></a><span class="lineno"> 3352</span>&#160;                need_dump = 1;</div>
<div class="line"><a name="l03353"></a><span class="lineno"> 3353</span>&#160;            }</div>
<div class="line"><a name="l03354"></a><span class="lineno"> 3354</span>&#160;            <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> iclass = 0; !need_dump &amp;&amp; (iclass &lt; <a class="code" href="../../df/dc0/rpmalloc_8c.html#a04406da3f5ff4e24f155c97591678ed9">LARGE_CLASS_COUNT</a>); ++iclass)</div>
<div class="line"><a name="l03355"></a><span class="lineno"> 3355</span>&#160;            {</div>
<div class="line"><a name="l03356"></a><span class="lineno"> 3356</span>&#160;                <span class="keywordflow">if</span> (!atomic_load32(&amp;heap-&gt;span_use[iclass].high) &amp;&amp; !atomic_load32(&amp;heap-&gt;span_use[iclass].spans_map_calls))</div>
<div class="line"><a name="l03357"></a><span class="lineno"> 3357</span>&#160;                    <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l03358"></a><span class="lineno"> 3358</span>&#160;                need_dump = 1;</div>
<div class="line"><a name="l03359"></a><span class="lineno"> 3359</span>&#160;            }</div>
<div class="line"><a name="l03360"></a><span class="lineno"> 3360</span>&#160;            <span class="keywordflow">if</span> (need_dump)</div>
<div class="line"><a name="l03361"></a><span class="lineno"> 3361</span>&#160;                _memory_heap_dump_statistics(heap, <a class="code" href="../../d0/d64/syscall_8cpp.html#a0eabe900500ad25646e5905a80f204de">file</a>);</div>
<div class="line"><a name="l03362"></a><span class="lineno"> 3362</span>&#160;            heap = heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a74b47a0eacf313fe421d32379a2b942c">next_heap</a>;</div>
<div class="line"><a name="l03363"></a><span class="lineno"> 3363</span>&#160;        }</div>
<div class="line"><a name="l03364"></a><span class="lineno"> 3364</span>&#160;    }</div>
<div class="line"><a name="l03365"></a><span class="lineno"> 3365</span>&#160;    <a class="code" href="../../d8/d67/Kernel_2include__std_2stdio_8h.html#a0cba47cd44d0dd910da561bdc55a25ad">fprintf</a>(<a class="code" href="../../d0/d64/syscall_8cpp.html#a0eabe900500ad25646e5905a80f204de">file</a>, <span class="stringliteral">&quot;Global stats:\n&quot;</span>);</div>
<div class="line"><a name="l03366"></a><span class="lineno"> 3366</span>&#160;    <span class="keywordtype">size_t</span> huge_current = (<a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#aa9d55e2f20e580b7445617d0d12fff6e">size_t</a>)atomic_load32(&amp;_huge_pages_current) * <a class="code" href="../../df/dc0/rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a>;</div>
<div class="line"><a name="l03367"></a><span class="lineno"> 3367</span>&#160;    <span class="keywordtype">size_t</span> huge_peak = (<a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#aa9d55e2f20e580b7445617d0d12fff6e">size_t</a>)_huge_pages_peak * <a class="code" href="../../df/dc0/rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a>;</div>
<div class="line"><a name="l03368"></a><span class="lineno"> 3368</span>&#160;    <a class="code" href="../../d8/d67/Kernel_2include__std_2stdio_8h.html#a0cba47cd44d0dd910da561bdc55a25ad">fprintf</a>(<a class="code" href="../../d0/d64/syscall_8cpp.html#a0eabe900500ad25646e5905a80f204de">file</a>, <span class="stringliteral">&quot;HugeCurrentMiB HugePeakMiB\n&quot;</span>);</div>
<div class="line"><a name="l03369"></a><span class="lineno"> 3369</span>&#160;    <a class="code" href="../../d8/d67/Kernel_2include__std_2stdio_8h.html#a0cba47cd44d0dd910da561bdc55a25ad">fprintf</a>(<a class="code" href="../../d0/d64/syscall_8cpp.html#a0eabe900500ad25646e5905a80f204de">file</a>, <span class="stringliteral">&quot;%14zu %11zu\n&quot;</span>, huge_current / (<span class="keywordtype">size_t</span>)(1024 * 1024), huge_peak / (<span class="keywordtype">size_t</span>)(1024 * 1024));</div>
<div class="line"><a name="l03370"></a><span class="lineno"> 3370</span>&#160; </div>
<div class="line"><a name="l03371"></a><span class="lineno"> 3371</span>&#160;    <a class="code" href="../../d8/d67/Kernel_2include__std_2stdio_8h.html#a0cba47cd44d0dd910da561bdc55a25ad">fprintf</a>(<a class="code" href="../../d0/d64/syscall_8cpp.html#a0eabe900500ad25646e5905a80f204de">file</a>, <span class="stringliteral">&quot;GlobalCacheMiB\n&quot;</span>);</div>
<div class="line"><a name="l03372"></a><span class="lineno"> 3372</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> iclass = 0; iclass &lt; <a class="code" href="../../df/dc0/rpmalloc_8c.html#a04406da3f5ff4e24f155c97591678ed9">LARGE_CLASS_COUNT</a>; ++iclass)</div>
<div class="line"><a name="l03373"></a><span class="lineno"> 3373</span>&#160;    {</div>
<div class="line"><a name="l03374"></a><span class="lineno"> 3374</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#db/d6b/structglobal__cache__t">global_cache_t</a> *cache = <a class="code" href="../../df/dc0/rpmalloc_8c.html#ad7af40ab0c9174515ec06efb45ebdd73">_memory_span_cache</a> + iclass;</div>
<div class="line"><a name="l03375"></a><span class="lineno"> 3375</span>&#160;        <span class="keywordtype">size_t</span> global_cache = (<a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#aa9d55e2f20e580b7445617d0d12fff6e">size_t</a>)cache-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a440c6f31099f3836f7beb5e47d14fb2d">count</a> * iclass * <a class="code" href="../../df/dc0/rpmalloc_8c.html#a9fefa5277fefa0c58f69d5b86d679ccb">_memory_span_size</a>;</div>
<div class="line"><a name="l03376"></a><span class="lineno"> 3376</span>&#160; </div>
<div class="line"><a name="l03377"></a><span class="lineno"> 3377</span>&#160;        <span class="keywordtype">size_t</span> global_overflow_cache = 0;</div>
<div class="line"><a name="l03378"></a><span class="lineno"> 3378</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *span = cache-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a8bb140aee00ffae527f7c0706d98c3d1">overflow</a>;</div>
<div class="line"><a name="l03379"></a><span class="lineno"> 3379</span>&#160;        <a class="code" href="../../d0/d64/syscall_8cpp.html#a0f5467b8ffa31593190a14d4d96ba084">while</a> (span)</div>
<div class="line"><a name="l03380"></a><span class="lineno"> 3380</span>&#160;        {</div>
<div class="line"><a name="l03381"></a><span class="lineno"> 3381</span>&#160;            global_overflow_cache += iclass * <a class="code" href="../../df/dc0/rpmalloc_8c.html#a9fefa5277fefa0c58f69d5b86d679ccb">_memory_span_size</a>;</div>
<div class="line"><a name="l03382"></a><span class="lineno"> 3382</span>&#160;            span = span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#ac62e0e77eb38ebff4443eb5db3ccd45c">next</a>;</div>
<div class="line"><a name="l03383"></a><span class="lineno"> 3383</span>&#160;        }</div>
<div class="line"><a name="l03384"></a><span class="lineno"> 3384</span>&#160;        <span class="keywordflow">if</span> (global_cache || global_overflow_cache || cache-&gt;insert_count || cache-&gt;extract_count)</div>
<div class="line"><a name="l03385"></a><span class="lineno"> 3385</span>&#160;            <a class="code" href="../../d8/d67/Kernel_2include__std_2stdio_8h.html#a0cba47cd44d0dd910da561bdc55a25ad">fprintf</a>(<a class="code" href="../../d0/d64/syscall_8cpp.html#a0eabe900500ad25646e5905a80f204de">file</a>, <span class="stringliteral">&quot;%4zu: %8zuMiB (%8zuMiB overflow) %14zu insert %14zu extract\n&quot;</span>, iclass + 1, global_cache / (<span class="keywordtype">size_t</span>)(1024 * 1024), global_overflow_cache / (<span class="keywordtype">size_t</span>)(1024 * 1024), cache-&gt;insert_count, cache-&gt;extract_count);</div>
<div class="line"><a name="l03386"></a><span class="lineno"> 3386</span>&#160;    }</div>
<div class="line"><a name="l03387"></a><span class="lineno"> 3387</span>&#160; </div>
<div class="line"><a name="l03388"></a><span class="lineno"> 3388</span>&#160;    <span class="keywordtype">size_t</span> mapped = (<a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#aa9d55e2f20e580b7445617d0d12fff6e">size_t</a>)atomic_load32(&amp;_mapped_pages) * <a class="code" href="../../df/dc0/rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a>;</div>
<div class="line"><a name="l03389"></a><span class="lineno"> 3389</span>&#160;    <span class="keywordtype">size_t</span> mapped_os = (<a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#aa9d55e2f20e580b7445617d0d12fff6e">size_t</a>)atomic_load32(&amp;_mapped_pages_os) * <a class="code" href="../../df/dc0/rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a>;</div>
<div class="line"><a name="l03390"></a><span class="lineno"> 3390</span>&#160;    <span class="keywordtype">size_t</span> mapped_peak = (<a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#aa9d55e2f20e580b7445617d0d12fff6e">size_t</a>)_mapped_pages_peak * <a class="code" href="../../df/dc0/rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a>;</div>
<div class="line"><a name="l03391"></a><span class="lineno"> 3391</span>&#160;    <span class="keywordtype">size_t</span> mapped_total = (<a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#aa9d55e2f20e580b7445617d0d12fff6e">size_t</a>)atomic_load32(&amp;_mapped_total) * <a class="code" href="../../df/dc0/rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a>;</div>
<div class="line"><a name="l03392"></a><span class="lineno"> 3392</span>&#160;    <span class="keywordtype">size_t</span> unmapped_total = (<a class="code" href="../../d0/df4/Kernel_2include_2types_8h.html#aa9d55e2f20e580b7445617d0d12fff6e">size_t</a>)atomic_load32(&amp;_unmapped_total) * <a class="code" href="../../df/dc0/rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a>;</div>
<div class="line"><a name="l03393"></a><span class="lineno"> 3393</span>&#160;    <a class="code" href="../../d8/d67/Kernel_2include__std_2stdio_8h.html#a0cba47cd44d0dd910da561bdc55a25ad">fprintf</a>(<a class="code" href="../../d0/d64/syscall_8cpp.html#a0eabe900500ad25646e5905a80f204de">file</a>, <span class="stringliteral">&quot;MappedMiB MappedOSMiB MappedPeakMiB MappedTotalMiB UnmappedTotalMiB\n&quot;</span>);</div>
<div class="line"><a name="l03394"></a><span class="lineno"> 3394</span>&#160;    <a class="code" href="../../d8/d67/Kernel_2include__std_2stdio_8h.html#a0cba47cd44d0dd910da561bdc55a25ad">fprintf</a>(<a class="code" href="../../d0/d64/syscall_8cpp.html#a0eabe900500ad25646e5905a80f204de">file</a>, <span class="stringliteral">&quot;%9zu %11zu %13zu %14zu %16zu\n&quot;</span>,</div>
<div class="line"><a name="l03395"></a><span class="lineno"> 3395</span>&#160;            mapped / (<span class="keywordtype">size_t</span>)(1024 * 1024),</div>
<div class="line"><a name="l03396"></a><span class="lineno"> 3396</span>&#160;            mapped_os / (<span class="keywordtype">size_t</span>)(1024 * 1024),</div>
<div class="line"><a name="l03397"></a><span class="lineno"> 3397</span>&#160;            mapped_peak / (<span class="keywordtype">size_t</span>)(1024 * 1024),</div>
<div class="line"><a name="l03398"></a><span class="lineno"> 3398</span>&#160;            mapped_total / (<span class="keywordtype">size_t</span>)(1024 * 1024),</div>
<div class="line"><a name="l03399"></a><span class="lineno"> 3399</span>&#160;            unmapped_total / (<span class="keywordtype">size_t</span>)(1024 * 1024));</div>
<div class="line"><a name="l03400"></a><span class="lineno"> 3400</span>&#160; </div>
<div class="line"><a name="l03401"></a><span class="lineno"> 3401</span>&#160;    <a class="code" href="../../d8/d67/Kernel_2include__std_2stdio_8h.html#a0cba47cd44d0dd910da561bdc55a25ad">fprintf</a>(<a class="code" href="../../d0/d64/syscall_8cpp.html#a0eabe900500ad25646e5905a80f204de">file</a>, <span class="stringliteral">&quot;\n&quot;</span>);</div>
<div class="line"><a name="l03402"></a><span class="lineno"> 3402</span>&#160;<span class="preprocessor">#if 0</span></div>
<div class="line"><a name="l03403"></a><span class="lineno"> 3403</span>&#160;    <a class="code" href="../../dd/ddd/arithmetic__operations_8c.html#a996e72f71b11a5bb8b3b7b6936b1516d">int64_t</a> allocated = <a class="code" href="../../df/dc0/rpmalloc_8c.html#a083ecd4af0f476009595e8ee78cf2ac0">atomic_load64</a>(&amp;_allocation_counter);</div>
<div class="line"><a name="l03404"></a><span class="lineno"> 3404</span>&#160;    <a class="code" href="../../dd/ddd/arithmetic__operations_8c.html#a996e72f71b11a5bb8b3b7b6936b1516d">int64_t</a> deallocated = <a class="code" href="../../df/dc0/rpmalloc_8c.html#a083ecd4af0f476009595e8ee78cf2ac0">atomic_load64</a>(&amp;_deallocation_counter);</div>
<div class="line"><a name="l03405"></a><span class="lineno"> 3405</span>&#160;    <a class="code" href="../../d8/d67/Kernel_2include__std_2stdio_8h.html#a0cba47cd44d0dd910da561bdc55a25ad">fprintf</a>(<a class="code" href="../../d0/d64/syscall_8cpp.html#a0eabe900500ad25646e5905a80f204de">file</a>, <span class="stringliteral">&quot;Allocation count: %lli\n&quot;</span>, allocated);</div>
<div class="line"><a name="l03406"></a><span class="lineno"> 3406</span>&#160;    <a class="code" href="../../d8/d67/Kernel_2include__std_2stdio_8h.html#a0cba47cd44d0dd910da561bdc55a25ad">fprintf</a>(<a class="code" href="../../d0/d64/syscall_8cpp.html#a0eabe900500ad25646e5905a80f204de">file</a>, <span class="stringliteral">&quot;Deallocation count: %lli\n&quot;</span>, deallocated);</div>
<div class="line"><a name="l03407"></a><span class="lineno"> 3407</span>&#160;    <a class="code" href="../../d8/d67/Kernel_2include__std_2stdio_8h.html#a0cba47cd44d0dd910da561bdc55a25ad">fprintf</a>(<a class="code" href="../../d0/d64/syscall_8cpp.html#a0eabe900500ad25646e5905a80f204de">file</a>, <span class="stringliteral">&quot;Current allocations: %lli\n&quot;</span>, (allocated - deallocated));</div>
<div class="line"><a name="l03408"></a><span class="lineno"> 3408</span>&#160;    <a class="code" href="../../d8/d67/Kernel_2include__std_2stdio_8h.html#a0cba47cd44d0dd910da561bdc55a25ad">fprintf</a>(<a class="code" href="../../d0/d64/syscall_8cpp.html#a0eabe900500ad25646e5905a80f204de">file</a>, <span class="stringliteral">&quot;Master spans: %d\n&quot;</span>, atomic_load32(&amp;_master_spans));</div>
<div class="line"><a name="l03409"></a><span class="lineno"> 3409</span>&#160;    <a class="code" href="../../d8/d67/Kernel_2include__std_2stdio_8h.html#a0cba47cd44d0dd910da561bdc55a25ad">fprintf</a>(<a class="code" href="../../d0/d64/syscall_8cpp.html#a0eabe900500ad25646e5905a80f204de">file</a>, <span class="stringliteral">&quot;Dangling master spans: %d\n&quot;</span>, atomic_load32(&amp;_unmapped_master_spans));</div>
<div class="line"><a name="l03410"></a><span class="lineno"> 3410</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l03411"></a><span class="lineno"> 3411</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l03412"></a><span class="lineno"> 3412</span>&#160;    (void)<span class="keyword">sizeof</span>(<a class="code" href="../../d0/d64/syscall_8cpp.html#a0eabe900500ad25646e5905a80f204de">file</a>);</div>
<div class="line"><a name="l03413"></a><span class="lineno"> 3413</span>&#160;}</div>
<div class="line"><a name="l03414"></a><span class="lineno"> 3414</span>&#160; </div>
<div class="line"><a name="l03415"></a><span class="lineno"> 3415</span>&#160;<span class="preprocessor">#if RPMALLOC_FIRST_CLASS_HEAPS</span></div>
<div class="line"><a name="l03416"></a><span class="lineno"> 3416</span>&#160; </div>
<div class="line"><a name="l03417"></a><span class="lineno"> 3417</span>&#160;<span class="keyword">extern</span> <span class="keyword">inline</span> rpmalloc_heap_t *</div>
<div class="line"><a name="l03418"></a><span class="lineno"> 3418</span>&#160;rpmalloc_heap_acquire(<span class="keywordtype">void</span>)</div>
<div class="line"><a name="l03419"></a><span class="lineno"> 3419</span>&#160;{</div>
<div class="line"><a name="l03420"></a><span class="lineno"> 3420</span>&#160;    <span class="comment">// Must be a pristine heap from newly mapped memory pages, or else memory blocks</span></div>
<div class="line"><a name="l03421"></a><span class="lineno"> 3421</span>&#160;    <span class="comment">// could already be allocated from the heap which would (wrongly) be released when</span></div>
<div class="line"><a name="l03422"></a><span class="lineno"> 3422</span>&#160;    <span class="comment">// heap is cleared with rpmalloc_heap_free_all(). Also heaps guaranteed to be</span></div>
<div class="line"><a name="l03423"></a><span class="lineno"> 3423</span>&#160;    <span class="comment">// pristine from the dedicated orphan list can be used.</span></div>
<div class="line"><a name="l03424"></a><span class="lineno"> 3424</span>&#160;    <a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#d9/d8a/structheap__t">heap_t</a> *heap = <a class="code" href="../../df/dc0/rpmalloc_8c.html#a4ca7faed398dff40d231cbce5ebcc845">_rpmalloc_heap_allocate</a>(1);</div>
<div class="line"><a name="l03425"></a><span class="lineno"> 3425</span>&#160;    heap-&gt;<a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#a436e67271364d132c12f2f5f0d4c79ef">owner_thread</a> = 0;</div>
<div class="line"><a name="l03426"></a><span class="lineno"> 3426</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#ab51bbcd0d9d41ba9c6f4ad547ba77405">_rpmalloc_stat_inc</a>(&amp;_memory_active_heaps);</div>
<div class="line"><a name="l03427"></a><span class="lineno"> 3427</span>&#160;    <span class="keywordflow">return</span> heap;</div>
<div class="line"><a name="l03428"></a><span class="lineno"> 3428</span>&#160;}</div>
<div class="line"><a name="l03429"></a><span class="lineno"> 3429</span>&#160; </div>
<div class="line"><a name="l03430"></a><span class="lineno"> 3430</span>&#160;<span class="keyword">extern</span> <span class="keyword">inline</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="l03431"></a><span class="lineno"> 3431</span>&#160;rpmalloc_heap_release(rpmalloc_heap_t *heap)</div>
<div class="line"><a name="l03432"></a><span class="lineno"> 3432</span>&#160;{</div>
<div class="line"><a name="l03433"></a><span class="lineno"> 3433</span>&#160;    <span class="keywordflow">if</span> (heap)</div>
<div class="line"><a name="l03434"></a><span class="lineno"> 3434</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#a1b9ab55b2401b2d4240bbca4b313f6a2">_rpmalloc_heap_release</a>(heap, 1, 1);</div>
<div class="line"><a name="l03435"></a><span class="lineno"> 3435</span>&#160;}</div>
<div class="line"><a name="l03436"></a><span class="lineno"> 3436</span>&#160; </div>
<div class="line"><a name="l03437"></a><span class="lineno"> 3437</span>&#160;<span class="keyword">extern</span> <span class="keyword">inline</span> <a class="code" href="../../d2/d43/rpmalloc_8h.html#a85561f3ac6a729bf480cdf706d6c75dc">RPMALLOC_ALLOCATOR</a> <span class="keywordtype">void</span> *</div>
<div class="line"><a name="l03438"></a><span class="lineno"> 3438</span>&#160;rpmalloc_heap_alloc(rpmalloc_heap_t *heap, <span class="keywordtype">size_t</span> <a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a>)</div>
<div class="line"><a name="l03439"></a><span class="lineno"> 3439</span>&#160;{</div>
<div class="line"><a name="l03440"></a><span class="lineno"> 3440</span>&#160;<span class="preprocessor">#if ENABLE_VALIDATE_ARGS</span></div>
<div class="line"><a name="l03441"></a><span class="lineno"> 3441</span>&#160;    <a class="code" href="../../dc/d6b/Kernel_2include__std_2assert_8h.html#af576bf8ffa22a44e53018c67095ffbf0">assert</a>(<a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a> &lt; <a class="code" href="../../df/dc0/rpmalloc_8c.html#a6ea14607e2b19ee5aa336addd0fdde01">MAX_ALLOC_SIZE</a>);</div>
<div class="line"><a name="l03442"></a><span class="lineno"> 3442</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l03443"></a><span class="lineno"> 3443</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#af8bd0cd08a93d20cb117e18d85f877cd">_rpmalloc_allocate</a>(heap, <a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a>);</div>
<div class="line"><a name="l03444"></a><span class="lineno"> 3444</span>&#160;}</div>
<div class="line"><a name="l03445"></a><span class="lineno"> 3445</span>&#160; </div>
<div class="line"><a name="l03446"></a><span class="lineno"> 3446</span>&#160;<span class="keyword">extern</span> <span class="keyword">inline</span> <a class="code" href="../../d2/d43/rpmalloc_8h.html#a85561f3ac6a729bf480cdf706d6c75dc">RPMALLOC_ALLOCATOR</a> <span class="keywordtype">void</span> *</div>
<div class="line"><a name="l03447"></a><span class="lineno"> 3447</span>&#160;rpmalloc_heap_aligned_alloc(rpmalloc_heap_t *heap, <span class="keywordtype">size_t</span> alignment, <span class="keywordtype">size_t</span> <a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a>)</div>
<div class="line"><a name="l03448"></a><span class="lineno"> 3448</span>&#160;{</div>
<div class="line"><a name="l03449"></a><span class="lineno"> 3449</span>&#160;<span class="preprocessor">#if ENABLE_VALIDATE_ARGS</span></div>
<div class="line"><a name="l03450"></a><span class="lineno"> 3450</span>&#160;    <a class="code" href="../../dc/d6b/Kernel_2include__std_2assert_8h.html#af576bf8ffa22a44e53018c67095ffbf0">assert</a>(<a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a> &lt; <a class="code" href="../../df/dc0/rpmalloc_8c.html#a6ea14607e2b19ee5aa336addd0fdde01">MAX_ALLOC_SIZE</a>);</div>
<div class="line"><a name="l03451"></a><span class="lineno"> 3451</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l03452"></a><span class="lineno"> 3452</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#a4be7846b7aabc5b469a4cc66dbc6fb36">_rpmalloc_aligned_allocate</a>(heap, alignment, <a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a>);</div>
<div class="line"><a name="l03453"></a><span class="lineno"> 3453</span>&#160;}</div>
<div class="line"><a name="l03454"></a><span class="lineno"> 3454</span>&#160; </div>
<div class="line"><a name="l03455"></a><span class="lineno"> 3455</span>&#160;<span class="keyword">extern</span> <span class="keyword">inline</span> <a class="code" href="../../d2/d43/rpmalloc_8h.html#a85561f3ac6a729bf480cdf706d6c75dc">RPMALLOC_ALLOCATOR</a> <span class="keywordtype">void</span> *</div>
<div class="line"><a name="l03456"></a><span class="lineno"> 3456</span>&#160;rpmalloc_heap_calloc(rpmalloc_heap_t *heap, <span class="keywordtype">size_t</span> <a class="code" href="../../d7/da1/fma_8c.html#d6/df8/structnum">num</a>, <span class="keywordtype">size_t</span> <a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a>)</div>
<div class="line"><a name="l03457"></a><span class="lineno"> 3457</span>&#160;{</div>
<div class="line"><a name="l03458"></a><span class="lineno"> 3458</span>&#160;    <span class="keywordflow">return</span> rpmalloc_heap_aligned_calloc(heap, 0, <a class="code" href="../../d7/da1/fma_8c.html#d6/df8/structnum">num</a>, <a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a>);</div>
<div class="line"><a name="l03459"></a><span class="lineno"> 3459</span>&#160;}</div>
<div class="line"><a name="l03460"></a><span class="lineno"> 3460</span>&#160; </div>
<div class="line"><a name="l03461"></a><span class="lineno"> 3461</span>&#160;<span class="keyword">extern</span> <span class="keyword">inline</span> <a class="code" href="../../d2/d43/rpmalloc_8h.html#a85561f3ac6a729bf480cdf706d6c75dc">RPMALLOC_ALLOCATOR</a> <span class="keywordtype">void</span> *</div>
<div class="line"><a name="l03462"></a><span class="lineno"> 3462</span>&#160;rpmalloc_heap_aligned_calloc(rpmalloc_heap_t *heap, <span class="keywordtype">size_t</span> alignment, <span class="keywordtype">size_t</span> <a class="code" href="../../d7/da1/fma_8c.html#d6/df8/structnum">num</a>, <span class="keywordtype">size_t</span> <a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a>)</div>
<div class="line"><a name="l03463"></a><span class="lineno"> 3463</span>&#160;{</div>
<div class="line"><a name="l03464"></a><span class="lineno"> 3464</span>&#160;    <span class="keywordtype">size_t</span> <a class="code" href="../../d6/d23/wi__stuff_8c.html#a81ad3ca73b21fc89fbb692189bb4031b">total</a>;</div>
<div class="line"><a name="l03465"></a><span class="lineno"> 3465</span>&#160;<span class="preprocessor">#if ENABLE_VALIDATE_ARGS</span></div>
<div class="line"><a name="l03466"></a><span class="lineno"> 3466</span>&#160;    <span class="keywordtype">int</span> <a class="code" href="../../d6/d40/err_8h.html#aa31bca214cc8f135a43aa7fbea017326">err</a> = __builtin_umull_overflow(<a class="code" href="../../d7/da1/fma_8c.html#d6/df8/structnum">num</a>, <a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a>, &amp;<a class="code" href="../../d6/d23/wi__stuff_8c.html#a81ad3ca73b21fc89fbb692189bb4031b">total</a>);</div>
<div class="line"><a name="l03467"></a><span class="lineno"> 3467</span>&#160;    <a class="code" href="../../dc/d6b/Kernel_2include__std_2assert_8h.html#af576bf8ffa22a44e53018c67095ffbf0">assert</a>(!<a class="code" href="../../d6/d40/err_8h.html#aa31bca214cc8f135a43aa7fbea017326">err</a> &amp;&amp; (<a class="code" href="../../d6/d23/wi__stuff_8c.html#a81ad3ca73b21fc89fbb692189bb4031b">total</a> &lt; <a class="code" href="../../df/dc0/rpmalloc_8c.html#a6ea14607e2b19ee5aa336addd0fdde01">MAX_ALLOC_SIZE</a>));</div>
<div class="line"><a name="l03468"></a><span class="lineno"> 3468</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l03469"></a><span class="lineno"> 3469</span>&#160;    <a class="code" href="../../d6/d23/wi__stuff_8c.html#a81ad3ca73b21fc89fbb692189bb4031b">total</a> = <a class="code" href="../../d7/da1/fma_8c.html#d6/df8/structnum">num</a> * <a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a>;</div>
<div class="line"><a name="l03470"></a><span class="lineno"> 3470</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l03471"></a><span class="lineno"> 3471</span>&#160;    <span class="keywordtype">void</span> *block = <a class="code" href="../../df/dc0/rpmalloc_8c.html#a4be7846b7aabc5b469a4cc66dbc6fb36">_rpmalloc_aligned_allocate</a>(heap, alignment, <a class="code" href="../../d6/d23/wi__stuff_8c.html#a81ad3ca73b21fc89fbb692189bb4031b">total</a>);</div>
<div class="line"><a name="l03472"></a><span class="lineno"> 3472</span>&#160;    <span class="keywordflow">if</span> (block)</div>
<div class="line"><a name="l03473"></a><span class="lineno"> 3473</span>&#160;        <a class="code" href="../../d3/d82/convert_8h.html#a9c1f204516a55affa9ba118907e5ab6b">memset_unsafe</a>(block, 0, <a class="code" href="../../d6/d23/wi__stuff_8c.html#a81ad3ca73b21fc89fbb692189bb4031b">total</a>);</div>
<div class="line"><a name="l03474"></a><span class="lineno"> 3474</span>&#160;    <span class="keywordflow">return</span> block;</div>
<div class="line"><a name="l03475"></a><span class="lineno"> 3475</span>&#160;}</div>
<div class="line"><a name="l03476"></a><span class="lineno"> 3476</span>&#160; </div>
<div class="line"><a name="l03477"></a><span class="lineno"> 3477</span>&#160;<span class="keyword">extern</span> <span class="keyword">inline</span> <a class="code" href="../../d2/d43/rpmalloc_8h.html#a85561f3ac6a729bf480cdf706d6c75dc">RPMALLOC_ALLOCATOR</a> <span class="keywordtype">void</span> *</div>
<div class="line"><a name="l03478"></a><span class="lineno"> 3478</span>&#160;rpmalloc_heap_realloc(rpmalloc_heap_t *heap, <span class="keywordtype">void</span> *ptr, <span class="keywordtype">size_t</span> <a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a>, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> flags)</div>
<div class="line"><a name="l03479"></a><span class="lineno"> 3479</span>&#160;{</div>
<div class="line"><a name="l03480"></a><span class="lineno"> 3480</span>&#160;<span class="preprocessor">#if ENABLE_VALIDATE_ARGS</span></div>
<div class="line"><a name="l03481"></a><span class="lineno"> 3481</span>&#160;    <a class="code" href="../../dc/d6b/Kernel_2include__std_2assert_8h.html#af576bf8ffa22a44e53018c67095ffbf0">assert</a>(<a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a> &lt; <a class="code" href="../../df/dc0/rpmalloc_8c.html#a6ea14607e2b19ee5aa336addd0fdde01">MAX_ALLOC_SIZE</a>);</div>
<div class="line"><a name="l03482"></a><span class="lineno"> 3482</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l03483"></a><span class="lineno"> 3483</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#a5c46183a2d82b761e9438c65b0dbad62">_rpmalloc_reallocate</a>(heap, ptr, <a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a>, 0, flags);</div>
<div class="line"><a name="l03484"></a><span class="lineno"> 3484</span>&#160;}</div>
<div class="line"><a name="l03485"></a><span class="lineno"> 3485</span>&#160; </div>
<div class="line"><a name="l03486"></a><span class="lineno"> 3486</span>&#160;<span class="keyword">extern</span> <span class="keyword">inline</span> <a class="code" href="../../d2/d43/rpmalloc_8h.html#a85561f3ac6a729bf480cdf706d6c75dc">RPMALLOC_ALLOCATOR</a> <span class="keywordtype">void</span> *</div>
<div class="line"><a name="l03487"></a><span class="lineno"> 3487</span>&#160;rpmalloc_heap_aligned_realloc(rpmalloc_heap_t *heap, <span class="keywordtype">void</span> *ptr, <span class="keywordtype">size_t</span> alignment, <span class="keywordtype">size_t</span> <a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a>, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> flags)</div>
<div class="line"><a name="l03488"></a><span class="lineno"> 3488</span>&#160;{</div>
<div class="line"><a name="l03489"></a><span class="lineno"> 3489</span>&#160;<span class="preprocessor">#if ENABLE_VALIDATE_ARGS</span></div>
<div class="line"><a name="l03490"></a><span class="lineno"> 3490</span>&#160;    <a class="code" href="../../dc/d6b/Kernel_2include__std_2assert_8h.html#af576bf8ffa22a44e53018c67095ffbf0">assert</a>((<a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a> + alignment) &gt;= <a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a> &amp;&amp; (alignment &lt;= <a class="code" href="../../df/dc0/rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a>));</div>
<div class="line"><a name="l03491"></a><span class="lineno"> 3491</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l03492"></a><span class="lineno"> 3492</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="../../df/dc0/rpmalloc_8c.html#a0d0546abbe1244019d00ecf28aac359c">_rpmalloc_aligned_reallocate</a>(heap, ptr, alignment, <a class="code" href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a>, 0, flags);</div>
<div class="line"><a name="l03493"></a><span class="lineno"> 3493</span>&#160;}</div>
<div class="line"><a name="l03494"></a><span class="lineno"> 3494</span>&#160; </div>
<div class="line"><a name="l03495"></a><span class="lineno"> 3495</span>&#160;<span class="keyword">extern</span> <span class="keyword">inline</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="l03496"></a><span class="lineno"> 3496</span>&#160;rpmalloc_heap_free(rpmalloc_heap_t *heap, <span class="keywordtype">void</span> *ptr)</div>
<div class="line"><a name="l03497"></a><span class="lineno"> 3497</span>&#160;{</div>
<div class="line"><a name="l03498"></a><span class="lineno"> 3498</span>&#160;    (void)<span class="keyword">sizeof</span>(heap);</div>
<div class="line"><a name="l03499"></a><span class="lineno"> 3499</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#ae324fa158db468143544693dfe539800">_rpmalloc_deallocate</a>(ptr);</div>
<div class="line"><a name="l03500"></a><span class="lineno"> 3500</span>&#160;}</div>
<div class="line"><a name="l03501"></a><span class="lineno"> 3501</span>&#160; </div>
<div class="line"><a name="l03502"></a><span class="lineno"> 3502</span>&#160;<span class="keyword">extern</span> <span class="keyword">inline</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="l03503"></a><span class="lineno"> 3503</span>&#160;rpmalloc_heap_free_all(rpmalloc_heap_t *heap)</div>
<div class="line"><a name="l03504"></a><span class="lineno"> 3504</span>&#160;{</div>
<div class="line"><a name="l03505"></a><span class="lineno"> 3505</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *span;</div>
<div class="line"><a name="l03506"></a><span class="lineno"> 3506</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a> *next_span;</div>
<div class="line"><a name="l03507"></a><span class="lineno"> 3507</span>&#160; </div>
<div class="line"><a name="l03508"></a><span class="lineno"> 3508</span>&#160;    <a class="code" href="../../df/dc0/rpmalloc_8c.html#af44e92f7ed42c434bd33a0ae98210a3f">_rpmalloc_heap_cache_adopt_deferred</a>(heap, 0);</div>
<div class="line"><a name="l03509"></a><span class="lineno"> 3509</span>&#160; </div>
<div class="line"><a name="l03510"></a><span class="lineno"> 3510</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> iclass = 0; iclass &lt; <a class="code" href="../../df/dc0/rpmalloc_8c.html#aa74d427b2b9955ff2d9719693d9fc80e">SIZE_CLASS_COUNT</a>; ++iclass)</div>
<div class="line"><a name="l03511"></a><span class="lineno"> 3511</span>&#160;    {</div>
<div class="line"><a name="l03512"></a><span class="lineno"> 3512</span>&#160;        span = heap-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a5a977febdd2e9ae15bcf66f83d0cf817">size_class</a>[iclass].partial_span;</div>
<div class="line"><a name="l03513"></a><span class="lineno"> 3513</span>&#160;        <span class="keywordflow">while</span> (span)</div>
<div class="line"><a name="l03514"></a><span class="lineno"> 3514</span>&#160;        {</div>
<div class="line"><a name="l03515"></a><span class="lineno"> 3515</span>&#160;            next_span = span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#ac62e0e77eb38ebff4443eb5db3ccd45c">next</a>;</div>
<div class="line"><a name="l03516"></a><span class="lineno"> 3516</span>&#160;            <a class="code" href="../../df/dc0/rpmalloc_8c.html#abdbbc20ab63d76c1709722f3f2305610">_rpmalloc_heap_cache_insert</a>(heap, span);</div>
<div class="line"><a name="l03517"></a><span class="lineno"> 3517</span>&#160;            span = next_span;</div>
<div class="line"><a name="l03518"></a><span class="lineno"> 3518</span>&#160;        }</div>
<div class="line"><a name="l03519"></a><span class="lineno"> 3519</span>&#160;        heap-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a5a977febdd2e9ae15bcf66f83d0cf817">size_class</a>[iclass].partial_span = 0;</div>
<div class="line"><a name="l03520"></a><span class="lineno"> 3520</span>&#160;        span = heap-&gt;full_span[iclass];</div>
<div class="line"><a name="l03521"></a><span class="lineno"> 3521</span>&#160;        <span class="keywordflow">while</span> (span)</div>
<div class="line"><a name="l03522"></a><span class="lineno"> 3522</span>&#160;        {</div>
<div class="line"><a name="l03523"></a><span class="lineno"> 3523</span>&#160;            next_span = span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#ac62e0e77eb38ebff4443eb5db3ccd45c">next</a>;</div>
<div class="line"><a name="l03524"></a><span class="lineno"> 3524</span>&#160;            <a class="code" href="../../df/dc0/rpmalloc_8c.html#abdbbc20ab63d76c1709722f3f2305610">_rpmalloc_heap_cache_insert</a>(heap, span);</div>
<div class="line"><a name="l03525"></a><span class="lineno"> 3525</span>&#160;            span = next_span;</div>
<div class="line"><a name="l03526"></a><span class="lineno"> 3526</span>&#160;        }</div>
<div class="line"><a name="l03527"></a><span class="lineno"> 3527</span>&#160;    }</div>
<div class="line"><a name="l03528"></a><span class="lineno"> 3528</span>&#160;    <a class="code" href="../../d3/d82/convert_8h.html#a9c1f204516a55affa9ba118907e5ab6b">memset_unsafe</a>(heap-&gt;size_class, 0, <span class="keyword">sizeof</span>(heap-&gt;size_class));</div>
<div class="line"><a name="l03529"></a><span class="lineno"> 3529</span>&#160;    <a class="code" href="../../d3/d82/convert_8h.html#a9c1f204516a55affa9ba118907e5ab6b">memset_unsafe</a>(heap-&gt;full_span, 0, <span class="keyword">sizeof</span>(heap-&gt;full_span));</div>
<div class="line"><a name="l03530"></a><span class="lineno"> 3530</span>&#160; </div>
<div class="line"><a name="l03531"></a><span class="lineno"> 3531</span>&#160;    span = heap-&gt;large_huge_span;</div>
<div class="line"><a name="l03532"></a><span class="lineno"> 3532</span>&#160;    <span class="keywordflow">while</span> (span)</div>
<div class="line"><a name="l03533"></a><span class="lineno"> 3533</span>&#160;    {</div>
<div class="line"><a name="l03534"></a><span class="lineno"> 3534</span>&#160;        next_span = span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#ac62e0e77eb38ebff4443eb5db3ccd45c">next</a>;</div>
<div class="line"><a name="l03535"></a><span class="lineno"> 3535</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="../../df/dc0/rpmalloc_8c.html#af8f864d9fe0055b43dc8034fe9060630">UNEXPECTED</a>(span-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a5a977febdd2e9ae15bcf66f83d0cf817">size_class</a> == <a class="code" href="../../df/dc0/rpmalloc_8c.html#a284460248778c94b6ee9ea1529299439">SIZE_CLASS_HUGE</a>))</div>
<div class="line"><a name="l03536"></a><span class="lineno"> 3536</span>&#160;            <a class="code" href="../../df/dc0/rpmalloc_8c.html#a428539d1600391a04bfc27f74980df5e">_rpmalloc_deallocate_huge</a>(span);</div>
<div class="line"><a name="l03537"></a><span class="lineno"> 3537</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l03538"></a><span class="lineno"> 3538</span>&#160;            <a class="code" href="../../df/dc0/rpmalloc_8c.html#abdbbc20ab63d76c1709722f3f2305610">_rpmalloc_heap_cache_insert</a>(heap, span);</div>
<div class="line"><a name="l03539"></a><span class="lineno"> 3539</span>&#160;        span = next_span;</div>
<div class="line"><a name="l03540"></a><span class="lineno"> 3540</span>&#160;    }</div>
<div class="line"><a name="l03541"></a><span class="lineno"> 3541</span>&#160;    heap-&gt;large_huge_span = 0;</div>
<div class="line"><a name="l03542"></a><span class="lineno"> 3542</span>&#160;    heap-&gt;full_span_count = 0;</div>
<div class="line"><a name="l03543"></a><span class="lineno"> 3543</span>&#160; </div>
<div class="line"><a name="l03544"></a><span class="lineno"> 3544</span>&#160;<span class="preprocessor">#if ENABLE_THREAD_CACHE</span></div>
<div class="line"><a name="l03545"></a><span class="lineno"> 3545</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> iclass = 0; iclass &lt; <a class="code" href="../../df/dc0/rpmalloc_8c.html#a04406da3f5ff4e24f155c97591678ed9">LARGE_CLASS_COUNT</a>; ++iclass)</div>
<div class="line"><a name="l03546"></a><span class="lineno"> 3546</span>&#160;    {</div>
<div class="line"><a name="l03547"></a><span class="lineno"> 3547</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#da/d15/structspan__cache__t">span_cache_t</a> *span_cache;</div>
<div class="line"><a name="l03548"></a><span class="lineno"> 3548</span>&#160;        <span class="keywordflow">if</span> (!iclass)</div>
<div class="line"><a name="l03549"></a><span class="lineno"> 3549</span>&#160;            span_cache = &amp;heap-&gt;span_cache;</div>
<div class="line"><a name="l03550"></a><span class="lineno"> 3550</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l03551"></a><span class="lineno"> 3551</span>&#160;            span_cache = (<a class="code" href="../../df/dc0/rpmalloc_8c.html#da/d15/structspan__cache__t">span_cache_t</a> *)(heap-&gt;span_large_cache + (iclass - 1));</div>
<div class="line"><a name="l03552"></a><span class="lineno"> 3552</span>&#160;        <span class="keywordflow">if</span> (!span_cache-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a894a66f329862f01de7619aee1954d19">count</a>)</div>
<div class="line"><a name="l03553"></a><span class="lineno"> 3553</span>&#160;            <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l03554"></a><span class="lineno"> 3554</span>&#160;<span class="preprocessor">#if ENABLE_GLOBAL_CACHE</span></div>
<div class="line"><a name="l03555"></a><span class="lineno"> 3555</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#a49e532a65b873a6c3315aa769299687c">_rpmalloc_stat_add64</a>(&amp;heap-&gt;thread_to_global, span_cache-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a894a66f329862f01de7619aee1954d19">count</a> * (iclass + 1) * <a class="code" href="../../df/dc0/rpmalloc_8c.html#a9fefa5277fefa0c58f69d5b86d679ccb">_memory_span_size</a>);</div>
<div class="line"><a name="l03556"></a><span class="lineno"> 3556</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#a4a53d0cfdcf755d4fbbae446a055440c">_rpmalloc_stat_add</a>(&amp;heap-&gt;span_use[iclass].spans_to_global, span_cache-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a894a66f329862f01de7619aee1954d19">count</a>);</div>
<div class="line"><a name="l03557"></a><span class="lineno"> 3557</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#a06d0861a56c7d5aac6e215ab0dceb9ca">_rpmalloc_global_cache_insert_spans</a>(span_cache-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a8cc6a9b0d6d8d6bf8367bca0101b1ae3">span</a>, iclass + 1, span_cache-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a894a66f329862f01de7619aee1954d19">count</a>);</div>
<div class="line"><a name="l03558"></a><span class="lineno"> 3558</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l03559"></a><span class="lineno"> 3559</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> ispan = 0; ispan &lt; span_cache-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a894a66f329862f01de7619aee1954d19">count</a>; ++ispan)</div>
<div class="line"><a name="l03560"></a><span class="lineno"> 3560</span>&#160;            <a class="code" href="../../df/dc0/rpmalloc_8c.html#a1b31ff8fa0abcdb205dadd8afc026014">_rpmalloc_span_unmap</a>(span_cache-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a8cc6a9b0d6d8d6bf8367bca0101b1ae3">span</a>[ispan]);</div>
<div class="line"><a name="l03561"></a><span class="lineno"> 3561</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l03562"></a><span class="lineno"> 3562</span>&#160;        span_cache-&gt;<a class="code" href="../../df/dc0/rpmalloc_8c.html#a894a66f329862f01de7619aee1954d19">count</a> = 0;</div>
<div class="line"><a name="l03563"></a><span class="lineno"> 3563</span>&#160;    }</div>
<div class="line"><a name="l03564"></a><span class="lineno"> 3564</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l03565"></a><span class="lineno"> 3565</span>&#160; </div>
<div class="line"><a name="l03566"></a><span class="lineno"> 3566</span>&#160;<span class="preprocessor">#if ENABLE_STATISTICS</span></div>
<div class="line"><a name="l03567"></a><span class="lineno"> 3567</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> iclass = 0; iclass &lt; <a class="code" href="../../df/dc0/rpmalloc_8c.html#aa74d427b2b9955ff2d9719693d9fc80e">SIZE_CLASS_COUNT</a>; ++iclass)</div>
<div class="line"><a name="l03568"></a><span class="lineno"> 3568</span>&#160;    {</div>
<div class="line"><a name="l03569"></a><span class="lineno"> 3569</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#aa1ee77cdccf0341222f64395d0be2626">atomic_store32</a>(&amp;heap-&gt;size_class_use[iclass].alloc_current, 0);</div>
<div class="line"><a name="l03570"></a><span class="lineno"> 3570</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#aa1ee77cdccf0341222f64395d0be2626">atomic_store32</a>(&amp;heap-&gt;size_class_use[iclass].spans_current, 0);</div>
<div class="line"><a name="l03571"></a><span class="lineno"> 3571</span>&#160;    }</div>
<div class="line"><a name="l03572"></a><span class="lineno"> 3572</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> iclass = 0; iclass &lt; <a class="code" href="../../df/dc0/rpmalloc_8c.html#a04406da3f5ff4e24f155c97591678ed9">LARGE_CLASS_COUNT</a>; ++iclass)</div>
<div class="line"><a name="l03573"></a><span class="lineno"> 3573</span>&#160;    {</div>
<div class="line"><a name="l03574"></a><span class="lineno"> 3574</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#aa1ee77cdccf0341222f64395d0be2626">atomic_store32</a>(&amp;heap-&gt;span_use[iclass].current, 0);</div>
<div class="line"><a name="l03575"></a><span class="lineno"> 3575</span>&#160;    }</div>
<div class="line"><a name="l03576"></a><span class="lineno"> 3576</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l03577"></a><span class="lineno"> 3577</span>&#160;}</div>
<div class="line"><a name="l03578"></a><span class="lineno"> 3578</span>&#160; </div>
<div class="line"><a name="l03579"></a><span class="lineno"> 3579</span>&#160;<span class="keyword">extern</span> <span class="keyword">inline</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="l03580"></a><span class="lineno"> 3580</span>&#160;rpmalloc_heap_thread_set_current(rpmalloc_heap_t *heap)</div>
<div class="line"><a name="l03581"></a><span class="lineno"> 3581</span>&#160;{</div>
<div class="line"><a name="l03582"></a><span class="lineno"> 3582</span>&#160;    <a class="code" href="../../d1/d7e/rpmalloc__compat_8cpp.html#d9/d8a/structheap__t">heap_t</a> *prev_heap = <a class="code" href="../../df/dc0/rpmalloc_8c.html#af7213260e19fbad385988302247150d4">get_thread_heap_raw</a>();</div>
<div class="line"><a name="l03583"></a><span class="lineno"> 3583</span>&#160;    <span class="keywordflow">if</span> (prev_heap != heap)</div>
<div class="line"><a name="l03584"></a><span class="lineno"> 3584</span>&#160;    {</div>
<div class="line"><a name="l03585"></a><span class="lineno"> 3585</span>&#160;        <a class="code" href="../../df/dc0/rpmalloc_8c.html#a4a224c6ef987eb60f3e3be98239109ec">set_thread_heap</a>(heap);</div>
<div class="line"><a name="l03586"></a><span class="lineno"> 3586</span>&#160;        <span class="keywordflow">if</span> (prev_heap)</div>
<div class="line"><a name="l03587"></a><span class="lineno"> 3587</span>&#160;            rpmalloc_heap_release(prev_heap);</div>
<div class="line"><a name="l03588"></a><span class="lineno"> 3588</span>&#160;    }</div>
<div class="line"><a name="l03589"></a><span class="lineno"> 3589</span>&#160;}</div>
<div class="line"><a name="l03590"></a><span class="lineno"> 3590</span>&#160; </div>
<div class="line"><a name="l03591"></a><span class="lineno"> 3591</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l03592"></a><span class="lineno"> 3592</span>&#160; </div>
<div class="line"><a name="l03593"></a><span class="lineno"> 3593</span>&#160;<span class="preprocessor">#if ENABLE_PRELOAD || ENABLE_OVERRIDE</span></div>
<div class="line"><a name="l03594"></a><span class="lineno"> 3594</span>&#160; </div>
<div class="line"><a name="l03595"></a><span class="lineno"> 3595</span>&#160;<span class="preprocessor">#include &quot;malloc.c&quot;</span></div>
<div class="line"><a name="l03596"></a><span class="lineno"> 3596</span>&#160; </div>
<div class="line"><a name="l03597"></a><span class="lineno"> 3597</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="ttc" id="aKernel_2include_2interface_2errno_8h_html_ab03f640d90fbc5bcb75285d08a0f25ed"><div class="ttname"><a href="../../df/d9b/Kernel_2include_2interface_2errno_8h.html#ab03f640d90fbc5bcb75285d08a0f25ed">errno</a></div><div class="ttdeci">#define errno</div><div class="ttdef"><b>Definition:</b> <a href="../../df/d9b/Kernel_2include_2interface_2errno_8h_source.html#l00593">errno.h:593</a></div></div>
<div class="ttc" id="aKernel_2include_2interface_2fs_8h_html_a8a8f6bdc98a851b29a69b484cb1bad98"><div class="ttname"><a href="../../da/d46/Kernel_2include_2interface_2fs_8h.html#a8a8f6bdc98a851b29a69b484cb1bad98">static_assert</a></div><div class="ttdeci">#define static_assert</div><div class="ttdef"><b>Definition:</b> <a href="../../da/d46/Kernel_2include_2interface_2fs_8h_source.html#l00132">fs.h:132</a></div></div>
<div class="ttc" id="aKernel_2include_2types_8h_html_a0bd5dec00e345e69027427f8621d6a6c"><div class="ttname"><a href="../../d0/df4/Kernel_2include_2types_8h.html#a0bd5dec00e345e69027427f8621d6a6c">intptr_t</a></div><div class="ttdeci">__INTPTR_TYPE__ intptr_t</div><div class="ttdef"><b>Definition:</b> <a href="../../d0/df4/Kernel_2include_2types_8h_source.html#l00134">types.h:134</a></div></div>
<div class="ttc" id="aKernel_2include_2types_8h_html_a0c18914b3041c2f583aba76f418399c2"><div class="ttname"><a href="../../d0/df4/Kernel_2include_2types_8h.html#a0c18914b3041c2f583aba76f418399c2">int32_t</a></div><div class="ttdeci">__INT32_TYPE__ int32_t</div><div class="ttdef"><b>Definition:</b> <a href="../../d0/df4/Kernel_2include_2types_8h_source.html#l00106">types.h:106</a></div></div>
<div class="ttc" id="aKernel_2include_2types_8h_html_a4788399d1d0b37ccf098a7da82254808"><div class="ttname"><a href="../../d0/df4/Kernel_2include_2types_8h.html#a4788399d1d0b37ccf098a7da82254808">uintptr_t</a></div><div class="ttdeci">__UINTPTR_TYPE__ uintptr_t</div><div class="ttdef"><b>Definition:</b> <a href="../../d0/df4/Kernel_2include_2types_8h_source.html#l00135">types.h:135</a></div></div>
<div class="ttc" id="aKernel_2include_2types_8h_html_a5debae8b2a1ec20a6694c0c443ee399e"><div class="ttname"><a href="../../d0/df4/Kernel_2include_2types_8h.html#a5debae8b2a1ec20a6694c0c443ee399e">uint16_t</a></div><div class="ttdeci">__UINT16_TYPE__ uint16_t</div><div class="ttdef"><b>Definition:</b> <a href="../../d0/df4/Kernel_2include_2types_8h_source.html#l00110">types.h:110</a></div></div>
<div class="ttc" id="aKernel_2include_2types_8h_html_a6d26a0475a6d6c897e655cdc5d8019d2"><div class="ttname"><a href="../../d0/df4/Kernel_2include_2types_8h.html#a6d26a0475a6d6c897e655cdc5d8019d2">ptrdiff_t</a></div><div class="ttdeci">__PTRDIFF_TYPE__ ptrdiff_t</div><div class="ttdef"><b>Definition:</b> <a href="../../d0/df4/Kernel_2include_2types_8h_source.html#l00140">types.h:140</a></div></div>
<div class="ttc" id="aKernel_2include_2types_8h_html_aa9d55e2f20e580b7445617d0d12fff6e"><div class="ttname"><a href="../../d0/df4/Kernel_2include_2types_8h.html#aa9d55e2f20e580b7445617d0d12fff6e">size_t</a></div><div class="ttdeci">__SIZE_TYPE__ size_t</div><div class="ttdef"><b>Definition:</b> <a href="../../d0/df4/Kernel_2include_2types_8h_source.html#l00141">types.h:141</a></div></div>
<div class="ttc" id="aKernel_2include__std_2assert_8h_html_af576bf8ffa22a44e53018c67095ffbf0"><div class="ttname"><a href="../../dc/d6b/Kernel_2include__std_2assert_8h.html#af576bf8ffa22a44e53018c67095ffbf0">assert</a></div><div class="ttdeci">#define assert(x)</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/d6b/Kernel_2include__std_2assert_8h_source.html#l00026">assert.h:26</a></div></div>
<div class="ttc" id="aKernel_2include__std_2stdio_8h_html_a0cba47cd44d0dd910da561bdc55a25ad"><div class="ttname"><a href="../../d8/d67/Kernel_2include__std_2stdio_8h.html#a0cba47cd44d0dd910da561bdc55a25ad">fprintf</a></div><div class="ttdeci">int int int int int int int int int fprintf(FILE *stream, const char *format,...) __attribute__((format(__printf__</div></div>
<div class="ttc" id="aKernel_2include__std_2stdio_8h_html_de/dc3/structFILE"><div class="ttname"><a href="../../d8/d67/Kernel_2include__std_2stdio_8h.html#de/dc3/structFILE">FILE</a></div><div class="ttdef"><b>Definition:</b> <a href="../../d8/d67/Kernel_2include__std_2stdio_8h_source.html#l00027">stdio.h:28</a></div></div>
<div class="ttc" id="aKernel_2include__std_2sys_2mman_8h_html_a15bf68ce8b590838b3a5c0b639d8d519"><div class="ttname"><a href="../../d1/deb/Kernel_2include__std_2sys_2mman_8h.html#a15bf68ce8b590838b3a5c0b639d8d519">PROT_READ</a></div><div class="ttdeci">#define PROT_READ</div><div class="ttdef"><b>Definition:</b> <a href="../../d1/deb/Kernel_2include__std_2sys_2mman_8h_source.html#l00032">mman.h:32</a></div></div>
<div class="ttc" id="aKernel_2include__std_2sys_2mman_8h_html_a2a79c8ceefb8fc25a940ae07a3d94429"><div class="ttname"><a href="../../d1/deb/Kernel_2include__std_2sys_2mman_8h.html#a2a79c8ceefb8fc25a940ae07a3d94429">PROT_WRITE</a></div><div class="ttdeci">#define PROT_WRITE</div><div class="ttdef"><b>Definition:</b> <a href="../../d1/deb/Kernel_2include__std_2sys_2mman_8h_source.html#l00036">mman.h:36</a></div></div>
<div class="ttc" id="aKernel_2include__std_2sys_2mman_8h_html_a398ef47a991a44389aa9818c98a28d24"><div class="ttname"><a href="../../d1/deb/Kernel_2include__std_2sys_2mman_8h.html#a398ef47a991a44389aa9818c98a28d24">MAP_PRIVATE</a></div><div class="ttdeci">#define MAP_PRIVATE</div><div class="ttdef"><b>Definition:</b> <a href="../../d1/deb/Kernel_2include__std_2sys_2mman_8h_source.html#l00024">mman.h:24</a></div></div>
<div class="ttc" id="aKernel_2include__std_2sys_2mman_8h_html_a8523dcf952f6ff059a3bed717e4f1296"><div class="ttname"><a href="../../d1/deb/Kernel_2include__std_2sys_2mman_8h.html#a8523dcf952f6ff059a3bed717e4f1296">MAP_FAILED</a></div><div class="ttdeci">#define MAP_FAILED</div><div class="ttdef"><b>Definition:</b> <a href="../../d1/deb/Kernel_2include__std_2sys_2mman_8h_source.html#l00040">mman.h:40</a></div></div>
<div class="ttc" id="aKernel_2include__std_2sys_2mman_8h_html_a930a5f4c7440ba221317ea3bf8139b58"><div class="ttname"><a href="../../d1/deb/Kernel_2include__std_2sys_2mman_8h.html#a930a5f4c7440ba221317ea3bf8139b58">POSIX_MADV_DONTNEED</a></div><div class="ttdeci">#define POSIX_MADV_DONTNEED</div><div class="ttdef"><b>Definition:</b> <a href="../../d1/deb/Kernel_2include__std_2sys_2mman_8h_source.html#l00044">mman.h:44</a></div></div>
<div class="ttc" id="aKernel_2include__std_2sys_2mman_8h_html_ae4f86bff73414c5fc08c058f957212f0"><div class="ttname"><a href="../../d1/deb/Kernel_2include__std_2sys_2mman_8h.html#ae4f86bff73414c5fc08c058f957212f0">MAP_ANONYMOUS</a></div><div class="ttdeci">#define MAP_ANONYMOUS</div><div class="ttdef"><b>Definition:</b> <a href="../../d1/deb/Kernel_2include__std_2sys_2mman_8h_source.html#l00028">mman.h:28</a></div></div>
<div class="ttc" id="aKernel_2include__std_2time_8h_html_da/d1c/structtimespec"><div class="ttname"><a href="../../de/d98/Kernel_2include__std_2time_8h.html#da/d1c/structtimespec">timespec</a></div><div class="ttdef"><b>Definition:</b> <a href="../../de/d98/Kernel_2include__std_2time_8h_source.html#l00023">time.h:24</a></div></div>
<div class="ttc" id="aKernel_2include__std_2unistd_8h_html_af8524bbbaf09850389a58789b72caf52"><div class="ttname"><a href="../../d2/d58/Kernel_2include__std_2unistd_8h.html#af8524bbbaf09850389a58789b72caf52">_SC_PAGESIZE</a></div><div class="ttdeci">#define _SC_PAGESIZE</div><div class="ttdef"><b>Definition:</b> <a href="../../d2/d58/Kernel_2include__std_2unistd_8h_source.html#l00023">unistd.h:23</a></div></div>
<div class="ttc" id="aUserspace_2libc_2include_2errno_8h_html_a2d1678d5a7cc8ce499643f3b8957def4"><div class="ttname"><a href="../../df/d53/Userspace_2libc_2include_2errno_8h.html#a2d1678d5a7cc8ce499643f3b8957def4">EINVAL</a></div><div class="ttdeci">#define EINVAL</div><div class="ttdef"><b>Definition:</b> <a href="../../df/d53/Userspace_2libc_2include_2errno_8h_source.html#l00025">errno.h:25</a></div></div>
<div class="ttc" id="aUserspace_2libc_2include_2errno_8h_html_a6a05c923dad0c1208043e9c20a58c8e5"><div class="ttname"><a href="../../df/d53/Userspace_2libc_2include_2errno_8h.html#a6a05c923dad0c1208043e9c20a58c8e5">ENOMEM</a></div><div class="ttdeci">#define ENOMEM</div><div class="ttdef"><b>Definition:</b> <a href="../../df/d53/Userspace_2libc_2include_2errno_8h_source.html#l00015">errno.h:15</a></div></div>
<div class="ttc" id="aUserspace_2libc_2include_2stdio_8h_html_a3abd78c220b4b49d1b088f0dfe40bf23"><div class="ttname"><a href="../../dd/d69/Userspace_2libc_2include_2stdio_8h.html#a3abd78c220b4b49d1b088f0dfe40bf23">fclose</a></div><div class="ttdeci">int fclose(FILE *fp)</div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d13/file_8c_source.html#l00054">file.c:54</a></div></div>
<div class="ttc" id="aUserspace_2libc_2include_2stdio_8h_html_afffa3e442e49895773d564f422e1be1c"><div class="ttname"><a href="../../dd/d69/Userspace_2libc_2include_2stdio_8h.html#afffa3e442e49895773d564f422e1be1c">fopen</a></div><div class="ttdeci">FILE * fopen(const char *filename, const char *mode)</div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d13/file_8c_source.html#l00019">file.c:19</a></div></div>
<div class="ttc" id="aUserspace_2libc_2include_2sys_2stat_8h_html_ae498af04567b740d66e09d36613c2cd8"><div class="ttname"><a href="../../d2/d5c/Userspace_2libc_2include_2sys_2stat_8h.html#ae498af04567b740d66e09d36613c2cd8">off_t</a></div><div class="ttdeci">#define off_t</div><div class="ttdef"><b>Definition:</b> <a href="../../d2/d5c/Userspace_2libc_2include_2sys_2stat_8h_source.html#l00012">stat.h:12</a></div></div>
<div class="ttc" id="aUserspace_2musl_2include_2pthread_8h_html_a74969d08c03097db757218adda625264"><div class="ttname"><a href="../../df/d00/Userspace_2musl_2include_2pthread_8h.html#a74969d08c03097db757218adda625264">pthread_key_create</a></div><div class="ttdeci">int pthread_key_create(pthread_key_t *, void(*)(void *))</div></div>
<div class="ttc" id="aUserspace_2musl_2include_2pthread_8h_html_a8d29d10e1e6b4fa6c05a427bb86fc4cb"><div class="ttname"><a href="../../df/d00/Userspace_2musl_2include_2pthread_8h.html#a8d29d10e1e6b4fa6c05a427bb86fc4cb">pthread_key_delete</a></div><div class="ttdeci">int pthread_key_delete(pthread_key_t)</div></div>
<div class="ttc" id="aUserspace_2musl_2include_2stdio_8h_html_a7fef8c27f707dff1fda32d2fed33693e"><div class="ttname"><a href="../../d7/d0a/Userspace_2musl_2include_2stdio_8h.html#a7fef8c27f707dff1fda32d2fed33693e">fgets</a></div><div class="ttdeci">char * fgets(char *__restrict, int, FILE *__restrict)</div></div>
<div class="ttc" id="aaarch64_2crt__arch_8h_html_a5ca5c7b25f3542384caad5c6fecf0ec1"><div class="ttname"><a href="../../d3/dfc/aarch64_2crt__arch_8h.html#a5ca5c7b25f3542384caad5c6fecf0ec1">__asm__</a></div><div class="ttdeci">__asm__(&quot;.text \n&quot; &quot;.global &quot; START &quot;\n&quot; &quot;.type &quot; START &quot;,%function\n&quot; START &quot;:\n&quot; &quot;	mov x29, #0\n&quot; &quot;	mov x30, #0\n&quot; &quot;	mov x0, sp\n&quot; &quot;.weak _DYNAMIC\n&quot; &quot;.hidden _DYNAMIC\n&quot; &quot;	adrp x1, _DYNAMIC\n&quot; &quot;	add x1, x1, #:lo12:_DYNAMIC\n&quot; &quot;	and sp, x0, #-16\n&quot; &quot;	b &quot; START &quot;_c\n&quot;)</div></div>
<div class="ttc" id="aarithmetic__operations_8c_html_a435d1572bf3f880d55459d9805097f62"><div class="ttname"><a href="../../dd/ddd/arithmetic__operations_8c.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a></div><div class="ttdeci">unsigned int uint32_t</div><div class="ttdef"><b>Definition:</b> <a href="../../dd/ddd/arithmetic__operations_8c_source.html#l00295">arithmetic_operations.c:295</a></div></div>
<div class="ttc" id="aarithmetic__operations_8c_html_a996e72f71b11a5bb8b3b7b6936b1516d"><div class="ttname"><a href="../../dd/ddd/arithmetic__operations_8c.html#a996e72f71b11a5bb8b3b7b6936b1516d">int64_t</a></div><div class="ttdeci">long long int64_t</div><div class="ttdef"><b>Definition:</b> <a href="../../dd/ddd/arithmetic__operations_8c_source.html#l00293">arithmetic_operations.c:293</a></div></div>
<div class="ttc" id="aconvert_8h_html_a2ce966cd04da3c32320f54c332569e03"><div class="ttname"><a href="../../d3/d82/convert_8h.html#a2ce966cd04da3c32320f54c332569e03">strtol</a></div><div class="ttdeci">long int strtol(const char *str, char **endptr, int base)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d68/convert_8cpp_source.html#l00203">convert.cpp:203</a></div></div>
<div class="ttc" id="aconvert_8h_html_a4a710d86541afc6b7dafddcdb4b1c94f"><div class="ttname"><a href="../../d3/d82/convert_8h.html#a4a710d86541afc6b7dafddcdb4b1c94f">strstr</a></div><div class="ttdeci">char * strstr(const char *haystack, const char *needle)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/d68/convert_8cpp_source.html#l00157">convert.cpp:157</a></div></div>
<div class="ttc" id="aconvert_8h_html_a7a71051d6440816fca3ad080ae2539f4"><div class="ttname"><a href="../../d3/d82/convert_8h.html#a7a71051d6440816fca3ad080ae2539f4">memcpy_unsafe</a></div><div class="ttdeci">void * memcpy_unsafe(void *dest, const void *src, size_t n)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/df3/Kernel_2library_2memop_8c_source.html#l00035">memop.c:35</a></div></div>
<div class="ttc" id="aconvert_8h_html_a7c4011320424e41e3875a3c9312242b0"><div class="ttname"><a href="../../d3/d82/convert_8h.html#a7c4011320424e41e3875a3c9312242b0">memmove_unsafe</a></div><div class="ttdeci">void * memmove_unsafe(void *dest, const void *src, size_t n)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/df3/Kernel_2library_2memop_8c_source.html#l00295">memop.c:295</a></div></div>
<div class="ttc" id="aconvert_8h_html_a9c1f204516a55affa9ba118907e5ab6b"><div class="ttname"><a href="../../d3/d82/convert_8h.html#a9c1f204516a55affa9ba118907e5ab6b">memset_unsafe</a></div><div class="ttdeci">void * memset_unsafe(void *dest, int c, size_t n)</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/df3/Kernel_2library_2memop_8c_source.html#l00214">memop.c:214</a></div></div>
<div class="ttc" id="aerr_8h_html_aa31bca214cc8f135a43aa7fbea017326"><div class="ttname"><a href="../../d6/d40/err_8h.html#aa31bca214cc8f135a43aa7fbea017326">err</a></div><div class="ttdeci">_Noreturn void err(int, const char *,...)</div><div class="ttdef"><b>Definition:</b> <a href="../../da/d80/err_8c_source.html#l00053">err.c:53</a></div></div>
<div class="ttc" id="afma_8c_html_d6/df8/structnum"><div class="ttname"><a href="../../d7/da1/fma_8c.html#d6/df8/structnum">num</a></div><div class="ttdef"><b>Definition:</b> <a href="../../d7/da1/fma_8c_source.html#l00009">fma.c:9</a></div></div>
<div class="ttc" id="agetusershell_8c_html_a8adb30f4f6669f927fd9232f686c637b"><div class="ttname"><a href="../../d0/dd9/getusershell_8c.html#a8adb30f4f6669f927fd9232f686c637b">line</a></div><div class="ttdeci">static char * line</div><div class="ttdef"><b>Definition:</b> <a href="../../d0/dd9/getusershell_8c_source.html#l00007">getusershell.c:7</a></div></div>
<div class="ttc" id="ahu__stuff_8c_html_a20358970b1abaf992eb85e071e454653"><div class="ttname"><a href="../../d3/dbb/hu__stuff_8c.html#a20358970b1abaf992eb85e071e454653">head</a></div><div class="ttdeci">static int head</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/dbb/hu__stuff_8c_source.html#l00478">hu_stuff.c:478</a></div></div>
<div class="ttc" id="ahu__stuff_8c_html_aff39d864a6594bc5f4a5e365282e00fe"><div class="ttname"><a href="../../d3/dbb/hu__stuff_8c.html#aff39d864a6594bc5f4a5e365282e00fe">tail</a></div><div class="ttdeci">static int tail</div><div class="ttdef"><b>Definition:</b> <a href="../../d3/dbb/hu__stuff_8c_source.html#l00479">hu_stuff.c:479</a></div></div>
<div class="ttc" id="alookup_8h_html_da/d97/structaddress"><div class="ttname"><a href="../../dd/d45/lookup_8h.html#da/d97/structaddress">address</a></div><div class="ttdef"><b>Definition:</b> <a href="../../dd/d45/lookup_8h_source.html#l00020">lookup.h:20</a></div></div>
<div class="ttc" id="amb__64bit__map_8cpp_html_a7d5d79792cdea43010184ab50d14ac5a"><div class="ttname"><a href="../../d9/def/mb__64bit__map_8cpp.html#a7d5d79792cdea43010184ab50d14ac5a">if</a></div><div class="ttdeci">if(!PML4.Present)</div><div class="ttdef"><b>Definition:</b> <a href="../../d9/def/mb__64bit__map_8cpp_source.html#l00205">mb_64bit_map.cpp:205</a></div></div>
<div class="ttc" id="amsexec_8h_html_ad342ac907eb044443153a22f964bf0af"><div class="ttname"><a href="../../de/d63/msexec_8h.html#ad342ac907eb044443153a22f964bf0af">DWORD</a></div><div class="ttdeci">unsigned long DWORD</div><div class="ttdef"><b>Definition:</b> <a href="../../de/d63/msexec_8h_source.html#l00037">msexec.h:37</a></div></div>
<div class="ttc" id="amultiboot_8h_html_a6d813a0f2b5281b18dea3f4cda696c33"><div class="ttname"><a href="../../d1/dc0/multiboot_8h.html#a6d813a0f2b5281b18dea3f4cda696c33">size</a></div><div class="ttdeci">multiboot_uint32_t size</div><div class="ttdef"><b>Definition:</b> <a href="../../d1/dc0/multiboot_8h_source.html#l00000">multiboot.h:0</a></div></div>
<div class="ttc" id="amultiboot_8h_html_a8286ae6db03c34c4bb161accbfbfbbcd"><div class="ttname"><a href="../../d1/dc0/multiboot_8h.html#a8286ae6db03c34c4bb161accbfbfbbcd">addr</a></div><div class="ttdeci">multiboot_uint64_t addr</div><div class="ttdef"><b>Definition:</b> <a href="../../d1/dc0/multiboot_8h_source.html#l00001">multiboot.h:1</a></div></div>
<div class="ttc" id="ananosleep_8c_html_a1b63fa141b202a0b01cfef8421aa48d6"><div class="ttname"><a href="../../d7/d50/nanosleep_8c.html#a1b63fa141b202a0b01cfef8421aa48d6">nanosleep</a></div><div class="ttdeci">int nanosleep(const struct timespec *req, struct timespec *rem)</div><div class="ttdef"><b>Definition:</b> <a href="../../d7/d50/nanosleep_8c_source.html#l00004">nanosleep.c:4</a></div></div>
<div class="ttc" id="aprctl_8h_html_a124f93dce8f8b29b6a245b178261b10e"><div class="ttname"><a href="../../db/dba/prctl_8h.html#a124f93dce8f8b29b6a245b178261b10e">prctl</a></div><div class="ttdeci">int prctl(int,...)</div><div class="ttdef"><b>Definition:</b> <a href="../../d2/d81/prctl_8c_source.html#l00005">prctl.c:5</a></div></div>
<div class="ttc" id="aproto_8c_html_ae40354a1051342eb5a9db005715dcfa9"><div class="ttname"><a href="../../dc/d3d/proto_8c.html#ae40354a1051342eb5a9db005715dcfa9">idx</a></div><div class="ttdeci">static int idx</div><div class="ttdef"><b>Definition:</b> <a href="../../dc/d3d/proto_8c_source.html#l00006">proto.c:6</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a000afcda168a6fd19a9435e049508463"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a000afcda168a6fd19a9435e049508463">SMALL_GRANULARITY</a></div><div class="ttdeci">#define SMALL_GRANULARITY</div><div class="ttdoc">Granularity of a small allocation block (must be power of two)</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00288">rpmalloc.c:288</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a007fc7dd52ba1f95d9a6ce88f47a614b"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a007fc7dd52ba1f95d9a6ce88f47a614b">size_class_t::block_size</a></div><div class="ttdeci">uint32_t block_size</div><div class="ttdoc">Size of blocks in this class.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00560">rpmalloc.c:560</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a00b91d87f9efd9b1073443761130d595"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a00b91d87f9efd9b1073443761130d595">_rpmalloc_allocate_huge</a></div><div class="ttdeci">static void * _rpmalloc_allocate_huge(heap_t *heap, size_t size)</div><div class="ttdoc">Allocate a huge block by mapping memory pages directly.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l02259">rpmalloc.c:2259</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a04406da3f5ff4e24f155c97591678ed9"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a04406da3f5ff4e24f155c97591678ed9">LARGE_CLASS_COUNT</a></div><div class="ttdeci">#define LARGE_CLASS_COUNT</div><div class="ttdoc">Number of large block size classes.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00304">rpmalloc.c:304</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a04a025a8c2529bc60cb95c78d3948c52"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a04a025a8c2529bc60cb95c78d3948c52">_memory_default_span_size</a></div><div class="ttdeci">#define _memory_default_span_size</div><div class="ttdoc">Default span size (64KiB)</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00593">rpmalloc.c:593</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a06d0861a56c7d5aac6e215ab0dceb9ca"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a06d0861a56c7d5aac6e215ab0dceb9ca">_rpmalloc_global_cache_insert_spans</a></div><div class="ttdeci">static void _rpmalloc_global_cache_insert_spans(span_t **span, size_t span_count, size_t count)</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l01367">rpmalloc.c:1367</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a07d2ba73260e7e5dbe98c76436888c5f"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a07d2ba73260e7e5dbe98c76436888c5f">span_t::offset_from_master</a></div><div class="ttdeci">uint32_t offset_from_master</div><div class="ttdoc">Offset from master span for subspans.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00455">rpmalloc.c:455</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a07da73cfe1c11642973a6eb1386a3a1c"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a07da73cfe1c11642973a6eb1386a3a1c">span_large_cache_t::count</a></div><div class="ttdeci">size_t count</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00478">rpmalloc.c:478</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a083ecd4af0f476009595e8ee78cf2ac0"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a083ecd4af0f476009595e8ee78cf2ac0">atomic_load64</a></div><div class="ttdeci">static FORCEINLINE int64_t atomic_load64(atomic64_t *val)</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00185">rpmalloc.c:185</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a0c3d121b2c7e431b109863973cff023c"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a0c3d121b2c7e431b109863973cff023c">_memory_thread_heap</a></div><div class="ttdeci">#define _memory_thread_heap</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00706">rpmalloc.c:706</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a0cbe158c682e307dc9372ee5a0b5167a"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a0cbe158c682e307dc9372ee5a0b5167a">MEDIUM_GRANULARITY</a></div><div class="ttdeci">#define MEDIUM_GRANULARITY</div><div class="ttdoc">Granularity of a medium allocation block.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00296">rpmalloc.c:296</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a0d0546abbe1244019d00ecf28aac359c"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a0d0546abbe1244019d00ecf28aac359c">_rpmalloc_aligned_reallocate</a></div><div class="ttdeci">static void * _rpmalloc_aligned_reallocate(heap_t *heap, void *ptr, size_t alignment, size_t size, size_t oldsize, unsigned int flags)</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l02729">rpmalloc.c:2729</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a0d896198d6c5673397704f9f6bdadbdf"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a0d896198d6c5673397704f9f6bdadbdf">_rpmalloc_heap_unmap</a></div><div class="ttdeci">static void _rpmalloc_heap_unmap(heap_t *heap)</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l01565">rpmalloc.c:1565</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a0e1e1399df4fbb1246dc73f3c6d14427"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a0e1e1399df4fbb1246dc73f3c6d14427">_Static_assert</a></div><div class="ttdeci">_Static_assert((SMALL_GRANULARITY &amp;(SMALL_GRANULARITY - 1))==0, &quot;Small granularity must be power of two&quot;)</div></div>
<div class="ttc" id="arpmalloc_8c_html_a132ac3786920f0bf24b2d2f7c73cf863"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a132ac3786920f0bf24b2d2f7c73cf863">SPAN_FLAG_UNMAPPED_MASTER</a></div><div class="ttdeci">#define SPAN_FLAG_UNMAPPED_MASTER</div><div class="ttdoc">Flag indicating an unmapped master span.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00363">rpmalloc.c:363</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a13753de75bc52a5b8a1a9532083c9ba4"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a13753de75bc52a5b8a1a9532083c9ba4">span_t::align_offset</a></div><div class="ttdeci">uint32_t align_offset</div><div class="ttdoc">Alignment offset.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00459">rpmalloc.c:459</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a14828817b96941a8a2ad71e2bb95143b"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a14828817b96941a8a2ad71e2bb95143b">MAP_UNINITIALIZED</a></div><div class="ttdeci">#define MAP_UNINITIALIZED</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00125">rpmalloc.c:125</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a19186eb24d08ef02b924951abb865b51"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a19186eb24d08ef02b924951abb865b51">rpfree</a></div><div class="ttdeci">void rpfree(void *ptr)</div><div class="ttdoc">Free the given memory block.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l03096">rpmalloc.c:3096</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a19d785146ca5053c2da69ad1ec4de94c"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a19d785146ca5053c2da69ad1ec4de94c">_memory_global_reserve_count</a></div><div class="ttdeci">static size_t _memory_global_reserve_count</div><div class="ttdoc">Global reserved count.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00641">rpmalloc.c:641</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a1af1f32c9b66b7e16c30098e456efa0d"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a1af1f32c9b66b7e16c30098e456efa0d">__get_tid</a></div><div class="ttdeci">uintptr_t __get_tid(void)</div><div class="ttdef"><b>Definition:</b> <a href="../../d1/d7e/rpmalloc__compat_8cpp_source.html#l00051">rpmalloc_compat.cpp:51</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a1b31ff8fa0abcdb205dadd8afc026014"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a1b31ff8fa0abcdb205dadd8afc026014">_rpmalloc_span_unmap</a></div><div class="ttdeci">static void _rpmalloc_span_unmap(span_t *span)</div><div class="ttdoc">Unmap memory pages for the given number of spans (or mark as unused if no partial unmappings)</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l01131">rpmalloc.c:1131</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a1b9ab55b2401b2d4240bbca4b313f6a2"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a1b9ab55b2401b2d4240bbca4b313f6a2">_rpmalloc_heap_release</a></div><div class="ttdeci">static void _rpmalloc_heap_release(void *heapptr, int first_class, int release_cache)</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l01997">rpmalloc.c:1997</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a1cb428169705ddd63fb35383132dbc40"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a1cb428169705ddd63fb35383132dbc40">_memory_global_lock</a></div><div class="ttdeci">static atomic32_t _memory_global_lock</div><div class="ttdoc">Used to restrict access to mapping memory for huge pages.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00647">rpmalloc.c:647</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a1d5126b78d2bb31fe3476abcd07dd801"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a1d5126b78d2bb31fe3476abcd07dd801">_memory_global_reserve_master</a></div><div class="ttdeci">static span_t * _memory_global_reserve_master</div><div class="ttdoc">Global reserved master.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00643">rpmalloc.c:643</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a1e29d8d18139babda354d5d92d46ca02"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a1e29d8d18139babda354d5d92d46ca02">_memory_map_granularity</a></div><div class="ttdeci">static size_t _memory_map_granularity</div><div class="ttdoc">Granularity at which memory pages are mapped by OS.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00608">rpmalloc.c:608</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a1e97049d3ae6097ed1f1b258eaabf2ee"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a1e97049d3ae6097ed1f1b258eaabf2ee">__memory_thread_heap</a></div><div class="ttdeci">heap_t ** __memory_thread_heap(void)</div><div class="ttdef"><b>Definition:</b> <a href="../../d1/d7e/rpmalloc__compat_8cpp_source.html#l00033">rpmalloc_compat.cpp:33</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a1fe9c932f58e2baffed3ea33fd299691"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a1fe9c932f58e2baffed3ea33fd299691">atomic_incr32</a></div><div class="ttdeci">static FORCEINLINE int32_t atomic_incr32(atomic32_t *val)</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00180">rpmalloc.c:180</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a2071bf7ebae50eced1f16b359f9d5c7d"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a2071bf7ebae50eced1f16b359f9d5c7d">atomic_cas32_acquire</a></div><div class="ttdeci">static FORCEINLINE int atomic_cas32_acquire(atomic32_t *dst, int32_t val, int32_t ref)</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00183">rpmalloc.c:183</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a21ea40b81bca2d791bb633dd5602dee8"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a21ea40b81bca2d791bb633dd5602dee8">free_list_pop</a></div><div class="ttdeci">static void * free_list_pop(void **list)</div><div class="ttdoc">Pop first block from a free list.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l02134">rpmalloc.c:2134</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a223c890fd871bff9081258f6520fc8a9"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a223c890fd871bff9081258f6520fc8a9">_rpmalloc_adjust_size_class</a></div><div class="ttdeci">static void _rpmalloc_adjust_size_class(size_t iclass)</div><div class="ttdoc">Adjust and optimize the size class properties for the given class.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l02788">rpmalloc.c:2788</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a22b0340927d02f0c7c4486f01c31358e"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a22b0340927d02f0c7c4486f01c31358e">span_t::free_list_deferred</a></div><div class="ttdeci">atomicptr_t free_list_deferred</div><div class="ttdoc">Deferred free list.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00443">rpmalloc.c:443</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a240396bd63b0822a9ec0ade52cab44b2"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a240396bd63b0822a9ec0ade52cab44b2">rprealloc</a></div><div class="ttdeci">RPMALLOC_ALLOCATOR void * rprealloc(void *ptr, size_t size)</div><div class="ttdoc">Reallocate the given block to at least the given size.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l03119">rpmalloc.c:3119</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a24ad9380461f94f601227da3fe3676da"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a24ad9380461f94f601227da3fe3676da">THREAD_SPAN_CACHE_TRANSFER</a></div><div class="ttdeci">#define THREAD_SPAN_CACHE_TRANSFER</div><div class="ttdoc">Number of spans to transfer between thread and global cache.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00314">rpmalloc.c:314</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a26f341387be75540b16ddf371b9ce3ed"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a26f341387be75540b16ddf371b9ce3ed">__rpmalloc_munmap</a></div><div class="ttdeci">int __rpmalloc_munmap(void *addr, size_t length)</div><div class="ttdef"><b>Definition:</b> <a href="../../d1/d7e/rpmalloc__compat_8cpp_source.html#l00080">rpmalloc_compat.cpp:80</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a284460248778c94b6ee9ea1529299439"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a284460248778c94b6ee9ea1529299439">SIZE_CLASS_HUGE</a></div><div class="ttdeci">#define SIZE_CLASS_HUGE</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00335">rpmalloc.c:335</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a2a1e3b11c0a8fc714d6def51250c6906"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a2a1e3b11c0a8fc714d6def51250c6906">_rpmalloc_heap_finalize</a></div><div class="ttdeci">static void _rpmalloc_heap_finalize(heap_t *heap)</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l02069">rpmalloc.c:2069</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a2a7ceea1aafc39d3196091847b88e701"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a2a7ceea1aafc39d3196091847b88e701">_rpmalloc_allocate_small</a></div><div class="ttdeci">static void * _rpmalloc_allocate_small(heap_t *heap, size_t size)</div><div class="ttdoc">Allocate a small sized memory block from the given heap.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l02199">rpmalloc.c:2199</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a2a87a6060d5387fe8491a00600073687"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a2a87a6060d5387fe8491a00600073687">atomic_store32_release</a></div><div class="ttdeci">static FORCEINLINE void atomic_store32_release(atomic32_t *dst, int32_t val)</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00184">rpmalloc.c:184</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a2aaa6595462b280c7c95e7804ab6f9fd"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a2aaa6595462b280c7c95e7804ab6f9fd">rpcalloc</a></div><div class="ttdeci">RPMALLOC_ALLOCATOR void * rpcalloc(size_t num, size_t size)</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l03102">rpmalloc.c:3102</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a2ae01990651a75a352409fb1fbf85d05"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a2ae01990651a75a352409fb1fbf85d05">rpmalloc_initialize_config</a></div><div class="ttdeci">int rpmalloc_initialize_config(const rpmalloc_config_t *config)</div><div class="ttdoc">Initialize allocator with given configuration.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l02824">rpmalloc.c:2824</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a2c70a492ba1920b405001750ab3e6622"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a2c70a492ba1920b405001750ab3e6622">_rpmalloc_heap_thread_cache_extract</a></div><div class="ttdeci">static span_t * _rpmalloc_heap_thread_cache_extract(heap_t *heap, size_t span_count)</div><div class="ttdoc">Extract the given number of spans from the different cache levels.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l01701">rpmalloc.c:1701</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a2d8a3eac487ff2943f8aae4dd20badd3"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a2d8a3eac487ff2943f8aae4dd20badd3">_rpmalloc_mmap</a></div><div class="ttdeci">static void * _rpmalloc_mmap(size_t size, size_t *offset)</div><div class="ttdoc">Map more virtual memory.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00801">rpmalloc.c:801</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a2e9cc04738eb37814086f557943373d8"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a2e9cc04738eb37814086f557943373d8">THREAD_SPAN_LARGE_CACHE_TRANSFER</a></div><div class="ttdeci">#define THREAD_SPAN_LARGE_CACHE_TRANSFER</div><div class="ttdoc">Number of spans to transfer between thread and global cache for large spans.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00318">rpmalloc.c:318</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a2f7a67a3403fd19a70e7a0418714af57"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a2f7a67a3403fd19a70e7a0418714af57">_rpmalloc_heap_global_finalize</a></div><div class="ttdeci">static void _rpmalloc_heap_global_finalize(heap_t *heap)</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l01585">rpmalloc.c:1585</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a2fcaea32cf5846f1f5b40a882175dbb0"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a2fcaea32cf5846f1f5b40a882175dbb0">SPAN_FLAG_SUBSPAN</a></div><div class="ttdeci">#define SPAN_FLAG_SUBSPAN</div><div class="ttdoc">Flag indicating span is a secondary (sub) span of a split superspan.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00359">rpmalloc.c:359</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a303f700546874a81e694eda44cc3174d"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a303f700546874a81e694eda44cc3174d">atomic_cas_ptr</a></div><div class="ttdeci">static FORCEINLINE int atomic_cas_ptr(atomicptr_t *dst, void *val, void *ref)</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00191">rpmalloc.c:191</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a335307d78e0ff77d4da9cf42156803ec"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a335307d78e0ff77d4da9cf42156803ec">_rpmalloc_spin</a></div><div class="ttdeci">static void _rpmalloc_spin(void)</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00755">rpmalloc.c:755</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a33cddb08b9ee0f969cc82dbf9cddb947"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a33cddb08b9ee0f969cc82dbf9cddb947">_memory_size_class</a></div><div class="ttdeci">static size_class_t _memory_size_class[SIZE_CLASS_COUNT]</div><div class="ttdoc">Global size classes.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00627">rpmalloc.c:627</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a345270ce5d1e5e112b45cfde43f37da0"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a345270ce5d1e5e112b45cfde43f37da0">span_t::heap</a></div><div class="ttdeci">heap_t * heap</div><div class="ttdoc">Owning heap.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00461">rpmalloc.c:461</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a34805759f2f107ac549c3394840ebf35"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a34805759f2f107ac549c3394840ebf35">_rpmalloc_heap_allocate_new</a></div><div class="ttdeci">static heap_t * _rpmalloc_heap_allocate_new(void)</div><div class="ttdoc">Allocate a new heap from newly mapped memory pages.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l01887">rpmalloc.c:1887</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a34a6e06414bb541b0d231513cb7b66e3"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a34a6e06414bb541b0d231513cb7b66e3">__rpmalloc_posix_madvise</a></div><div class="ttdeci">int __rpmalloc_posix_madvise(void *addr, size_t length, int advice)</div><div class="ttdef"><b>Definition:</b> <a href="../../d1/d7e/rpmalloc__compat_8cpp_source.html#l00087">rpmalloc_compat.cpp:87</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a3667b745f7290a10ff5c5a71575533d9"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a></div><div class="ttdeci">static size_t _memory_page_size</div><div class="ttdoc">Memory page size.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00604">rpmalloc.c:604</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a375befcec19545c40cb27c22512501bb"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a375befcec19545c40cb27c22512501bb">_rpmalloc_heap_release_raw_fc</a></div><div class="ttdeci">static void _rpmalloc_heap_release_raw_fc(void *heapptr)</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l02063">rpmalloc.c:2063</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a386f776cc556d33534161ece5083e4de"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a386f776cc556d33534161ece5083e4de">span_t::prev</a></div><div class="ttdeci">span_t * prev</div><div class="ttdoc">Previous span.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00465">rpmalloc.c:465</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a38abd8cccc9bef76c59666dc716e3f30"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a38abd8cccc9bef76c59666dc716e3f30">__rpmalloc_mmap</a></div><div class="ttdeci">void * __rpmalloc_mmap(void *addr, size_t length, int prot, int flags, int fd, off_t offset)</div><div class="ttdef"><b>Definition:</b> <a href="../../d1/d7e/rpmalloc__compat_8cpp_source.html#l00069">rpmalloc_compat.cpp:69</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a3d9a7f69f3e3cc2dc7ea18d8c58b274c"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a3d9a7f69f3e3cc2dc7ea18d8c58b274c">_memory_span_map_count</a></div><div class="ttdeci">static size_t _memory_span_map_count</div><div class="ttdoc">Number of spans to map in each map call.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00623">rpmalloc.c:623</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a3dedf1d71cda4a8f3d1f372934ddad30"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a3dedf1d71cda4a8f3d1f372934ddad30">_memory_default_span_size_shift</a></div><div class="ttdeci">#define _memory_default_span_size_shift</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00594">rpmalloc.c:594</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a3e39052a111a2e243645494f1d6ca439"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a3e39052a111a2e243645494f1d6ca439">_memory_heaps</a></div><div class="ttdeci">static heap_t * _memory_heaps[HEAP_ARRAY_SIZE]</div><div class="ttdoc">All heaps.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00645">rpmalloc.c:645</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a3f84dd23eb0ef3cf54aeb6afff0618ae"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a3f84dd23eb0ef3cf54aeb6afff0618ae">SIZE_CLASS_LARGE</a></div><div class="ttdeci">#define SIZE_CLASS_LARGE</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00334">rpmalloc.c:334</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a411d5d6c063a099c1a08fa853851b764"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a411d5d6c063a099c1a08fa853851b764">_memory_global_reserve</a></div><div class="ttdeci">static span_t * _memory_global_reserve</div><div class="ttdoc">Global reserved spans.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00639">rpmalloc.c:639</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a428539d1600391a04bfc27f74980df5e"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a428539d1600391a04bfc27f74980df5e">_rpmalloc_deallocate_huge</a></div><div class="ttdeci">static void _rpmalloc_deallocate_huge(span_t *)</div><div class="ttdoc">Deallocate the given huge span.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l02588">rpmalloc.c:2588</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a435bea54b94450010a1a6d0c4f22a0c5"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a435bea54b94450010a1a6d0c4f22a0c5">_rpmalloc_heap_extract_new_span</a></div><div class="ttdeci">static span_t * _rpmalloc_heap_extract_new_span(heap_t *heap, heap_size_class_t *heap_size_class, size_t span_count, uint32_t class_idx)</div><div class="ttdoc">Get a span from one of the cache levels (thread cache, reserved, global cache) or fallback to mapping...</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l01801">rpmalloc.c:1801</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a440c6f31099f3836f7beb5e47d14fb2d"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a440c6f31099f3836f7beb5e47d14fb2d">global_cache_t::count</a></div><div class="ttdeci">uint32_t count</div><div class="ttdoc">Cache count.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00573">rpmalloc.c:573</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a472f0bf448a2dc3f31c0b79acd70d829"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a472f0bf448a2dc3f31c0b79acd70d829">_Atomic</a></div><div class="ttdeci">volatile _Atomic(int32_t)</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00171">rpmalloc.c:171</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a481f7733c3d6469b66e9a746e0afb0e9"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a481f7733c3d6469b66e9a746e0afb0e9">atomic_add64</a></div><div class="ttdeci">static FORCEINLINE int64_t atomic_add64(atomic64_t *val, int64_t add)</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00186">rpmalloc.c:186</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a49d22808308e599742e41ef2d4671cfa"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a49d22808308e599742e41ef2d4671cfa">_rpmalloc_span_double_link_list_pop_head</a></div><div class="ttdeci">static void _rpmalloc_span_double_link_list_pop_head(span_t **head, span_t *span)</div><div class="ttdoc">Pop head span from double linked list.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00953">rpmalloc.c:953</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a49e532a65b873a6c3315aa769299687c"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a49e532a65b873a6c3315aa769299687c">_rpmalloc_stat_add64</a></div><div class="ttdeci">#define _rpmalloc_stat_add64(counter, value)</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00261">rpmalloc.c:261</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a4a224c6ef987eb60f3e3be98239109ec"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a4a224c6ef987eb60f3e3be98239109ec">set_thread_heap</a></div><div class="ttdeci">static void set_thread_heap(heap_t *heap)</div><div class="ttdoc">Set the current thread heap.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00738">rpmalloc.c:738</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a4a53d0cfdcf755d4fbbae446a055440c"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a4a53d0cfdcf755d4fbbae446a055440c">_rpmalloc_stat_add</a></div><div class="ttdeci">#define _rpmalloc_stat_add(counter, value)</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00257">rpmalloc.c:257</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a4aecbd1cbb36425fddd53125ea1a84c7"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a4aecbd1cbb36425fddd53125ea1a84c7">span_t::remaining_spans</a></div><div class="ttdeci">atomic32_t remaining_spans</div><div class="ttdoc">Remaining span counter, for master spans.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00457">rpmalloc.c:457</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a4be7846b7aabc5b469a4cc66dbc6fb36"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a4be7846b7aabc5b469a4cc66dbc6fb36">_rpmalloc_aligned_allocate</a></div><div class="ttdeci">static void * _rpmalloc_aligned_allocate(heap_t *heap, size_t alignment, size_t size)</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l02302">rpmalloc.c:2302</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a4ca7faed398dff40d231cbce5ebcc845"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a4ca7faed398dff40d231cbce5ebcc845">_rpmalloc_heap_allocate</a></div><div class="ttdeci">static heap_t * _rpmalloc_heap_allocate(int first_class)</div><div class="ttdoc">Allocate a new heap, potentially reusing a previously orphaned heap.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l01978">rpmalloc.c:1978</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a4cdf64413eaa3e80f8a1dfe158bd2525"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a4cdf64413eaa3e80f8a1dfe158bd2525">_memory_huge_pages</a></div><div class="ttdeci">static int _memory_huge_pages</div><div class="ttdoc">Huge page support.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00633">rpmalloc.c:633</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a4de89d484559557bb639a2703c750b17"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a4de89d484559557bb639a2703c750b17">span_t::flags</a></div><div class="ttdeci">uint32_t flags</div><div class="ttdoc">Flags and counters.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00449">rpmalloc.c:449</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a4f0dc3c548801773a4da1c96f39b04c9"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a4f0dc3c548801773a4da1c96f39b04c9">atomic_decr32</a></div><div class="ttdeci">static FORCEINLINE int32_t atomic_decr32(atomic32_t *val)</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00181">rpmalloc.c:181</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a51b78975d481805f29847ad91c77d6ad"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a51b78975d481805f29847ad91c77d6ad">MAX_THREAD_SPAN_LARGE_CACHE</a></div><div class="ttdeci">#define MAX_THREAD_SPAN_LARGE_CACHE</div><div class="ttdoc">Number of spans in thread cache for large spans (must be greater than LARGE_CLASS_COUNT / 2)</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00316">rpmalloc.c:316</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a53adc7f95e9b3fa3e62ba8f50add0ce9"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a53adc7f95e9b3fa3e62ba8f50add0ce9">rpmalloc_set_main_thread</a></div><div class="ttdeci">void rpmalloc_set_main_thread(void)</div><div class="ttdoc">Set main thread ID.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00749">rpmalloc.c:749</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a554df4bc024ffaa8328e6ef37cec5c77"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a554df4bc024ffaa8328e6ef37cec5c77">MEDIUM_CLASS_COUNT</a></div><div class="ttdeci">#define MEDIUM_CLASS_COUNT</div><div class="ttdoc">Number of medium block size classes.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00300">rpmalloc.c:300</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a56211c3481cd02195d9bac3c1475cdfb"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a56211c3481cd02195d9bac3c1475cdfb">_rpmalloc_inc_span_statistics</a></div><div class="ttdeci">static void _rpmalloc_inc_span_statistics(heap_t *heap, size_t span_count, uint32_t class_idx)</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l01785">rpmalloc.c:1785</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a573fc7baab7be24c6bac115b7f62192f"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a573fc7baab7be24c6bac115b7f62192f">_rpmalloc_deallocate_large</a></div><div class="ttdeci">static void _rpmalloc_deallocate_large(span_t *span)</div><div class="ttdoc">Deallocate the given large memory block to the current heap.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l02529">rpmalloc.c:2529</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a58f109a58b8e38970cda041f4ea96772"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a58f109a58b8e38970cda041f4ea96772">_rpmalloc_heap_initialize</a></div><div class="ttdeci">static void _rpmalloc_heap_initialize(heap_t *heap)</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l01859">rpmalloc.c:1859</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a599c57201987cc23a9787a745296e575"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a599c57201987cc23a9787a745296e575">_rpmalloc_stat_add_peak</a></div><div class="ttdeci">#define _rpmalloc_stat_add_peak(counter, value, peak)</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00265">rpmalloc.c:265</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a5a977febdd2e9ae15bcf66f83d0cf817"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a5a977febdd2e9ae15bcf66f83d0cf817">span_t::size_class</a></div><div class="ttdeci">uint32_t size_class</div><div class="ttdoc">Size class.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00437">rpmalloc.c:437</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a5bd98ea2cfee2186b2aa2b921450807f"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a5bd98ea2cfee2186b2aa2b921450807f">_rpmalloc_heap_orphan</a></div><div class="ttdeci">static void _rpmalloc_heap_orphan(heap_t *heap, int first_class)</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l01872">rpmalloc.c:1872</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a5c46183a2d82b761e9438c65b0dbad62"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a5c46183a2d82b761e9438c65b0dbad62">_rpmalloc_reallocate</a></div><div class="ttdeci">static void * _rpmalloc_reallocate(heap_t *heap, void *p, size_t size, size_t oldsize, unsigned int flags)</div><div class="ttdoc">Reallocate the given block to the given size.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l02641">rpmalloc.c:2641</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a62b31eca2760e37676716c54c5b64947"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a62b31eca2760e37676716c54c5b64947">_rpmalloc_span_release_to_cache</a></div><div class="ttdeci">static void _rpmalloc_span_release_to_cache(heap_t *heap, span_t *span)</div><div class="ttdoc">Move the span (used for small or medium allocations) to the heap thread cache.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l01172">rpmalloc.c:1172</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a63b187e233e7b190db2bac536cf8a09b"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a63b187e233e7b190db2bac536cf8a09b">_rpmalloc_allocate_medium</a></div><div class="ttdeci">static void * _rpmalloc_allocate_medium(heap_t *heap, size_t size)</div><div class="ttdoc">Allocate a medium sized memory block from the given heap.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l02213">rpmalloc.c:2213</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a6414f61e9643ce358f1a33e6a2c6aeaa"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a6414f61e9643ce358f1a33e6a2c6aeaa">_rpmalloc_initialized</a></div><div class="ttdeci">static int _rpmalloc_initialized</div><div class="ttdoc">Initialized flag.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00598">rpmalloc.c:598</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a645356809d937167848705edabde7d44"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a645356809d937167848705edabde7d44">SPAN_HEADER_SIZE</a></div><div class="ttdeci">#define SPAN_HEADER_SIZE</div><div class="ttdoc">Size of a span header (must be a multiple of SMALL_GRANULARITY and a power of two)</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00310">rpmalloc.c:310</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a66893939b9053e9bf8a97a5f50bc773a"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a66893939b9053e9bf8a97a5f50bc773a">SMALL_GRANULARITY_SHIFT</a></div><div class="ttdeci">#define SMALL_GRANULARITY_SHIFT</div><div class="ttdoc">Small granularity shift count.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00290">rpmalloc.c:290</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a66c4be5ac967e1374b25eb8ac80f68d9"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a66c4be5ac967e1374b25eb8ac80f68d9">_rpmalloc_set_name</a></div><div class="ttdeci">static void _rpmalloc_set_name(void *address, size_t size)</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00781">rpmalloc.c:781</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a6780f79fe39d5c99886e27fccaf4133c"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a6780f79fe39d5c99886e27fccaf4133c">_rpmalloc_span_align_count</a></div><div class="ttdeci">static size_t _rpmalloc_span_align_count(size_t span_count)</div><div class="ttdoc">Get the aligned number of spans to map in based on wanted count, configured mapping granularity and t...</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l01026">rpmalloc.c:1026</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a6866e2b7c1e8f60d6c74ea8fba6be44d"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a6866e2b7c1e8f60d6c74ea8fba6be44d">LARGE_SIZE_LIMIT</a></div><div class="ttdeci">#define LARGE_SIZE_LIMIT</div><div class="ttdoc">Maximum size of a large block.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00308">rpmalloc.c:308</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a693c463bae081b54b0b799e97bf84fb5"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a693c463bae081b54b0b799e97bf84fb5">_rpmalloc_unmap_os</a></div><div class="ttdeci">static void _rpmalloc_unmap_os(void *address, size_t size, size_t offset, size_t release)</div><div class="ttdoc">Default implementation to unmap pages from virtual memory.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00874">rpmalloc.c:874</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a69503d4619673c88e0882f291eb6d86f"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a69503d4619673c88e0882f291eb6d86f">ENABLE_THREAD_CACHE</a></div><div class="ttdeci">#define ENABLE_THREAD_CACHE</div><div class="ttdoc">Enable per-thread cache.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00037">rpmalloc.c:37</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a6a8bcd4676dfdcfd084cfe9d0c81c3d5"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a6a8bcd4676dfdcfd084cfe9d0c81c3d5">_rpmalloc_heap_thread_cache_deferred_extract</a></div><div class="ttdeci">static span_t * _rpmalloc_heap_thread_cache_deferred_extract(heap_t *heap, size_t span_count)</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l01720">rpmalloc.c:1720</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a6c1102ef8a3812f1098cad573ea7794e"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a6c1102ef8a3812f1098cad573ea7794e">_rpmalloc_deallocate_direct_small_or_medium</a></div><div class="ttdeci">static void _rpmalloc_deallocate_direct_small_or_medium(span_t *span, void *block)</div><div class="ttdoc">Deallocate the given small/medium memory block in the current thread local heap.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l02430">rpmalloc.c:2430</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a6cc5147be3d12c47a533a9cd14e36801"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a6cc5147be3d12c47a533a9cd14e36801">_rpmalloc_deallocate_defer_small_or_medium</a></div><div class="ttdeci">static void _rpmalloc_deallocate_defer_small_or_medium(span_t *span, void *block)</div><div class="ttdoc">Put the block in the deferred free list of the owning span.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l02480">rpmalloc.c:2480</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a6db2d5852bc3af5ee8bbbfae2db30997"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a6db2d5852bc3af5ee8bbbfae2db30997">rpmalloc_thread_collect</a></div><div class="ttdeci">void rpmalloc_thread_collect(void)</div><div class="ttdoc">Perform deferred deallocations pending for the calling thread heap.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l03185">rpmalloc.c:3185</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a6e5fc3857f84254caa88503e02bf163c"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a6e5fc3857f84254caa88503e02bf163c">rpmalloc_thread_finalize</a></div><div class="ttdeci">void rpmalloc_thread_finalize(int release_caches)</div><div class="ttdoc">Finalize thread, orphan heap.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l03061">rpmalloc.c:3061</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a6ea14607e2b19ee5aa336addd0fdde01"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a6ea14607e2b19ee5aa336addd0fdde01">MAX_ALLOC_SIZE</a></div><div class="ttdeci">#define MAX_ALLOC_SIZE</div><div class="ttdoc">Maximum allocation size to avoid integer overflow.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00326">rpmalloc.c:326</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a6f18b8696daac522d93e448aadd7cd4b"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a6f18b8696daac522d93e448aadd7cd4b">rpmalloc_is_thread_initialized</a></div><div class="ttdeci">int rpmalloc_is_thread_initialized(void)</div><div class="ttdoc">Query if allocator is initialized for calling thread.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l03072">rpmalloc.c:3072</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a724fb9f82013c782db5c3c12ea36aac8"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a724fb9f82013c782db5c3c12ea36aac8">FORCEINLINE</a></div><div class="ttdeci">#define FORCEINLINE</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00104">rpmalloc.c:104</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a72cb3beffa763418cb7c8e89ff257b8e"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a72cb3beffa763418cb7c8e89ff257b8e">heap_size_class_t::cache</a></div><div class="ttdeci">span_t * cache</div><div class="ttdoc">Early level cache of fully free spans.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00491">rpmalloc.c:491</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a7524fc81b83a0b54ef5ec3fb4563b69d"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a7524fc81b83a0b54ef5ec3fb4563b69d">size_class_t::class_idx</a></div><div class="ttdeci">uint16_t class_idx</div><div class="ttdoc">Class index this class is merged with.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00564">rpmalloc.c:564</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a759e72612fab78b1159ab7129a7f7e86"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a759e72612fab78b1159ab7129a7f7e86">rpmalloc_dump_statistics</a></div><div class="ttdeci">void rpmalloc_dump_statistics(void *file)</div><div class="ttdoc">Dump all statistics in human readable format to file (should be a FILE*)</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l03335">rpmalloc.c:3335</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a75c19bcef00dee4542c1ddab212e29a8"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a75c19bcef00dee4542c1ddab212e29a8">heap_t</a></div><div class="ttdeci">struct heap_t heap_t</div><div class="ttdoc">A memory heap, per thread.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00321">rpmalloc.c:344</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a77eff1faca249ec6ae27881769f7d979"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a77eff1faca249ec6ae27881769f7d979">span_large_cache_t::span</a></div><div class="ttdeci">span_t * span[MAX_THREAD_SPAN_LARGE_CACHE]</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00479">rpmalloc.c:479</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a7a9f597c853963de259b40e985d81113"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a7a9f597c853963de259b40e985d81113">rpmalloc_usable_size</a></div><div class="ttdeci">size_t rpmalloc_usable_size(void *ptr)</div><div class="ttdoc">Query the usable size of the given memory block (from given pointer to the end of block)</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l03179">rpmalloc.c:3179</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a7ee7892ce3c5d8342af193f1824a5098"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a7ee7892ce3c5d8342af193f1824a5098">span_t::block_count</a></div><div class="ttdeci">uint32_t block_count</div><div class="ttdoc">Total block count of size class.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00435">rpmalloc.c:435</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a7f0d32d7a842d13c6a15e4ddae3814eb"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a7f0d32d7a842d13c6a15e4ddae3814eb">rpmemalign</a></div><div class="ttdeci">RPMALLOC_ALLOCATOR void * rpmemalign(size_t alignment, size_t size)</div><div class="ttdoc">Allocate a memory block of at least the given size and alignment.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l03163">rpmalloc.c:3163</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a7fdcd37f930a06ca527ab10334bf1d1e"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a7fdcd37f930a06ca527ab10334bf1d1e">_rpmalloc_deallocate_small_or_medium</a></div><div class="ttdeci">static void _rpmalloc_deallocate_small_or_medium(span_t *span, void *p)</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l02505">rpmalloc.c:2505</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a80aeb0b9294d1463006c963e7073244e"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a80aeb0b9294d1463006c963e7073244e">_rpmalloc_span_map</a></div><div class="ttdeci">static span_t * _rpmalloc_span_map(heap_t *heap, size_t span_count)</div><div class="ttdoc">Map in memory pages for the given number of spans (or use previously reserved pages)</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l01093">rpmalloc.c:1093</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a829d3a1ca51d0ba687990a8111940c42"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a829d3a1ca51d0ba687990a8111940c42">_rpmalloc_stat_sub</a></div><div class="ttdeci">#define _rpmalloc_stat_sub(counter, value)</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00269">rpmalloc.c:269</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a83ddc23debb02a3c47f0b00939fc8f35"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a83ddc23debb02a3c47f0b00939fc8f35">atomic_load_ptr</a></div><div class="ttdeci">static FORCEINLINE void * atomic_load_ptr(atomicptr_t *src)</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00187">rpmalloc.c:187</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a84e326ca88dee0bd7ca995727bb52381"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a84e326ca88dee0bd7ca995727bb52381">get_thread_id</a></div><div class="ttdeci">static uintptr_t get_thread_id(void)</div><div class="ttdoc">Fast thread ID.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00734">rpmalloc.c:734</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a85527ad364915bcb39b7d421524d0bd6"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a85527ad364915bcb39b7d421524d0bd6">span_t::free_list</a></div><div class="ttdeci">void * free_list</div><div class="ttdoc">Free list.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00433">rpmalloc.c:433</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a85a64540090a42380ee6d969ec1897c1"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a85a64540090a42380ee6d969ec1897c1">rpmalloc_thread_initialize</a></div><div class="ttdeci">void rpmalloc_thread_initialize(void)</div><div class="ttdoc">Initialize thread, assign heap.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l03044">rpmalloc.c:3044</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a894a66f329862f01de7619aee1954d19"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a894a66f329862f01de7619aee1954d19">span_cache_t::count</a></div><div class="ttdeci">size_t count</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00471">rpmalloc.c:471</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a8bb140aee00ffae527f7c0706d98c3d1"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a8bb140aee00ffae527f7c0706d98c3d1">global_cache_t::overflow</a></div><div class="ttdeci">span_t * overflow</div><div class="ttdoc">Unlimited cache overflow.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00583">rpmalloc.c:583</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a8cc6a9b0d6d8d6bf8367bca0101b1ae3"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a8cc6a9b0d6d8d6bf8367bca0101b1ae3">span_cache_t::span</a></div><div class="ttdeci">span_t * span[MAX_THREAD_SPAN_CACHE]</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00472">rpmalloc.c:472</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a90593dceacf0c04f14d084bed7e7eabe"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a90593dceacf0c04f14d084bed7e7eabe">EXPECTED</a></div><div class="ttdeci">#define EXPECTED(x)</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00212">rpmalloc.c:212</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a91bf3ee061b188b8a650fbac9babef4a"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a91bf3ee061b188b8a650fbac9babef4a">_rpmalloc_span_mark_as_subspan_unless_master</a></div><div class="ttdeci">static void _rpmalloc_span_mark_as_subspan_unless_master(span_t *master, span_t *subspan, size_t span_count)</div><div class="ttdoc">Declare the span to be a subspan and store distance from master span and span count.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00996">rpmalloc.c:996</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a91e8ecc3f466b065c5d14e8506b47e3f"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a91e8ecc3f466b065c5d14e8506b47e3f">rpaligned_realloc</a></div><div class="ttdeci">RPMALLOC_ALLOCATOR void * rpaligned_realloc(void *ptr, size_t alignment, size_t size, size_t oldsize, unsigned int flags)</div><div class="ttdoc">Reallocate the given block to at least the given size and alignment,.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l03129">rpmalloc.c:3129</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a94d4ba8d2181723f35b45da39c91d8ab"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a94d4ba8d2181723f35b45da39c91d8ab">atomic_store_ptr_release</a></div><div class="ttdeci">static FORCEINLINE void atomic_store_ptr_release(atomicptr_t *dst, void *val)</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00189">rpmalloc.c:189</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a95449a66565995789e144cfc3f538261"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a95449a66565995789e144cfc3f538261">MEDIUM_GRANULARITY_SHIFT</a></div><div class="ttdeci">#define MEDIUM_GRANULARITY_SHIFT</div><div class="ttdoc">Medium granularity shift count.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00298">rpmalloc.c:298</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a95d666267d99d22454086d5fa0390bff"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a95d666267d99d22454086d5fa0390bff">INVALID_POINTER</a></div><div class="ttdeci">#define INVALID_POINTER</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00332">rpmalloc.c:332</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a9641beb0030ad56b2df025775823b2af"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a9641beb0030ad56b2df025775823b2af">_memory_medium_size_limit</a></div><div class="ttdeci">static size_t _memory_medium_size_limit</div><div class="ttdoc">Run-time size limit of medium blocks.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00629">rpmalloc.c:629</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a97df83853dc6ddf7e0114691b15edb49"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a97df83853dc6ddf7e0114691b15edb49">span_t::block_size</a></div><div class="ttdeci">uint32_t block_size</div><div class="ttdoc">Size of a block.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00447">rpmalloc.c:447</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a97f4a6378f5e22e4e38e32cf9f370430"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a97f4a6378f5e22e4e38e32cf9f370430">__rpmalloc_sysconf</a></div><div class="ttdeci">long __rpmalloc_sysconf(int name)</div><div class="ttdef"><b>Definition:</b> <a href="../../d1/d7e/rpmalloc__compat_8cpp_source.html#l00058">rpmalloc_compat.cpp:58</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a9891bc299af5a3533139ca76ce76cd70"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a9891bc299af5a3533139ca76ce76cd70">_rpmalloc_allocate_large</a></div><div class="ttdeci">static void * _rpmalloc_allocate_large(heap_t *heap, size_t size)</div><div class="ttdoc">Allocate a large sized memory block from the given heap.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l02228">rpmalloc.c:2228</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a98c82279e204e31a5dc89b64d2c6c27c"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a98c82279e204e31a5dc89b64d2c6c27c">SPAN_FLAG_MASTER</a></div><div class="ttdeci">#define SPAN_FLAG_MASTER</div><div class="ttdoc">Flag indicating span is the first (master) span of a split superspan.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00357">rpmalloc.c:357</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a995ec0e5a8f40e3fb178abab89dc7fd5"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a995ec0e5a8f40e3fb178abab89dc7fd5">rpmalloc_initialize</a></div><div class="ttdeci">int rpmalloc_initialize(void)</div><div class="ttdoc">Initialize the allocator and setup global data.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l02814">rpmalloc.c:2814</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a9c0563645d0d1fd53044a9c00dad6dc0"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a9c0563645d0d1fd53044a9c00dad6dc0">global_cache_t::lock</a></div><div class="ttdeci">atomic32_t lock</div><div class="ttdoc">Cache lock.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00571">rpmalloc.c:571</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a9d6636075b348ce9cbd7e59e45d097c7"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a9d6636075b348ce9cbd7e59e45d097c7">global_cache_t::span</a></div><div class="ttdeci">span_t * span[GLOBAL_CACHE_MULTIPLIER *MAX_THREAD_SPAN_CACHE]</div><div class="ttdoc">Cached spans.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00581">rpmalloc.c:581</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a9d7ec974d864302bb4f8516859c4b212"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a9d7ec974d864302bb4f8516859c4b212">_memory_page_size_shift</a></div><div class="ttdeci">static size_t _memory_page_size_shift</div><div class="ttdoc">Shift to divide by page size.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00606">rpmalloc.c:606</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a9fefa5277fefa0c58f69d5b86d679ccb"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#a9fefa5277fefa0c58f69d5b86d679ccb">_memory_span_size</a></div><div class="ttdeci">static size_t _memory_span_size</div><div class="ttdoc">Size of a span of memory pages.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00611">rpmalloc.c:611</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_aa1ee77cdccf0341222f64395d0be2626"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#aa1ee77cdccf0341222f64395d0be2626">atomic_store32</a></div><div class="ttdeci">static FORCEINLINE void atomic_store32(atomic32_t *dst, int32_t val)</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00179">rpmalloc.c:179</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_aa34fdcc23a2d119e7436a33e05ddb665"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#aa34fdcc23a2d119e7436a33e05ddb665">span_t</a></div><div class="ttdeci">struct span_t span_t</div><div class="ttdoc">Span of memory pages.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00321">rpmalloc.c:346</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_aa378f245dd9ff587c375db42472ac954"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#aa378f245dd9ff587c375db42472ac954">_rpmalloc_heap_release_raw</a></div><div class="ttdeci">static void _rpmalloc_heap_release_raw(void *heapptr, int release_cache)</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l02057">rpmalloc.c:2057</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_aa3b1a6473db3c198691da8c7b8918f7a"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#aa3b1a6473db3c198691da8c7b8918f7a">_rpmalloc_mmap_os</a></div><div class="ttdeci">static void * _rpmalloc_mmap_os(size_t size, size_t *offset)</div><div class="ttdoc">Default implementation to map new pages to virtual memory.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00835">rpmalloc.c:835</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_aa6d37b325f0f3c68f89cdf681681a09f"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#aa6d37b325f0f3c68f89cdf681681a09f">_rpmalloc_global_set_reserved_spans</a></div><div class="ttdeci">static void _rpmalloc_global_set_reserved_spans(span_t *master, span_t *reserve, size_t reserve_span_count)</div><div class="ttdoc">Store the given spans as global reserve (must only be called from within new heap allocation,...</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00928">rpmalloc.c:928</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_aa74d427b2b9955ff2d9719693d9fc80e"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#aa74d427b2b9955ff2d9719693d9fc80e">SIZE_CLASS_COUNT</a></div><div class="ttdeci">#define SIZE_CLASS_COUNT</div><div class="ttdoc">Total number of small + medium size classes.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00302">rpmalloc.c:302</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_aa776faada2c6d5b7edda58a3a1d701c4"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#aa776faada2c6d5b7edda58a3a1d701c4">_rpmalloc_span_finalize</a></div><div class="ttdeci">static int _rpmalloc_span_finalize(heap_t *heap, size_t iclass, span_t *span, span_t **list_head)</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l01290">rpmalloc.c:1290</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_aab22b36fb2408434cc731fb9fe6a5cec"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#aab22b36fb2408434cc731fb9fe6a5cec">_rpmalloc_stat_dec</a></div><div class="ttdeci">#define _rpmalloc_stat_dec(counter)</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00253">rpmalloc.c:253</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_aacc7bcb924cab5e38c3fe65c5d0b4ab0"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#aacc7bcb924cab5e38c3fe65c5d0b4ab0">_rpmalloc_main_thread_id</a></div><div class="ttdeci">static uintptr_t _rpmalloc_main_thread_id</div><div class="ttdoc">Main thread ID.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00600">rpmalloc.c:600</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_ab1224666923d459edcb9bc5a7399a419"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#ab1224666923d459edcb9bc5a7399a419">_rpmalloc_span_map_from_reserve</a></div><div class="ttdeci">static span_t * _rpmalloc_span_map_from_reserve(heap_t *heap, size_t span_count)</div><div class="ttdoc">Use reserved spans to fulfill a memory map request (reserve size must be checked by caller)</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l01010">rpmalloc.c:1010</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_ab3168e56cb172bc471c410e9daaf7ca1"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#ab3168e56cb172bc471c410e9daaf7ca1">_rpmalloc_stat_inc_free</a></div><div class="ttdeci">#define _rpmalloc_stat_inc_free(heap, class_idx)</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00277">rpmalloc.c:277</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_ab4225911698b67188e1538c334cfe16c"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#ab4225911698b67188e1538c334cfe16c">pointer_offset</a></div><div class="ttdeci">#define pointer_offset(ptr, ofs)</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00329">rpmalloc.c:329</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_ab51bbcd0d9d41ba9c6f4ad547ba77405"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#ab51bbcd0d9d41ba9c6f4ad547ba77405">_rpmalloc_stat_inc</a></div><div class="ttdeci">#define _rpmalloc_stat_inc(counter)</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00249">rpmalloc.c:249</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_abc75935ba437c535deefc42928807231"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#abc75935ba437c535deefc42928807231">_rpmalloc_global_get_reserved_spans</a></div><div class="ttdeci">static span_t * _rpmalloc_global_get_reserved_spans(size_t span_count)</div><div class="ttdoc">Use global reserved spans to fulfill a memory map request (reserve size must be checked by caller)</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00914">rpmalloc.c:914</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_abd4c41e806e09b0468b6db0ae56ed461"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#abd4c41e806e09b0468b6db0ae56ed461">_rpmalloc_stat_inc_alloc</a></div><div class="ttdeci">#define _rpmalloc_stat_inc_alloc(heap, class_idx)</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00273">rpmalloc.c:273</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_abdbbc20ab63d76c1709722f3f2305610"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#abdbbc20ab63d76c1709722f3f2305610">_rpmalloc_heap_cache_insert</a></div><div class="ttdeci">static void _rpmalloc_heap_cache_insert(heap_t *heap, span_t *span)</div><div class="ttdoc">Insert a single span into thread heap cache, releasing to global cache if overflow.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l01642">rpmalloc.c:1642</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_abf4fa6f8f0e7baff0d6a7a96df58bcca"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#abf4fa6f8f0e7baff0d6a7a96df58bcca">span_t::used_count</a></div><div class="ttdeci">uint32_t used_count</div><div class="ttdoc">Number of used blocks remaining when in partial state.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00441">rpmalloc.c:441</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_abfbbb8e2f9b086d466fe2898a283c98d"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#abfbbb8e2f9b086d466fe2898a283c98d">_rpmalloc_unmap</a></div><div class="ttdeci">static void _rpmalloc_unmap(void *address, size_t size, size_t offset, size_t release)</div><div class="ttdoc">Unmap virtual memory.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00820">rpmalloc.c:820</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_ac0d9f7ba6a7fbb2c64e323a0f55c66d7"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#ac0d9f7ba6a7fbb2c64e323a0f55c66d7">_rpmalloc_global_cache_extract_spans</a></div><div class="ttdeci">static size_t _rpmalloc_global_cache_extract_spans(span_t **span, size_t span_count, size_t count)</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l01456">rpmalloc.c:1456</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_ac32a750ddf4072d46c28f52b9f3ee018"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#ac32a750ddf4072d46c28f52b9f3ee018">_rpmalloc_span_double_link_list_add</a></div><div class="ttdeci">static void _rpmalloc_span_double_link_list_add(span_t **head, span_t *span)</div><div class="ttdoc">Add a span to double linked list at the head.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00943">rpmalloc.c:943</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_ac411b0f198d4e31569fc30ca2c174f65"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#ac411b0f198d4e31569fc30ca2c174f65">heap_size_class_t::free_list</a></div><div class="ttdeci">void * free_list</div><div class="ttdoc">Free list of active span.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00486">rpmalloc.c:486</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_ac62e0e77eb38ebff4443eb5db3ccd45c"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#ac62e0e77eb38ebff4443eb5db3ccd45c">span_t::next</a></div><div class="ttdeci">span_t * next</div><div class="ttdoc">Next span.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00463">rpmalloc.c:463</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_ac7e4a352a230ef04d4372db43a454b7f"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#ac7e4a352a230ef04d4372db43a454b7f">HEAP_ARRAY_SIZE</a></div><div class="ttdeci">#define HEAP_ARRAY_SIZE</div><div class="ttdoc">Size of heap hashmap.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00033">rpmalloc.c:33</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_ac8a96725f034c08fdff774eb54785947"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#ac8a96725f034c08fdff774eb54785947">_rpmalloc_deallocate_defer_free_span</a></div><div class="ttdeci">static void _rpmalloc_deallocate_defer_free_span(heap_t *heap, span_t *span)</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l02467">rpmalloc.c:2467</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_acb3289e60a1c405dbb154dce3f3d6c7a"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#acb3289e60a1c405dbb154dce3f3d6c7a">rpmalloc_thread_statistics</a></div><div class="ttdeci">void rpmalloc_thread_statistics(rpmalloc_thread_statistics_t *stats)</div><div class="ttdoc">Get per-thread statistics.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l03189">rpmalloc.c:3189</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_ad008ddf766a4f56fbde2edf2c51d9a87"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#ad008ddf766a4f56fbde2edf2c51d9a87">rpmalloc_assert</a></div><div class="ttdeci">#define rpmalloc_assert(truth, message)</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00143">rpmalloc.c:143</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_ad1094486bd3e5ee282e7a4ce7de9c7db"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#ad1094486bd3e5ee282e7a4ce7de9c7db">SPAN_FLAG_ALIGNED_BLOCKS</a></div><div class="ttdeci">#define SPAN_FLAG_ALIGNED_BLOCKS</div><div class="ttdoc">Flag indicating span has blocks with increased alignment.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00361">rpmalloc.c:361</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_ad3b62974f1bafcc293cde80eb05a7abe"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#ad3b62974f1bafcc293cde80eb05a7abe">_rpmalloc_global_cache_finalize</a></div><div class="ttdeci">static void _rpmalloc_global_cache_finalize(global_cache_t *cache)</div><div class="ttdoc">Finalize a global cache.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l01347">rpmalloc.c:1347</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_ad5eb163989618d4ea0eff254cdbdd596"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#ad5eb163989618d4ea0eff254cdbdd596">_rpmalloc_span_initialize</a></div><div class="ttdeci">static void _rpmalloc_span_initialize(span_t *span, size_t total_span_count, size_t span_count, size_t align_offset)</div><div class="ttdoc">Setup a newly mapped span.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l01036">rpmalloc.c:1036</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_ad7af40ab0c9174515ec06efb45ebdd73"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#ad7af40ab0c9174515ec06efb45ebdd73">_memory_span_cache</a></div><div class="ttdeci">static global_cache_t _memory_span_cache[LARGE_CLASS_COUNT]</div><div class="ttdoc">Global span cache.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00636">rpmalloc.c:636</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_ad842dbc76a30fb5beee77a2d773a3e91"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#ad842dbc76a30fb5beee77a2d773a3e91">span_t::list_size</a></div><div class="ttdeci">uint32_t list_size</div><div class="ttdoc">Size of deferred free list, or list of spans when part of a cache list.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00445">rpmalloc.c:445</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_ad9fade5754c34dc5e3ee99c1e432ccb7"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#ad9fade5754c34dc5e3ee99c1e432ccb7">_rpmalloc_heap_global_cache_extract</a></div><div class="ttdeci">static span_t * _rpmalloc_heap_global_cache_extract(heap_t *heap, size_t span_count)</div><div class="ttdoc">Extract a span from the global cache.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l01745">rpmalloc.c:1745</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_ada0a343b3498bb882ebd7e0c3caa0935"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#ada0a343b3498bb882ebd7e0c3caa0935">_memory_default_span_mask</a></div><div class="ttdeci">#define _memory_default_span_mask</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00595">rpmalloc.c:595</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_ada12637cd22672d5ad52ceba482b7f5c"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#ada12637cd22672d5ad52ceba482b7f5c">_memory_heap_reserve_count</a></div><div class="ttdeci">static size_t _memory_heap_reserve_count</div><div class="ttdoc">Number of spans to keep reserved in each heap.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00625">rpmalloc.c:625</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_adb538a1ad8a86db6b92895d9ebf6d907"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#adb538a1ad8a86db6b92895d9ebf6d907">_memory_span_size_shift</a></div><div class="ttdeci">static size_t _memory_span_size_shift</div><div class="ttdoc">Shift to divide by span size.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00613">rpmalloc.c:613</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_adc5743a6b15192da5b7e023f85360208"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#adc5743a6b15192da5b7e023f85360208">_rpmalloc_usable_size</a></div><div class="ttdeci">static size_t _rpmalloc_usable_size(void *p)</div><div class="ttdoc">Get the usable size of the given block.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l02765">rpmalloc.c:2765</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_addaef25db6ed1f3f0308ad7464745828"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#addaef25db6ed1f3f0308ad7464745828">_rpmalloc_span_initialize_new</a></div><div class="ttdeci">static void * _rpmalloc_span_initialize_new(heap_t *heap, heap_size_class_t *heap_size_class, span_t *span, uint32_t class_idx)</div><div class="ttdoc">Initialize an unused span (from cache or mapped) to be new active span, putting the initial free list...</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l01234">rpmalloc.c:1234</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_addf543f30c5eefc1dded60025c78a816"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#addf543f30c5eefc1dded60025c78a816">free_list_partial_init</a></div><div class="ttdeci">static uint32_t free_list_partial_init(void **list, void **first_block, void *page_start, void *block_start, uint32_t block_count, uint32_t block_size)</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l01198">rpmalloc.c:1198</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_ade7fb930b30a5a8bd04ecc97cad60e6b"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#ade7fb930b30a5a8bd04ecc97cad60e6b">_rpmalloc_span_is_fully_utilized</a></div><div class="ttdeci">static int _rpmalloc_span_is_fully_utilized(span_t *span)</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l01283">rpmalloc.c:1283</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_ae1f1297fe3d143e41deac95ee7a7f8d4"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#ae1f1297fe3d143e41deac95ee7a7f8d4">_memory_config</a></div><div class="ttdeci">static rpmalloc_config_t _memory_config</div><div class="ttdoc">Configuration.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00602">rpmalloc.c:602</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_ae261e72f93968b03a76ada7a6b150965"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#ae261e72f93968b03a76ada7a6b150965">atomic_store_ptr</a></div><div class="ttdeci">static FORCEINLINE void atomic_store_ptr(atomicptr_t *dst, void *val)</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00188">rpmalloc.c:188</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_ae324fa158db468143544693dfe539800"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#ae324fa158db468143544693dfe539800">_rpmalloc_deallocate</a></div><div class="ttdeci">static void _rpmalloc_deallocate(void *p)</div><div class="ttdoc">Deallocate the given block.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l02615">rpmalloc.c:2615</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_ae3a524405e2a853229e95546df284be2"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#ae3a524405e2a853229e95546df284be2">_memory_orphan_heaps</a></div><div class="ttdeci">static heap_t * _memory_orphan_heaps</div><div class="ttdoc">Orphaned heaps.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00649">rpmalloc.c:649</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_ae4a00ccf859d64a7519ae121563a56e7"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#ae4a00ccf859d64a7519ae121563a56e7">_rpmalloc_heap_set_reserved_spans</a></div><div class="ttdeci">static void _rpmalloc_heap_set_reserved_spans(heap_t *heap, span_t *master, span_t *reserve, size_t reserve_span_count)</div><div class="ttdoc">Store the given spans as reserve in the given heap.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l01506">rpmalloc.c:1506</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_ae6278b2864893c2bc2d86b5d6d9f2d51"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#ae6278b2864893c2bc2d86b5d6d9f2d51">rpmalloc_global_statistics</a></div><div class="ttdeci">void rpmalloc_global_statistics(rpmalloc_global_statistics_t *stats)</div><div class="ttdoc">Get global statistics.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l03262">rpmalloc.c:3262</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_ae6f35022f9384e2a22ed2b96c00995b2"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#ae6f35022f9384e2a22ed2b96c00995b2">rpposix_memalign</a></div><div class="ttdeci">int rpposix_memalign(void **memptr, size_t alignment, size_t size)</div><div class="ttdoc">Allocate a memory block of at least the given size and alignment.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l03169">rpmalloc.c:3169</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_ae75d84f0a9ac27b96d18fcd652249cda"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#ae75d84f0a9ac27b96d18fcd652249cda">get_thread_heap</a></div><div class="ttdeci">static heap_t * get_thread_heap(void)</div><div class="ttdoc">Get the current thread heap.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00717">rpmalloc.c:717</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_ae77d9a2cdd2a2fd46e3b27739d6c88cc"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#ae77d9a2cdd2a2fd46e3b27739d6c88cc">span_t::span_count</a></div><div class="ttdeci">uint32_t span_count</div><div class="ttdoc">Number of spans.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00451">rpmalloc.c:451</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_ae7b97ba12e15609b6d63926ed2e30238"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#ae7b97ba12e15609b6d63926ed2e30238">_memory_span_mask</a></div><div class="ttdeci">static uintptr_t _memory_span_mask</div><div class="ttdoc">Mask to get to start of a memory span.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00615">rpmalloc.c:615</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_ae82498bcdc6e7af0bc9adc0e75c60cee"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#ae82498bcdc6e7af0bc9adc0e75c60cee">_rpmalloc_span_map_aligned_count</a></div><div class="ttdeci">static span_t * _rpmalloc_span_map_aligned_count(heap_t *heap, size_t span_count)</div><div class="ttdoc">Map an aligned set of spans, taking configured mapping granularity and the page size into account.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l01050">rpmalloc.c:1050</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_aebbd8639c3b627f526bd557e065f1c00"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#aebbd8639c3b627f526bd557e065f1c00">MAX_THREAD_SPAN_CACHE</a></div><div class="ttdeci">#define MAX_THREAD_SPAN_CACHE</div><div class="ttdoc">Number of spans in thread cache.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00312">rpmalloc.c:312</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_aec7913670102d551e3fd60509cd381a3"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#aec7913670102d551e3fd60509cd381a3">_rpmalloc_span_double_link_list_remove</a></div><div class="ttdeci">static void _rpmalloc_span_double_link_list_remove(span_t **head, span_t *span)</div><div class="ttdoc">Remove a span from double linked list.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00962">rpmalloc.c:962</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_aec9c1ea6434b5703d7b6e01cfffd1261"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#aec9c1ea6434b5703d7b6e01cfffd1261">GLOBAL_CACHE_MULTIPLIER</a></div><div class="ttdeci">#define GLOBAL_CACHE_MULTIPLIER</div><div class="ttdoc">Multiplier for global cache.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00081">rpmalloc.c:81</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_aecb085054ab2d682b41748925519c084"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#aecb085054ab2d682b41748925519c084">MEDIUM_SIZE_LIMIT</a></div><div class="ttdeci">#define MEDIUM_SIZE_LIMIT</div><div class="ttdoc">Maximum size of a medium block.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00306">rpmalloc.c:306</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_aecf578949f89fb109c5f6f527a2dc49d"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#aecf578949f89fb109c5f6f527a2dc49d">SMALL_SIZE_LIMIT</a></div><div class="ttdeci">#define SMALL_SIZE_LIMIT</div><div class="ttdoc">Maximum size of a small block.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00294">rpmalloc.c:294</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_aeded978bd21c13b71d9b0310b5bb09ec"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#aeded978bd21c13b71d9b0310b5bb09ec">size_class_t::block_count</a></div><div class="ttdeci">uint16_t block_count</div><div class="ttdoc">Number of blocks in each chunk.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00562">rpmalloc.c:562</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_af080b8796eb59bb59da90cb8536f0891"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#af080b8796eb59bb59da90cb8536f0891">_rpmalloc_allocate_from_heap_fallback</a></div><div class="ttdeci">static void * _rpmalloc_allocate_from_heap_fallback(heap_t *heap, heap_size_class_t *heap_size_class, uint32_t class_idx)</div><div class="ttdoc">Allocate a small/medium sized memory block from the given heap.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l02143">rpmalloc.c:2143</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_af093d9cb1719d72c20f96a9b467590f5"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#af093d9cb1719d72c20f96a9b467590f5">span_t::free_list_limit</a></div><div class="ttdeci">uint32_t free_list_limit</div><div class="ttdoc">Index of last block initialized in free list.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00439">rpmalloc.c:439</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_af1cf3243cc57cc5033ae07b71984abcf"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#af1cf3243cc57cc5033ae07b71984abcf">_rpmalloc_heap_reserved_extract</a></div><div class="ttdeci">static span_t * _rpmalloc_heap_reserved_extract(heap_t *heap, size_t span_count)</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l01736">rpmalloc.c:1736</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_af281178bc271d4b4a2f2bd11f17adc04"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#af281178bc271d4b4a2f2bd11f17adc04">_rpmalloc_heap_extract_orphan</a></div><div class="ttdeci">static heap_t * _rpmalloc_heap_extract_orphan(heap_t **heap_list)</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l01969">rpmalloc.c:1969</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_af2ca2fcf7e544c9458ef49057a40b78e"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#af2ca2fcf7e544c9458ef49057a40b78e">_rpmalloc_span_extract_free_list_deferred</a></div><div class="ttdeci">static void _rpmalloc_span_extract_free_list_deferred(span_t *span)</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l01269">rpmalloc.c:1269</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_af2f2ee0936896aa297771a26dec63027"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#af2f2ee0936896aa297771a26dec63027">span_list_t</a></div><div class="ttdeci">struct span_list_t span_list_t</div><div class="ttdoc">Span list.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00321">rpmalloc.c:348</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_af327588f7260778f453d9a212396e0e0"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#af327588f7260778f453d9a212396e0e0">atomic_add32</a></div><div class="ttdeci">static FORCEINLINE int32_t atomic_add32(atomic32_t *val, int32_t add)</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00182">rpmalloc.c:182</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_af32dc4254a995d8ba3ab99376c9ad4d0"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#af32dc4254a995d8ba3ab99376c9ad4d0">span_t::total_spans</a></div><div class="ttdeci">uint32_t total_spans</div><div class="ttdoc">Total span counter for master spans.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00453">rpmalloc.c:453</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_af330a53810a7e9a1d2a151bc229a9dc4"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#af330a53810a7e9a1d2a151bc229a9dc4">rpmalloc</a></div><div class="ttdeci">RPMALLOC_ALLOCATOR void * rpmalloc(size_t size)</div><div class="ttdoc">Allocate a memory block of at least the given size.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l03086">rpmalloc.c:3086</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_af42cdefbf9addf1c268ba19e63c60f29"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#af42cdefbf9addf1c268ba19e63c60f29">_memory_heap_id</a></div><div class="ttdeci">static atomic32_t _memory_heap_id</div><div class="ttdoc">Heap ID counter.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00631">rpmalloc.c:631</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_af44e92f7ed42c434bd33a0ae98210a3f"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#af44e92f7ed42c434bd33a0ae98210a3f">_rpmalloc_heap_cache_adopt_deferred</a></div><div class="ttdeci">static void _rpmalloc_heap_cache_adopt_deferred(heap_t *heap, span_t **single_span)</div><div class="ttdoc">Adopt the deferred span cache list, optionally extracting the first single span for immediate re-use.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l01515">rpmalloc.c:1515</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_af51a6ed47e80b1b57187f1d5be6c8b4c"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#af51a6ed47e80b1b57187f1d5be6c8b4c">pointer_diff</a></div><div class="ttdeci">#define pointer_diff(first, second)</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00330">rpmalloc.c:330</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_af696dfc58704b5b75dc6b0a02c6fed66"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#af696dfc58704b5b75dc6b0a02c6fed66">rpaligned_alloc</a></div><div class="ttdeci">RPMALLOC_ALLOCATOR void * rpaligned_alloc(size_t alignment, size_t size)</div><div class="ttdoc">Allocate a memory block of at least the given size and alignment.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l03140">rpmalloc.c:3140</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_af6f24a9d51e940bbad434106b1d56e20"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#af6f24a9d51e940bbad434106b1d56e20">atomic_exchange_ptr_acquire</a></div><div class="ttdeci">static FORCEINLINE void * atomic_exchange_ptr_acquire(atomicptr_t *dst, void *val)</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00190">rpmalloc.c:190</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_af7213260e19fbad385988302247150d4"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#af7213260e19fbad385988302247150d4">get_thread_heap_raw</a></div><div class="ttdeci">static heap_t * get_thread_heap_raw(void)</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00710">rpmalloc.c:710</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_af801d58362e979c2a31744800624dcf9"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#af801d58362e979c2a31744800624dcf9">span_active_t</a></div><div class="ttdeci">struct span_active_t span_active_t</div><div class="ttdoc">Span active data.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00321">rpmalloc.c:350</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_af829c49d9fc4d933c14113ba0d694e7c"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#af829c49d9fc4d933c14113ba0d694e7c">heap_size_class_t::partial_span</a></div><div class="ttdeci">span_t * partial_span</div><div class="ttdoc">Double linked list of partially used spans with free blocks.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00489">rpmalloc.c:489</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_af8803f4eab133ac4c823104577553d78"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#af8803f4eab133ac4c823104577553d78">DEFAULT_SPAN_MAP_COUNT</a></div><div class="ttdeci">#define DEFAULT_SPAN_MAP_COUNT</div><div class="ttdoc">Default number of spans to map in call to map more virtual memory (default values yield 4MiB here)</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00077">rpmalloc.c:77</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_af8bd0cd08a93d20cb117e18d85f877cd"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#af8bd0cd08a93d20cb117e18d85f877cd">_rpmalloc_allocate</a></div><div class="ttdeci">static void * _rpmalloc_allocate(heap_t *heap, size_t size)</div><div class="ttdoc">Allocate a block of the given size.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l02289">rpmalloc.c:2289</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_af8f864d9fe0055b43dc8034fe9060630"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#af8f864d9fe0055b43dc8034fe9060630">UNEXPECTED</a></div><div class="ttdeci">#define UNEXPECTED(x)</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00213">rpmalloc.c:213</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_afa1244471261835d7a8a2fa23464834b"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#afa1244471261835d7a8a2fa23464834b">rpaligned_calloc</a></div><div class="ttdeci">RPMALLOC_ALLOCATOR void * rpaligned_calloc(size_t alignment, size_t num, size_t size)</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l03147">rpmalloc.c:3147</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_afed57ac88686e15e2d9cee4743e31857"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#afed57ac88686e15e2d9cee4743e31857">rpmalloc_config</a></div><div class="ttdeci">const rpmalloc_config_t * rpmalloc_config(void)</div><div class="ttdoc">Get allocator configuration.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l03078">rpmalloc.c:3078</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_afef7a20458b75404cdbba364a751694a"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#afef7a20458b75404cdbba364a751694a">SMALL_CLASS_COUNT</a></div><div class="ttdeci">#define SMALL_CLASS_COUNT</div><div class="ttdoc">Number of small block size classes.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00292">rpmalloc.c:292</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_aff58cf54f7ebc5d3d71a2ad80a0dab94"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#aff58cf54f7ebc5d3d71a2ad80a0dab94">rpmalloc_finalize</a></div><div class="ttdeci">void rpmalloc_finalize(void)</div><div class="ttdoc">Finalize the allocator.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l02993">rpmalloc.c:2993</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_d1/d24/structspan__t"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#d1/d24/structspan__t">span_t</a></div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00430">rpmalloc.c:431</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_d2/daa/structsize__class__t"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#d2/daa/structsize__class__t">size_class_t</a></div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00557">rpmalloc.c:558</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_d3/dad/structheap__size__class__t"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#d3/dad/structheap__size__class__t">heap_size_class_t</a></div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00483">rpmalloc.c:484</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_d5/dec/structspan__large__cache__t"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#d5/dec/structspan__large__cache__t">span_large_cache_t</a></div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00476">rpmalloc.c:477</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_da/d15/structspan__cache__t"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#da/d15/structspan__cache__t">span_cache_t</a></div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00469">rpmalloc.c:470</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_db/d6b/structglobal__cache__t"><div class="ttname"><a href="../../df/dc0/rpmalloc_8c.html#db/d6b/structglobal__cache__t">global_cache_t</a></div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00568">rpmalloc.c:569</a></div></div>
<div class="ttc" id="arpmalloc_8h_html"><div class="ttname"><a href="../../d2/d43/rpmalloc_8h.html">rpmalloc.h</a></div></div>
<div class="ttc" id="arpmalloc_8h_html_a29f83756e4d2a2bdebcfdfc8a8908081"><div class="ttname"><a href="../../d2/d43/rpmalloc_8h.html#a29f83756e4d2a2bdebcfdfc8a8908081">rpmalloc_thread_statistics_t::global_to_thread</a></div><div class="ttdeci">size_t global_to_thread</div><div class="ttdoc">Total number of bytes transitioned from global cache to thread cache (only if ENABLE_STATISTICS=1)</div><div class="ttdef"><b>Definition:</b> <a href="../../d2/d43/rpmalloc_8h_source.html#l00096">rpmalloc.h:96</a></div></div>
<div class="ttc" id="arpmalloc_8h_html_a308868b1a8740da06b79c1bdabae1997"><div class="ttname"><a href="../../d2/d43/rpmalloc_8h.html#a308868b1a8740da06b79c1bdabae1997">rpmalloc_global_statistics_t::huge_alloc_peak</a></div><div class="ttdeci">size_t huge_alloc_peak</div><div class="ttdoc">Peak amount of memory allocated in huge allocations, i.e larger than LARGE_SIZE_LIMIT which is 2MiB b...</div><div class="ttdef"><b>Definition:</b> <a href="../../d2/d43/rpmalloc_8h_source.html#l00080">rpmalloc.h:80</a></div></div>
<div class="ttc" id="arpmalloc_8h_html_a5d0cd8aecab18855e794487437dc593a"><div class="ttname"><a href="../../d2/d43/rpmalloc_8h.html#a5d0cd8aecab18855e794487437dc593a">rpmalloc_thread_statistics_t::span_use</a></div><div class="ttdeci">struct rpmalloc_thread_statistics_t::@33 span_use[64]</div><div class="ttdoc">Per span count statistics (only if ENABLE_STATISTICS=1)</div></div>
<div class="ttc" id="arpmalloc_8h_html_a5db28c5567049de1e58833c061841f7e"><div class="ttname"><a href="../../d2/d43/rpmalloc_8h.html#a5db28c5567049de1e58833c061841f7e">rpmalloc_global_statistics_t::huge_alloc</a></div><div class="ttdeci">size_t huge_alloc</div><div class="ttdoc">Current amount of memory allocated in huge allocations, i.e larger than LARGE_SIZE_LIMIT which is 2Mi...</div><div class="ttdef"><b>Definition:</b> <a href="../../d2/d43/rpmalloc_8h_source.html#l00078">rpmalloc.h:78</a></div></div>
<div class="ttc" id="arpmalloc_8h_html_a70b10faa79aac5df497ba5eccdd554ae"><div class="ttname"><a href="../../d2/d43/rpmalloc_8h.html#a70b10faa79aac5df497ba5eccdd554ae">rpmalloc_global_statistics_t::cached</a></div><div class="ttdeci">size_t cached</div><div class="ttdoc">Current amount of memory in global caches for small and medium sizes (&lt;32KiB)</div><div class="ttdef"><b>Definition:</b> <a href="../../d2/d43/rpmalloc_8h_source.html#l00076">rpmalloc.h:76</a></div></div>
<div class="ttc" id="arpmalloc_8h_html_a85561f3ac6a729bf480cdf706d6c75dc"><div class="ttname"><a href="../../d2/d43/rpmalloc_8h.html#a85561f3ac6a729bf480cdf706d6c75dc">RPMALLOC_ALLOCATOR</a></div><div class="ttdeci">#define RPMALLOC_ALLOCATOR</div><div class="ttdef"><b>Definition:</b> <a href="../../d2/d43/rpmalloc_8h_source.html#l00043">rpmalloc.h:43</a></div></div>
<div class="ttc" id="arpmalloc_8h_html_aa896cafa124a63254f56621fe2c5241f"><div class="ttname"><a href="../../d2/d43/rpmalloc_8h.html#aa896cafa124a63254f56621fe2c5241f">rpmalloc_global_statistics_t::unmapped_total</a></div><div class="ttdeci">size_t unmapped_total</div><div class="ttdoc">Total amount of memory unmapped since initialization (only if ENABLE_STATISTICS=1)</div><div class="ttdef"><b>Definition:</b> <a href="../../d2/d43/rpmalloc_8h_source.html#l00084">rpmalloc.h:84</a></div></div>
<div class="ttc" id="arpmalloc_8h_html_ab0d895a6016dd1c5937f2a74370f2727"><div class="ttname"><a href="../../d2/d43/rpmalloc_8h.html#ab0d895a6016dd1c5937f2a74370f2727">rpmalloc_global_statistics_t::mapped</a></div><div class="ttdeci">size_t mapped</div><div class="ttdoc">Current amount of virtual memory mapped, all of which might not have been committed (only if ENABLE_S...</div><div class="ttdef"><b>Definition:</b> <a href="../../d2/d43/rpmalloc_8h_source.html#l00072">rpmalloc.h:72</a></div></div>
<div class="ttc" id="arpmalloc_8h_html_ab3774a093749aeca1d4e387b11e79395"><div class="ttname"><a href="../../d2/d43/rpmalloc_8h.html#ab3774a093749aeca1d4e387b11e79395">RPMALLOC_GROW_OR_FAIL</a></div><div class="ttdeci">#define RPMALLOC_GROW_OR_FAIL</div><div class="ttdoc">Flag to rpaligned_realloc to fail and return null pointer if grow cannot be done in-place,...</div><div class="ttdef"><b>Definition:</b> <a href="../../d2/d43/rpmalloc_8h_source.html#l00067">rpmalloc.h:67</a></div></div>
<div class="ttc" id="arpmalloc_8h_html_ac5a79462677dd135cae918db93f5dfe1"><div class="ttname"><a href="../../d2/d43/rpmalloc_8h.html#ac5a79462677dd135cae918db93f5dfe1">rpmalloc_thread_statistics_t::size_use</a></div><div class="ttdeci">struct rpmalloc_thread_statistics_t::@34 size_use[128]</div><div class="ttdoc">Per size class statistics (only if ENABLE_STATISTICS=1)</div></div>
<div class="ttc" id="arpmalloc_8h_html_ad5723376daeb707aa20547190ced2865"><div class="ttname"><a href="../../d2/d43/rpmalloc_8h.html#ad5723376daeb707aa20547190ced2865">rpmalloc_global_statistics_t::mapped_peak</a></div><div class="ttdeci">size_t mapped_peak</div><div class="ttdoc">Peak amount of virtual memory mapped, all of which might not have been committed (only if ENABLE_STAT...</div><div class="ttdef"><b>Definition:</b> <a href="../../d2/d43/rpmalloc_8h_source.html#l00074">rpmalloc.h:74</a></div></div>
<div class="ttc" id="arpmalloc_8h_html_ae1b16b8970cd1354befab4f0e4b993ac"><div class="ttname"><a href="../../d2/d43/rpmalloc_8h.html#ae1b16b8970cd1354befab4f0e4b993ac">rpmalloc_thread_statistics_t::sizecache</a></div><div class="ttdeci">size_t sizecache</div><div class="ttdoc">Current number of bytes available in thread size class caches for small and medium sizes (&lt;32KiB)</div><div class="ttdef"><b>Definition:</b> <a href="../../d2/d43/rpmalloc_8h_source.html#l00090">rpmalloc.h:90</a></div></div>
<div class="ttc" id="arpmalloc_8h_html_af1916b4138cfc1e46ff0787ff9206375"><div class="ttname"><a href="../../d2/d43/rpmalloc_8h.html#af1916b4138cfc1e46ff0787ff9206375">rpmalloc_global_statistics_t::mapped_total</a></div><div class="ttdeci">size_t mapped_total</div><div class="ttdoc">Total amount of memory mapped since initialization (only if ENABLE_STATISTICS=1)</div><div class="ttdef"><b>Definition:</b> <a href="../../d2/d43/rpmalloc_8h_source.html#l00082">rpmalloc.h:82</a></div></div>
<div class="ttc" id="arpmalloc_8h_html_af75f9eeddb63a098824a555506334c8a"><div class="ttname"><a href="../../d2/d43/rpmalloc_8h.html#af75f9eeddb63a098824a555506334c8a">rpmalloc_thread_statistics_t::spancache</a></div><div class="ttdeci">size_t spancache</div><div class="ttdoc">Current number of bytes available in thread span caches for small and medium sizes (&lt;32KiB)</div><div class="ttdef"><b>Definition:</b> <a href="../../d2/d43/rpmalloc_8h_source.html#l00092">rpmalloc.h:92</a></div></div>
<div class="ttc" id="arpmalloc_8h_html_affc9a9b9fff3b494c0f0dd63884be0e4"><div class="ttname"><a href="../../d2/d43/rpmalloc_8h.html#affc9a9b9fff3b494c0f0dd63884be0e4">rpmalloc_thread_statistics_t::thread_to_global</a></div><div class="ttdeci">size_t thread_to_global</div><div class="ttdoc">Total number of bytes transitioned from thread cache to global cache (only if ENABLE_STATISTICS=1)</div><div class="ttdef"><b>Definition:</b> <a href="../../d2/d43/rpmalloc_8h_source.html#l00094">rpmalloc.h:94</a></div></div>
<div class="ttc" id="arpmalloc_8h_html_affda05352198b9ef86d42be851a1349f"><div class="ttname"><a href="../../d2/d43/rpmalloc_8h.html#affda05352198b9ef86d42be851a1349f">RPMALLOC_NO_PRESERVE</a></div><div class="ttdeci">#define RPMALLOC_NO_PRESERVE</div><div class="ttdoc">Flag to rpaligned_realloc to not preserve content in reallocation.</div><div class="ttdef"><b>Definition:</b> <a href="../../d2/d43/rpmalloc_8h_source.html#l00063">rpmalloc.h:63</a></div></div>
<div class="ttc" id="arpmalloc_8h_html_d0/d25/structrpmalloc__thread__statistics__t"><div class="ttname"><a href="../../d2/d43/rpmalloc_8h.html#d0/d25/structrpmalloc__thread__statistics__t">rpmalloc_thread_statistics_t</a></div><div class="ttdef"><b>Definition:</b> <a href="../../d2/d43/rpmalloc_8h_source.html#l00087">rpmalloc.h:88</a></div></div>
<div class="ttc" id="arpmalloc_8h_html_d1/d1a/structrpmalloc__global__statistics__t"><div class="ttname"><a href="../../d2/d43/rpmalloc_8h.html#d1/d1a/structrpmalloc__global__statistics__t">rpmalloc_global_statistics_t</a></div><div class="ttdef"><b>Definition:</b> <a href="../../d2/d43/rpmalloc_8h_source.html#l00069">rpmalloc.h:70</a></div></div>
<div class="ttc" id="arpmalloc__compat_8cpp_html_a13ccab5430ace95c471aacf1fab0fcd6"><div class="ttname"><a href="../../d1/d7e/rpmalloc__compat_8cpp.html#a13ccab5430ace95c471aacf1fab0fcd6">heap_t::finalize</a></div><div class="ttdeci">int finalize</div><div class="ttdoc">Finalization state flag.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00525">rpmalloc.c:525</a></div></div>
<div class="ttc" id="arpmalloc__compat_8cpp_html_a2342224142317f85fca91614fc973131"><div class="ttname"><a href="../../d1/d7e/rpmalloc__compat_8cpp.html#a2342224142317f85fca91614fc973131">heap_t::id</a></div><div class="ttdeci">int32_t id</div><div class="ttdoc">Heap ID.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00523">rpmalloc.c:523</a></div></div>
<div class="ttc" id="arpmalloc__compat_8cpp_html_a348c1835d21f0af4a3776f96bdba64fb"><div class="ttname"><a href="../../d1/d7e/rpmalloc__compat_8cpp.html#a348c1835d21f0af4a3776f96bdba64fb">heap_t::master_heap</a></div><div class="ttdeci">heap_t * master_heap</div><div class="ttdoc">Master heap owning the memory pages.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00527">rpmalloc.c:527</a></div></div>
<div class="ttc" id="arpmalloc__compat_8cpp_html_a354c0beb35fd982bc4dbd3783b2dd1ff"><div class="ttname"><a href="../../d1/d7e/rpmalloc__compat_8cpp.html#a354c0beb35fd982bc4dbd3783b2dd1ff">heap_t::span_free_deferred</a></div><div class="ttdeci">atomicptr_t span_free_deferred</div><div class="ttdoc">List of deferred free spans (single linked list)</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00507">rpmalloc.c:507</a></div></div>
<div class="ttc" id="arpmalloc__compat_8cpp_html_a436e67271364d132c12f2f5f0d4c79ef"><div class="ttname"><a href="../../d1/d7e/rpmalloc__compat_8cpp.html#a436e67271364d132c12f2f5f0d4c79ef">heap_t::owner_thread</a></div><div class="ttdeci">uintptr_t owner_thread</div><div class="ttdoc">Owning thread ID.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00499">rpmalloc.c:499</a></div></div>
<div class="ttc" id="arpmalloc__compat_8cpp_html_a59fb66e831ef1e0d56d826b1851576eb"><div class="ttname"><a href="../../d1/d7e/rpmalloc__compat_8cpp.html#a59fb66e831ef1e0d56d826b1851576eb">heap_t::child_count</a></div><div class="ttdeci">atomic32_t child_count</div><div class="ttdoc">Child count.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00517">rpmalloc.c:517</a></div></div>
<div class="ttc" id="arpmalloc__compat_8cpp_html_a6aa789c3cdf7e70df144c248d18c5f4c"><div class="ttname"><a href="../../d1/d7e/rpmalloc__compat_8cpp.html#a6aa789c3cdf7e70df144c248d18c5f4c">heap_t::full_span_count</a></div><div class="ttdeci">size_t full_span_count</div><div class="ttdoc">Number of full spans.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00509">rpmalloc.c:509</a></div></div>
<div class="ttc" id="arpmalloc__compat_8cpp_html_a70f9a96b9071ccb6642894f5a7f56432"><div class="ttname"><a href="../../d1/d7e/rpmalloc__compat_8cpp.html#a70f9a96b9071ccb6642894f5a7f56432">heap_t::size_class</a></div><div class="ttdeci">heap_size_class_t size_class[SIZE_CLASS_COUNT]</div><div class="ttdoc">Free lists for each size class.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00501">rpmalloc.c:501</a></div></div>
<div class="ttc" id="arpmalloc__compat_8cpp_html_a74b47a0eacf313fe421d32379a2b942c"><div class="ttname"><a href="../../d1/d7e/rpmalloc__compat_8cpp.html#a74b47a0eacf313fe421d32379a2b942c">heap_t::next_heap</a></div><div class="ttdeci">heap_t * next_heap</div><div class="ttdoc">Next heap in id list.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00519">rpmalloc.c:519</a></div></div>
<div class="ttc" id="arpmalloc__compat_8cpp_html_a87e83453c93d1e6de70f6a45044e510d"><div class="ttname"><a href="../../d1/d7e/rpmalloc__compat_8cpp.html#a87e83453c93d1e6de70f6a45044e510d">heap_t::next_orphan</a></div><div class="ttdeci">heap_t * next_orphan</div><div class="ttdoc">Next heap in orphan list.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00521">rpmalloc.c:521</a></div></div>
<div class="ttc" id="arpmalloc__compat_8cpp_html_a8d5b27011e1ab5140090f90a75584329"><div class="ttname"><a href="../../d1/d7e/rpmalloc__compat_8cpp.html#a8d5b27011e1ab5140090f90a75584329">heap_t::spans_reserved</a></div><div class="ttdeci">uint32_t spans_reserved</div><div class="ttdoc">Number of mapped but unused spans.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00515">rpmalloc.c:515</a></div></div>
<div class="ttc" id="arpmalloc__compat_8cpp_html_aa549da79e540bdd3e963e294a39f64cf"><div class="ttname"><a href="../../d1/d7e/rpmalloc__compat_8cpp.html#aa549da79e540bdd3e963e294a39f64cf">heap_t::span_reserve</a></div><div class="ttdeci">span_t * span_reserve</div><div class="ttdoc">Mapped but unused spans.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00511">rpmalloc.c:511</a></div></div>
<div class="ttc" id="arpmalloc__compat_8cpp_html_aa6719c6b21d6c30ce96e404a63cc4bae"><div class="ttname"><a href="../../d1/d7e/rpmalloc__compat_8cpp.html#aa6719c6b21d6c30ce96e404a63cc4bae">heap_t::span_reserve_master</a></div><div class="ttdeci">span_t * span_reserve_master</div><div class="ttdoc">Master span for mapped but unused spans.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00513">rpmalloc.c:513</a></div></div>
<div class="ttc" id="arpmalloc__compat_8cpp_html_ae112aace519bbe14edb9127cefb59705"><div class="ttname"><a href="../../d1/d7e/rpmalloc__compat_8cpp.html#ae112aace519bbe14edb9127cefb59705">heap_t::span_cache</a></div><div class="ttdeci">span_cache_t span_cache</div><div class="ttdoc">Arrays of fully freed spans, single span.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00504">rpmalloc.c:504</a></div></div>
<div class="ttc" id="arpmalloc__compat_8cpp_html_aea02bb1ed60acc428d5a2d2db2cd9a7b"><div class="ttname"><a href="../../d1/d7e/rpmalloc__compat_8cpp.html#aea02bb1ed60acc428d5a2d2db2cd9a7b">heap_t::span_large_cache</a></div><div class="ttdeci">span_large_cache_t span_large_cache[LARGE_CLASS_COUNT - 1]</div><div class="ttdoc">Arrays of fully freed spans, large spans with &gt; 1 span count.</div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00530">rpmalloc.c:530</a></div></div>
<div class="ttc" id="arpmalloc__compat_8cpp_html_d9/d8a/structheap__t"><div class="ttname"><a href="../../d1/d7e/rpmalloc__compat_8cpp.html#d9/d8a/structheap__t">heap_t</a></div><div class="ttdef"><b>Definition:</b> <a href="../../df/dc0/rpmalloc_8c_source.html#l00496">rpmalloc.c:497</a></div></div>
<div class="ttc" id="astdatomic_8h_html"><div class="ttname"><a href="../../d6/d07/stdatomic_8h.html">stdatomic.h</a></div></div>
<div class="ttc" id="astdatomic_8h_html_a17c2de5ae768960284c047a320f17d1ba685a90c8fc516895354973c3918a5f7b"><div class="ttname"><a href="../../d6/d07/stdatomic_8h.html#a17c2de5ae768960284c047a320f17d1ba685a90c8fc516895354973c3918a5f7b">memory_order_release</a></div><div class="ttdeci">@ memory_order_release</div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d07/stdatomic_8h_source.html#l00025">stdatomic.h:25</a></div></div>
<div class="ttc" id="astdatomic_8h_html_a17c2de5ae768960284c047a320f17d1bac6489d0374e297a776f6a3db7ea5654a"><div class="ttname"><a href="../../d6/d07/stdatomic_8h.html#a17c2de5ae768960284c047a320f17d1bac6489d0374e297a776f6a3db7ea5654a">memory_order_relaxed</a></div><div class="ttdeci">@ memory_order_relaxed</div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d07/stdatomic_8h_source.html#l00022">stdatomic.h:22</a></div></div>
<div class="ttc" id="astdatomic_8h_html_a17c2de5ae768960284c047a320f17d1bafb313754331704b978e9a80a933b3da7"><div class="ttname"><a href="../../d6/d07/stdatomic_8h.html#a17c2de5ae768960284c047a320f17d1bafb313754331704b978e9a80a933b3da7">memory_order_acquire</a></div><div class="ttdeci">@ memory_order_acquire</div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d07/stdatomic_8h_source.html#l00024">stdatomic.h:24</a></div></div>
<div class="ttc" id="astdatomic_8h_html_a1d2b72b5d6ad1392c4f805054be0bdd1"><div class="ttname"><a href="../../d6/d07/stdatomic_8h.html#a1d2b72b5d6ad1392c4f805054be0bdd1">atomic_fetch_add_explicit</a></div><div class="ttdeci">#define atomic_fetch_add_explicit(object, operand, order)</div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d07/stdatomic_8h_source.html#l00063">stdatomic.h:63</a></div></div>
<div class="ttc" id="astdatomic_8h_html_a714cabdfee3dff182363e10401689371"><div class="ttname"><a href="../../d6/d07/stdatomic_8h.html#a714cabdfee3dff182363e10401689371">atomic_load_explicit</a></div><div class="ttdeci">#define atomic_load_explicit(object, order)</div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d07/stdatomic_8h_source.html#l00036">stdatomic.h:36</a></div></div>
<div class="ttc" id="astdatomic_8h_html_abc7db808dcdfb37a76f5dc646422fe29"><div class="ttname"><a href="../../d6/d07/stdatomic_8h.html#abc7db808dcdfb37a76f5dc646422fe29">atomic_exchange_explicit</a></div><div class="ttdeci">#define atomic_exchange_explicit(object, desired, order)</div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d07/stdatomic_8h_source.html#l00042">stdatomic.h:42</a></div></div>
<div class="ttc" id="astdatomic_8h_html_ad559c29e007899c11142f0d899625397"><div class="ttname"><a href="../../d6/d07/stdatomic_8h.html#ad559c29e007899c11142f0d899625397">atomic_store_explicit</a></div><div class="ttdeci">#define atomic_store_explicit(object, desired, order)</div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d07/stdatomic_8h_source.html#l00030">stdatomic.h:30</a></div></div>
<div class="ttc" id="astdatomic_8h_html_ae7f81d6541b8feec676e997952555882"><div class="ttname"><a href="../../d6/d07/stdatomic_8h.html#ae7f81d6541b8feec676e997952555882">atomic_compare_exchange_weak_explicit</a></div><div class="ttdeci">#define atomic_compare_exchange_weak_explicit(object, expected, desired, success, failure)</div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d07/stdatomic_8h_source.html#l00054">stdatomic.h:54</a></div></div>
<div class="ttc" id="astructrpmalloc__config__t_html"><div class="ttname"><a href="../../df/d42/structrpmalloc__config__t.html">rpmalloc_config_t</a></div><div class="ttdef"><b>Definition:</b> <a href="../../d2/d43/rpmalloc_8h_source.html#l00141">rpmalloc.h:142</a></div></div>
<div class="ttc" id="astructrpmalloc__config__t_html_a10fb22a2f8775aafd70b1c79f6b80630"><div class="ttname"><a href="../../df/d42/structrpmalloc__config__t.html#a10fb22a2f8775aafd70b1c79f6b80630">rpmalloc_config_t::memory_unmap</a></div><div class="ttdeci">void(* memory_unmap)(void *address, size_t size, size_t offset, size_t release)</div><div class="ttdoc">Unmap the memory pages starting at address and spanning the given number of bytes.</div><div class="ttdef"><b>Definition:</b> <a href="../../d2/d43/rpmalloc_8h_source.html#l00163">rpmalloc.h:163</a></div></div>
<div class="ttc" id="astructrpmalloc__config__t_html_a35106c441d799201ae0c57068d539ca4"><div class="ttname"><a href="../../df/d42/structrpmalloc__config__t.html#a35106c441d799201ae0c57068d539ca4">rpmalloc_config_t::map_fail_callback</a></div><div class="ttdeci">int(* map_fail_callback)(size_t size)</div><div class="ttdoc">Called when a call to map memory pages fails (out of memory). If this callback is.</div><div class="ttdef"><b>Definition:</b> <a href="../../d2/d43/rpmalloc_8h_source.html#l00172">rpmalloc.h:172</a></div></div>
<div class="ttc" id="astructrpmalloc__config__t_html_a84cfc60f2a133ca255a762778cc024c6"><div class="ttname"><a href="../../df/d42/structrpmalloc__config__t.html#a84cfc60f2a133ca255a762778cc024c6">rpmalloc_config_t::span_map_count</a></div><div class="ttdeci">size_t span_map_count</div><div class="ttdoc">Number of spans to map at each request to map new virtual memory blocks. This can.</div><div class="ttdef"><b>Definition:</b> <a href="../../d2/d43/rpmalloc_8h_source.html#l00186">rpmalloc.h:186</a></div></div>
<div class="ttc" id="astructrpmalloc__config__t_html_a8b1c79b90f2b7f66d98690b1234ab8d8"><div class="ttname"><a href="../../df/d42/structrpmalloc__config__t.html#a8b1c79b90f2b7f66d98690b1234ab8d8">rpmalloc_config_t::page_name</a></div><div class="ttdeci">const char * page_name</div><div class="ttdoc">Respectively allocated pages and huge allocated pages names for systems.</div><div class="ttdef"><b>Definition:</b> <a href="../../d2/d43/rpmalloc_8h_source.html#l00197">rpmalloc.h:197</a></div></div>
<div class="ttc" id="astructrpmalloc__config__t_html_a9cfb1a2f571e8ebe68185b387f04260b"><div class="ttname"><a href="../../df/d42/structrpmalloc__config__t.html#a9cfb1a2f571e8ebe68185b387f04260b">rpmalloc_config_t::enable_huge_pages</a></div><div class="ttdeci">int enable_huge_pages</div><div class="ttdoc">Enable use of large/huge pages. If this flag is set to non-zero and page size is.</div><div class="ttdef"><b>Definition:</b> <a href="../../d2/d43/rpmalloc_8h_source.html#l00194">rpmalloc.h:194</a></div></div>
<div class="ttc" id="astructrpmalloc__config__t_html_aaaf26ab237ec708c05953e92ae93578f"><div class="ttname"><a href="../../df/d42/structrpmalloc__config__t.html#aaaf26ab237ec708c05953e92ae93578f">rpmalloc_config_t::huge_page_name</a></div><div class="ttdeci">const char * huge_page_name</div><div class="ttdef"><b>Definition:</b> <a href="../../d2/d43/rpmalloc_8h_source.html#l00198">rpmalloc.h:198</a></div></div>
<div class="ttc" id="astructrpmalloc__config__t_html_ab1a81b9e7c3dee077fafc85b5327ea6b"><div class="ttname"><a href="../../df/d42/structrpmalloc__config__t.html#ab1a81b9e7c3dee077fafc85b5327ea6b">rpmalloc_config_t::memory_map</a></div><div class="ttdeci">void *(* memory_map)(size_t size, size_t *offset)</div><div class="ttdoc">Map memory pages for the given number of bytes. The returned address MUST be.</div><div class="ttdef"><b>Definition:</b> <a href="../../d2/d43/rpmalloc_8h_source.html#l00154">rpmalloc.h:154</a></div></div>
<div class="ttc" id="astructrpmalloc__config__t_html_ab730f9de6da78affe64497f859d6d345"><div class="ttname"><a href="../../df/d42/structrpmalloc__config__t.html#ab730f9de6da78affe64497f859d6d345">rpmalloc_config_t::span_size</a></div><div class="ttdeci">size_t span_size</div><div class="ttdoc">Size of a span of memory blocks. MUST be a power of two, and in [4096,262144].</div><div class="ttdef"><b>Definition:</b> <a href="../../d2/d43/rpmalloc_8h_source.html#l00180">rpmalloc.h:180</a></div></div>
<div class="ttc" id="astructrpmalloc__config__t_html_adcf8dfc992b8b4a4e6cd72e213bf1035"><div class="ttname"><a href="../../df/d42/structrpmalloc__config__t.html#adcf8dfc992b8b4a4e6cd72e213bf1035">rpmalloc_config_t::page_size</a></div><div class="ttdeci">size_t page_size</div><div class="ttdoc">Size of memory pages. The page size MUST be a power of two. All memory mapping.</div><div class="ttdef"><b>Definition:</b> <a href="../../d2/d43/rpmalloc_8h_source.html#l00176">rpmalloc.h:176</a></div></div>
<div class="ttc" id="asyscall_8cpp_html_a0eabe900500ad25646e5905a80f204de"><div class="ttname"><a href="../../d0/d64/syscall_8cpp.html#a0eabe900500ad25646e5905a80f204de">file</a></div><div class="ttdeci">FileNode * file</div><div class="ttdef"><b>Definition:</b> <a href="../../d0/d64/syscall_8cpp_source.html#l01674">syscall.cpp:1674</a></div></div>
<div class="ttc" id="asyscall_8cpp_html_a0f5467b8ffa31593190a14d4d96ba084"><div class="ttname"><a href="../../d0/d64/syscall_8cpp.html#a0f5467b8ffa31593190a14d4d96ba084">while</a></div><div class="ttdeci">while(true) ctx -&gt; Yield()</div></div>
<div class="ttc" id="asyscall_8cpp_html_a6f8059414f0228f0256115e024eeed4b"><div class="ttname"><a href="../../d0/d64/syscall_8cpp.html#a6f8059414f0228f0256115e024eeed4b">fd</a></div><div class="ttdeci">int fd</div><div class="ttdef"><b>Definition:</b> <a href="../../d0/d64/syscall_8cpp_source.html#l02873">syscall.cpp:2873</a></div></div>
<div class="ttc" id="asyscall_8cpp_html_a7801f18982e0e5d2853680593ff81c04"><div class="ttname"><a href="../../d0/d64/syscall_8cpp.html#a7801f18982e0e5d2853680593ff81c04">count</a></div><div class="ttdeci">int struct linux_dirent64 size_t count</div><div class="ttdef"><b>Definition:</b> <a href="../../d0/d64/syscall_8cpp_source.html#l02873">syscall.cpp:2874</a></div></div>
<div class="ttc" id="auserspace__test_8c_html_a83de08c56df151f990dc392523079284"><div class="ttname"><a href="../../df/d55/userspace__test_8c.html#a83de08c56df151f990dc392523079284">p</a></div><div class="ttdeci">struct passwd * p</div><div class="ttdef"><b>Definition:</b> <a href="../../df/d55/userspace__test_8c_source.html#l00129">userspace_test.c:129</a></div></div>
<div class="ttc" id="awi__stuff_8c_html_a81ad3ca73b21fc89fbb692189bb4031b"><div class="ttname"><a href="../../d6/d23/wi__stuff_8c.html#a81ad3ca73b21fc89fbb692189bb4031b">total</a></div><div class="ttdeci">static patch_t * total</div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d23/wi__stuff_8c_source.html#l00381">wi_stuff.c:381</a></div></div>
</div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="../../dir_52bed8acfaac088d5968cb2c84d7645d.html">Kernel</a></li><li class="navelem"><a class="el" href="../../dir_4b43f92f3b36afcf854dcf934e6beeae.html">core</a></li><li class="navelem"><a class="el" href="../../dir_0324a785b1c9bd6cbd91488045f3d0b5.html">memory</a></li><li class="navelem"><a class="el" href="../../dir_c5ea9415aa1db88b86345b822e37d7c6.html">heap_allocators</a></li><li class="navelem"><a class="el" href="../../dir_4170784ae1708a215052b93ed4398a20.html">rpmalloc</a></li><li class="navelem"><a class="el" href="../../df/dc0/rpmalloc_8c.html">rpmalloc.c</a></li>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1 </li>
  </ul>
</div>
</body>
</html>
